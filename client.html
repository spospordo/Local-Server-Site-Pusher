<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Access - Local Server Site Pusher</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .content {
            padding: 2rem;
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .device-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-left: 4px solid #4CAF50;
        }

        .device-info h2 {
            color: white;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .info-item {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .info-item.regular {
            background: #fff;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .info-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-offline {
            background: #f44336;
        }

        .device-name-form {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .link-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            text-decoration: none;
            color: #333;
            transition: all 0.3s;
            display: block;
        }

        .link-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            color: #667eea;
        }

        .link-name {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .link-url {
            font-size: 0.9rem;
            opacity: 0.7;
            word-break: break-all;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .password-form {
            text-align: center;
            padding: 2rem;
        }

        .password-form h2 {
            margin-bottom: 1rem;
            color: #333;
        }

        .password-form input {
            width: 100%;
            max-width: 300px;
            margin: 1rem auto;
            display: block;
        }

        /* File Upload Styles */
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            transition: border-color 0.3s;
        }

        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .file-item {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-info {
            flex: 1;
            min-width: 200px;
        }

        .file-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .file-details {
            font-size: 0.9rem;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .file-actions select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .file-actions button {
            padding: 0.25rem 0.75rem;
            font-size: 0.9rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        .btn-view {
            background-color: #007bff;
            color: white;
        }

        .btn-view:hover {
            background-color: #0056b3;
        }

        .sharing-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .sharing-none {
            background-color: #6c757d;
            color: white;
        }

        .sharing-admin {
            background-color: #fd7e14;
            color: white;
        }

        .sharing-all {
            background-color: #28a745;
            color: white;
        }

        /* New Welcome Message */
        .welcome-message {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
        }

        .welcome-message h2 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .welcome-message p {
            color: #666;
            font-size: 1rem;
        }

        /* Compact Server Status */
        .server-status-compact {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
            border-left: 4px solid #4CAF50;
        }

        .status-compact {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            font-size: 0.95rem;
            color: #555;
        }

        .status-compact .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        /* Media Streaming Styles */
        .media-streaming-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .media-player-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }

        .media-player-card.playing {
            border-left-color: #007bff;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
        }

        .media-player-card.paused {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff8e1 100%);
        }

        .media-player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .media-player-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .media-player-status {
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            background: #e9ecef;
            color: #6c757d;
        }

        .media-player-status.playing {
            background: #007bff;
            color: white;
        }

        .media-player-status.paused {
            background: #ffc107;
            color: #212529;
        }

        .media-info {
            margin-top: 0.75rem;
        }

        .media-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.3rem;
            font-size: 1.1rem;
            line-height: 1.3;
        }

        .media-artist {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
        }

        .media-device-type {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
        }

        .no-media {
            text-align: center;
            padding: 2rem;
            color: #666;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background: #fafafa;
        }

        .no-media h3 {
            margin-bottom: 0.5rem;
            color: #888;
        }

        .media-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 1rem;
        }

        .media-summary h3 {
            margin: 0 0 0.5rem 0;
        }

        .media-summary p {
            margin: 0;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .media-streaming-container {
                grid-template-columns: 1fr;
            }
        }

        /* Optional Section */
        .optional-section {
            background: linear-gradient(135deg, #fff8e1 0%, #fff3c4 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid #ffc107;
        }

        .optional-section h2 {
            color: #795548;
            margin-bottom: 0.5rem;
        }

        .optional-section p {
            color: #6d4c41;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .header {
                padding: 1.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .content {
                padding: 1rem;
            }
            
            .device-name-form {
                flex-direction: column;
            }
            
            .form-group {
                min-width: auto;
            }
        }

        /* Available Drinks Styles */
        .drink-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .drink-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .drink-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .drink-name::before {
            content: "🍸";
            margin-right: 0.5rem;
        }

        .drink-ingredients {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .drink-ingredient {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .drink-ingredient:last-child {
            border-bottom: none;
        }

        .ingredient-name {
            font-weight: 500;
            color: #34495e;
        }

        .ingredient-amount {
            color: #7f8c8d;
            font-size: 0.9rem;
            background: #ecf0f1;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .drinks-summary {
            text-align: center;
            padding: 1rem;
            background: #e8f5e8;
            border-radius: 6px;
            margin-bottom: 1rem;
            color: #2d5a2d;
            font-weight: 500;
        }

        .no-drinks {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 1rem 0;
        }

        /* Tournament Bracket Client Styles */
        .tournament-client-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
            padding: 1rem;
            transition: box-shadow 0.2s ease;
        }

        .tournament-client-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .tournament-client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tournament-client-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .tournament-client-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .tournament-client-status.setup {
            background: #fff3cd;
            color: #856404;
        }

        .tournament-client-status.active {
            background: #d1eddb;
            color: #155724;
        }

        .tournament-client-status.completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .tournament-client-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tournament-client-stat {
            text-align: center;
        }

        .tournament-client-stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }

        .tournament-client-stat-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
        }

        .tournament-winner {
            text-align: center;
            padding: 1rem;
            background: #d1eddb;
            color: #155724;
            border-radius: 6px;
            font-weight: 600;
            margin-top: 1rem;
        }

        .tournament-client-bracket {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            overflow-x: auto;
        }

        .bracket-client-rounds {
            display: flex;
            gap: 2rem;
            min-width: fit-content;
            justify-content: flex-start;
        }

        .bracket-client-round {
            min-width: 150px;
        }

        .bracket-client-round-title {
            text-align: center;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }

        .bracket-client-match {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-size: 0.85rem;
        }

        .bracket-client-match.completed {
            border-color: #28a745;
        }

        .bracket-client-participant {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .bracket-client-participant:last-child {
            border-bottom: none;
        }

        .bracket-client-participant.winner {
            background: #28a745;
            color: white;
            font-weight: 600;
        }

        .bracket-client-participant.loser {
            color: #6c757d;
        }

        .bracket-client-participant.bye {
            background: #ffc107;
            color: #856404;
            font-style: italic;
        }

        .no-tournaments {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 1rem 0;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌐 Client Access</h1>
            <p id="welcomeMessage">Welcome to Local Server Site Pusher</p>
        </div>
        
        <div class="content">
            <!-- Password Protection (shown if required) -->
            <div id="passwordSection" class="password-form" style="display: none;">
                <h2>🔒 Access Protection</h2>
                <p>This server requires a password to access client features.</p>
                <div id="passwordAlert"></div>
                <form id="passwordForm">
                    <input type="password" id="clientPassword" placeholder="Enter access password" required>
                    <br>
                    <button type="submit" class="btn">Access</button>
                </form>
            </div>

            <!-- Main Content (shown after authentication if required) -->
            <div id="mainContent">
                <!-- Brief Welcome Message -->
                <div class="welcome-message">
                    <h2>👋 Welcome to Client Access</h2>
                    <p>Upload files, manage content, and configure your settings.</p>
                </div>

                <!-- Useful Links -->
                <div class="section" id="usefulLinksSection">
                    <h2>🔗 Useful Links</h2>
                    <div id="linksContainer">
                        <div class="info-item regular" style="text-align: center; opacity: 0.7;">
                            <div class="info-value">Loading links...</div>
                        </div>
                    </div>
                </div>

                <!-- Available Drinks -->
                <div class="section" id="availableDrinksSection">
                    <h2>🍹 Available Drinks</h2>
                    <div id="drinksContainer">
                        <div class="info-item regular" style="text-align: center; opacity: 0.7;">
                            <div class="info-value">Loading available drinks...</div>
                        </div>
                    </div>
                </div>

                <!-- Tournament Brackets -->
                <div class="section" id="tournamentsSection">
                    <h2>🏆 Tournament Brackets</h2>
                    <div id="tournamentsContainer">
                        <div class="info-item regular" style="text-align: center; opacity: 0.7;">
                            <div class="info-value">Loading tournaments...</div>
                        </div>
                    </div>
                </div>

                <!-- Simplified Server Status -->
                <div class="server-status-compact section">
                    <h2>📊 Server Status</h2>
                    <div class="status-compact">
                        <span class="status-indicator status-online"></span>
                        <span id="serverStatus">Online</span> • 
                        <span id="serverVersion">Loading...</span> • 
                        Uptime: <span id="serverUptime">Loading...</span>
                    </div>
                </div>

                <!-- Home Assistant Media Streaming -->
                <div class="section" id="mediaStreamingSection">
                    <h2>🎵 Now Playing</h2>
                    <div id="mediaStreamingContainer">
                        <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                            Loading media information...
                        </div>
                    </div>
                </div>

                <!-- Optional: Device Name Setup -->
                <div class="optional-section">
                    <h2>📱 Optional: Add Device Name</h2>
                    <p>Give your device a custom name for easier identification.</p>
                    
                    <div class="device-name-form">
                        <div class="form-group">
                            <label for="deviceName">Device Name (Optional)</label>
                            <input type="text" id="deviceName" placeholder="e.g., John's iPhone, Living Room Tablet">
                        </div>
                        <button type="button" class="btn" onclick="updateDeviceName()">Save Name</button>
                    </div>
                </div>

                <!-- File Management (requires name) -->
                <div class="section">
                    <h2>📁 File Management</h2>
                    <p style="color: #666; margin-bottom: 1rem;"><strong>Note:</strong> A device name is required for file uploads.</p>
                    <div id="fileManagementAlert"></div>
                    
                    <!-- File Upload -->
                    <div id="fileUploadSection">
                        <h3>Upload Files</h3>
                        <form id="fileUploadForm" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="fileInput">Choose File</label>
                                <input type="file" id="fileInput" name="file" required>
                            </div>
                            <div class="form-group">
                                <label for="fileSharing">Sharing Permissions</label>
                                <select id="fileSharing" name="sharing">
                                    <option value="none">Private (Only me)</option>
                                    <option value="admin">Admin only</option>
                                    <option value="all">Public (Everyone)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn" id="uploadBtn">Upload File</button>
                        </form>
                    </div>

                    <!-- File List -->
                    <div id="fileListSection" style="margin-top: 2rem;">
                        <h3>My Files</h3>
                        <div id="fileList">
                            <div class="info-item regular" style="text-align: center; opacity: 0.7;">
                                <div class="info-value">Loading files...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Password Management -->
                <div class="optional-section">
                    <h2>🔐 Optional: Password Management</h2>
                    <p>Set up password protection for additional security.</p>
                    <div id="passwordManagementAlert"></div>
                    
                    <div id="passwordStatusSection">
                        <div class="info-item">
                            <div class="info-label">Password Protection Status</div>
                            <div class="info-value" id="passwordProtectionStatus">Checking...</div>
                        </div>
                    </div>

                    <div id="noPasswordSection" style="display: none;">
                        <div class="form-group">
                            <label for="newPassword">Set New Password</label>
                            <input type="password" id="newPassword" placeholder="Enter new password (min 4 characters)">
                        </div>
                        <button type="button" class="btn" onclick="setNewPassword()">Set Password</button>
                    </div>

                    <div id="hasPasswordSection" style="display: none;">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeNewPassword">New Password (optional)</label>
                            <input type="password" id="changeNewPassword" placeholder="Enter new password to change">
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <button type="button" class="btn" onclick="changePassword()" style="margin-right: 0.5rem;">Change Password</button>
                            <button type="button" class="btn" onclick="removePassword()" style="background-color: #dc3545;">Remove Password</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let deviceId = null;
        let connectionTime = new Date();
        let clientAuthenticated = false;
        let clientPassword = null; // Store the client password for file uploads

        // Device detection
        function detectDevice() {
            const userAgent = navigator.userAgent;
            let deviceType = 'Desktop';
            let browserInfo = 'Unknown';

            // Device type detection
            if (/iPhone/i.test(userAgent)) {
                deviceType = 'iPhone';
            } else if (/iPad/i.test(userAgent)) {
                deviceType = 'iPad';
            } else if (/Android/i.test(userAgent) && /Mobile/i.test(userAgent)) {
                deviceType = 'Android Phone';
            } else if (/Android/i.test(userAgent)) {
                deviceType = 'Android Tablet';
            } else if (/Windows Phone/i.test(userAgent)) {
                deviceType = 'Windows Phone';
            } else if (/Mobile/i.test(userAgent)) {
                deviceType = 'Mobile Device';
            } else if (/Tablet/i.test(userAgent)) {
                deviceType = 'Tablet';
            }

            // Browser detection
            if (userAgent.includes('Chrome')) {
                browserInfo = 'Chrome';
            } else if (userAgent.includes('Firefox')) {
                browserInfo = 'Firefox';
            } else if (userAgent.includes('Safari')) {
                browserInfo = 'Safari';
            } else if (userAgent.includes('Edge')) {
                browserInfo = 'Edge';
            } else if (userAgent.includes('Opera')) {
                browserInfo = 'Opera';
            }

            return { deviceType, browserInfo };
        }

        // Generate unique device ID
        function generateDeviceId() {
            const stored = localStorage.getItem('lssp_device_id');
            if (stored) {
                return stored;
            }
            
            const id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('lssp_device_id', id);
            return id;
        }

        // Update connection time display
        // Register device with server
        async function registerDevice() {
            try {
                const deviceInfo = detectDevice();
                const response = await fetch('/api/client/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceId: deviceId,
                        deviceType: deviceInfo.deviceType,
                        browserInfo: deviceInfo.browserInfo,
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    })
                });

                const result = await response.json();
                if (result.success) {
                    console.log('Device registered successfully');
                    if (result.deviceName) {
                        document.getElementById('deviceName').value = result.deviceName;
                    }
                }
            } catch (error) {
                console.error('Failed to register device:', error);
            }
        }

        // Check device name and update UI accordingly
        async function checkDeviceName() {
            try {
                const response = await fetch(`/api/visitor/status/${deviceId}`);
                const data = await response.json();
                
                if (data.isRecognized && data.name) {
                    // Device has a name, show it with edit button
                    showDeviceNameDisplay(data.name);
                } else {
                    // Device doesn't have a name, show the form
                    showDeviceNameForm();
                }
            } catch (error) {
                console.error('Failed to check device name:', error);
                // Default to showing the form
                showDeviceNameForm();
            }
        }

        function showDeviceNameDisplay(name) {
            const deviceNameSection = document.querySelector('.optional-section');
            deviceNameSection.innerHTML = `
                <h2>📱 Device Name</h2>
                <p>Your device is registered with the name: <strong>${name}</strong></p>
                <div class="device-name-display">
                    <div class="current-name">
                        <span class="name-value">${name}</span>
                        <button type="button" class="btn" onclick="showDeviceNameForm()" style="margin-left: 1rem;">Edit Name</button>
                    </div>
                </div>
            `;
        }

        function showDeviceNameForm() {
            const deviceNameSection = document.querySelector('.optional-section');
            deviceNameSection.innerHTML = `
                <h2>📱 Optional: Add Device Name</h2>
                <p>Give your device a custom name for easier identification.</p>
                
                <div class="device-name-form">
                    <div class="form-group">
                        <label for="deviceName">Device Name (Optional)</label>
                        <input type="text" id="deviceName" placeholder="e.g., John's iPhone, Living Room Tablet">
                    </div>
                    <button type="button" class="btn" onclick="updateDeviceName()">Save Name</button>
                </div>
            `;
        }

        // Update device name
        async function updateDeviceName() {
            const nameInput = document.getElementById('deviceName');
            const name = nameInput.value.trim();
            
            try {
                const response = await fetch('/api/client/update-name', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceId: deviceId,
                        name: name
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showAlert('Device name updated successfully!', 'success');
                    // Refresh the device name display
                    if (name) {
                        showDeviceNameDisplay(name);
                    } else {
                        showDeviceNameForm();
                    }
                } else {
                    showAlert('Failed to update device name: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Failed to update device name: ' + error.message, 'error');
            }
        }

        // Load server status
        async function loadServerStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                document.getElementById('serverUptime').textContent = Math.floor(status.server.uptime / 60) + ' minutes';
                document.getElementById('serverVersion').textContent = status.version;
                document.getElementById('serverStatus').textContent = 'Online';
                document.querySelector('.status-indicator').className = 'status-indicator status-online';
            } catch (error) {
                console.error('Failed to load server status:', error);
                document.getElementById('serverStatus').textContent = 'Offline';
                document.querySelector('.status-indicator').className = 'status-indicator status-offline';
            }
        }

        // Media Streaming Functions
        async function loadMediaStreamingStatus() {
            try {
                const response = await fetch('/api/media-streaming');
                const result = await response.json();
                
                const container = document.getElementById('mediaStreamingContainer');
                
                if (!result.success) {
                    // Hide the entire media streaming section if Home Assistant is not configured
                    if (result.error.includes('not properly configured') || result.error.includes('disabled')) {
                        document.getElementById('mediaStreamingSection').style.display = 'none';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="no-media">
                            <h3>📻 Media Streaming Unavailable</h3>
                            <p>${result.error}</p>
                        </div>
                    `;
                    return;
                }
                
                const data = result.data;
                
                if (!data.hasActiveMedia && data.totalDevices === 0) {
                    document.getElementById('mediaStreamingSection').style.display = 'none';
                    return;
                }
                
                // Show the section since we have data
                document.getElementById('mediaStreamingSection').style.display = 'block';
                
                let html = '';
                
                if (data.hasActiveMedia) {
                    const activePlayers = data.players.filter(player => player.isActive);
                    html += `
                        <div class="media-summary">
                            <h3>🎵 ${activePlayers.length} Device${activePlayers.length > 1 ? 's' : ''} Playing Media</h3>
                            <p>Showing current media from your Home Assistant devices</p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="media-summary" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                            <h3>⏸️ No Active Media</h3>
                            <p>${data.totalDevices} media player${data.totalDevices > 1 ? 's' : ''} found, all idle</p>
                        </div>
                    `;
                }
                
                if (data.hasActiveMedia) {
                    const activePlayers = data.players.filter(player => player.isActive);
                    
                    html += `<div class="media-streaming-container">`;
                    
                    activePlayers.forEach(player => {
                        const statusClass = player.state === 'playing' ? 'playing' : 'paused';
                        
                        html += `
                            <div class="media-player-card ${statusClass}">
                                <div class="media-player-header">
                                    <div class="media-player-name">${player.friendly_name}</div>
                                    <div class="media-player-status ${player.state}">${player.state}</div>
                                </div>
                        `;
                        
                        if (player.media_title || player.media_artist) {
                            html += `
                                <div class="media-info">
                                    ${player.media_title ? `<div class="media-title">${player.media_title}</div>` : ''}
                                    ${player.media_artist ? `<div class="media-artist">by ${player.media_artist}</div>` : ''}
                                    <div class="media-device-type">${player.deviceType}</div>
                                </div>
                            `;
                        } else {
                            html += `<div class="media-device-type">${player.deviceType}</div>`;
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                } else if (data.totalDevices > 0) {
                    // Show idle devices in a compact way
                    const idlePlayers = data.players.filter(player => !player.isActive).slice(0, 3); // Show max 3
                    
                    if (idlePlayers.length > 0) {
                        html += `
                            <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <small style="color: #666;">
                                    Available devices: ${idlePlayers.map(p => p.friendly_name).join(', ')}
                                    ${data.players.length > 3 ? ` and ${data.players.length - 3} more...` : ''}
                                </small>
                            </div>
                        `;
                    }
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Failed to load media streaming status:', error);
                const container = document.getElementById('mediaStreamingContainer');
                container.innerHTML = `
                    <div class="no-media">
                        <h3>📻 Connection Error</h3>
                        <p>Unable to load media information</p>
                    </div>
                `;
            }
        }

        // Load useful links
        async function loadUsefulLinks() {
            try {
                const response = await fetch('/api/client/links');
                const links = await response.json();
                
                const container = document.getElementById('linksContainer');
                
                if (links.length === 0) {
                    container.innerHTML = `
                        <div class="info-item regular" style="text-align: center; opacity: 0.7;">
                            <div class="info-value">No useful links configured</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = links.map(link => `
                        <a href="${link.url}" target="_blank" class="link-item">
                            <div class="link-name">${link.name}</div>
                            <div class="link-url">${link.url}</div>
                        </a>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load useful links:', error);
            }
        }

        // Load available drinks
        async function loadAvailableDrinks() {
            try {
                const response = await fetch('/api/drink-mixer/available-drinks');
                const data = await response.json();
                const container = document.getElementById('drinksContainer');
                
                if (data.availableDrinks.length === 0) {
                    container.innerHTML = `
                        <div class="no-drinks">
                            No drinks can be made with current ingredients.<br>
                            <small>Check back later or ask the admin to stock up! 🍹</small>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="drinks-summary">
                            🎉 ${data.availableCount} delicious drink${data.availableCount !== 1 ? 's' : ''} available right now!
                        </div>
                        ${data.availableDrinks.map(drink => `
                            <div class="drink-item">
                                <div class="drink-name">${drink.name}</div>
                                <div class="drink-ingredients">
                                    ${drink.ingredients.map(ingredient => `
                                        <div class="drink-ingredient">
                                            <span class="ingredient-name">${ingredient.name}</span>
                                            <span class="ingredient-amount">${ingredient.ounces} oz</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
            } catch (error) {
                console.error('Failed to load available drinks:', error);
                document.getElementById('drinksContainer').innerHTML = `
                    <div class="no-drinks">
                        Unable to load drinks menu. Please try again later.
                    </div>
                `;
            }
        }

        // Load tournaments for client view
        async function loadTournaments() {
            try {
                const response = await fetch('/api/tournaments');
                const tournaments = await response.json();
                
                const container = document.getElementById('tournamentsContainer');
                
                if (!tournaments || tournaments.length === 0) {
                    container.innerHTML = `
                        <div class="no-tournaments">
                            No tournaments available at the moment.
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                for (const tournament of tournaments) {
                    html += `
                        <div class="tournament-client-card">
                            <div class="tournament-client-header">
                                <div class="tournament-client-title">${escapeHtml(tournament.name)}</div>
                                <div class="tournament-client-status ${tournament.status}">${tournament.status}</div>
                            </div>
                            
                            <div class="tournament-client-info">
                                <div class="tournament-client-stat">
                                    <div class="tournament-client-stat-value">${tournament.participantCount}</div>
                                    <div class="tournament-client-stat-label">Players</div>
                                </div>
                                <div class="tournament-client-stat">
                                    <div class="tournament-client-stat-value">${tournament.currentRound || 0}</div>
                                    <div class="tournament-client-stat-label">Round</div>
                                </div>
                                <div class="tournament-client-stat">
                                    <div class="tournament-client-stat-value">${tournament.maxParticipants}</div>
                                    <div class="tournament-client-stat-label">Max</div>
                                </div>
                            </div>
                            
                            ${tournament.winner ? `
                                <div class="tournament-winner">
                                    🏆 Champion: ${escapeHtml(tournament.winner.name)}
                                </div>
                            ` : ''}
                            
                            <div id="bracket-${tournament.id}" class="tournament-client-bracket">
                                Loading bracket...
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
                // Load detailed bracket information for each tournament
                for (const tournament of tournaments) {
                    loadTournamentBracket(tournament.id);
                }
                
            } catch (error) {
                console.error('Failed to load tournaments:', error);
                document.getElementById('tournamentsContainer').innerHTML = `
                    <div class="no-tournaments">
                        Unable to load tournaments. Please try again later.
                    </div>
                `;
            }
        }

        // Load detailed bracket for a tournament
        async function loadTournamentBracket(tournamentId) {
            try {
                const response = await fetch(`/api/tournaments/${tournamentId}/bracket`);
                const tournament = await response.json();
                
                const container = document.getElementById(`bracket-${tournamentId}`);
                
                if (!tournament.bracket || tournament.bracket.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 1rem;">
                            ${tournament.status === 'setup' ? 'Bracket not generated yet' : 'No bracket data available'}
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="bracket-client-rounds">';
                
                tournament.bracket.forEach(round => {
                    html += `
                        <div class="bracket-client-round">
                            <div class="bracket-client-round-title">${round.name}</div>
                    `;
                    
                    round.matches.forEach(match => {
                        const isCompleted = match.completed;
                        
                        html += `
                            <div class="bracket-client-match ${isCompleted ? 'completed' : ''}">
                                <div class="bracket-client-participant ${isCompleted && match.winnerId === match.participant1?.id ? 'winner' : isCompleted ? 'loser' : ''}">
                                    ${match.participant1 ? escapeHtml(match.participant1.name) : 'TBD'}
                                </div>
                                <div class="bracket-client-participant ${isCompleted && match.winnerId === match.participant2?.id ? 'winner' : isCompleted ? 'loser' : match.score === 'BYE' ? 'bye' : ''}">
                                    ${match.participant2 ? escapeHtml(match.participant2.name) : match.score === 'BYE' ? 'BYE' : 'TBD'}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error(`Failed to load bracket for tournament ${tournamentId}:`, error);
                document.getElementById(`bracket-${tournamentId}`).innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 1rem;">
                        Error loading bracket
                    </div>
                `;
            }
        }

        // Utility function for HTML escaping
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Load client configuration
        async function loadClientConfig() {
            try {
                const response = await fetch('/api/client/config');
                const config = await response.json();
                
                // Update welcome message
                if (config.welcomeMessage) {
                    document.getElementById('welcomeMessage').textContent = config.welcomeMessage;
                }
                
                // Show/hide sections based on configuration
                if (!config.showServerStatus) {
                    document.getElementById('serverStatusSection').style.display = 'none';
                }
                
                if (!config.showUsefulLinks) {
                    document.getElementById('usefulLinksSection').style.display = 'none';
                }
                
                // Handle password protection
                if (config.requirePassword && !clientAuthenticated) {
                    await personalizePasswordPrompt();
                    document.getElementById('passwordSection').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';
                } else {
                    document.getElementById('passwordSection').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    initializeClient();
                }
            } catch (error) {
                console.error('Failed to load client config:', error);
                // Default to showing main content if config load fails
                initializeClient();
            }
        }

        // Personalize password prompt for returning users
        async function personalizePasswordPrompt() {
            try {
                const response = await fetch(`/api/visitor/status/${deviceId}`);
                const data = await response.json();
                
                if (data.isRecognized && data.name) {
                    // Personalize the password prompt for recognized device
                    const passwordSection = document.getElementById('passwordSection');
                    const heading = passwordSection.querySelector('h2');
                    const description = passwordSection.querySelector('p');
                    
                    heading.textContent = '🔒 Welcome Back!';
                    description.innerHTML = `Welcome back, <strong>${escapeHtml(data.name)}</strong>! Please enter your password to access your files and settings.`;
                }
            } catch (error) {
                console.error('Failed to personalize password prompt:', error);
                // Keep default generic text if personalization fails
            }
        }

        // Handle password authentication
        async function authenticateClient(password) {
            try {
                const response = await fetch('/api/client/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });

                const result = await response.json();
                if (result.success) {
                    clientAuthenticated = true;
                    clientPassword = password; // Store password for file uploads
                    document.getElementById('passwordSection').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    initializeClient();
                    return true;
                } else {
                    showPasswordAlert('Invalid password. Please try again.', 'error');
                    return false;
                }
            } catch (error) {
                showPasswordAlert('Authentication failed: ' + error.message, 'error');
                return false;
            }
        }

        // Initialize client functionality
        function initializeClient() {
            const deviceInfo = detectDevice();
            
            registerDevice();
            loadServerStatus();
            loadUsefulLinks();
            loadAvailableDrinks();
            loadTournaments();
            loadMediaStreamingStatus(); // Load media streaming status
            checkPasswordStatus(); // Load password status
            loadFileList(); // Load user files
            checkDeviceName(); // Check if device has a name and update UI
            
            // Refresh server status every 30 seconds
            setInterval(loadServerStatus, 30000);
            
            // Refresh tournaments every 60 seconds
            setInterval(loadTournaments, 60000);
            
            // Refresh media streaming status every 15 seconds
            setInterval(loadMediaStreamingStatus, 15000);
        }

        // Password management functions
        async function checkPasswordStatus() {
            try {
                const response = await fetch('/api/client/password-status');
                const data = await response.json();
                
                updatePasswordStatusDisplay(data);
            } catch (error) {
                console.error('Failed to check password status:', error);
                document.getElementById('passwordProtectionStatus').textContent = 'Error checking status';
            }
        }

        function updatePasswordStatusDisplay(status) {
            const passwordSection = document.querySelector('.optional-section:last-child');
            
            if (status.hasPassword) {
                // Password exists - show simplified UI
                passwordSection.innerHTML = `
                    <h2>🔐 Password Protection</h2>
                    <div id="passwordManagementAlert"></div>
                    
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value" style="color: #28a745;">
                            🔒 <strong>Password Set</strong> - Your account is protected
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <button type="button" class="btn" onclick="showPasswordChangeForm()" style="margin-right: 0.5rem;">Change Password</button>
                        <button type="button" class="btn" onclick="removePassword()" style="background-color: #dc3545;">Remove Password</button>
                    </div>
                    
                    <div id="passwordChangeForm" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeNewPassword">New Password</label>
                            <input type="password" id="changeNewPassword" placeholder="Enter new password (min 4 characters)">
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <button type="button" class="btn" onclick="changePassword()" style="margin-right: 0.5rem;">Update Password</button>
                            <button type="button" class="btn" onclick="hidePasswordChangeForm()" style="background-color: #6c757d;">Cancel</button>
                        </div>
                    </div>
                `;
            } else {
                // No password - show setup form
                passwordSection.innerHTML = `
                    <h2>🔐 Optional: Password Protection</h2>
                    <p>Set up password protection for additional security.</p>
                    <div id="passwordManagementAlert"></div>
                    
                    <div class="info-item">
                        <div class="info-label">Password Protection Status</div>
                        <div class="info-value" style="color: #6c757d;">
                            🔓 <strong>No Protection</strong> - No password is set
                        </div>
                    </div>

                    <div style="margin-top: 1rem;">
                        <div class="form-group">
                            <label for="newPassword">Set New Password</label>
                            <input type="password" id="newPassword" placeholder="Enter new password (min 4 characters)">
                        </div>
                        <button type="button" class="btn" onclick="setNewPassword()">Set Password</button>
                    </div>
                `;
            }
        }

        function showPasswordChangeForm() {
            document.getElementById('passwordChangeForm').style.display = 'block';
        }

        function hidePasswordChangeForm() {
            document.getElementById('passwordChangeForm').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('changeNewPassword').value = '';
        }

        async function setNewPassword() {
            const newPassword = document.getElementById('newPassword').value;
            
            if (!newPassword) {
                showPasswordManagementAlert('Please enter a password', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showPasswordManagementAlert('Password must be at least 4 characters long', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/client/set-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPassword: newPassword })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showPasswordManagementAlert(result.message, 'success');
                    clientPassword = newPassword; // Store the password for file uploads
                    document.getElementById('newPassword').value = '';
                    checkPasswordStatus(); // Refresh status
                } else {
                    showPasswordManagementAlert(result.error, 'error');
                }
            } catch (error) {
                showPasswordManagementAlert('Error setting password: ' + error.message, 'error');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('changeNewPassword').value;
            
            if (!currentPassword) {
                showPasswordManagementAlert('Please enter your current password', 'error');
                return;
            }
            
            if (!newPassword) {
                showPasswordManagementAlert('Please enter a new password', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showPasswordManagementAlert('New password must be at least 4 characters long', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/client/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        currentPassword: currentPassword, 
                        newPassword: newPassword 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showPasswordManagementAlert(result.message, 'success');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('changeNewPassword').value = '';
                    checkPasswordStatus(); // Refresh status
                } else {
                    showPasswordManagementAlert(result.error, 'error');
                }
            } catch (error) {
                showPasswordManagementAlert('Error changing password: ' + error.message, 'error');
            }
        }

        async function removePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            
            if (!currentPassword) {
                showPasswordManagementAlert('Please enter your current password to remove protection', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to remove password protection? This will allow unrestricted access to client features.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/client/remove-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword: currentPassword })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showPasswordManagementAlert(result.message, 'success');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('changeNewPassword').value = '';
                    checkPasswordStatus(); // Refresh status
                } else {
                    showPasswordManagementAlert(result.error, 'error');
                }
            } catch (error) {
                showPasswordManagementAlert('Error removing password: ' + error.message, 'error');
            }
        }

        function showPasswordManagementAlert(message, type) {
            const alertDiv = document.getElementById('passwordManagementAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        // Show alert
        function showAlert(message, type) {
            // You can implement this to show alerts in the main content
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        // Show password alert
        function showPasswordAlert(message, type) {
            const alertDiv = document.getElementById('passwordAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        // File Upload and Management Functions
        async function uploadFile() {
            // Check if device has a name
            const deviceName = getDeviceNameFromDOM();
            
            if (!deviceName) {
                showFileManagementAlert('Please set a device name before uploading files. Scroll up to the "Device Name" section.', 'error');
                return;
            }
            
            const form = document.getElementById('fileUploadForm');
            const formData = new FormData(form);
            formData.append('deviceId', deviceId);
            formData.append('deviceName', deviceName);
            
            // Add password to form data if we have one (for authentication)
            if (clientPassword) {
                formData.append('password', clientPassword);
            }
            
            try {
                const response = await fetch('/api/client/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showFileManagementAlert('File uploaded successfully!', 'success');
                    form.reset();
                    loadFileList();
                } else {
                    showFileManagementAlert(result.error, 'error');
                }
            } catch (error) {
                showFileManagementAlert('Error uploading file: ' + error.message, 'error');
            }
        }

        // Helper function to get device name from DOM
        function getDeviceNameFromDOM() {
            // Try to get name from display mode first
            const nameDisplay = document.querySelector('.name-value');
            if (nameDisplay) {
                return nameDisplay.textContent.trim();
            }
            
            // Fall back to input field
            const deviceNameInput = document.getElementById('deviceName');
            if (deviceNameInput) {
                return deviceNameInput.value.trim();
            }
            
            return '';
        }

        async function loadFileList() {
            try {
                const response = await fetch(`/api/client/files?deviceId=${deviceId}`);
                const result = await response.json();
                
                const fileListContainer = document.getElementById('fileList');
                
                if (result.success && result.files.length > 0) {
                    fileListContainer.innerHTML = result.files.map(file => `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">${escapeHtml(file.originalName)}</div>
                                <div class="file-details">
                                    Size: ${formatFileSize(file.size)} | 
                                    Type: ${file.mimeType} | 
                                    Uploaded: ${formatDate(file.uploadDate)}
                                    <span class="sharing-badge sharing-${file.sharing}">${formatSharing(file.sharing)}</span>
                                </div>
                            </div>
                            <div class="file-actions">
                                <select onchange="updateFileSharing('${file.filename}', this.value)">
                                    <option value="none" ${file.sharing === 'none' ? 'selected' : ''}>Private</option>
                                    <option value="admin" ${file.sharing === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="all" ${file.sharing === 'all' ? 'selected' : ''}>Public</option>
                                </select>
                                <button class="btn-view" onclick="viewFile('${file.filename}')">View</button>
                                <button class="btn-delete" onclick="deleteFile('${file.filename}')">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    fileListContainer.innerHTML = `
                        <div class="info-item regular" style="text-align: center; opacity: 0.7;">
                            <div class="info-value">No files uploaded yet</div>
                        </div>
                    `;
                }
            } catch (error) {
                showFileManagementAlert('Error loading files: ' + error.message, 'error');
            }
        }

        async function updateFileSharing(filename, sharing) {
            try {
                const response = await fetch(`/api/client/files/${filename}/sharing`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        sharing: sharing,
                        deviceId: deviceId 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showFileManagementAlert('File sharing updated successfully!', 'success');
                    loadFileList(); // Refresh the list
                } else {
                    showFileManagementAlert(result.error, 'error');
                }
            } catch (error) {
                showFileManagementAlert('Error updating file sharing: ' + error.message, 'error');
            }
        }

        async function deleteFile(filename) {
            if (!confirm('Are you sure you want to delete this file?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/client/files/${filename}?deviceId=${deviceId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showFileManagementAlert('File deleted successfully!', 'success');
                    loadFileList();
                } else {
                    showFileManagementAlert(result.error, 'error');
                }
            } catch (error) {
                showFileManagementAlert('Error deleting file: ' + error.message, 'error');
            }
        }

        function viewFile(filename) {
            const url = `/files/${deviceId}/${filename}`;
            window.open(url, '_blank');
        }

        function showFileManagementAlert(message, type) {
            const alertContainer = document.getElementById('fileManagementAlert');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function formatSharing(sharing) {
            switch(sharing) {
                case 'none': return 'Private';
                case 'admin': return 'Admin Only';
                case 'all': return 'Public';
                default: return sharing;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            deviceId = generateDeviceId();
            
            // Password form handler
            document.getElementById('passwordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const password = document.getElementById('clientPassword').value;
                await authenticateClient(password);
            });
            
            // File upload form handler
            document.getElementById('fileUploadForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await uploadFile();
            });
            
            // Load configuration and initialize
            loadClientConfig();
        });
    </script>
</body>
</html>