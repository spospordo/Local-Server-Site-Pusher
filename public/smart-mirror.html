<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Mirror Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        body.theme-light {
            background: #f5f5f5;
            color: #333;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            height: 100vh;
            width: 100vw;
        }

        .widget {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.theme-light .widget {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .widget-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .widget-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Clock Widget */
        .clock-time {
            font-size: 4rem;
            font-weight: 300;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .clock-date {
            font-size: 1.5rem;
            margin-top: 10px;
            opacity: 0.7;
        }

        /* Calendar Widget */
        .calendar-container {
            width: 100%;
        }

        .calendar-header {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .calendar-day-name {
            font-weight: 600;
            padding: 5px;
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .calendar-day {
            padding: 10px 5px;
            border-radius: 5px;
            font-size: 1rem;
        }

        .calendar-day.today {
            background: rgba(102, 126, 234, 0.6);
            font-weight: 700;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-events {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .calendar-event {
            background: rgba(102, 126, 234, 0.2);
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .calendar-event-time {
            font-weight: 600;
            margin-right: 10px;
        }

        /* Weather Widget */
        .weather-temp {
            font-size: 3rem;
            font-weight: 300;
        }
        
        .weather-temp-unit {
            font-size: 1.5rem;
            opacity: 0.6;
            margin-left: 5px;
        }
        
        .weather-temp-secondary {
            font-size: 1.2rem;
            opacity: 0.5;
            margin-left: 10px;
        }

        .weather-condition {
            font-size: 1.5rem;
            margin-top: 10px;
            opacity: 0.8;
        }
        
        .weather-icon {
            font-size: 2.5rem;
            margin: 10px 0;
        }

        .weather-details {
            margin-top: 15px;
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            opacity: 0.7;
            flex-wrap: wrap;
        }
        
        .weather-location {
            font-size: 1rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        /* Forecast Widget */
        .forecast-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            gap: 10px;
        }
        
        .forecast-day {
            text-align: center;
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        body.theme-light .forecast-day {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .forecast-day-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .forecast-icon {
            font-size: 2rem;
            margin: 8px 0;
        }
        
        .forecast-temp {
            font-size: 1.2rem;
            margin: 5px 0;
        }
        
        .forecast-temp-high {
            font-weight: 600;
        }
        
        .forecast-temp-low {
            opacity: 0.6;
        }
        
        .forecast-precip {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* News Widget */
        .news-items {
            width: 100%;
            overflow-y: auto;
            max-height: 100%;
        }

        .news-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.theme-light .news-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .news-source {
            font-size: 0.8rem;
            opacity: 0.6;
        }

        /* Error message */
        .error-message {
            color: #ff6b6b;
            padding: 20px;
            text-align: center;
            font-size: 1.2rem;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.6;
        }

        /* Responsive grid positioning */
        .widget[data-grid-x="0"] { grid-column: 1; }
        .widget[data-grid-x="1"] { grid-column: 2; }
        .widget[data-grid-x="2"] { grid-column: 3; }
        .widget[data-grid-x="3"] { grid-column: 4; }

        .widget[data-grid-y="0"] { grid-row: 1; }
        .widget[data-grid-y="1"] { grid-row: 2; }
        .widget[data-grid-y="2"] { grid-row: 3; }

        .widget[data-grid-width="1"] { grid-column: span 1; }
        .widget[data-grid-width="2"] { grid-column: span 2; }
        .widget[data-grid-width="3"] { grid-column: span 3; }
        .widget[data-grid-width="4"] { grid-column: span 4; }

        .widget[data-grid-height="1"] { grid-row: span 1; }
        .widget[data-grid-height="2"] { grid-row: span 2; }
        .widget[data-grid-height="3"] { grid-row: span 3; }

        /* Scrollbar styling for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        body.theme-light ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        body.theme-light ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
        }

        body.theme-light ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="dashboard-container" id="dashboardContainer">
        <div class="loading">Loading Smart Mirror Dashboard...</div>
    </div>

    <script>
        let config = null;
        let refreshInterval = null;

        // Load configuration and initialize dashboard
        async function loadConfig() {
            console.log('[Smart Mirror] Loading configuration from API...');
            console.log('[Smart Mirror] Timestamp:', new Date().toISOString());
            console.log('[Smart Mirror] User Agent:', navigator.userAgent);
            console.log('[Smart Mirror] Page URL:', window.location.href);
            
            try {
                const fetchStart = performance.now();
                console.log('[Smart Mirror] Fetching config from /api/smart-mirror/config');
                
                const response = await fetch('/api/smart-mirror/config');
                const fetchEnd = performance.now();
                
                console.log(`[Smart Mirror] API response received (${Math.round(fetchEnd - fetchStart)}ms)`);
                console.log('[Smart Mirror] Response status:', response.status, response.statusText);
                console.log('[Smart Mirror] Response headers:', {
                    contentType: response.headers.get('content-type'),
                    cacheControl: response.headers.get('cache-control')
                });
                
                const data = await response.json();
                console.log('[Smart Mirror] Config data parsed:', {
                    success: data.success,
                    hasConfig: !!data.config,
                    enabled: data.config?.enabled,
                    theme: data.config?.theme,
                    widgetCount: Object.keys(data.config?.widgets || {}).length
                });
                
                if (data.success && data.config) {
                    config = data.config;
                    console.log('‚úÖ [Smart Mirror] Config loaded successfully:', config);
                    console.log('[Smart Mirror] Enabled widgets:', 
                        Object.keys(config.widgets || {}).filter(k => config.widgets[k]?.enabled)
                    );
                    
                    // Apply theme
                    if (config.theme === 'light') {
                        console.log('[Smart Mirror] Applying light theme');
                        document.body.classList.add('theme-light');
                    } else {
                        console.log('[Smart Mirror] Using dark theme (default)');
                    }
                    
                    // Check if dashboard is enabled
                    if (config.enabled === false) {
                        console.warn('‚ö†Ô∏è  [Smart Mirror] Dashboard is disabled in configuration');
                        showError('Smart Mirror Dashboard is currently disabled. Please enable it in the admin panel.');
                        return;
                    }
                    
                    console.log('[Smart Mirror] Dashboard is enabled, rendering...');
                    
                    // Render dashboard
                    renderDashboard();
                    
                    // Set up refresh interval
                    if (config.refreshInterval && config.refreshInterval > 0) {
                        console.log(`[Smart Mirror] Setting refresh interval: ${config.refreshInterval}ms`);
                        refreshInterval = setInterval(updateWidgets, config.refreshInterval);
                    }
                } else {
                    console.error('‚ùå [Smart Mirror] Config load failed:', data);
                    showError('Failed to load Smart Mirror configuration.');
                }
            } catch (error) {
                console.error('‚ùå [Smart Mirror] Error loading config:', error);
                console.error('[Smart Mirror] Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                showError('Error connecting to server. Please check your connection.');
            }
        }

        // Render the dashboard with configured widgets
        function renderDashboard() {
            console.log('[Smart Mirror] Starting dashboard render');
            const container = document.getElementById('dashboardContainer');
            container.innerHTML = '';

            if (!config || !config.widgets) {
                console.error('‚ùå [Smart Mirror] No widgets configured');
                showError('No widgets configured.');
                return;
            }

            console.log('[Smart Mirror] Rendering widgets:', Object.keys(config.widgets));
            
            // Create widgets based on configuration
            Object.keys(config.widgets).forEach(widgetKey => {
                const widgetConfig = config.widgets[widgetKey];
                
                console.log(`[Smart Mirror] Processing widget: ${widgetKey}`, {
                    enabled: widgetConfig?.enabled,
                    area: widgetConfig?.area,
                    size: widgetConfig?.size
                });
                
                // Only render enabled widgets
                if (widgetConfig && widgetConfig.enabled === true) {
                    const widget = createWidget(widgetKey, widgetConfig);
                    if (widget) {
                        container.appendChild(widget);
                    }
                }
            });

            // Start updating dynamic content
            updateWidgets();
        }

        // Create a widget element
        function createWidget(type, widgetConfig) {
            const widget = document.createElement('div');
            widget.className = 'widget';
            widget.dataset.type = type;
            
            // Set grid position
            const pos = widgetConfig.gridPosition || {};
            widget.dataset.gridX = pos.x || 0;
            widget.dataset.gridY = pos.y || 0;
            widget.dataset.gridWidth = pos.width || 1;
            widget.dataset.gridHeight = pos.height || 1;

            // Create widget header
            const header = document.createElement('div');
            header.className = 'widget-header';
            header.textContent = getWidgetTitle(type);
            widget.appendChild(header);

            // Create widget content container
            const content = document.createElement('div');
            content.className = 'widget-content';
            content.id = `widget-${type}`;
            widget.appendChild(content);

            return widget;
        }

        // Get widget title
        function getWidgetTitle(type) {
            const titles = {
                clock: 'üïê Time',
                calendar: 'üìÖ Calendar',
                weather: 'üå§Ô∏è Weather',
                forecast: 'üå¶Ô∏è Forecast',
                news: 'üì∞ News'
            };
            return titles[type] || type.charAt(0).toUpperCase() + type.slice(1);
        }

        // Update all dynamic widgets
        function updateWidgets() {
            if (!config || !config.widgets) return;

            Object.keys(config.widgets).forEach(widgetKey => {
                const widgetConfig = config.widgets[widgetKey];
                if (widgetConfig && widgetConfig.enabled === true) {
                    updateWidget(widgetKey, widgetConfig);
                }
            });
        }

        // Update individual widget
        function updateWidget(type, widgetConfig) {
            const content = document.getElementById(`widget-${type}`);
            if (!content) return;

            switch (type) {
                case 'clock':
                    updateClockWidget(content);
                    break;
                case 'calendar':
                    updateCalendarWidget(content, widgetConfig);
                    break;
                case 'weather':
                    updateWeatherWidget(content, widgetConfig);
                    break;
                case 'forecast':
                    updateForecastWidget(content, widgetConfig);
                    break;
                case 'news':
                    updateNewsWidget(content, widgetConfig);
                    break;
            }
        }

        // Update clock widget
        function updateClockWidget(content) {
            const now = new Date();
            
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            content.innerHTML = `
                <div class="clock-time">${timeStr}</div>
                <div class="clock-date">${dateStr}</div>
            `;
        }

        // Update calendar widget
        async function updateCalendarWidget(content, widgetConfig) {
            try {
                const response = await fetch('/api/smart-mirror/calendar');
                const data = await response.json();
                
                if (data.success && data.events && data.events.length > 0) {
                    let eventsHTML = '<div class="calendar-events">';
                    data.events.forEach(event => {
                        const startDate = new Date(event.start);
                        const timeStr = startDate.toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit',
                            hour12: true 
                        });
                        const dateStr = startDate.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                        });
                        
                        // Create safe text nodes by using textContent
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'calendar-event';
                        
                        const mainDiv = document.createElement('div');
                        const timeSpan = document.createElement('span');
                        timeSpan.className = 'calendar-event-time';
                        timeSpan.textContent = `${dateStr} ${timeStr}`;
                        mainDiv.appendChild(timeSpan);
                        
                        const titleStrong = document.createElement('strong');
                        titleStrong.textContent = event.title || 'Untitled Event';
                        mainDiv.appendChild(titleStrong);
                        eventDiv.appendChild(mainDiv);
                        
                        if (event.location) {
                            const locationDiv = document.createElement('div');
                            locationDiv.style.fontSize = '0.85em';
                            locationDiv.style.opacity = '0.7';
                            locationDiv.style.marginTop = '3px';
                            locationDiv.textContent = 'üìç ' + event.location;
                            eventDiv.appendChild(locationDiv);
                        }
                        
                        eventsHTML += eventDiv.outerHTML;
                    });
                    eventsHTML += '</div>';
                    content.innerHTML = eventsHTML;
                } else if (data.error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.opacity = '0.6';
                    errorDiv.style.textAlign = 'center';
                    errorDiv.textContent = '‚ö†Ô∏è ' + data.error;
                    content.innerHTML = '';
                    content.appendChild(errorDiv);
                } else {
                    const msgDiv = document.createElement('div');
                    msgDiv.style.opacity = '0.6';
                    msgDiv.style.textAlign = 'center';
                    msgDiv.textContent = 'No upcoming events';
                    content.innerHTML = '';
                    content.appendChild(msgDiv);
                }
            } catch (error) {
                console.error('Error fetching calendar:', error);
                const errorDiv = document.createElement('div');
                errorDiv.style.opacity = '0.6';
                errorDiv.style.textAlign = 'center';
                errorDiv.textContent = 'Error loading calendar';
                content.innerHTML = '';
                content.appendChild(errorDiv);
            }
        }

        // Helper function to convert Celsius to Fahrenheit
        function celsiusToFahrenheit(celsius) {
            return Math.round((celsius * 9/5) + 32);
        }

        // Helper function to convert Fahrenheit to Celsius
        function fahrenheitToCelsius(fahrenheit) {
            return Math.round((fahrenheit - 32) * 5/9);
        }

        // Helper function to get weather icon from OpenWeatherMap icon code
        function getWeatherIcon(iconCode) {
            const iconMap = {
                '01d': '‚òÄÔ∏è', '01n': 'üåô',
                '02d': '‚õÖ', '02n': '‚òÅÔ∏è',
                '03d': '‚òÅÔ∏è', '03n': '‚òÅÔ∏è',
                '04d': '‚òÅÔ∏è', '04n': '‚òÅÔ∏è',
                '09d': 'üåßÔ∏è', '09n': 'üåßÔ∏è',
                '10d': 'üå¶Ô∏è', '10n': 'üåßÔ∏è',
                '11d': '‚õàÔ∏è', '11n': '‚õàÔ∏è',
                '13d': 'üå®Ô∏è', '13n': 'üå®Ô∏è',
                '50d': 'üå´Ô∏è', '50n': 'üå´Ô∏è'
            };
            return iconMap[iconCode] || 'üå§Ô∏è';
        }

        // Update weather widget
        async function updateWeatherWidget(content, widgetConfig) {
            try {
                const response = await fetch('/api/smart-mirror/weather');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const weather = data.data;
                    const isImperial = weather.units === 'imperial';
                    const tempUnit = isImperial ? 'F' : 'C';
                    const tempSecondary = isImperial ? fahrenheitToCelsius(weather.temp) : celsiusToFahrenheit(weather.temp);
                    const secondaryUnit = isImperial ? 'C' : 'F';
                    const windUnit = isImperial ? 'mph' : 'm/s';
                    
                    // Create elements safely
                    content.innerHTML = '';
                    
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'weather-icon';
                    iconDiv.textContent = getWeatherIcon(weather.icon);
                    content.appendChild(iconDiv);
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.className = 'weather-temp';
                    tempDiv.textContent = weather.temp + '¬∞';
                    
                    const tempUnitSpan = document.createElement('span');
                    tempUnitSpan.className = 'weather-temp-unit';
                    tempUnitSpan.textContent = tempUnit;
                    tempDiv.appendChild(tempUnitSpan);
                    
                    const tempSecondarySpan = document.createElement('span');
                    tempSecondarySpan.className = 'weather-temp-secondary';
                    tempSecondarySpan.textContent = tempSecondary + '¬∞' + secondaryUnit;
                    tempDiv.appendChild(tempSecondarySpan);
                    content.appendChild(tempDiv);
                    
                    const conditionDiv = document.createElement('div');
                    conditionDiv.className = 'weather-condition';
                    conditionDiv.textContent = weather.description || 'Unknown';
                    content.appendChild(conditionDiv);
                    
                    const locationDiv = document.createElement('div');
                    locationDiv.className = 'weather-location';
                    locationDiv.textContent = weather.location + (weather.country ? ', ' + weather.country : '');
                    content.appendChild(locationDiv);
                    
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'weather-details';
                    
                    const humidityDiv = document.createElement('div');
                    humidityDiv.textContent = 'üíß ' + weather.humidity + '%';
                    detailsDiv.appendChild(humidityDiv);
                    
                    const windDiv = document.createElement('div');
                    windDiv.textContent = 'üí® ' + weather.windSpeed + ' ' + windUnit;
                    detailsDiv.appendChild(windDiv);
                    
                    if (weather.feelsLike) {
                        const feelsLikeDiv = document.createElement('div');
                        feelsLikeDiv.textContent = 'Feels: ' + weather.feelsLike + '¬∞' + tempUnit;
                        detailsDiv.appendChild(feelsLikeDiv);
                    }
                    
                    content.appendChild(detailsDiv);
                } else if (data.error) {
                    const errorContainer = document.createElement('div');
                    errorContainer.style.opacity = '0.6';
                    errorContainer.style.textAlign = 'center';
                    
                    const iconDiv = document.createElement('div');
                    iconDiv.style.fontSize = '2rem';
                    iconDiv.style.marginBottom = '10px';
                    iconDiv.textContent = '‚ö†Ô∏è';
                    errorContainer.appendChild(iconDiv);
                    
                    const msgDiv = document.createElement('div');
                    msgDiv.textContent = data.error;
                    errorContainer.appendChild(msgDiv);
                    
                    content.innerHTML = '';
                    content.appendChild(errorContainer);
                }
            } catch (error) {
                console.error('Error fetching weather:', error);
                const errorDiv = document.createElement('div');
                errorDiv.style.opacity = '0.6';
                errorDiv.style.textAlign = 'center';
                errorDiv.textContent = 'Error loading weather';
                content.innerHTML = '';
                content.appendChild(errorDiv);
            }
        }

        // Update forecast widget
        async function updateForecastWidget(content, widgetConfig) {
            try {
                const response = await fetch('/api/smart-mirror/forecast');
                const data = await response.json();
                
                if (data.success && data.days && data.days.length > 0) {
                    const isImperial = data.units === 'imperial';
                    const tempUnit = isImperial ? 'F' : 'C';
                    
                    let forecastHTML = '<div class="forecast-container">';
                    data.days.forEach(day => {
                        const tempHigh = day.tempHigh;
                        const tempLow = day.tempLow;
                        const tempHighSecondary = isImperial ? fahrenheitToCelsius(tempHigh) : celsiusToFahrenheit(tempHigh);
                        const tempLowSecondary = isImperial ? fahrenheitToCelsius(tempLow) : celsiusToFahrenheit(tempLow);
                        const secondaryUnit = isImperial ? 'C' : 'F';
                        
                        forecastHTML += `
                            <div class="forecast-day">
                                <div class="forecast-day-name">${day.dayName}</div>
                                <div class="forecast-icon">${getWeatherIcon(day.icon)}</div>
                                <div class="forecast-temp">
                                    <div class="forecast-temp-high">${tempHigh}¬∞${tempUnit}</div>
                                    <div class="forecast-temp-low">${tempLow}¬∞${tempUnit}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.5; margin-top: 3px;">
                                        ${tempHighSecondary}¬∞/${tempLowSecondary}¬∞${secondaryUnit}
                                    </div>
                                </div>
                                ${day.precipChance > 0 ? `<div class="forecast-precip">üíß ${day.precipChance}%</div>` : ''}
                            </div>
                        `;
                    });
                    forecastHTML += '</div>';
                    content.innerHTML = forecastHTML;
                } else if (data.error) {
                    content.innerHTML = `<div style="opacity: 0.6; text-align: center;">‚ö†Ô∏è ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Error fetching forecast:', error);
                content.innerHTML = '<div style="opacity: 0.6; text-align: center;">Error loading forecast</div>';
            }
        }

        // Update news widget
        async function updateNewsWidget(content, widgetConfig) {
            try {
                const response = await fetch('/api/smart-mirror/news');
                const data = await response.json();
                
                if (data.success && data.items && data.items.length > 0) {
                    content.innerHTML = '';
                    const newsContainer = document.createElement('div');
                    newsContainer.className = 'news-items';
                    
                    data.items.slice(0, 5).forEach(item => {
                        const date = item.pubDate ? new Date(item.pubDate).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                        }) : '';
                        
                        const newsItem = document.createElement('div');
                        newsItem.className = 'news-item';
                        
                        const title = document.createElement('div');
                        title.className = 'news-title';
                        title.textContent = item.title || 'Untitled';
                        newsItem.appendChild(title);
                        
                        const source = document.createElement('div');
                        source.className = 'news-source';
                        source.textContent = item.source + (date ? ' ‚Ä¢ ' + date : '');
                        newsItem.appendChild(source);
                        
                        newsContainer.appendChild(newsItem);
                    });
                    
                    content.appendChild(newsContainer);
                } else if (data.error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.opacity = '0.6';
                    errorDiv.style.textAlign = 'center';
                    errorDiv.textContent = '‚ö†Ô∏è ' + data.error;
                    content.innerHTML = '';
                    content.appendChild(errorDiv);
                } else {
                    const msgDiv = document.createElement('div');
                    msgDiv.style.opacity = '0.6';
                    msgDiv.style.textAlign = 'center';
                    msgDiv.textContent = 'No news items available';
                    content.innerHTML = '';
                    content.appendChild(msgDiv);
                }
            } catch (error) {
                console.error('Error fetching news:', error);
                const errorDiv = document.createElement('div');
                errorDiv.style.opacity = '0.6';
                errorDiv.style.textAlign = 'center';
                errorDiv.textContent = 'Error loading news';
                content.innerHTML = '';
                content.appendChild(errorDiv);
            }
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('dashboardContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.innerHTML = '';
            container.appendChild(errorDiv);
        }

        // Initialize dashboard on page load
        let clockInterval = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            
            // Update clock every second
            clockInterval = setInterval(() => {
                if (config && config.widgets && config.widgets.clock && config.widgets.clock.enabled) {
                    const clockElement = document.getElementById('widget-clock');
                    if (clockElement) {
                        updateClockWidget(clockElement);
                    }
                }
            }, 1000);
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (clockInterval) {
                clearInterval(clockInterval);
            }
        });
    </script>
</body>
</html>
