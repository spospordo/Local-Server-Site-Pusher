<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Local Server Site Pusher</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .card-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .card-header h2 {
            color: #333;
            font-size: 1.3rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .status-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        
        .status-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 0.5rem;
        }
        
        .status-value {
            font-size: 1.2rem;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .config-editor {
            width: 100%;
            height: 400px;
            font-family: 'Courier New', monospace;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            resize: vertical;
        }
        
        .config-editor:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning-box {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        .warning-box strong {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .section-divider {
            border-top: 1px solid #eee;
            margin: 1.5rem 0;
        }
        
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem;
        }
        
        .log-timestamp {
            color: #6c757d;
            margin-right: 1rem;
        }
        
        .log-level {
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .log-level.INFO {
            color: #28a745;
        }
        
        .log-level.WARN {
            color: #ffc107;
        }
        
        .log-level.ERROR {
            color: #dc3545;
        }
        
        .links-list {
            list-style: none;
        }
        
        .link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }
        
        .link-item a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .link-item a:hover {
            text-decoration: underline;
        }
        
        .hidden {
            display: none;
        }
        
        .toggle-section {
            cursor: pointer;
            user-select: none;
        }
        
        .toggle-section:hover {
            color: #667eea;
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #ddd;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            border: none;
            background: none;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        /* Client Storage Usage Styles */
        .storage-client {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .storage-client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .storage-client-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }
        
        .storage-client-total {
            color: #666;
            font-size: 0.95rem;
        }
        
        .storage-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .storage-category {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            border-left: 4px solid;
        }
        
        .storage-category.image {
            border-left-color: #28a745;
        }
        
        .storage-category.video {
            border-left-color: #dc3545;
        }
        
        .storage-category.document {
            border-left-color: #007bff;
        }
        
        .storage-category.other {
            border-left-color: #6c757d;
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .category-name {
            font-weight: 600;
            text-transform: capitalize;
            color: #333;
        }
        
        .category-count {
            font-size: 0.85rem;
            color: #666;
        }
        
        .category-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .category-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .category-bar-fill.image {
            background: #28a745;
        }
        
        .category-bar-fill.video {
            background: #dc3545;
        }
        
        .category-bar-fill.document {
            background: #007bff;
        }
        
        .category-bar-fill.other {
            background: #6c757d;
        }
        
        .category-size {
            font-size: 0.9rem;
            color: #555;
            font-weight: 500;
        }
        
        .storage-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }
        
        .media-player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .media-player-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #ddd;
            transition: all 0.2s ease;
        }
        
        .media-player-card.active {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        
        .media-player-card.playing {
            border-left-color: #007bff;
            background: #f0f8ff;
        }
        
        .media-player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .media-player-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        
        .media-player-type {
            font-size: 0.8rem;
            color: #666;
            background: #e9ecef;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }
        
        .media-player-status {
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .media-player-status.playing {
            color: #007bff;
        }
        
        .media-player-status.paused {
            color: #ffc107;
        }
        
        .media-player-status.idle {
            color: #6c757d;
        }
        
        .media-info {
            margin-top: 0.5rem;
        }
        
        .media-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.2rem;
        }
        
        .media-artist {
            color: #666;
            font-size: 0.9rem;
        }
        
        .media-source {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.3rem;
        }
        
        .media-streaming-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .media-streaming-summary h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
        }
        
        .media-streaming-summary p {
            margin: 0;
            opacity: 0.9;
        }
        
        /* Storage Slider Styles */
        .storage-slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .storage-slider {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .storage-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .storage-slider::-webkit-slider-thumb:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }
        
        .storage-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .storage-input-container {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            min-width: 100px;
        }
        
        .storage-input {
            width: 70px;
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .storage-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .storage-unit {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }
        
        .storage-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .storage-display {
            font-weight: 600;
            color: #333;
        }
        
        .storage-available {
            color: #666;
        }
        
        .storage-validation-message {
            font-size: 0.85rem;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .storage-validation-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .storage-validation-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }
        
        /* Drink Mixer Styles */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            color: #007bff;
            background: rgba(0, 123, 255, 0.1);
        }
        
        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: rgba(0, 123, 255, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .ingredients-list, .recipes-list, .available-drinks-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .ingredient-item, .recipe-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ingredient-item.unavailable {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .ingredient-name {
            font-weight: 600;
            color: #333;
        }
        
        .ingredient-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .ingredient-status.available {
            background: #d4edda;
            color: #155724;
        }
        
        .ingredient-status.unavailable {
            background: #f8d7da;
            color: #721c24;
        }
        
        .ingredient-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .ingredient-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        
        .ingredient-field {
            flex: 2;
            position: relative;
        }
        
        .ingredient-name-dropdown,
        .ingredient-name-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .ingredient-amount {
            flex: 1;
            max-width: 120px;
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .ingredient-unit {
            flex: 1;
            max-width: 100px;
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .ingredient-row input {
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        
        .ingredient-row input:focus,
        .ingredient-row select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .recipe-item {
            flex-direction: column;
            align-items: stretch;
        }
        
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .recipe-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .recipe-ingredients {
            background: white;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .recipe-ingredient {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .recipe-ingredient:last-child {
            border-bottom: none;
        }
        
        .recipe-ingredient-name {
            font-weight: 500;
        }
        
        .recipe-ingredient-amount {
            color: #666;
        }
        
        .recipe-directions {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-left: 4px solid #667eea;
        }
        
        .recipe-directions p {
            margin: 0.5rem 0 0 0;
            color: #555;
            line-height: 1.4;
        }
        
        .available-drink-item {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .available-drink-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #155724;
            margin-bottom: 0.5rem;
        }
        
        .available-drink-ingredients {
            background: white;
            border-radius: 4px;
            padding: 0.75rem;
        }
        
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .no-items {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }
        
        /* Tournament Styles */
        .tournament-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
            transition: all 0.2s ease;
        }
        
        .tournament-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .tournament-card.setup {
            border-left-color: #ffc107;
        }
        
        .tournament-card.active {
            border-left-color: #28a745;
        }
        
        .tournament-card.completed {
            border-left-color: #6c757d;
        }
        
        .tournament-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .tournament-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }
        
        .tournament-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .tournament-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            min-width: fit-content;
        }
        
        .tournament-status.setup {
            background: #fff3cd;
            color: #856404;
        }
        
        .tournament-status.active {
            background: #d1eddb;
            color: #155724;
        }
        
        .tournament-status.completed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .tournament-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .tournament-stat {
            text-align: center;
        }
        
        .tournament-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        
        .tournament-stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
        }
        
        .tournament-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .participants-list {
            background: white;
            border-radius: 6px;
            padding: 1rem;
        }
        
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .participant-item:last-child {
            border-bottom: none;
        }
        
        .participant-name {
            font-weight: 500;
            color: #333;
        }
        
        .participant-stats {
            font-size: 0.8rem;
            color: #666;
        }
        
        .bracket-container {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
        }
        
        .bracket-rounds {
            display: flex;
            gap: 3rem;
            min-width: fit-content;
        }
        
        .bracket-round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            min-height: 300px;
        }
        
        .bracket-round-title {
            text-align: center;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }
        
        .bracket-match {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 0.5rem 0;
            min-width: 200px;
            position: relative;
        }
        
        .bracket-match.completed {
            border-color: #28a745;
            background: #d1eddb;
        }
        
        .bracket-participant {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .bracket-participant:last-child {
            border-bottom: none;
        }
        
        .bracket-participant.winner {
            background: #28a745;
            color: white;
            font-weight: 600;
        }
        
        .bracket-participant.loser {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .bracket-participant.bye {
            background: #ffc107;
            color: #856404;
            font-style: italic;
        }
        
        .match-score {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .match-actions {
            padding: 0.5rem 1rem;
            background: white;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .winner-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border: 1px solid #28a745;
            background: white;
            color: #28a745;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .winner-btn:hover {
            background: #28a745;
            color: white;
        }
        
        .tournament-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 3rem;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .main-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }

        .main-tab {
            flex: 1;
            padding: 1rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-right: 1px solid #eee;
        }

        .main-tab:last-child {
            border-right: none;
        }

        .main-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .main-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .sub-tabs {
            display: none;
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .sub-tabs.active {
            display: flex;
            gap: 1rem;
        }

        .sub-tab {
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s ease;
        }

        .sub-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .sub-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Section visibility management */
        .admin-section {
            display: block;
        }

        .admin-section.hidden {
            display: none;
        }

        /* Collapsible sections */
        .collapsible-section {
            margin: 20px 0;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 12px 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .collapsible-header:hover {
            background: #e9ecef;
        }

        .collapsible-header.collapsed {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            margin-bottom: 0;
        }

        .collapsible-header.expanded {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
            margin-bottom: 0;
        }

        .collapsible-title {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-icon {
            transition: transform 0.2s ease;
            font-size: 12px;
            color: #666;
        }

        .collapsible-header.expanded .collapsible-icon {
            transform: rotate(90deg);
        }

        .collapsible-content {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: white;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0 15px;
            opacity: 0;
        }

        .collapsible-content.expanded {
            padding: 15px;
            opacity: 1;
        }

        .error-indicator {
            color: #dc3545;
            font-weight: bold;
            margin-left: 8px;
            font-size: 14px;
        }

        .unsaved-warning {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px 16px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        .unsaved-warning.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .save-button-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
    </style>
</head>
<body>
    <div class="header">
        <h1>Local Server Site Pusher - Admin Dashboard</h1>
        <form method="POST" action="/admin/logout" style="display: inline;">
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </div>
    
    <!-- Unsaved Changes Warning -->
    <div id="unsaved-warning" class="unsaved-warning">
        ⚠️ You have unsaved changes. Please save your work.
    </div>
    
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <div class="main-tabs">
                <button class="main-tab active" onclick="showMainTab('dashboard')">Dashboard</button>
                <button class="main-tab" onclick="showMainTab('clients')">Clients</button>
                <button class="main-tab" onclick="showMainTab('party')">Party</button>
                <button class="main-tab" onclick="showMainTab('server')">Server</button>
                <button class="main-tab" onclick="showMainTab('settings')">Settings</button>
            </div>
            
            <!-- Sub-tabs for Party -->
            <div class="sub-tabs" id="party-subtabs">
                <button class="sub-tab active" onclick="showSubTab('party-links')">Useful Links</button>
                <button class="sub-tab" onclick="showSubTab('party-drinks')">Drinks</button>
                <button class="sub-tab" onclick="showSubTab('party-tournament')">Tournament</button>
            </div>
            
            <!-- Sub-tabs for Server -->
            <div class="sub-tabs" id="server-subtabs">
                <button class="sub-tab active" onclick="showSubTab('server-vidiots')">Vidiots</button>
                <button class="sub-tab" onclick="showSubTab('server-espresso')">Espresso</button>
                <button class="sub-tab" onclick="showSubTab('server-github')">GitHub</button>
            </div>
        </div>
        <!-- Server Status -->
        <div class="card admin-section dashboard-section">
            <div class="card-header">
                <h2>Server Status</h2>
            </div>
            <div class="card-body">
                <div class="status-grid" id="statusGrid">
                    <div class="status-item">
                        <div class="status-label">Loading...</div>
                        <div class="status-value">Please wait</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Management -->
        <div class="card admin-section settings-section">
            <div class="card-header">
                <h2>Configuration Management</h2>
            </div>
            <div class="card-body">
                <!-- Basic Settings Form -->
                <div id="basicConfig">
                    <h3>Basic Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serverPort">Server Port</label>
                            <input type="number" id="serverPort" value="3000">
                        </div>
                        <div class="form-group">
                            <label for="adminUsername">Admin Username</label>
                            <input type="text" id="adminUsername" value="admin">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">Admin Password</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="password" id="adminPassword" value="admin123" readonly style="background-color: #f5f5f5; cursor: not-allowed; flex: 1;">
                            <button type="button" id="changePasswordBtn" class="btn btn-secondary" onclick="openPasswordChangeModal()" style="white-space: nowrap;">Change Password</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 4px;">Password is protected. Click "Change Password" to modify.</small>
                    </div>
                    
                    <h3>Integrations</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="homeAssistantEnabled">Home Assistant</label>
                            <select id="homeAssistantEnabled">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="homeAssistantUrl">Home Assistant URL</label>
                            <input type="url" id="homeAssistantUrl" value="http://localhost:8123">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cockpitEnabled">Cockpit</label>
                            <select id="cockpitEnabled">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cockpitUrl">Cockpit URL</label>
                            <input type="url" id="cockpitUrl" value="http://localhost:9090">
                        </div>
                    </div>
                    
                    <button id="saveBasicConfig" class="btn">Save Basic Configuration</button>
                </div>

                <div class="section-divider"></div>

                <!-- Advanced Configuration Editor -->
                <div class="toggle-section" onclick="toggleAdvancedConfig()">
                    <h3>⚠️ Advanced Users - Configuration Editor (Click to expand)</h3>
                </div>
                <div id="advancedConfig" class="hidden">
                    <div class="warning-box">
                        <strong>⚠️ Warning - Advanced Configuration</strong>
                        This section allows direct editing of the configuration file. Incorrect modifications may break the server. 
                        Only modify these settings if you understand the configuration structure.
                    </div>
                    <textarea id="configEditor" class="config-editor" placeholder="Loading configuration..."></textarea>
                    <div>
                        <button id="saveConfig" class="btn">Save Advanced Configuration</button>
                        <button id="resetConfig" class="btn btn-secondary">Reset</button>
                    </div>
                </div>
                <div id="configAlert" class="alert"></div>
            </div>
        </div>

        <!-- Storage Management -->
        <div class="card admin-section settings-section">
            <div class="card-header">
                <h2>Storage Management</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="maxTotalSize">Maximum Total Storage</label>
                    <div class="storage-slider-container">
                        <input type="range" id="maxTotalStorageSlider" class="storage-slider" min="1" max="1000" value="1000">
                        <div class="storage-input-container">
                            <input type="number" id="maxTotalStorageInput" class="storage-input" min="1" placeholder="1000"> 
                            <span class="storage-unit">MB</span>
                        </div>
                    </div>
                    <div class="storage-info">
                        <span id="maxTotalStorageDisplay" class="storage-display">1000 MB</span>
                        <span id="availableStorageInfo" class="storage-available">Loading...</span>
                    </div>
                    <div id="storageValidationMessage" class="storage-validation-message"></div>
                </div>
                
                <h3>File Type Limits</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="maxImageSize">Images (jpg, png, gif, etc.)</label>
                        <input type="text" id="maxImageSize" placeholder="e.g., 50MB">
                    </div>
                    <div class="form-group">
                        <label for="maxVideoSize">Videos (mp4, avi, etc.)</label>
                        <input type="text" id="maxVideoSize" placeholder="e.g., 500MB">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="maxDocumentSize">Documents (pdf, doc, etc.)</label>
                        <input type="text" id="maxDocumentSize" placeholder="e.g., 100MB">
                    </div>
                    <div class="form-group">
                        <label for="maxOtherSize">Other Files</label>
                        <input type="text" id="maxOtherSize" placeholder="e.g., 10MB">
                    </div>
                </div>
                
                <button id="saveStorageConfig" class="btn">Save Storage Settings</button>
                <div id="storageAlert" class="alert"></div>
            </div>
        </div>

        <!-- Useful Links Management -->
        <div class="card admin-section party-section party-links-section">
            <div class="card-header">
                <h2>Useful Links</h2>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="linkName">Link Name (Optional)</label>
                        <input type="text" id="linkName" placeholder="e.g., Documentation (optional)">
                    </div>
                    <div class="form-group">
                        <label for="linkUrl">URL</label>
                        <input type="url" id="linkUrl" placeholder="https://example.com">
                    </div>
                </div>
                <button id="addLink" class="btn btn-success">Add Link</button>
                
                <div class="section-divider"></div>
                
                <h3>Saved Links</h3>
                <ul id="linksList" class="links-list">
                    <!-- Links will be loaded here -->
                </ul>
                
                <div id="linksAlert" class="alert"></div>
            </div>
        </div>

        <!-- Drink Mixer Management -->
        <div class="card admin-section party-section party-drinks-section">
            <div class="card-header">
                <h2>Drink Mixer Management</h2>
            </div>
            <div class="card-body">
                <div class="tabs">
                    <button class="tab-button active" onclick="showTab('alcohols')">Alcohols</button>
                    <button class="tab-button" onclick="showTab('mixers')">Mixers</button>
                    <button class="tab-button" onclick="showTab('recipes')">Recipes</button>
                    <button class="tab-button" onclick="showTab('available')">Available Drinks</button>
                </div>

                <!-- Alcohols Tab -->
                <div id="alcohols-tab" class="tab-content active">
                    <h3>Manage Alcohols</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="alcoholName">Alcohol Name</label>
                            <input type="text" id="alcoholName" placeholder="e.g., Tequila, Vodka">
                        </div>
                        <div class="form-group">
                            <label for="alcoholAvailable">Available</label>
                            <select id="alcoholAvailable">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addAlcohol()" class="btn btn-success">Add Alcohol</button>
                    
                    <div class="section-divider"></div>
                    
                    <h3>Alcohol List</h3>
                    <div id="alcoholsList" class="ingredients-list">
                        <!-- Alcohols will be loaded here -->
                    </div>
                    <div id="alcoholsAlert" class="alert"></div>
                </div>

                <!-- Mixers Tab -->
                <div id="mixers-tab" class="tab-content">
                    <h3>Manage Mixers</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mixerName">Mixer Name</label>
                            <input type="text" id="mixerName" placeholder="e.g., Lemon Juice, Sugar">
                        </div>
                        <div class="form-group">
                            <label for="mixerAvailable">Available</label>
                            <select id="mixerAvailable">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addMixer()" class="btn btn-success">Add Mixer</button>
                    
                    <div class="section-divider"></div>
                    
                    <h3>Mixer List</h3>
                    <div id="mixersList" class="ingredients-list">
                        <!-- Mixers will be loaded here -->
                    </div>
                    <div id="mixersAlert" class="alert"></div>
                </div>

                <!-- Recipes Tab -->
                <div id="recipes-tab" class="tab-content">
                    <h3>Manage Recipes</h3>
                    <div class="form-group">
                        <label for="recipeName">Recipe Name</label>
                        <input type="text" id="recipeName" placeholder="e.g., Margarita">
                    </div>
                    
                    <h4>Ingredients</h4>
                    <div id="recipeIngredients">
                        <div class="ingredient-row">
                            <div class="ingredient-field">
                                <select class="ingredient-name-dropdown" onchange="handleIngredientChange(this)">
                                    <option value="">Select ingredient...</option>
                                    <option value="__ADD_NEW__">+ Add New Ingredient</option>
                                </select>
                                <input type="text" class="ingredient-name-input" placeholder="Enter new ingredient name" style="display: none;">
                            </div>
                            <input type="number" class="ingredient-amount" placeholder="Amount" step="0.1" min="0.1">
                            <select class="ingredient-unit">
                                <option value="oz">Ounces</option>
                                <option value="dash">Dashes</option>
                                <option value="unit">Units</option>
                            </select>
                            <button type="button" onclick="removeIngredientRow(this)" class="btn btn-danger btn-small">Remove</button>
                        </div>
                    </div>
                    <button type="button" onclick="addIngredientRow()" class="btn btn-secondary">Add Ingredient</button>
                    
                    <h4>Directions</h4>
                    <div class="form-group">
                        <textarea id="recipeDirections" placeholder="Enter step-by-step instructions for making this drink..." rows="4" style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 0.9rem; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <button onclick="addRecipe()" class="btn btn-success">Save Recipe</button>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <h3>Recipe List</h3>
                    <div id="recipesList" class="recipes-list">
                        <!-- Recipes will be loaded here -->
                    </div>
                    <div id="recipesAlert" class="alert"></div>
                </div>

                <!-- Available Drinks Tab -->
                <div id="available-tab" class="tab-content">
                    <h3>Available Drinks</h3>
                    <p>These are the drinks that can be made based on currently available ingredients:</p>
                    <div id="availableDrinksList" class="available-drinks-list">
                        <!-- Available drinks will be loaded here -->
                    </div>
                    <button onclick="loadAvailableDrinks()" class="btn">Refresh Available Drinks</button>
                </div>
            </div>
        </div>

        <!-- Client Access Management -->
        <div class="card admin-section clients-section">
            <div class="card-header">
                <h2>Client Access Management</h2>
            </div>
            <div class="card-body">
                <h3>Client Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientEnabled">Client Access</label>
                        <select id="clientEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clientRequirePassword">Password Protection Status</label>
                        <div id="passwordStatus" style="margin-top: 0.5rem;">
                            <span id="passwordStatusText">Checking...</span>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                                <em>Note: Clients manage their own passwords. Admins cannot view or modify client passwords.</em>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="welcomeMessage">Welcome Message</label>
                    <input type="text" id="welcomeMessage" placeholder="Welcome to Local Server Site Pusher">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="showServerStatus">Show Server Status</label>
                        <select id="showServerStatus">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="showUsefulLinks">Show Useful Links</label>
                        <select id="showUsefulLinks">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                
                <button id="saveClientConfig" class="btn btn-primary">Save Client Settings</button>
                
                <div class="section-divider"></div>
                
                <h3>Client Management</h3>
                <p>Manage all clients that have connected to this server. Delete a client to remove their account and all associated data.</p>
                <div id="devicesContainer">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading clients...
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <p><strong>Client Access URL:</strong></p>
                <p><a href="/client" target="_blank"><code>http://your-server:3000/client</code></a></p>
                
                <div id="clientAlert" class="alert"></div>
            </div>
        </div>

        <!-- Client Storage Usage -->
        <div class="card admin-section clients-section">
            <div class="card-header">
                <h2>Client Storage Usage</h2>
            </div>
            <div class="card-body">
                <p>Storage usage by each client, organized by file category:</p>
                <div id="clientStorageContainer">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading storage statistics...
                    </div>
                </div>
                <div id="clientStorageAlert" class="alert"></div>
            </div>
        </div>

        <!-- Client Files Management -->
        <div class="card admin-section clients-section">
            <div class="card-header">
                <h2>Client Files</h2>
            </div>
            <div class="card-body">
                <p>Files uploaded by clients with their sharing permissions:</p>
                <div id="clientFilesContainer">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading client files...
                    </div>
                </div>
                <div id="clientFilesAlert" class="alert"></div>
            </div>
        </div>

        <!-- Vidiots Configuration -->
        <div class="card admin-section server-section server-vidiots-section">
            <div class="card-header">
                <h2>Vidiots Movie Scraper</h2>
            </div>
            <div class="card-body">
                <p>Configure the Vidiots Foundation website scraper for e-ink displays:</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsEnabled">Vidiots Scraper</label>
                        <select id="vidiotsEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vidiotsCronSchedule">Schedule (Cron)</label>
                        <input type="text" id="vidiotsCronSchedule" placeholder="0 6,12 * * *" title="Cron expression (default: 6 AM and 12 PM daily)">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsOutputFile">Output HTML File</label>
                        <input type="text" id="vidiotsOutputFile" placeholder="./public/vidiots/index.html">
                    </div>
                    <div class="form-group">
                        <label for="vidiotsPosterDirectory">Poster Directory</label>
                        <input type="text" id="vidiotsPosterDirectory" placeholder="./public/vidiots/posters">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsPosterBaseUrl">Poster Base URL</label>
                        <input type="text" id="vidiotsPosterBaseUrl" placeholder="/vidiots/posters/">
                    </div>
                    <div class="form-group">
                        <label for="vidiotsMaxAgeHours">Max File Age (Hours)</label>
                        <input type="number" id="vidiotsMaxAgeHours" placeholder="24" min="1" max="168">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsForceUpdate">Force Update</label>
                        <select id="vidiotsForceUpdate">
                            <option value="false">Disabled</option>
                            <option value="true">Always Update</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vidiotsGithubEnabled">GitHub Pages Upload</label>
                        <select id="vidiotsGithubEnabled">
                            <option value="false">Disabled</option>
                            <option value="true">Enabled</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn" onclick="saveVidiotsConfig()">Save Configuration</button>
                    <button class="btn btn-secondary" onclick="testVidiotsScrape()">Test Scrape</button>
                    <button class="btn btn-secondary" onclick="loadVidiotsStatus()">Refresh Status</button>
                </div>
                
                <div id="vidiotsAlert" class="alert"></div>
                
                <!-- Status Display -->
                <div class="card" style="margin-top: 20px; background: #f8f9fa;">
                    <div class="card-header">
                        <h3>Scraper Status</h3>
                    </div>
                    <div class="card-body">
                        <div id="vidiotsStatus" style="font-family: monospace; font-size: 0.9em; white-space: pre-wrap; color: #666;">
                            Loading status...
                        </div>
                    </div>
                </div>
                
                <!-- Preview Link -->
                <div style="margin-top: 15px;">
                    <a href="/vidiots" target="_blank" class="btn btn-secondary">Preview Generated Content</a>
                </div>
            </div>
        </div>

        <!-- Espresso HTML Generator -->
        <div class="card admin-section server-section server-espresso-section">
            <div class="card-header">
                <h2>Espresso HTML Generator</h2>
            </div>
            <div class="card-body">
                <p>Configure the espresso data management and HTML generation system:</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="espressoEnabled">Espresso Module</label>
                        <select id="espressoEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="espressoDataFilePath">Data File Path</label>
                        <input type="text" id="espressoDataFilePath" placeholder="./config/espresso-data.json">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="espressoTemplatePath">HTML Template Path</label>
                        <input type="text" id="espressoTemplatePath" placeholder="/path/to/template.html" readonly>
                        <small id="espressoTemplatePathStatus" style="color: #666;"></small>
                    </div>
                    <div class="form-group">
                        <label for="espressoOutputPath">Output HTML Path</label>
                        <input type="text" id="espressoOutputPath" placeholder="./public/espresso/index.html">
                    </div>
                </div>
                
                <!-- Image Mapping Configuration -->
                <div id="espresso-image-mapping" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>Configure Image Mapping</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <p><small>Map template image identifiers to uploaded images or absolute URLs</small></p>
                        <div id="espressoImageMapping" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                            <div style="text-align: center; color: #666; margin: 20px 0;">
                                <i>Loading image configuration...</i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Local Repository File Location -->
                <div id="espresso-local-repo" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>📂 Local Repository Output Settings</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                            Configure where the generated espresso HTML and images should be saved within the local repository managed by the GitHub tab.
                            The GitHub tab handles all upload operations - this section only controls local file placement.
                        </p>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="espressoLocalOutputPath">HTML Output Path within Repository</label>
                                <input type="text" id="espressoLocalOutputPath" placeholder="espresso/index.html" title="Path within the local repository where the HTML file will be saved">
                                <small>Relative path within repository. Example: <code>espresso/index.html</code> or <code>coffee/espresso.html</code></small>
                            </div>
                            <div class="form-group">
                                <label for="espressoLocalImagePath">Images Path within Repository</label>
                                <input type="text" id="espressoLocalImagePath" placeholder="espresso/images" title="Directory within the local repository where images will be saved">
                                <small>Relative path within repository. Example: <code>espresso/images</code> or <code>assets/coffee-images</code></small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="espressoSaveToRepo">Save to Local Repository</label>
                                <select id="espressoSaveToRepo">
                                    <option value="false">Save to public directory (default)</option>
                                    <option value="true">Save to local repository (managed by GitHub tab)</option>
                                </select>
                                <small>When enabled, files are saved to the local repository configured in the GitHub tab instead of the public directory</small>
                            </div>
                        </div>
                        
                        <div id="espressoRepoStatus" style="margin-top: 15px; padding: 10px; background: white; border-radius: 3px; border: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d;">
                            <strong>Repository Status:</strong> <span id="espressoRepoStatusText">Checking GitHub tab configuration...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Template Source Selection -->
                <div id="espresso-template-source" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>📁 Template Source</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <p><small>Choose how to provide HTML template and image files. Only one method can be active at a time.</small></p>
                        
                        <!-- Template Source Method Selection -->
                        <div class="form-group">
                            <label>Template Source Method</label>
                            <div style="margin-top: 5px;">
                                <input type="radio" id="templateSourceUpload" name="templateSource" value="upload" onchange="toggleTemplateSourceMethod()">
                                <label for="templateSourceUpload" style="margin-left: 5px; font-weight: normal;">📤 File Upload</label>
                            </div>
                            <div style="margin-top: 5px;">
                                <input type="radio" id="templateSourceGit" name="templateSource" value="git" onchange="toggleTemplateSourceMethod()">
                                <label for="templateSourceGit" style="margin-left: 5px; font-weight: normal;">📋 Git Repository</label>
                            </div>
                        </div>

                        <!-- File Upload Section -->
                        <div id="templateUploadSection" style="display: none; margin-top: 15px; padding: 10px; border-left: 3px solid #007bff; background: rgba(0,123,255,0.1);">
                            <h5>📤 Upload Template Files</h5>
                            <p><small>Upload HTML template and image files directly to the server.</small></p>
                            
                            <div class="form-group">
                                <label for="espressoTemplateFile">Upload Template/Images</label>
                                <input type="file" id="espressoTemplateFile" accept=".html,.htm,.png,.jpg,.jpeg,.gif,.svg" multiple>
                                <small>Supported: HTML templates (.html, .htm) and images (.png, .jpg, .jpeg, .gif, .svg)</small>
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <button onclick="uploadEspressoTemplate()" class="btn btn-primary">Upload Files</button>
                                <button onclick="loadEspressoTemplateFiles()" class="btn btn-secondary">Refresh File List</button>
                            </div>
                        </div>

                        <!-- Git Repository Section -->
                        <div id="templateGitSection" style="display: none; margin-top: 15px; padding: 10px; border-left: 3px solid #28a745; background: rgba(40,167,69,0.1);">
                            <h5>📋 Git Repository Template Source</h5>
                            <p><small>Download/clone template files from a public git repository. No authentication required - works with any publicly accessible repository. All HTML and image files will be copied automatically.</small></p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="espressoGitRepoUrl">Template Repository URL <span style="color: red;">*</span></label>
                                    <input type="url" id="espressoGitRepoUrl" placeholder="https://github.com/username/template-repo.git">
                                    <small>Public git repository URL containing template files (no authentication needed)</small>
                                </div>
                                <div class="form-group">
                                    <label for="espressoGitBranch">Branch</label>
                                    <input type="text" id="espressoGitBranch" placeholder="main" value="main">
                                    <small>Git branch to download from (default: main)</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="espressoGitLocalPath">Temporary Download Path <span style="color: red;">*</span></label>
                                <input type="text" id="espressoGitLocalPath" placeholder="/tmp/espresso-template-repo">
                                <small>Temporary local directory where template files will be downloaded. Use writable paths like <code>/tmp/</code>. Files will be copied to the uploads directory automatically.</small>
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <button onclick="cloneEspressoTemplateRepo()" class="btn btn-success" id="cloneTemplateBtn">Download Template Repository</button>
                                <button onclick="loadEspressoTemplateFiles()" class="btn btn-secondary">Refresh File List</button>
                            </div>
                        </div>
                        
                        <!-- Common Template Files Display -->
                        <div id="espressoTemplateFiles" style="margin-top: 15px;"></div>
                        <div id="espressoTemplateAlert" class="alert" style="margin-top: 10px;"></div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="margin-top: 20px;">
                    <button onclick="saveEspressoConfig()" class="btn btn-primary">Save Configuration</button>
                    <button onclick="testEspressoGeneration()" class="btn btn-secondary">Test HTML Generation</button>
                    <button onclick="uploadEspressoToGitHub()" class="btn btn-secondary" id="uploadEspressoBtn" style="display: none;">Upload to GitHub</button>
                    <button onclick="refreshEspressoRepoStatus()" class="btn btn-secondary" id="refreshRepoStatusBtn">Refresh Repository Status</button>
                </div>
                
                <!-- Status and Preview -->
                <div style="margin-top: 15px;">
                    <div id="espressoStatus" class="status-info"></div>
                    <a href="/espresso" target="_blank" class="btn btn-secondary">Preview Generated Content</a>
                </div>
                
                <div id="espressoAlert" class="alert"></div>
            </div>
        </div>

        <!-- Espresso Data Editor -->
        <div class="card admin-section server-section server-espresso-section">
            <div class="card-header">
                <h2>📊 Espresso Data Editor</h2>
            </div>
            <div class="card-body">
                <p>Edit the espresso brewing data for each coffee preparation:</p>
                
                <div id="espressoDataContainer">
                    <!-- Data will be loaded here -->
                    <div style="text-align: center; color: #666; margin: 20px 0;">
                        <i>Loading espresso data...</i>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                    <button onclick="loadEspressoData()" class="btn btn-secondary">Reload Data</button>
                    <button onclick="saveEspressoData()" class="btn btn-primary">Save Changes</button>
                    <button onclick="resetEspressoData()" class="btn btn-danger">Reset to Defaults</button>
                </div>
                
                <div id="espressoDataAlert" class="alert"></div>
            </div>
        </div>

        <!-- GitHub Configuration -->
        <div class="card admin-section server-section server-github-section">
            <div class="card-header">
                <h2>GitHub Pages Configuration</h2>
            </div>
            <div class="card-body">
                <p>Configure GitHub Pages integration for automated website deployment:</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsGithubEnabled">GitHub Pages Upload</label>
                        <select id="vidiotsGithubEnabled">
                            <option value="false">Disabled</option>
                            <option value="true">Enabled</option>
                        </select>
                    </div>
                </div>
                
                <!-- GitHub Pages Configuration -->
                <div id="github-repository-settings" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>Repository Settings</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vidiotsRepoOwner">Repository Owner</label>
                                <input type="text" id="vidiotsRepoOwner" placeholder="github-username">
                            </div>
                            <div class="form-group">
                                <label for="vidiotsRepoName">Repository Name</label>
                                <input type="text" id="vidiotsRepoName" placeholder="username.github.io">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vidiotsRepoBranch">Branch</label>
                                <input type="text" id="vidiotsRepoBranch" placeholder="main">
                            </div>
                            <div class="form-group">
                                <label for="vidiotsRepoLocalPath">Local Repository Path</label>
                                <input type="text" id="vidiotsRepoLocalPath" placeholder="/path/to/local/repo">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vidiotsCommitMessage">Commit Message</label>
                                <input type="text" id="vidiotsCommitMessage" placeholder="Automated vidiots update">
                            </div>
                            <div class="form-group">
                                <label for="vidiotsAccessToken">GitHub Personal Access Token <span style="color: red;">*</span></label>
                                <input type="password" id="vidiotsAccessToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                <small style="color: #666;">Required for authentication. Create at: Settings → Developer settings → Personal access tokens</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Git Identity Configuration -->
                <div id="github-git-identity" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>Git Identity Configuration</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                            Configure the git author identity for commits. This is required for GitHub upload operations and will persist across container restarts.
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="gitUserName">Git User Name <span style="color: red;">*</span></label>
                                <input type="text" id="gitUserName" placeholder="Your Name" required>
                                <small style="color: #666;">This will be used as the author name for git commits</small>
                            </div>
                            <div class="form-group">
                                <label for="gitUserEmail">Git User Email <span style="color: red;">*</span></label>
                                <input type="email" id="gitUserEmail" placeholder="your.email@example.com" required>
                                <small style="color: #666;">This will be used as the author email for git commits</small>
                            </div>
                        </div>
                        <div class="save-button-container">
                            <button class="btn btn-primary" onclick="saveGitIdentity()">Save Git Identity</button>
                            <button class="btn btn-secondary" onclick="loadGitIdentity()">Refresh</button>
                        </div>
                        <div id="gitIdentityAlert" class="alert" style="margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn" onclick="saveVidiotsConfig()">Save Configuration</button>
                    <button class="btn btn-secondary" onclick="testGitHubConnection()" id="testGitHubBtn">Test GitHub</button>
                    <button class="btn btn-secondary" onclick="cloneGitHubRepo()" id="cloneGitHubBtn">Clone/Pull Repository</button>
                    <button class="btn btn-secondary" onclick="browseGitHubRepo()" id="browseGitHubBtn">Browse Repository</button>
                    <button class="btn btn-secondary" onclick="uploadToGitHub()" id="uploadGitHubBtn">Upload to GitHub</button>
                </div>
                
                <!-- GitHub Operation Status & Logging -->
                <div id="githubStatusSection" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #28a745;">
                    <h4 style="margin-bottom: 10px; color: #28a745;">GitHub Operation Status</h4>
                    <div id="githubOperationStatus" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 3px; border: 1px solid #dee2e6; font-family: monospace; font-size: 0.9em; color: #6c757d;">
                        Ready for GitHub operations...
                    </div>
                    
                    <h5 style="margin-bottom: 10px;">Recent Operations Log</h5>
                    <div id="githubOperationLog" style="max-height: 200px; overflow-y: auto; background: white; border: 1px solid #dee2e6; border-radius: 3px; padding: 10px; font-family: monospace; font-size: 0.85em;">
                        <div class="log-entry" style="color: #6c757d; margin-bottom: 5px;">
                            <span class="timestamp">[${new Date().toLocaleTimeString()}]</span> 
                            <span class="level">INFO</span> 
                            <span class="message">GitHub interface initialized</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="clearGitHubLogs()" style="font-size: 0.8em;">Clear Logs</button>
                        <button class="btn btn-sm btn-secondary" onclick="refreshGitHubStatus()" style="font-size: 0.8em;">Refresh Status</button>
                    </div>
                </div>
                
                <div id="vidiotsAlert" class="alert"></div>
            </div>
        </div>

        <!-- GitHub.io Repository Browser -->
        <div class="card admin-section server-section server-github-section" id="githubRepositoryBrowser" style="display: none;">
            <div class="card-header">
                <h2>GitHub.io Repository Browser</h2>
            </div>
            <div class="card-body">
                <p>Browse and download files from your GitHub.io repository:</p>
                
                <div id="repositoryBrowserAlert" class="alert"></div>
                
                <!-- Breadcrumb Navigation -->
                <div id="breadcrumbNav" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <span style="font-weight: bold;">📁 Path: </span>
                    <span id="currentPath">/</span>
                </div>
                
                <!-- File Browser -->
                <div id="fileBrowser" style="border: 1px solid #ddd; border-radius: 5px; max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Click "Browse Repository" to explore your GitHub.io files
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="refreshRepositoryBrowser()">Refresh</button>
                    <button class="btn btn-secondary" onclick="goToParentDirectory()">📁 Up One Level</button>
                </div>
            </div>
        </div>


        <!-- Home Assistant Media Streaming -->
        <div class="card admin-section settings-section">
            <div class="card-header">
                <h2>Home Assistant Media Streaming</h2>
            </div>
            <div class="card-body">
                <p>Monitor and display media currently streaming on your Home Assistant devices:</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="haEnabled">Home Assistant Integration</label>
                        <select id="haEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mediaPlayersEnabled">Media Players</label>
                        <select id="mediaPlayersEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="haUrl">Home Assistant URL</label>
                    <input type="url" id="haUrl" placeholder="http://localhost:8123">
                </div>
                
                <div class="form-group">
                    <label for="haToken">Home Assistant Long-Lived Access Token</label>
                    <input type="password" id="haToken" placeholder="Enter your Home Assistant token">
                    <small style="color: #666; display: block; margin-top: 4px;">
                        Create a long-lived access token in Home Assistant: Profile → Security → Create Token
                    </small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="refreshInterval">Refresh Interval (ms)</label>
                        <input type="number" id="refreshInterval" min="1000" max="60000" step="1000" value="5000">
                    </div>
                    <div class="form-group">
                        <button id="testHAConnection" class="btn btn-secondary" onclick="testHomeAssistantConnection()">Test Connection</button>
                    </div>
                </div>
                
                <button onclick="saveMediaStreamingConfig()" class="btn btn-primary">Save Media Streaming Settings</button>
                
                <div class="section-divider"></div>
                
                <h3>Current Media Status</h3>
                <div id="mediaStreamingStatus">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading media streaming status...
                    </div>
                </div>
                
                <div id="mediaStreamingAlert" class="alert"></div>
            </div>
        </div>

        <!-- Tournament Management -->
        <div class="card admin-section party-section party-tournament-section">
            <div class="card-header">
                <h2>Tournament Bracket Tracker</h2>
            </div>
            <div class="card-body">
                <p>Manage tournaments and track brackets for competitive events.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <button id="createTournamentBtn" class="btn btn-primary">Create New Tournament</button>
                        <button id="refreshTournaments" class="btn btn-secondary">Refresh</button>
                    </div>
                </div>
                
                <div id="tournamentsContainer">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading tournaments...
                    </div>
                </div>
                
                <div id="tournamentAlert" class="alert"></div>
            </div>
        </div>

        <!-- System Logs -->
        <div class="card admin-section dashboard-section">
            <div class="card-header">
                <h2>System Logs</h2>
            </div>
            <div class="card-body">
                <button id="refreshLogs" class="btn btn-secondary">Refresh Logs</button>
                <div id="logsContainer" class="logs-container">
                    <!-- Logs will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card admin-section dashboard-section">
            <div class="card-header">
                <h2>Quick Actions</h2>
            </div>
            <div class="card-body">
                <p><strong>API Endpoints:</strong></p>
                <ul>
                    <li><code>GET /api/status</code> - Server status for external tools</li>
                    <li><code>POST /api/webhook</code> - Receive webhooks from external services</li>
                    <li><code>GET /api/data</code> - Data endpoint for integrations</li>
                </ul>
                
                <div class="section-divider"></div>
                
                <p><strong>Public Content:</strong></p>
                <p>Upload files to the <code>public</code> directory to serve web content.</p>
                <p><a href="/public/" target="_blank">View Public Directory</a></p>
                
                <div class="section-divider"></div>
                
                <p><strong>Integration URLs:</strong></p>
                <ul>
                    <li><strong>Home Assistant:</strong> Use <code>http://your-server:3000/api/status</code> as a RESTful sensor</li>
                    <li><strong>Cockpit:</strong> Monitor via <code>http://your-server:3000/api/status</code></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Tournament Creation Modal -->
    <div id="tournamentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Tournament</h3>
                <span class="close" onclick="closeTournamentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="tournamentModalAlert" class="alert"></div>
                <form id="tournamentForm">
                    <div class="form-group">
                        <label for="tournamentName">Tournament Name</label>
                        <input type="text" id="tournamentName" required placeholder="Spring Championship 2024">
                    </div>
                    <div class="form-group">
                        <label for="tournamentDescription">Description (Optional)</label>
                        <textarea id="tournamentDescription" rows="3" placeholder="Tournament description..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tournamentType">Tournament Type</label>
                            <select id="tournamentType">
                                <option value="single-elimination">Single Elimination</option>
                                <option value="double-elimination" disabled>Double Elimination (Coming Soon)</option>
                                <option value="round-robin" disabled>Round Robin (Coming Soon)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxParticipants">Max Participants</label>
                            <select id="maxParticipants">
                                <option value="4">4</option>
                                <option value="8" selected>8</option>
                                <option value="16">16</option>
                                <option value="32">32</option>
                                <option value="64">64</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeTournamentModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn">Create Tournament</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tournament Details Modal -->
    <div id="tournamentDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="tournamentDetailsTitle">Tournament Details</h3>
                <span class="close" onclick="closeTournamentDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="tournamentDetailsAlert" class="alert"></div>
                
                <!-- Tournament Info -->
                <div id="tournamentInfo" class="tournament-info">
                    <!-- Tournament info will be loaded here -->
                </div>
                
                <!-- Participants Section -->
                <div id="participantsSection" style="margin-top: 2rem;">
                    <h4>Participants</h4>
                    <div id="addParticipantForm" class="form-row" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <input type="text" id="participantName" placeholder="Participant name">
                        </div>
                        <div class="form-group">
                            <input type="text" id="teamMembers" placeholder="Team members (comma separated, optional)">
                        </div>
                        <div class="form-group">
                            <button type="button" id="addParticipantBtn" class="btn">Add Participant</button>
                        </div>
                    </div>
                    <div id="participantsList">
                        <!-- Participants will be loaded here -->
                    </div>
                </div>
                
                <!-- Bracket Section -->
                <div id="bracketSection" style="margin-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>Tournament Bracket</h4>
                        <div id="tournamentActions">
                            <!-- Actions will be loaded here -->
                        </div>
                    </div>
                    <div id="bracketContainer">
                        <!-- Bracket will be loaded here -->
                    </div>
                </div>
                
                <div class="modal-actions" style="margin-top: 2rem;">
                    <button type="button" onclick="closeTournamentDetailsModal()" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="passwordChangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Admin Password</h3>
                <span class="close" onclick="closePasswordChangeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="passwordChangeAlert" class="alert"></div>
                <form id="passwordChangeForm">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" required minlength="4">
                        <small style="color: #666; display: block; margin-top: 4px;">Minimum 4 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" required minlength="4">
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closePasswordChangeModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn">Change Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        let originalConfig = '';
        let currentLinks = [];
        let systemDiskSpace = null; // Cache for system disk space information
        let unsavedChanges = new Set(); // Track sections with unsaved changes

        // Collapsible section functions
        function toggleCollapsible(sectionId) {
            const header = document.querySelector(`#${sectionId} .collapsible-header`);
            const content = document.querySelector(`#${sectionId} .collapsible-content`);
            
            if (!header || !content) {
                console.error(`Collapsible section ${sectionId} not found`);
                return;
            }

            const isExpanded = header.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                header.classList.remove('expanded');
                header.classList.add('collapsed');
                content.classList.remove('expanded');
                content.classList.add('collapsed');
            } else {
                // Expand
                header.classList.remove('collapsed');
                header.classList.add('expanded');
                content.classList.remove('collapsed');
                content.classList.add('expanded');
            }
        }

        function showErrorIndicator(sectionId, hasError) {
            const header = document.querySelector(`#${sectionId} .collapsible-header`);
            if (!header) return;

            let errorIndicator = header.querySelector('.error-indicator');
            
            if (hasError && !errorIndicator) {
                errorIndicator = document.createElement('span');
                errorIndicator.className = 'error-indicator';
                errorIndicator.innerHTML = '●';
                errorIndicator.title = 'This section has missing information or errors';
                header.querySelector('.collapsible-title').appendChild(errorIndicator);
            } else if (!hasError && errorIndicator) {
                errorIndicator.remove();
            }
        }

        function markUnsavedChanges(sectionId) {
            unsavedChanges.add(sectionId);
            updateUnsavedWarning();
        }

        function markSaved(sectionId) {
            unsavedChanges.delete(sectionId);
            updateUnsavedWarning();
        }

        function updateUnsavedWarning() {
            const warning = document.getElementById('unsaved-warning');
            if (unsavedChanges.size > 0) {
                if (!warning.classList.contains('show')) {
                    warning.classList.add('show');
                }
                const sections = Array.from(unsavedChanges).join(', ');
                warning.innerHTML = `⚠️ Unsaved changes in: ${sections}. Please save your changes.`;
            } else {
                warning.classList.remove('show');
            }
        }

        function initializeCollapsibleSections() {
            // Initialize all collapsible sections as collapsed by default
            const sections = [
                'espresso-image-mapping',
                'espresso-local-repo',
                'espresso-template-source',
                'github-repository-settings',
                'github-git-identity'
            ];

            sections.forEach(sectionId => {
                const header = document.querySelector(`#${sectionId} .collapsible-header`);
                const content = document.querySelector(`#${sectionId} .collapsible-content`);
                
                if (header && content) {
                    // Start collapsed
                    header.classList.add('collapsed');
                    content.classList.add('collapsed');
                    
                    // Add click handler
                    header.addEventListener('click', () => toggleCollapsible(sectionId));
                }
            });

            // Initialize change tracking for form inputs
            initializeChangeTracking();
        }

        function initializeChangeTracking() {
            // Track changes for espresso section inputs
            const espressoInputs = [
                'espressoEnabled', 'espressoDataFilePath', 'espressoTemplatePath', 'espressoOutputPath',
                'espressoLocalOutputPath', 'espressoLocalImagePath', 'espressoSaveToRepo',
                'templateSourceUpload', 'templateSourceGit', 'espressoGitRepoUrl', 'espressoGitBranch', 'espressoGitLocalPath'
            ];
            
            espressoInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', () => markUnsavedChanges('Espresso Configuration'));
                    input.addEventListener('input', () => markUnsavedChanges('Espresso Configuration'));
                }
            });

            // Track changes for GitHub repository settings
            const githubRepoInputs = [
                'vidiotsRepoOwner', 'vidiotsRepoName', 'vidiotsRepoBranch', 
                'vidiotsRepoLocalPath', 'vidiotsCommitMessage', 'vidiotsAccessToken'
            ];

            githubRepoInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', () => markUnsavedChanges('GitHub Repository Settings'));
                    input.addEventListener('input', () => markUnsavedChanges('GitHub Repository Settings'));
                }
            });

            // Track changes for Git identity
            const gitIdentityInputs = ['gitUserName', 'gitUserEmail'];
            
            gitIdentityInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', () => markUnsavedChanges('Git Identity'));
                    input.addEventListener('input', () => markUnsavedChanges('Git Identity'));
                }
            });

            // Set up periodic validation checks for error indicators
            setInterval(updateErrorIndicators, 5000); // Check every 5 seconds
        }

        function updateErrorIndicators() {
            // Check espresso sections for errors
            checkEspressoImageMappingErrors();
            checkEspressoLocalRepoErrors();
            checkEspressoTemplateSourceErrors();
            checkGitHubRepositoryErrors();
            checkGitIdentityErrors();
        }

        function checkEspressoImageMappingErrors() {
            // Check if there are image configuration issues
            const templatePath = document.getElementById('espressoTemplatePath').value.trim();
            const hasError = !templatePath || templatePath.includes('❌');
            showErrorIndicator('espresso-image-mapping', hasError);
        }

        function checkEspressoLocalRepoErrors() {
            // Check if local repository configuration has issues
            const repoStatusText = document.getElementById('espressoRepoStatusText');
            const hasError = repoStatusText && repoStatusText.textContent.includes('⚠️');
            showErrorIndicator('espresso-local-repo', hasError);
        }

        function checkEspressoTemplateSourceErrors() {
            // Check if template source has issues
            const uploadRadio = document.getElementById('templateSourceUpload');
            const gitRadio = document.getElementById('templateSourceGit');
            const templateFiles = document.getElementById('espressoTemplateFiles');
            
            let hasError = false;
            
            // No method selected
            if (!uploadRadio.checked && !gitRadio.checked) {
                hasError = true;
            }
            
            // Upload method selected but no files
            if (uploadRadio.checked && templateFiles && templateFiles.textContent.includes('No template files uploaded yet')) {
                hasError = true;
            }
            
            // Git method selected but no URL
            if (gitRadio.checked) {
                const gitUrl = document.getElementById('espressoGitRepoUrl').value.trim();
                if (!gitUrl) {
                    hasError = true;
                }
            }
            
            showErrorIndicator('espresso-template-source', hasError);
        }

        function checkGitHubRepositoryErrors() {
            // Check if required GitHub repository fields are missing
            const repoOwner = document.getElementById('vidiotsRepoOwner').value.trim();
            const repoName = document.getElementById('vidiotsRepoName').value.trim();
            const accessToken = document.getElementById('vidiotsAccessToken').value.trim();
            
            const hasError = !repoOwner || !repoName || (!accessToken && accessToken !== '••••••••••••••••••••');
            showErrorIndicator('github-repository-settings', hasError);
        }

        function checkGitIdentityErrors() {
            // Check if required Git identity fields are missing
            const userName = document.getElementById('gitUserName').value.trim();
            const userEmail = document.getElementById('gitUserEmail').value.trim();
            
            let hasError = !userName || !userEmail;
            
            // Basic email validation
            if (userEmail) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                hasError = hasError || !emailRegex.test(userEmail);
            }
            
            showErrorIndicator('github-git-identity', hasError);
        }
        
        // Load system disk space information
        async function loadSystemDiskSpace() {
            try {
                const response = await fetch('/admin/api/system/disk-space');
                const result = await response.json();
                if (result.success) {
                    systemDiskSpace = result.diskSpace;
                } else {
                    console.error('Failed to load disk space:', result.error);
                    // Set fallback values if API fails
                    systemDiskSpace = {
                        total: 50 * 1024 * 1024 * 1024, // 50GB fallback
                        available: 25 * 1024 * 1024 * 1024, // 25GB fallback
                        used: 25 * 1024 * 1024 * 1024,
                        approximate: true
                    };
                }
            } catch (error) {
                console.error('Error loading disk space:', error);
                // Set fallback values if request fails
                systemDiskSpace = {
                    total: 50 * 1024 * 1024 * 1024, // 50GB fallback
                    available: 25 * 1024 * 1024 * 1024, // 25GB fallback
                    used: 25 * 1024 * 1024 * 1024,
                    approximate: true
                };
            }
        }
        
        // Load server status
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                const statusGrid = document.getElementById('statusGrid');
                statusGrid.innerHTML = `
                    <div class="status-item">
                        <div class="status-label">Server Status</div>
                        <div class="status-value">${status.server.status}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Uptime</div>
                        <div class="status-value">${Math.floor(status.server.uptime / 60)} minutes</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Port</div>
                        <div class="status-value">${status.server.port}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Memory Usage</div>
                        <div class="status-value">${Math.round(status.memory.heapUsed / 1024 / 1024)} MB</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Version</div>
                        <div class="status-value">${status.version}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Last Updated</div>
                        <div class="status-value">${new Date(status.timestamp).toLocaleTimeString()}</div>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load status:', err);
            }
        }
        
        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/admin/api/config');
                const config = await response.json();
                originalConfig = JSON.stringify(config, null, 2);
                
                // Populate basic config form
                document.getElementById('serverPort').value = config.server.port;
                document.getElementById('adminUsername').value = config.server.admin.username;
                document.getElementById('adminPassword').value = config.server.admin.password;
                document.getElementById('homeAssistantEnabled').value = config.homeAssistant.enabled;
                document.getElementById('homeAssistantUrl').value = config.homeAssistant.url;
                document.getElementById('cockpitEnabled').value = config.cockpit.enabled;
                document.getElementById('cockpitUrl').value = config.cockpit.url;
                
                // Populate storage config
                if (config.storage) {
                    const maxTotalSizeStr = config.storage.maxTotalSize || '1GB';
                    const maxTotalSizeBytes = parseFileSize(maxTotalSizeStr);
                    const maxTotalSizeMB = bytesToMB(maxTotalSizeBytes);
                    
                    // Update slider and input
                    updateStorageSlider(maxTotalSizeMB);
                    
                    if (config.storage.maxFileSizes) {
                        document.getElementById('maxImageSize').value = config.storage.maxFileSizes.image || '';
                        document.getElementById('maxVideoSize').value = config.storage.maxFileSizes.video || '';
                        document.getElementById('maxDocumentSize').value = config.storage.maxFileSizes.document || '';
                        document.getElementById('maxOtherSize').value = config.storage.maxFileSizes.other || '';
                    }
                }
                
                // Populate advanced editor
                document.getElementById('configEditor').value = originalConfig;
            } catch (err) {
                console.error('Failed to load config:', err);
                showAlert('Failed to load configuration', 'error', 'configAlert');
            }
        }
        
        // Save basic configuration
        async function saveBasicConfig() {
            try {
                const config = {
                    server: {
                        port: parseInt(document.getElementById('serverPort').value),
                        admin: {
                            username: document.getElementById('adminUsername').value
                            // Note: password is intentionally omitted to prevent overwriting
                        }
                    },
                    homeAssistant: {
                        enabled: document.getElementById('homeAssistantEnabled').value === 'true',
                        url: document.getElementById('homeAssistantUrl').value
                    },
                    cockpit: {
                        enabled: document.getElementById('cockpitEnabled').value === 'true',
                        url: document.getElementById('cockpitUrl').value
                    },
                    webContent: {
                        directory: "./public",
                        defaultFile: "index.html"
                    }
                };
                
                // Get current config to preserve other settings
                const currentResponse = await fetch('/admin/api/config');
                const currentConfig = await currentResponse.json();
                
                // Merge with existing config, preserving the current admin password
                const mergedConfig = { ...currentConfig, ...config };
                // Ensure admin password is preserved from current config
                mergedConfig.server.admin.password = currentConfig.server.admin.password;
                
                const response = await fetch('/admin/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mergedConfig)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Basic configuration saved successfully!', 'success', 'configAlert');
                    setTimeout(loadStatus, 1000); // Refresh status
                    setTimeout(loadConfig, 1000); // Refresh config
                } else {
                    showAlert('Failed to save: ' + result.error, 'error', 'configAlert');
                }
            } catch (err) {
                showAlert('Error saving configuration: ' + err.message, 'error', 'configAlert');
            }
        }
        
        // Save storage configuration
        async function saveStorageConfig() {
            try {
                // Validate configuration first
                if (!validateStorageConfiguration()) {
                    showAlert('Please fix the storage configuration errors before saving.', 'error', 'storageAlert');
                    return;
                }
                
                // Get current config
                const currentResponse = await fetch('/admin/api/config');
                const config = await currentResponse.json();
                
                // Get values from slider/input
                const totalMB = parseInt(document.getElementById('maxTotalStorageInput').value) || 1000;
                const totalSizeStr = formatFileSizeFromMB(totalMB);
                
                // Update storage settings
                config.storage = {
                    maxTotalSize: totalSizeStr,
                    maxFileSizes: {
                        image: document.getElementById('maxImageSize').value,
                        video: document.getElementById('maxVideoSize').value,
                        document: document.getElementById('maxDocumentSize').value,
                        other: document.getElementById('maxOtherSize').value
                    }
                };
                
                const response = await fetch('/admin/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Storage settings saved successfully!', 'success', 'storageAlert');
                } else {
                    showAlert('Failed to save storage settings: ' + result.error, 'error', 'storageAlert');
                }
            } catch (err) {
                showAlert('Error saving storage settings: ' + err.message, 'error', 'storageAlert');
            }
        }
        
        // Save advanced configuration
        async function saveConfig() {
            try {
                const configText = document.getElementById('configEditor').value;
                const config = JSON.parse(configText);
                
                const response = await fetch('/admin/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    originalConfig = configText;
                    showAlert('Advanced configuration saved successfully!', 'success', 'configAlert');
                    setTimeout(loadStatus, 1000); // Refresh status
                    setTimeout(loadConfig, 1000); // Refresh basic form
                } else {
                    showAlert('Failed to save: ' + result.error, 'error', 'configAlert');
                }
            } catch (err) {
                showAlert('Invalid JSON format: ' + err.message, 'error', 'configAlert');
            }
        }
        
        // Reset configuration
        function resetConfig() {
            document.getElementById('configEditor').value = originalConfig;
            showAlert('Configuration reset to last saved version', 'success', 'configAlert');
        }
        
        // Toggle advanced config section
        function toggleAdvancedConfig() {
            const section = document.getElementById('advancedConfig');
            section.classList.toggle('hidden');
        }
        
        // Load logs
        async function loadLogs() {
            try {
                const response = await fetch('/admin/api/logs');
                const logs = await response.json();
                
                const container = document.getElementById('logsContainer');
                container.innerHTML = logs.map(log => `
                    <div class="log-entry">
                        <span class="log-timestamp">${new Date(log.timestamp).toLocaleString()}</span>
                        <span class="log-level ${log.level}">${log.level}</span>
                        <span class="log-message">${log.message}</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load logs:', err);
            }
        }
        
        // Load useful links
        async function loadLinks() {
            try {
                const response = await fetch('/admin/api/links');
                const links = await response.json();
                currentLinks = links;
                
                const container = document.getElementById('linksList');
                container.innerHTML = links.length > 0 ? links.map((link, index) => `
                    <li class="link-item">
                        <a href="${link.url}" target="_blank">${link.name}</a>
                        <button class="btn btn-danger" onclick="removeLink(${index})">Remove</button>
                    </li>
                `).join('') : '<li style="text-align: center; color: #6c757d;">No links saved yet</li>';
            } catch (err) {
                console.error('Failed to load links:', err);
            }
        }
        
        // Add useful link
        async function addLink() {
            const name = document.getElementById('linkName').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            
            if (!url) {
                showAlert('Please enter a URL', 'error', 'linksAlert');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/links', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, url })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('linkName').value = '';
                    document.getElementById('linkUrl').value = '';
                    showAlert('Link added successfully!', 'success', 'linksAlert');
                    loadLinks();
                } else {
                    showAlert('Failed to add link: ' + result.error, 'error', 'linksAlert');
                }
            } catch (err) {
                showAlert('Error adding link: ' + err.message, 'error', 'linksAlert');
            }
        }
        
        // Remove useful link
        async function removeLink(index) {
            const linkToRemove = currentLinks[index];
            if (!linkToRemove || !linkToRemove.id) {
                showAlert('Invalid link to remove', 'error', 'linksAlert');
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/links/${linkToRemove.id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Link removed successfully!', 'success', 'linksAlert');
                    loadLinks();
                } else {
                    showAlert('Failed to remove link: ' + result.error, 'error', 'linksAlert');
                }
            } catch (err) {
                showAlert('Error removing link: ' + err.message, 'error', 'linksAlert');
            }
        }
        
        // Show alert
        function showAlert(message, type, containerId) {
            const alert = document.getElementById(containerId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        // Load client configuration and devices
        async function loadClientConfig() {
            try {
                const response = await fetch('/admin/api/client');
                const data = await response.json();
                
                // Populate client configuration
                const config = data.config;
                document.getElementById('clientEnabled').value = config.enabled ? 'true' : 'false';
                document.getElementById('welcomeMessage').value = config.welcomeMessage || '';
                document.getElementById('showServerStatus').value = config.showServerStatus ? 'true' : 'false';
                document.getElementById('showUsefulLinks').value = config.showUsefulLinks ? 'true' : 'false';
                
                // Update password status display
                updatePasswordStatus(config.requirePassword, config.hasPassword);
                
                // Load connected devices
                loadConnectedDevices(data.connectedDevices || []);
            } catch (err) {
                console.error('Failed to load client config:', err);
                showAlert('Failed to load client configuration', 'error', 'clientAlert');
            }
        }
        
        // Update password protection status display
        function updatePasswordStatus(requirePassword, hasPassword) {
            const statusElement = document.getElementById('passwordStatusText');
            if (hasPassword && requirePassword) {
                statusElement.innerHTML = '🔒 <strong>Protected</strong> - Client has set a password and protection is enabled';
                statusElement.style.color = '#28a745';
            } else if (hasPassword && !requirePassword) {
                statusElement.innerHTML = '🔓 <strong>Password Set but Disabled</strong> - Client has a password but protection is disabled';
                statusElement.style.color = '#ffc107';
            } else {
                statusElement.innerHTML = '🔓 <strong>No Protection</strong> - No client password is set';
                statusElement.style.color = '#6c757d';
            }
        }
        
        // Load connected devices
        function loadConnectedDevices(devices) {
            const container = document.getElementById('devicesContainer');
            
            if (devices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        No clients have connected yet
                    </div>
                `;
                return;
            }
            
            container.innerHTML = devices.map(device => {
                const lastSeen = new Date(device.lastSeen);
                const firstSeen = new Date(device.firstSeen);
                const timeDiff = Math.floor((Date.now() - lastSeen.getTime()) / 1000 / 60); // minutes
                const timeAgo = timeDiff < 1 ? 'Just now' : timeDiff < 60 ? `${timeDiff}m ago` : `${Math.floor(timeDiff/60)}h ago`;
                
                return `
                    <div class="client-item" style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <div>
                                <h4 style="margin: 0; color: #333; font-size: 1.1rem;">
                                    ${escapeHtml(device.name || 'Unnamed Client')}
                                    <span style="opacity: 0.7; font-weight: normal; font-size: 0.9rem; margin-left: 0.5rem;">(${escapeHtml(device.deviceType)})</span>
                                </h4>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                    Client ID: <code style="background: #f1f1f1; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8rem;">${escapeHtml(device.deviceId)}</code>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="removeDevice('${device.deviceId}')" title="Remove client from device list only">Remove Device</button>
                                <button class="btn btn-danger" onclick="deleteClient('${device.deviceId}')" title="Delete client and all their data permanently">Delete Client</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.9rem; color: #555;">
                            <div>
                                <strong>Browser:</strong><br>
                                <span style="opacity: 0.8;">${escapeHtml(device.browserInfo || 'Unknown')}</span>
                            </div>
                            <div>
                                <strong>IP Address:</strong><br>
                                <span style="opacity: 0.8;">${escapeHtml(device.ip || 'Unknown')}</span>
                            </div>
                            <div>
                                <strong>Last Seen:</strong><br>
                                <span style="opacity: 0.8;">${timeAgo}</span>
                            </div>
                            <div>
                                <strong>First Connected:</strong><br>
                                <span style="opacity: 0.8;">${formatDate(device.firstSeen)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Save client configuration
        async function saveClientConfig() {
            const clientConfig = {
                enabled: document.getElementById('clientEnabled').value === 'true',
                welcomeMessage: document.getElementById('welcomeMessage').value.trim(),
                showServerStatus: document.getElementById('showServerStatus').value === 'true',
                showUsefulLinks: document.getElementById('showUsefulLinks').value === 'true'
            };
            
            try {
                const response = await fetch('/admin/api/client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(clientConfig)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Client configuration saved successfully!', 'success', 'clientAlert');
                    // Reload to refresh password status
                    loadClientConfig();
                } else {
                    showAlert('Failed to save client configuration: ' + result.error, 'error', 'clientAlert');
                }
            } catch (err) {
                showAlert('Error saving client configuration: ' + err.message, 'error', 'clientAlert');
            }
        }
        
        // Remove device
        async function removeDevice(deviceId) {
            if (!confirm('Are you sure you want to remove this device from the list? This will NOT delete any files uploaded by the client.')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/client/device/${deviceId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Device removed successfully!', 'success', 'clientAlert');
                    loadClientConfig(); // Reload to refresh device list
                } else {
                    showAlert('Failed to remove device: ' + result.error, 'error', 'clientAlert');
                }
            } catch (err) {
                showAlert('Error removing device: ' + err.message, 'error', 'clientAlert');
            }
        }
        
        // Delete client and all their data
        async function deleteClient(deviceId) {
            const deviceName = getDeviceName(deviceId);
            const confirmMessage = `⚠️ WARNING: This will permanently delete the client "${deviceName}" and ALL their data including:\n\n• Device record from the system\n• All uploaded files\n• All file metadata\n\nThis action CANNOT be undone!\n\nAre you absolutely sure you want to proceed?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Second confirmation for safety
            if (!confirm('This is your final warning. Type "DELETE" and press OK to confirm:')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/client/${deviceId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Client "${result.deletedDevice.name || 'Unnamed Device'}" and all associated data deleted successfully!`, 'success', 'clientAlert');
                    // Reload multiple sections that might be affected
                    loadClientConfig();
                    loadClientFiles();
                    loadClientStorageStats();
                } else {
                    showAlert('Failed to delete client: ' + result.error, 'error', 'clientAlert');
                }
            } catch (err) {
                showAlert('Error deleting client: ' + err.message, 'error', 'clientAlert');
            }
        }
        
        // Helper function to get device name from the current devices list
        function getDeviceName(deviceId) {
            const container = document.getElementById('devicesContainer');
            const deviceElements = container.querySelectorAll('.client-item');
            for (let element of deviceElements) {
                if (element.innerHTML.includes(deviceId)) {
                    const nameElement = element.querySelector('h4');
                    if (nameElement) {
                        return nameElement.textContent.split('(')[0].trim();
                    }
                }
            }
            return 'Unknown Device';
        }
        
        // Password Change Modal Functions
        function openPasswordChangeModal() {
            document.getElementById('passwordChangeModal').style.display = 'flex';
            document.getElementById('currentPassword').focus();
        }
        
        function closePasswordChangeModal() {
            document.getElementById('passwordChangeModal').style.display = 'none';
            document.getElementById('passwordChangeForm').reset();
            document.getElementById('passwordChangeAlert').innerHTML = '';
        }
        
        function showPasswordAlert(message, type) {
            const alertDiv = document.getElementById('passwordChangeAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }
        
        async function handlePasswordChange(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showPasswordAlert('New passwords do not match', 'error');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 4) {
                showPasswordAlert('New password must be at least 4 characters long', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showPasswordAlert('Password changed successfully!', 'success');
                    setTimeout(() => {
                        closePasswordChangeModal();
                        // Update the displayed password field to show it was changed
                        document.getElementById('adminPassword').value = '••••••••';
                    }, 2000);
                } else {
                    showPasswordAlert(result.error || 'Failed to change password', 'error');
                }
            } catch (err) {
                showPasswordAlert('Error changing password: ' + err.message, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('saveBasicConfig').addEventListener('click', saveBasicConfig);
        document.getElementById('saveStorageConfig').addEventListener('click', saveStorageConfig);
        document.getElementById('saveConfig').addEventListener('click', saveConfig);
        document.getElementById('resetConfig').addEventListener('click', resetConfig);
        document.getElementById('refreshLogs').addEventListener('click', loadLogs);
        document.getElementById('addLink').addEventListener('click', addLink);
        document.getElementById('saveClientConfig').addEventListener('click', saveClientConfig);
        document.getElementById('passwordChangeForm').addEventListener('submit', handlePasswordChange);
        
        // File type input validation listeners
        ['maxImageSize', 'maxVideoSize', 'maxDocumentSize', 'maxOtherSize'].forEach(id => {
            document.getElementById(id).addEventListener('input', validateStorageConfiguration);
        });
        
        // Close modal when clicking outside of it
        document.getElementById('passwordChangeModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closePasswordChangeModal();
            }
        });
        
        // Load client storage usage statistics
        async function loadClientStorageStats() {
            try {
                const response = await fetch('/admin/api/client/storage-stats');
                const result = await response.json();
                
                const container = document.getElementById('clientStorageContainer');
                
                if (result.success && Object.keys(result.clients).length > 0) {
                    let maxClientSize = 0;
                    // Find the max client size for relative bar scaling
                    Object.values(result.clients).forEach(client => {
                        maxClientSize = Math.max(maxClientSize, client.totalSize);
                    });
                    
                    container.innerHTML = Object.values(result.clients).map(client => {
                        let maxCategorySize = 0;
                        // Find max category size for this client for relative bar scaling
                        Object.values(client.categories).forEach(category => {
                            maxCategorySize = Math.max(maxCategorySize, category.size);
                        });
                        
                        const categoriesHtml = Object.entries(client.categories).map(([type, data]) => {
                            const percentage = maxCategorySize > 0 ? (data.size / maxCategorySize * 100) : 0;
                            return `
                                <div class="storage-category ${type}">
                                    <div class="category-header">
                                        <span class="category-name">${type}</span>
                                        <span class="category-count">${data.count} files</span>
                                    </div>
                                    <div class="category-bar">
                                        <div class="category-bar-fill ${type}" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="category-size">${formatFileSize(data.size)}</div>
                                </div>
                            `;
                        }).join('');
                        
                        return `
                            <div class="storage-client">
                                <div class="storage-client-header">
                                    <span class="storage-client-name">${escapeHtml(client.deviceName)}</span>
                                    <span class="storage-client-total">${client.totalFiles} files • ${formatFileSize(client.totalSize)} total</span>
                                </div>
                                <div class="storage-categories">
                                    ${categoriesHtml}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="storage-empty">
                            No client storage data available
                        </div>
                    `;
                }
            } catch (error) {
                const container = document.getElementById('clientStorageContainer');
                container.innerHTML = `
                    <div style="text-align: center; opacity: 0.7; padding: 2rem; color: #dc3545;">
                        Error loading storage statistics: ${error.message}
                    </div>
                `;
            }
        }
        
        // Load client files
        async function loadClientFiles() {
            try {
                const response = await fetch('/admin/api/client/files');
                const result = await response.json();
                
                const container = document.getElementById('clientFilesContainer');
                
                if (result.success && result.files.length > 0) {
                    container.innerHTML = result.files.map(file => `
                        <div class="file-item" style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                            <div class="file-info" style="flex: 1; min-width: 200px;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 0.25rem;">${escapeHtml(file.originalName)}</div>
                                <div style="font-size: 0.9rem; color: #666;">
                                    Device: ${escapeHtml(file.deviceName)} | 
                                    Size: ${formatFileSize(file.size)} | 
                                    Type: ${file.mimeType} | 
                                    Uploaded: ${formatDate(file.uploadDate)}
                                    <span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-left: 0.5rem; background-color: ${getSharingColor(file.sharing)}; color: white;">
                                        ${formatSharing(file.sharing)}
                                    </span>
                                </div>
                            </div>
                            <div class="file-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="window.open('${file.url}', '_blank')" style="padding: 0.25rem 0.75rem; font-size: 0.9rem; border: none; border-radius: 4px; cursor: pointer; background-color: #007bff; color: white;">View</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                            No files uploaded by clients yet
                        </div>
                    `;
                }
            } catch (error) {
                const container = document.getElementById('clientFilesContainer');
                container.innerHTML = `
                    <div style="text-align: center; opacity: 0.7; padding: 2rem; color: #dc3545;">
                        Error loading client files: ${error.message}
                    </div>
                `;
            }
        }
        
        // Utility functions for client files
        function getSharingColor(sharing) {
            switch(sharing) {
                case 'none': return '#6c757d';
                case 'admin': return '#fd7e14';
                case 'all': return '#28a745';
                default: return '#6c757d';
            }
        }
        
        // Utility functions for file size conversion
        function parseFileSize(sizeStr) {
            const units = { 'B': 1, 'KB': 1024, 'MB': 1024*1024, 'GB': 1024*1024*1024 };
            const match = sizeStr.match(/^(\d+(?:\.\d+)?)\s*([A-Z]*B?)$/i);
            if (!match) return 0;
            const value = parseFloat(match[1]);
            const unit = match[2].toUpperCase() || 'B';
            return value * (units[unit] || 1);
        }
        
        function bytesToMB(bytes) {
            return Math.round(bytes / (1024 * 1024));
        }
        
        function mbToBytes(mb) {
            return mb * 1024 * 1024;
        }
        
        function formatFileSizeFromMB(mb) {
            const bytes = mbToBytes(mb);
            return formatFileSize(bytes);
        }
        
        // Storage slider management functions
        function updateStorageSlider(mb) {
            const slider = document.getElementById('maxTotalStorageSlider');
            const input = document.getElementById('maxTotalStorageInput');
            const display = document.getElementById('maxTotalStorageDisplay');
            
            slider.value = mb;
            input.value = mb;
            display.textContent = formatFileSizeFromMB(mb);
        }
        
        function setupStorageSlider() {
            const slider = document.getElementById('maxTotalStorageSlider');
            const input = document.getElementById('maxTotalStorageInput');
            
            // Set maximum based on available disk space
            if (systemDiskSpace) {
                const availableMB = bytesToMB(systemDiskSpace.available);
                const maxAllowedMB = Math.min(availableMB, 10000); // Cap at 10GB for UI reasons
                slider.max = maxAllowedMB;
                input.max = maxAllowedMB;
                
                // Update available storage info
                const infoElement = document.getElementById('availableStorageInfo');
                infoElement.textContent = `Available: ${formatFileSize(systemDiskSpace.available)}${systemDiskSpace.approximate ? ' (estimated)' : ''}`;
            }
            
            // Slider change handler
            slider.addEventListener('input', function() {
                const mb = parseInt(this.value);
                input.value = mb;
                document.getElementById('maxTotalStorageDisplay').textContent = formatFileSizeFromMB(mb);
                validateStorageConfiguration();
            });
            
            // Input change handler
            input.addEventListener('input', function() {
                const mb = parseInt(this.value) || 1;
                const maxMB = parseInt(slider.max);
                const clampedMB = Math.max(1, Math.min(mb, maxMB));
                
                if (mb !== clampedMB) {
                    this.value = clampedMB;
                }
                
                slider.value = clampedMB;
                document.getElementById('maxTotalStorageDisplay').textContent = formatFileSizeFromMB(clampedMB);
                validateStorageConfiguration();
            });
        }
        
        function validateStorageConfiguration() {
            const totalMB = parseInt(document.getElementById('maxTotalStorageInput').value) || 0;
            const messageElement = document.getElementById('storageValidationMessage');
            
            // Calculate sum of file type limits
            const imageSize = parseFileSize(document.getElementById('maxImageSize').value || '0MB');
            const videoSize = parseFileSize(document.getElementById('maxVideoSize').value || '0MB');
            const documentSize = parseFileSize(document.getElementById('maxDocumentSize').value || '0MB');
            const otherSize = parseFileSize(document.getElementById('maxOtherSize').value || '0MB');
            
            const totalFileTypesBytes = imageSize + videoSize + documentSize + otherSize;
            const totalFileTypesMB = bytesToMB(totalFileTypesBytes);
            
            messageElement.className = 'storage-validation-message';
            
            if (totalFileTypesMB > totalMB) {
                messageElement.className += ' error';
                messageElement.textContent = `Error: Total file type limits (${formatFileSize(totalFileTypesBytes)}) exceed maximum total storage (${formatFileSizeFromMB(totalMB)}).`;
                return false;
            } else if (totalFileTypesMB > totalMB * 0.8) {
                messageElement.className += ' warning';
                messageElement.textContent = `Warning: File type limits (${formatFileSize(totalFileTypesBytes)}) are close to maximum total storage (${formatFileSizeFromMB(totalMB)}).`;
            } else {
                messageElement.style.display = 'none';
            }
            
            return true;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }
        
        function formatSharing(sharing) {
            switch(sharing) {
                case 'none': return 'Private';
                case 'admin': return 'Admin Only';
                case 'all': return 'Public';
                default: return sharing;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load initial data
        async function initializeAdmin() {
            // Load system information first
            await loadSystemDiskSpace();
            
            // Load configuration and setup storage slider
            await loadConfig();
            setupStorageSlider();
            
            // Load other data
            loadStatus();
            loadLogs();
            loadLinks();
            loadClientConfig();
            loadClientFiles();
            loadClientStorageStats();
            loadMediaStreamingConfig(); // Load media streaming configuration
            initializeDrinkMixer();
        }
        
        // Drink Mixer Functions
        let currentAlcohols = [];
        let currentMixers = [];
        let currentRecipes = [];
        let availableIngredients = [];
        
        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for the selected tab
            if (tabName === 'alcohols') {
                loadAlcohols();
            } else if (tabName === 'mixers') {
                loadMixers();
            } else if (tabName === 'recipes') {
                loadRecipes();
                loadAvailableIngredients().then(() => {
                    // Populate initial dropdown after ingredients are loaded
                    const initialDropdown = document.querySelector('#recipeIngredients .ingredient-name-dropdown');
                    if (initialDropdown) {
                        populateIngredientDropdown(initialDropdown);
                    }
                });
            } else if (tabName === 'available') {
                loadAvailableDrinks();
            }
        }
        
        // Load alcohols
        async function loadAlcohols() {
            try {
                const response = await fetch('/admin/api/drink-mixer/alcohols');
                currentAlcohols = await response.json();
                
                const container = document.getElementById('alcoholsList');
                if (currentAlcohols.length === 0) {
                    container.innerHTML = '<div class="no-items">No alcohols added yet</div>';
                    return;
                }
                
                container.innerHTML = currentAlcohols.map(alcohol => `
                    <div class="ingredient-item ${!alcohol.available ? 'unavailable' : ''}">
                        <div>
                            <div class="ingredient-name">${alcohol.name}</div>
                            <span class="ingredient-status ${alcohol.available ? 'available' : 'unavailable'}">
                                ${alcohol.available ? 'Available' : 'Unavailable'}
                            </span>
                        </div>
                        <div class="ingredient-actions">
                            <button onclick="toggleAlcoholAvailability(${alcohol.id})" class="btn btn-secondary btn-small">
                                ${alcohol.available ? 'Mark Unavailable' : 'Mark Available'}
                            </button>
                            <button onclick="removeAlcohol(${alcohol.id})" class="btn btn-danger btn-small">Remove</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load alcohols:', err);
                showAlertInTab('alcohols', 'Failed to load alcohols: ' + err.message, 'error');
            }
        }
        
        // Add alcohol
        async function addAlcohol() {
            const name = document.getElementById('alcoholName').value.trim();
            const available = document.getElementById('alcoholAvailable').value === 'true';
            
            if (!name) {
                showAlertInTab('alcohols', 'Please enter an alcohol name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/drink-mixer/alcohols', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, available })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('alcoholName').value = '';
                    document.getElementById('alcoholAvailable').value = 'true';
                    showAlertInTab('alcohols', result.message, 'success');
                    loadAlcohols();
                } else {
                    showAlertInTab('alcohols', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('alcohols', 'Error adding alcohol: ' + err.message, 'error');
            }
        }
        
        // Toggle alcohol availability
        async function toggleAlcoholAvailability(id) {
            const alcohol = currentAlcohols.find(a => a.id === id);
            if (!alcohol) return;
            
            try {
                const response = await fetch('/admin/api/drink-mixer/alcohols', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: alcohol.name, available: !alcohol.available })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('alcohols', result.message, 'success');
                    loadAlcohols();
                } else {
                    showAlertInTab('alcohols', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('alcohols', 'Error updating alcohol: ' + err.message, 'error');
            }
        }
        
        // Remove alcohol
        async function removeAlcohol(id) {
            if (!confirm('Are you sure you want to remove this alcohol?')) return;
            
            try {
                const response = await fetch(`/admin/api/drink-mixer/alcohols/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('alcohols', result.message, 'success');
                    loadAlcohols();
                } else {
                    showAlertInTab('alcohols', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('alcohols', 'Error removing alcohol: ' + err.message, 'error');
            }
        }
        
        // Load mixers
        async function loadMixers() {
            try {
                const response = await fetch('/admin/api/drink-mixer/mixers');
                currentMixers = await response.json();
                
                const container = document.getElementById('mixersList');
                if (currentMixers.length === 0) {
                    container.innerHTML = '<div class="no-items">No mixers added yet</div>';
                    return;
                }
                
                container.innerHTML = currentMixers.map(mixer => `
                    <div class="ingredient-item ${!mixer.available ? 'unavailable' : ''}">
                        <div>
                            <div class="ingredient-name">${mixer.name}</div>
                            <span class="ingredient-status ${mixer.available ? 'available' : 'unavailable'}">
                                ${mixer.available ? 'Available' : 'Unavailable'}
                            </span>
                        </div>
                        <div class="ingredient-actions">
                            <button onclick="toggleMixerAvailability(${mixer.id})" class="btn btn-secondary btn-small">
                                ${mixer.available ? 'Mark Unavailable' : 'Mark Available'}
                            </button>
                            <button onclick="removeMixer(${mixer.id})" class="btn btn-danger btn-small">Remove</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load mixers:', err);
                showAlertInTab('mixers', 'Failed to load mixers: ' + err.message, 'error');
            }
        }
        
        // Add mixer
        async function addMixer() {
            const name = document.getElementById('mixerName').value.trim();
            const available = document.getElementById('mixerAvailable').value === 'true';
            
            if (!name) {
                showAlertInTab('mixers', 'Please enter a mixer name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/drink-mixer/mixers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, available })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('mixerName').value = '';
                    document.getElementById('mixerAvailable').value = 'true';
                    showAlertInTab('mixers', result.message, 'success');
                    loadMixers();
                } else {
                    showAlertInTab('mixers', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('mixers', 'Error adding mixer: ' + err.message, 'error');
            }
        }
        
        // Toggle mixer availability
        async function toggleMixerAvailability(id) {
            const mixer = currentMixers.find(m => m.id === id);
            if (!mixer) return;
            
            try {
                const response = await fetch('/admin/api/drink-mixer/mixers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: mixer.name, available: !mixer.available })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('mixers', result.message, 'success');
                    loadMixers();
                } else {
                    showAlertInTab('mixers', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('mixers', 'Error updating mixer: ' + err.message, 'error');
            }
        }
        
        // Remove mixer
        async function removeMixer(id) {
            if (!confirm('Are you sure you want to remove this mixer?')) return;
            
            try {
                const response = await fetch(`/admin/api/drink-mixer/mixers/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('mixers', result.message, 'success');
                    loadMixers();
                } else {
                    showAlertInTab('mixers', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('mixers', 'Error removing mixer: ' + err.message, 'error');
            }
        }
        
        // Load available ingredients for dropdown
        async function loadAvailableIngredients() {
            try {
                const response = await fetch('/admin/api/drink-mixer/available-ingredients');
                availableIngredients = await response.json();
            } catch (err) {
                console.error('Error loading available ingredients:', err);
                availableIngredients = [];
            }
        }
        
        // Recipe management
        function populateIngredientDropdown(selectElement) {
            // Clear existing options except the default ones
            selectElement.innerHTML = '<option value="">Select ingredient...</option><option value="__ADD_NEW__">+ Add New Ingredient</option>';
            
            // Add available ingredients
            availableIngredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient.name;
                option.textContent = `${ingredient.name} (${ingredient.type})`;
                selectElement.appendChild(option);
            });
        }
        
        function handleIngredientChange(selectElement) {
            const row = selectElement.closest('.ingredient-row');
            const textInput = row.querySelector('.ingredient-name-input');
            
            if (selectElement.value === '__ADD_NEW__') {
                selectElement.style.display = 'none';
                textInput.style.display = 'block';
                textInput.focus();
            } else {
                textInput.style.display = 'none';
                selectElement.style.display = 'block';
            }
        }
        
        function addIngredientRow() {
            const container = document.getElementById('recipeIngredients');
            const newRow = document.createElement('div');
            newRow.className = 'ingredient-row';
            newRow.innerHTML = `
                <div class="ingredient-field">
                    <select class="ingredient-name-dropdown" onchange="handleIngredientChange(this)">
                        <option value="">Select ingredient...</option>
                        <option value="__ADD_NEW__">+ Add New Ingredient</option>
                    </select>
                    <input type="text" class="ingredient-name-input" placeholder="Enter new ingredient name" style="display: none;">
                </div>
                <input type="number" class="ingredient-amount" placeholder="Amount" step="0.1" min="0.1">
                <select class="ingredient-unit">
                    <option value="oz">Ounces</option>
                    <option value="dash">Dashes</option>
                    <option value="unit">Units</option>
                </select>
                <button type="button" onclick="removeIngredientRow(this)" class="btn btn-danger btn-small">Remove</button>
            `;
            container.appendChild(newRow);
            
            // Populate the dropdown
            const dropdown = newRow.querySelector('.ingredient-name-dropdown');
            populateIngredientDropdown(dropdown);
        }
        
        function removeIngredientRow(button) {
            const container = document.getElementById('recipeIngredients');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }
        
        // Add recipe
        async function addRecipe() {
            const name = document.getElementById('recipeName').value.trim();
            const directions = document.getElementById('recipeDirections').value.trim();
            const ingredientRows = document.querySelectorAll('#recipeIngredients .ingredient-row');
            
            if (!name) {
                showAlertInTab('recipes', 'Please enter a recipe name', 'error');
                return;
            }
            
            const ingredients = [];
            for (const row of ingredientRows) {
                const dropdown = row.querySelector('.ingredient-name-dropdown');
                const textInput = row.querySelector('.ingredient-name-input');
                const amount = parseFloat(row.querySelector('.ingredient-amount').value);
                const unit = row.querySelector('.ingredient-unit').value;
                
                let ingredientName = '';
                if (dropdown.value && dropdown.value !== '__ADD_NEW__') {
                    ingredientName = dropdown.value;
                } else if (textInput.style.display !== 'none' && textInput.value.trim()) {
                    ingredientName = textInput.value.trim();
                }
                
                if (ingredientName && amount > 0 && unit) {
                    ingredients.push({ name: ingredientName, amount, unit });
                }
            }
            
            if (ingredients.length === 0) {
                showAlertInTab('recipes', 'Please add at least one valid ingredient', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/drink-mixer/recipes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, ingredients, directions })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('recipeName').value = '';
                    document.getElementById('recipeDirections').value = '';
                    // Reset to single ingredient row
                    resetIngredientRows();
                    showAlertInTab('recipes', result.message, 'success');
                    loadRecipes();
                } else {
                    showAlertInTab('recipes', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('recipes', 'Error adding recipe: ' + err.message, 'error');
            }
        }
        
        function resetIngredientRows() {
            document.getElementById('recipeIngredients').innerHTML = `
                <div class="ingredient-row">
                    <div class="ingredient-field">
                        <select class="ingredient-name-dropdown" onchange="handleIngredientChange(this)">
                            <option value="">Select ingredient...</option>
                            <option value="__ADD_NEW__">+ Add New Ingredient</option>
                        </select>
                        <input type="text" class="ingredient-name-input" placeholder="Enter new ingredient name" style="display: none;">
                    </div>
                    <input type="number" class="ingredient-amount" placeholder="Amount" step="0.1" min="0.1">
                    <select class="ingredient-unit">
                        <option value="oz">Ounces</option>
                        <option value="dash">Dashes</option>
                        <option value="unit">Units</option>
                    </select>
                    <button type="button" onclick="removeIngredientRow(this)" class="btn btn-danger btn-small">Remove</button>
                </div>
            `;
            // Populate the dropdown
            const dropdown = document.querySelector('#recipeIngredients .ingredient-name-dropdown');
            populateIngredientDropdown(dropdown);
        }
        
        // Load recipes
        async function loadRecipes() {
            try {
                const response = await fetch('/admin/api/drink-mixer/recipes');
                currentRecipes = await response.json();
                
                const container = document.getElementById('recipesList');
                if (currentRecipes.length === 0) {
                    container.innerHTML = '<div class="no-items">No recipes added yet</div>';
                    return;
                }
                
                container.innerHTML = currentRecipes.map(recipe => `
                    <div class="recipe-item">
                        <div class="recipe-header">
                            <div class="recipe-name">${recipe.name}</div>
                            <button onclick="removeRecipe(${recipe.id})" class="btn btn-danger btn-small">Remove</button>
                        </div>
                        <div class="recipe-ingredients">
                            ${recipe.ingredients.map(ing => `
                                <div class="recipe-ingredient">
                                    <span class="recipe-ingredient-name">${ing.name}</span>
                                    <span class="recipe-ingredient-amount">${ing.amount || ing.ounces} ${getUnitDisplay(ing.unit || 'oz')}</span>
                                </div>
                            `).join('')}
                        </div>
                        ${recipe.directions ? `
                            <div class="recipe-directions">
                                <strong>Directions:</strong>
                                <p>${recipe.directions}</p>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load recipes:', err);
                showAlertInTab('recipes', 'Failed to load recipes: ' + err.message, 'error');
            }
        }
        
        function getUnitDisplay(unit) {
            switch(unit) {
                case 'oz': return 'oz';
                case 'dash': return 'dash(es)';
                case 'unit': return 'unit(s)';
                default: return 'oz';
            }
        }
        
        // Remove recipe
        async function removeRecipe(id) {
            if (!confirm('Are you sure you want to remove this recipe?')) return;
            
            try {
                const response = await fetch(`/admin/api/drink-mixer/recipes/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('recipes', result.message, 'success');
                    loadRecipes();
                } else {
                    showAlertInTab('recipes', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('recipes', 'Error removing recipe: ' + err.message, 'error');
            }
        }
        
        // Load available drinks
        async function loadAvailableDrinks() {
            try {
                const response = await fetch('/api/drink-mixer/available-drinks');
                const data = await response.json();
                
                const container = document.getElementById('availableDrinksList');
                if (data.availableDrinks.length === 0) {
                    container.innerHTML = `
                        <div class="no-items">
                            No drinks can be made with current available ingredients.<br>
                            <small>Total recipes: ${data.totalRecipes}</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #d4edda; border-radius: 6px; color: #155724;">
                        <strong>${data.availableCount}</strong> of <strong>${data.totalRecipes}</strong> drinks can be made
                    </div>
                    ${data.availableDrinks.map(drink => `
                        <div class="available-drink-item">
                            <div class="available-drink-name">${drink.name}</div>
                            <div class="available-drink-ingredients">
                                ${drink.ingredients.map(ing => `
                                    <div class="recipe-ingredient">
                                        <span class="recipe-ingredient-name">${ing.name}</span>
                                        <span class="recipe-ingredient-amount">${ing.amount || ing.ounces} ${getUnitDisplay(ing.unit || 'oz')}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ${drink.directions ? `
                                <div class="recipe-directions" style="margin-top: 0.5rem; font-size: 0.9rem;">
                                    <strong>Directions:</strong> ${drink.directions}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                `;
            } catch (err) {
                console.error('Failed to load available drinks:', err);
                showAlertInTab('available', 'Failed to load available drinks: ' + err.message, 'error');
            }
        }
        
        // Helper function to show alerts in tabs
        function showAlertInTab(tabName, message, type) {
            const alertId = `${tabName}Alert`;
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.textContent = message;
                alert.className = `alert alert-${type}`;
                alert.style.display = 'block';
                
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }
        
        // Initialize drink mixer data on page load
        function initializeDrinkMixer() {
            loadAlcohols(); // Load the default active tab
        }
        
        // Home Assistant Media Streaming Functions
        async function loadMediaStreamingConfig() {
            try {
                const response = await fetch('/admin/api/media-streaming/config');
                const config = await response.json();
                
                if (config.homeAssistant) {
                    const ha = config.homeAssistant;
                    document.getElementById('haEnabled').value = ha.enabled.toString();
                    document.getElementById('haUrl').value = ha.url || 'http://localhost:8123';
                    document.getElementById('haToken').value = ha.hasToken ? '••••••••••••' : '';
                    document.getElementById('haToken').dataset.hasToken = ha.hasToken.toString();
                    
                    if (ha.mediaPlayers) {
                        document.getElementById('mediaPlayersEnabled').value = ha.mediaPlayers.enabled.toString();
                        document.getElementById('refreshInterval').value = ha.mediaPlayers.refreshInterval || 5000;
                    }
                }
                
                // Load media status if enabled
                if (config.homeAssistant?.enabled && config.homeAssistant?.mediaPlayers?.enabled) {
                    loadMediaStreamingStatus();
                }
            } catch (error) {
                console.error('Error loading media streaming config:', error);
                showAlert('Failed to load media streaming configuration', 'error', 'mediaStreamingAlert');
            }
        }
        
        async function saveMediaStreamingConfig() {
            try {
                const tokenField = document.getElementById('haToken');
                let token = tokenField.value;
                
                // If showing masked token and user didn't change it, don't send it
                if (token === '••••••••••••' && tokenField.dataset.hasToken === 'true') {
                    token = undefined; // Don't update the token
                }
                
                const configData = {
                    homeAssistant: {
                        enabled: document.getElementById('haEnabled').value === 'true',
                        url: document.getElementById('haUrl').value,
                        mediaPlayers: {
                            enabled: document.getElementById('mediaPlayersEnabled').value === 'true',
                            refreshInterval: parseInt(document.getElementById('refreshInterval').value) || 5000
                        }
                    }
                };
                
                // Only include token if it was changed
                if (token !== undefined && token !== '••••••••••••') {
                    configData.homeAssistant.token = token;
                }
                
                const response = await fetch('/admin/api/media-streaming/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Media streaming configuration saved successfully!', 'success', 'mediaStreamingAlert');
                    loadMediaStreamingConfig(); // Reload to refresh display
                } else {
                    showAlert('Failed to save configuration: ' + result.error, 'error', 'mediaStreamingAlert');
                }
            } catch (error) {
                showAlert('Error saving configuration: ' + error.message, 'error', 'mediaStreamingAlert');
            }
        }
        
        async function testHomeAssistantConnection() {
            const testButton = document.getElementById('testHAConnection');
            const originalText = testButton.textContent;
            
            try {
                testButton.textContent = 'Testing...';
                testButton.disabled = true;
                
                const response = await fetch('/admin/api/media-streaming/test');
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`✅ Connection successful! ${result.message}`, 'success', 'mediaStreamingAlert');
                    loadMediaStreamingStatus(); // Refresh status display
                } else {
                    showAlert('❌ Connection failed: ' + result.error, 'error', 'mediaStreamingAlert');
                }
            } catch (error) {
                showAlert('❌ Test failed: ' + error.message, 'error', 'mediaStreamingAlert');
            } finally {
                testButton.textContent = originalText;
                testButton.disabled = false;
            }
        }
        
        async function loadMediaStreamingStatus() {
            try {
                const response = await fetch('/api/media-streaming');
                const result = await response.json();
                
                const container = document.getElementById('mediaStreamingStatus');
                
                if (!result.success) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc3545;">
                            <strong>Error:</strong> ${result.error}
                        </div>
                    `;
                    return;
                }
                
                const data = result.data;
                
                if (!data.hasActiveMedia && data.totalDevices === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            No media players found. Check your Home Assistant connection and configuration.
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="media-streaming-summary">
                        <h4>${data.hasActiveMedia ? '🎵 Media Currently Playing' : '⏸️ No Active Media'}</h4>
                        <p>${data.totalDevices} devices found • ${data.activeDevices} currently active</p>
                    </div>
                `;
                
                if (data.players.length > 0) {
                    html += `<div class="media-player-grid">`;
                    
                    data.players.forEach(player => {
                        const cardClass = player.isActive ? (player.state === 'playing' ? 'playing' : 'active') : '';
                        
                        html += `
                            <div class="media-player-card ${cardClass}">
                                <div class="media-player-header">
                                    <span class="media-player-name">${player.friendly_name}</span>
                                    <span class="media-player-type">${player.deviceType}</span>
                                </div>
                                <div class="media-player-status ${player.state}">${player.state}</div>
                        `;
                        
                        if (player.media_title || player.media_artist) {
                            html += `
                                <div class="media-info">
                                    ${player.media_title ? `<div class="media-title">${player.media_title}</div>` : ''}
                                    ${player.media_artist ? `<div class="media-artist">by ${player.media_artist}</div>` : ''}
                                    ${player.source ? `<div class="media-source">Source: ${player.source}</div>` : ''}
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                } else {
                    html += `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            All media players are currently idle.
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('mediaStreamingStatus');
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        Error loading media status: ${error.message}
                    </div>
                `;
            }
        }
        
        
        // Tournament management functions
        let currentTournament = null;
        
        async function loadTournaments() {
            try {
                const response = await fetch('/admin/api/tournaments');
                const tournaments = await response.json();
                
                const container = document.getElementById('tournamentsContainer');
                if (tournaments.length === 0) {
                    container.innerHTML = `
                        <div class="tournament-empty">
                            No tournaments created yet. Click "Create New Tournament" to get started.
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                tournaments.forEach(tournament => {
                    const statusClass = tournament.status;
                    const createdDate = new Date(tournament.createdAt).toLocaleDateString();
                    const winnerText = tournament.winner ? `Winner: ${tournament.winner.name}` : '';
                    
                    html += `
                        <div class="tournament-card ${statusClass}">
                            <div class="tournament-header">
                                <div>
                                    <div class="tournament-title">${escapeHtml(tournament.name)}</div>
                                    ${tournament.description ? `<div class="tournament-description">${escapeHtml(tournament.description)}</div>` : ''}
                                    <small style="color: #666;">Created: ${createdDate}</small>
                                </div>
                                <div class="tournament-status ${statusClass}">
                                    ${tournament.status}
                                </div>
                            </div>
                            
                            <div class="tournament-info">
                                <div class="tournament-stat">
                                    <div class="tournament-stat-value">${tournament.participants.length}</div>
                                    <div class="tournament-stat-label">Participants</div>
                                </div>
                                <div class="tournament-stat">
                                    <div class="tournament-stat-value">${tournament.maxParticipants}</div>
                                    <div class="tournament-stat-label">Max</div>
                                </div>
                                <div class="tournament-stat">
                                    <div class="tournament-stat-value">${tournament.currentRound || 0}</div>
                                    <div class="tournament-stat-label">Round</div>
                                </div>
                            </div>
                            
                            ${winnerText ? `<div style="text-align: center; color: #28a745; font-weight: 600; margin-bottom: 1rem;">${winnerText}</div>` : ''}
                            
                            <div class="tournament-actions">
                                <button class="btn btn-small" onclick="viewTournament(${tournament.id})">View Details</button>
                                ${tournament.status === 'setup' ? `<button class="btn btn-small btn-danger" onclick="deleteTournament(${tournament.id})">Delete</button>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                showTournamentAlert('Error loading tournaments: ' + error.message, 'error');
            }
        }
        
        function showTournamentAlert(message, type = 'info') {
            const alert = document.getElementById('tournamentAlert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alert.innerHTML = '';
            }, 5000);
        }
        
        function showTournamentModalAlert(message, type = 'info') {
            const alert = document.getElementById('tournamentModalAlert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }
        
        // Tournament modal functions
        function openTournamentModal() {
            document.getElementById('tournamentModal').style.display = 'block';
            document.getElementById('tournamentForm').reset();
            showTournamentModalAlert('');
        }
        
        function closeTournamentModal() {
            document.getElementById('tournamentModal').style.display = 'none';
        }
        
        function openTournamentDetailsModal() {
            document.getElementById('tournamentDetailsModal').style.display = 'block';
        }
        
        function closeTournamentDetailsModal() {
            document.getElementById('tournamentDetailsModal').style.display = 'none';
            currentTournament = null;
        }
        
        async function createTournament(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('tournamentName').value,
                description: document.getElementById('tournamentDescription').value,
                tournamentType: document.getElementById('tournamentType').value,
                maxParticipants: parseInt(document.getElementById('maxParticipants').value)
            };
            
            try {
                const response = await fetch('/admin/api/tournaments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showTournamentModalAlert('Tournament created successfully!', 'success');
                    setTimeout(() => {
                        closeTournamentModal();
                        loadTournaments();
                    }, 1500);
                } else {
                    showTournamentModalAlert(result.error || 'Failed to create tournament', 'error');
                }
            } catch (error) {
                showTournamentModalAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function viewTournament(tournamentId) {
            try {
                const response = await fetch(`/admin/api/tournaments/${tournamentId}`);
                currentTournament = await response.json();
                
                document.getElementById('tournamentDetailsTitle').textContent = currentTournament.name;
                
                // Update tournament info
                const infoHtml = `
                    <div class="tournament-info">
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">${currentTournament.status}</div>
                            <div class="tournament-stat-label">Status</div>
                        </div>
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">${currentTournament.participants.length}</div>
                            <div class="tournament-stat-label">Participants</div>
                        </div>
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">${currentTournament.maxParticipants}</div>
                            <div class="tournament-stat-label">Max</div>
                        </div>
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">${currentTournament.currentRound || 0}</div>
                            <div class="tournament-stat-label">Round</div>
                        </div>
                    </div>
                    ${currentTournament.description ? `<p style="margin-top: 1rem;"><strong>Description:</strong> ${escapeHtml(currentTournament.description)}</p>` : ''}
                `;
                document.getElementById('tournamentInfo').innerHTML = infoHtml;
                
                // Update participants
                updateParticipantsList();
                
                // Update bracket
                updateBracket();
                
                // Update tournament actions
                updateTournamentActions();
                
                openTournamentDetailsModal();
                
            } catch (error) {
                showTournamentAlert('Error loading tournament: ' + error.message, 'error');
            }
        }
        
        function updateParticipantsList() {
            const container = document.getElementById('participantsList');
            
            if (currentTournament.participants.length === 0) {
                container.innerHTML = '<div class="tournament-empty">No participants added yet.</div>';
                return;
            }
            
            let html = '<div class="participants-list">';
            currentTournament.participants.forEach(participant => {
                html += `
                    <div class="participant-item">
                        <div>
                            <div class="participant-name">${escapeHtml(participant.name)}</div>
                            ${participant.teamMembers && participant.teamMembers.length > 0 ? 
                                `<small style="color: #666;">Team: ${participant.teamMembers.join(', ')}</small>` : ''}
                        </div>
                        <div class="participant-stats">
                            W: ${participant.wins} | L: ${participant.losses}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        function updateBracket() {
            const container = document.getElementById('bracketContainer');
            
            if (!currentTournament.bracket || currentTournament.bracket.length === 0) {
                container.innerHTML = '<div class="tournament-empty">Bracket not generated yet.</div>';
                return;
            }
            
            let html = '<div class="bracket-rounds">';
            
            currentTournament.bracket.forEach(round => {
                html += `
                    <div class="bracket-round">
                        <div class="bracket-round-title">${round.name}</div>
                `;
                
                round.matches.forEach(match => {
                    const isCompleted = match.completed;
                    const canSetResult = currentTournament.status === 'active' && 
                                       match.participant1 && match.participant2 && !isCompleted;
                    
                    html += `
                        <div class="bracket-match ${isCompleted ? 'completed' : ''}">
                            <div class="bracket-participant ${isCompleted && match.winnerId === match.participant1?.id ? 'winner' : isCompleted ? 'loser' : ''}">
                                <span>${match.participant1 ? escapeHtml(match.participant1.name) : 'TBD'}</span>
                                ${isCompleted && match.score && match.winnerId === match.participant1?.id ? `<span class="match-score">${match.score}</span>` : ''}
                            </div>
                            <div class="bracket-participant ${isCompleted && match.winnerId === match.participant2?.id ? 'winner' : isCompleted ? 'loser' : match.score === 'BYE' ? 'bye' : ''}">
                                <span>${match.participant2 ? escapeHtml(match.participant2.name) : match.score === 'BYE' ? 'BYE' : 'TBD'}</span>
                                ${isCompleted && match.score && match.winnerId === match.participant2?.id ? `<span class="match-score">${match.score}</span>` : ''}
                            </div>
                            ${canSetResult ? `
                                <div class="match-actions">
                                    <button class="winner-btn" onclick="setMatchWinner(${match.id}, ${match.participant1.id})">
                                        ${escapeHtml(match.participant1.name)} Wins
                                    </button>
                                    <button class="winner-btn" onclick="setMatchWinner(${match.id}, ${match.participant2.id})">
                                        ${escapeHtml(match.participant2.name)} Wins
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function updateTournamentActions() {
            const container = document.getElementById('tournamentActions');
            let html = '';
            
            if (currentTournament.status === 'setup') {
                const canGenerate = currentTournament.participants.length >= 2;
                html += `
                    <button class="btn ${canGenerate ? '' : 'btn-secondary'}" 
                            onclick="generateBracket()" 
                            ${canGenerate ? '' : 'disabled'}>
                        Generate Bracket
                    </button>
                `;
            }
            
            container.innerHTML = html;
        }
        
        async function addParticipant() {
            const name = document.getElementById('participantName').value.trim();
            const teamMembersText = document.getElementById('teamMembers').value.trim();
            
            if (!name) {
                showTournamentAlert('Participant name is required', 'error');
                return;
            }
            
            if (currentTournament.participants.length >= currentTournament.maxParticipants) {
                showTournamentAlert('Tournament is full', 'error');
                return;
            }
            
            const teamMembers = teamMembersText ? teamMembersText.split(',').map(m => m.trim()).filter(m => m) : [];
            
            try {
                const response = await fetch(`/admin/api/tournaments/${currentTournament.id}/participants`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, teamMembers })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTournament = result.tournament;
                    updateParticipantsList();
                    updateTournamentActions();
                    
                    // Clear form
                    document.getElementById('participantName').value = '';
                    document.getElementById('teamMembers').value = '';
                    
                    showTournamentAlert('Participant added successfully!', 'success');
                } else {
                    showTournamentAlert(result.error || 'Failed to add participant', 'error');
                }
            } catch (error) {
                showTournamentAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function generateBracket() {
            try {
                const response = await fetch(`/admin/api/tournaments/${currentTournament.id}/generate-bracket`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTournament = result.tournament;
                    updateBracket();
                    updateTournamentActions();
                    showTournamentAlert('Tournament bracket generated successfully!', 'success');
                    loadTournaments(); // Refresh the main list
                } else {
                    showTournamentAlert(result.error || 'Failed to generate bracket', 'error');
                }
            } catch (error) {
                showTournamentAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function setMatchWinner(matchId, winnerId) {
            const score = prompt('Enter score (optional):');
            
            try {
                const response = await fetch(`/admin/api/tournaments/${currentTournament.id}/matches/${matchId}/result`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ winnerId, score: score || null })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTournament = result.tournament;
                    updateBracket();
                    updateParticipantsList();
                    
                    if (result.roundComplete) {
                        if (currentTournament.status === 'completed' && currentTournament.winner) {
                            showTournamentAlert(`Tournament completed! Winner: ${currentTournament.winner.name}`, 'success');
                        } else {
                            showTournamentAlert('Round completed! Tournament advanced to next round.', 'success');
                        }
                    } else {
                        showTournamentAlert('Match result updated successfully!', 'success');
                    }
                    
                    loadTournaments(); // Refresh the main list
                } else {
                    showTournamentAlert(result.error || 'Failed to update match result', 'error');
                }
            } catch (error) {
                showTournamentAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function deleteTournament(tournamentId) {
            if (!confirm('Are you sure you want to delete this tournament? This action cannot be undone.')) {
                return;
            }
            
            // Since we don't have a delete endpoint yet, we'll implement it
            showTournamentAlert('Delete functionality not implemented yet', 'warning');
        }
        
        // Initialize tournament functionality
        function initializeTournaments() {
            // Add event listeners
            document.getElementById('createTournamentBtn').addEventListener('click', openTournamentModal);
            document.getElementById('refreshTournaments').addEventListener('click', loadTournaments);
            document.getElementById('tournamentForm').addEventListener('submit', createTournament);
            document.getElementById('addParticipantBtn').addEventListener('click', addParticipant);
            
            // Load tournaments on init
            loadTournaments();
        }
        
        // Initialize the admin interface
        initializeAdmin();
        
        // Initialize tournaments
        initializeTournaments();
        
        // Refresh status every 30 seconds
        setInterval(loadStatus, 30000);
        
        // Refresh client configuration and connected devices every 30 seconds
        setInterval(loadClientConfig, 30000);
        
        // Refresh client storage stats every 60 seconds
        setInterval(loadClientStorageStats, 60000);
        
        // Refresh media streaming status every 10 seconds (configurable)
        setInterval(loadMediaStreamingStatus, 10000);

        // Tab Management Functions
        function showMainTab(tabName) {
            // Remove active class from all main tabs
            const mainTabs = document.querySelectorAll('.main-tab');
            mainTabs.forEach(tab => tab.classList.remove('active'));
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Hide all sections
            const allSections = document.querySelectorAll('.admin-section');
            allSections.forEach(section => section.classList.add('hidden'));
            
            // Hide all sub-tabs
            const subTabs = document.querySelectorAll('.sub-tabs');
            subTabs.forEach(subTab => subTab.classList.remove('active'));
            
            // Show sections for the selected tab
            if (tabName === 'dashboard') {
                const dashboardSections = document.querySelectorAll('.dashboard-section');
                dashboardSections.forEach(section => section.classList.remove('hidden'));
                
                // Load dashboard data
                loadStatus();
                loadLogs();
            } else if (tabName === 'clients') {
                const clientsSections = document.querySelectorAll('.clients-section');
                clientsSections.forEach(section => section.classList.remove('hidden'));
                
                // Load clients data
                loadClientConfig();
                loadClientFiles();
                loadClientStorageStats();
            } else if (tabName === 'party') {
                // Show sub-tabs for party
                const partySubTabs = document.getElementById('party-subtabs');
                if (partySubTabs) {
                    partySubTabs.classList.add('active');
                }
                
                // Show default sub-tab (useful links)
                showSubTab('party-links', true);
            } else if (tabName === 'server') {
                // Show sub-tabs for server
                const serverSubTabs = document.getElementById('server-subtabs');
                if (serverSubTabs) {
                    serverSubTabs.classList.add('active');
                }
                
                // Show default sub-tab (vidiots)
                showSubTab('server-vidiots', true);
            } else if (tabName === 'settings') {
                const settingsSections = document.querySelectorAll('.settings-section');
                settingsSections.forEach(section => section.classList.remove('hidden'));
                
                // Load settings data
                loadConfig();
                setupStorageSlider();
                loadMediaStreamingConfig();
            }
        }

        function showSubTab(subTabName, shouldLoadData = true) {
            // Remove active class from all sub-tabs
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => tab.classList.remove('active'));
            
            // Add active class to clicked sub-tab
            if (shouldLoadData && event && event.target) {
                // If we have a click event, use the clicked element
                event.target.classList.add('active');
            } else {
                // Find the correct sub-tab based on subTabName and activate it
                let targetTabText = '';
                if (subTabName === 'party-links') targetTabText = 'Useful Links';
                else if (subTabName === 'party-drinks') targetTabText = 'Drinks';
                else if (subTabName === 'party-tournament') targetTabText = 'Tournament';
                else if (subTabName === 'server-vidiots') targetTabText = 'Vidiots';
                else if (subTabName === 'server-espresso') targetTabText = 'Espresso';
                else if (subTabName === 'server-github') targetTabText = 'GitHub';
                
                if (targetTabText) {
                    const targetTab = Array.from(subTabs).find(tab => tab.textContent.trim() === targetTabText);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                }
            }
            
            // Hide all party and server sections
            const partySections = document.querySelectorAll('.party-section');
            partySections.forEach(section => section.classList.add('hidden'));
            const serverSections = document.querySelectorAll('.server-section');
            serverSections.forEach(section => section.classList.add('hidden'));
            
            // Show the selected sub-tab sections
            if (subTabName === 'party-links') {
                const linksSections = document.querySelectorAll('.party-links-section');
                linksSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadLinks();
                }
            } else if (subTabName === 'party-drinks') {
                const drinksSections = document.querySelectorAll('.party-drinks-section');
                drinksSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    initializeDrinkMixer();
                }
            } else if (subTabName === 'party-tournament') {
                const tournamentSections = document.querySelectorAll('.party-tournament-section');
                tournamentSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadTournaments();
                }
            } else if (subTabName === 'server-vidiots') {
                const vidiotsSections = document.querySelectorAll('.server-vidiots-section');
                vidiotsSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadVidiotsConfig();
                    loadVidiotsStatus();
                }
            } else if (subTabName === 'server-espresso') {
                const espressoSections = document.querySelectorAll('.server-espresso-section');
                espressoSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadEspressoConfig();
                    loadEspressoStatus();
                    loadEspressoTemplateFiles();
                    loadEspressoData(); // Load the espresso data for editing
                }
            } else if (subTabName === 'server-github') {
                const githubSections = document.querySelectorAll('.server-github-section');
                githubSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadVidiotsConfig(); // Still need to load config for GitHub settings
                    initializeGitHubSection(); // Initialize GitHub logging and load git identity
                }
            }
        }

        // Template Source Selection Functions
        function toggleTemplateSourceMethod() {
            const uploadRadio = document.getElementById('templateSourceUpload');
            const gitRadio = document.getElementById('templateSourceGit');
            const uploadSection = document.getElementById('templateUploadSection');
            const gitSection = document.getElementById('templateGitSection');
            
            if (uploadRadio.checked) {
                uploadSection.style.display = 'block';
                gitSection.style.display = 'none';
                console.log('Switched to file upload method');
            } else if (gitRadio.checked) {
                uploadSection.style.display = 'none';
                gitSection.style.display = 'block';
                console.log('Switched to git repository method');
            } else {
                uploadSection.style.display = 'none';
                gitSection.style.display = 'none';
            }
        }
        
        // Initialize template source selection on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Default to upload method
            const uploadRadio = document.getElementById('templateSourceUpload');
            if (uploadRadio) {
                uploadRadio.checked = true;
                toggleTemplateSourceMethod();
            }
        });

        // Clone espresso template repository
        async function cloneEspressoTemplateRepo() {
            const repoUrlInput = document.getElementById('espressoGitRepoUrl');
            const branchInput = document.getElementById('espressoGitBranch');
            const localPathInput = document.getElementById('espressoGitLocalPath');
            const cloneBtn = document.getElementById('cloneTemplateBtn');
            
            const repoUrl = repoUrlInput.value.trim();
            const branch = branchInput.value.trim() || 'main';
            const localPath = localPathInput.value.trim();
            
            if (!repoUrl) {
                showAlert('Repository URL is required', 'error', 'espressoTemplateAlert');
                return;
            }
            
            if (!localPath) {
                showAlert('Local clone path is required', 'error', 'espressoTemplateAlert');
                return;
            }
            
            try {
                // Set button loading state
                cloneBtn.disabled = true;
                cloneBtn.innerHTML = '🔄 Cloning...';
                
                showAlert('Cloning template repository...', 'success', 'espressoTemplateAlert');
                
                const response = await fetch('/admin/api/espresso/clone-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        repoUrl: repoUrl,
                        branch: branch,
                        localPath: localPath
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const actionText = result.action === 'cloned' ? 'cloned' : 'updated';
                    const fileText = result.filesCopied > 0 ? ` (${result.filesCopied} files copied)` : '';
                    showAlert(`Repository ${actionText} successfully${fileText}`, 'success', 'espressoTemplateAlert');
                    
                    // Refresh template files list
                    await loadEspressoTemplateFiles();
                    await loadEspressoStatus(); // Refresh status to show template is available
                    
                    // Refresh template path and image mapping UI
                    await loadEspressoTemplatePath();
                    const currentConfig = await getCurrentEspressoConfig();
                    await loadEspressoImageMapping(currentConfig.imagePaths || {});
                    
                } else {
                    showAlert('Failed to clone repository: ' + result.error, 'error', 'espressoTemplateAlert');
                }
                
            } catch (error) {
                showAlert('Error cloning repository: ' + error.message, 'error', 'espressoTemplateAlert');
            } finally {
                // Reset button state
                cloneBtn.disabled = false;
                cloneBtn.innerHTML = 'Clone Repository';
            }
        }

        // Vidiots Functions
        async function loadVidiotsConfig() {
            try {
                const response = await fetch('/admin/api/vidiots/config');
                const result = await response.json();
                
                if (result.success && result.config) {
                    const config = result.config;
                    document.getElementById('vidiotsEnabled').value = config.enabled ? 'true' : 'false';
                    document.getElementById('vidiotsCronSchedule').value = config.cronSchedule || '0 6,12 * * *';
                    document.getElementById('vidiotsOutputFile').value = config.outputFile || './public/vidiots/index.html';
                    document.getElementById('vidiotsPosterDirectory').value = config.posterDirectory || './public/vidiots/posters';
                    document.getElementById('vidiotsPosterBaseUrl').value = config.posterBaseUrl || '/vidiots/posters/';
                    document.getElementById('vidiotsMaxAgeHours').value = config.maxAgeHours || 24;
                    document.getElementById('vidiotsForceUpdate').value = config.forceUpdate ? 'true' : 'false';
                    
                    // GitHub Pages configuration
                    const githubConfig = config.githubPages || {};
                    document.getElementById('vidiotsGithubEnabled').value = githubConfig.enabled ? 'true' : 'false';
                    document.getElementById('vidiotsRepoOwner').value = githubConfig.repoOwner || '';
                    document.getElementById('vidiotsRepoName').value = githubConfig.repoName || '';
                    document.getElementById('vidiotsRepoBranch').value = githubConfig.branch || 'main';
                    document.getElementById('vidiotsRepoLocalPath').value = githubConfig.repoLocalPath || '';
                    document.getElementById('vidiotsCommitMessage').value = githubConfig.commitMessage || 'Automated vidiots update';
                    document.getElementById('vidiotsAccessToken').value = githubConfig.accessToken ? '••••••••••••••••••••' : '';
                    document.getElementById('vidiotsAccessToken').dataset.hasToken = (githubConfig.accessToken ? 'true' : 'false');
                    
                    // Show/hide GitHub config based on enabled status
                    toggleGitHubConfig();
                } else {
                    showAlert('Failed to load vidiots configuration: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                showAlert('Error loading vidiots configuration: ' + error.message, 'error', 'vidiotsAlert');
            }
        }

        async function saveVidiotsConfig() {
            try {
                const config = {
                    enabled: document.getElementById('vidiotsEnabled').value === 'true',
                    cronSchedule: document.getElementById('vidiotsCronSchedule').value.trim() || '0 6,12 * * *',
                    outputFile: document.getElementById('vidiotsOutputFile').value.trim() || './public/vidiots/index.html',
                    posterDirectory: document.getElementById('vidiotsPosterDirectory').value.trim() || './public/vidiots/posters',
                    posterBaseUrl: document.getElementById('vidiotsPosterBaseUrl').value.trim() || '/vidiots/posters/',
                    maxAgeHours: parseInt(document.getElementById('vidiotsMaxAgeHours').value) || 24,
                    forceUpdate: document.getElementById('vidiotsForceUpdate').value === 'true',
                    githubPages: {
                        enabled: document.getElementById('vidiotsGithubEnabled').value === 'true',
                        repoOwner: document.getElementById('vidiotsRepoOwner').value.trim(),
                        repoName: document.getElementById('vidiotsRepoName').value.trim(),
                        branch: document.getElementById('vidiotsRepoBranch').value.trim() || 'main',
                        repoLocalPath: document.getElementById('vidiotsRepoLocalPath').value.trim(),
                        commitMessage: document.getElementById('vidiotsCommitMessage').value.trim() || 'Automated vidiots update'
                    }
                };
                
                // Handle access token separately (similar to Home Assistant token)
                const accessTokenField = document.getElementById('vidiotsAccessToken');
                let accessToken = accessTokenField.value;
                
                // If showing masked token and user didn't change it, don't send it
                if (accessToken === '••••••••••••••••••••' && accessTokenField.dataset.hasToken === 'true') {
                    accessToken = undefined; // Don't update the token
                }
                
                // Only include access token if it was changed or is new
                if (accessToken !== undefined && accessToken !== '••••••••••••••••••••' && accessToken.trim() !== '') {
                    config.githubPages.accessToken = accessToken.trim();
                }

                const response = await fetch('/admin/api/vidiots/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ vidiots: config })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'Vidiots configuration saved successfully', 'success', 'vidiotsAlert');
                    loadVidiotsStatus(); // Refresh status after config change
                    markSaved('GitHub Repository Settings'); // Clear unsaved changes
                } else {
                    showAlert('Failed to save vidiots configuration: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                showAlert('Error saving vidiots configuration: ' + error.message, 'error', 'vidiotsAlert');
            }
        }

        async function loadVidiotsStatus() {
            try {
                const response = await fetch('/admin/api/vidiots/status');
                const result = await response.json();
                
                if (result.success && result.status) {
                    const status = result.status;
                    let statusText = `Enabled: ${status.enabled ? 'Yes' : 'No'}\n`;
                    statusText += `Schedule: ${status.cronSchedule}\n`;
                    statusText += `Cron Job Running: ${status.isRunning ? 'Yes' : 'No'}\n`;
                    statusText += `Output File: ${status.outputFile}\n`;
                    statusText += `File Exists: ${status.fileExists ? 'Yes' : 'No'}\n`;
                    if (status.fileExists) {
                        statusText += `File Size: ${(status.fileSize / 1024).toFixed(1)} KB\n`;
                        statusText += `Last Modified: ${status.lastModified ? new Date(status.lastModified).toLocaleString() : 'Unknown'}\n`;
                    }
                    statusText += `\n--- GitHub Pages ---\n`;
                    statusText += `GitHub Pages: ${status.githubPages.enabled ? 'Enabled' : 'Disabled'}\n`;
                    if (status.githubPages.enabled) {
                        statusText += `Repository: ${status.githubPages.repoOwner}/${status.githubPages.repoName}\n`;
                        statusText += `Local Path: ${status.githubPages.repoLocalPath || 'Not configured'}\n`;
                    }
                    
                    document.getElementById('vidiotsStatus').textContent = statusText;
                } else {
                    document.getElementById('vidiotsStatus').textContent = 'Error loading status: ' + (result.error || 'Unknown error');
                }
            } catch (error) {
                document.getElementById('vidiotsStatus').textContent = 'Error loading status: ' + error.message;
            }
        }

        async function testVidiotsScrape() {
            try {
                showAlert('Starting vidiots scrape test...', 'success', 'vidiotsAlert');
                document.getElementById('vidiotsStatus').textContent = 'Running scrape test... This may take up to 60 seconds.';
                
                const response = await fetch('/admin/api/vidiots/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'Scrape test completed successfully', 'success', 'vidiotsAlert');
                } else {
                    showAlert('Scrape test failed: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
                
                // Refresh status after test
                setTimeout(loadVidiotsStatus, 2000);
            } catch (error) {
                showAlert('Error running scrape test: ' + error.message, 'error', 'vidiotsAlert');
                setTimeout(loadVidiotsStatus, 2000);
            }
        }

        // ================================================================
        // ESPRESSO CONFIGURATION FUNCTIONS
        // ================================================================

        async function loadEspressoConfig() {
            try {
                const response = await fetch('/admin/api/espresso/config');
                const result = await response.json();
                
                if (result.success) {
                    const config = result.config;
                    document.getElementById('espressoEnabled').value = config.enabled ? 'true' : 'false';
                    document.getElementById('espressoDataFilePath').value = config.dataFilePath || '';
                    document.getElementById('espressoOutputPath').value = config.outputPath || '';
                    // Load local repository settings
                    document.getElementById('espressoSaveToRepo').value = config.localRepo?.enabled ? 'true' : 'false';
                    document.getElementById('espressoLocalOutputPath').value = config.localRepo?.outputPath || 'espresso/index.html';
                    document.getElementById('espressoLocalImagePath').value = config.localRepo?.imagePath || 'espresso/images';
                    
                    // Update repository status
                    updateEspressoRepoStatus();
                    
                    // Load template path info
                    await loadEspressoTemplatePath();
                    
                    // Load image mapping UI
                    await loadEspressoImageMapping(config.imagePaths || {});
                    
                    // Load status as well
                    loadEspressoStatus();
                }
            } catch (error) {
                showAlert('Error loading espresso configuration: ' + error.message, 'error', 'espressoAlert');
            }
        }

        async function saveEspressoConfig() {
            try {
                // Collect image paths from new UI
                const imagePaths = collectImagePaths();

                const config = {
                    enabled: document.getElementById('espressoEnabled').value === 'true',
                    dataFilePath: document.getElementById('espressoDataFilePath').value.trim() || './config/espresso-data.json',
                    templatePath: document.getElementById('espressoTemplatePath').value.trim(),
                    outputPath: document.getElementById('espressoOutputPath').value.trim() || './public/espresso/index.html',
                    imagePaths: imagePaths,
                    localRepo: {
                        enabled: document.getElementById('espressoSaveToRepo').value === 'true',
                        outputPath: document.getElementById('espressoLocalOutputPath').value.trim() || 'espresso/index.html',
                        imagePath: document.getElementById('espressoLocalImagePath').value.trim() || 'espresso/images'
                    }
                };

                const response = await fetch('/admin/api/espresso/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ espresso: config })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'Espresso configuration saved successfully', 'success', 'espressoAlert');
                    loadEspressoStatus(); // Refresh status after config change
                    markSaved('Espresso Configuration'); // Clear unsaved changes
                } else {
                    showAlert('Failed to save espresso configuration: ' + (result.error || 'Unknown error'), 'error', 'espressoAlert');
                }
            } catch (error) {
                showAlert('Error saving espresso configuration: ' + error.message, 'error', 'espressoAlert');
            }
        }

        async function loadEspressoStatus() {
            try {
                const response = await fetch('/admin/api/espresso/status');
                const result = await response.json();
                
                if (result.success && result.status) {
                    const status = result.status;
                    let statusText = `Enabled: ${status.enabled ? 'Yes' : 'No'}\n`;
                    statusText += `Data File: ${status.dataFile ? 'Exists' : 'Missing'}\n`;
                    statusText += `Template File: ${status.templateFile ? 'Exists' : 'Missing'}\n`;
                    statusText += `Output File: ${status.outputFile ? 'Exists' : 'Missing'}\n`;
                    statusText += `GitHub Enabled: ${status.githubEnabled ? 'Yes' : 'No'}\n`;
                    if (status.lastUpdated) {
                        statusText += `Last Updated: ${new Date(status.lastUpdated).toLocaleString()}\n`;
                    }
                    
                    document.getElementById('espressoStatus').textContent = statusText;
                } else {
                    document.getElementById('espressoStatus').textContent = 'Status unavailable';
                }
            } catch (error) {
                document.getElementById('espressoStatus').textContent = 'Error loading status: ' + error.message;
            }
        }

        async function testEspressoGeneration() {
            try {
                showAlert('Starting espresso HTML generation test...', 'success', 'espressoAlert');
                document.getElementById('espressoStatus').textContent = 'Running HTML generation test...';
                
                const response = await fetch('/admin/api/espresso/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'HTML generation test completed successfully', 'success', 'espressoAlert');
                } else {
                    showAlert('HTML generation test failed: ' + (result.error || 'Unknown error'), 'error', 'espressoAlert');
                }
                
                // Refresh status after test
                setTimeout(loadEspressoStatus, 2000);
            } catch (error) {
                showAlert('Error running HTML generation test: ' + error.message, 'error', 'espressoAlert');
                setTimeout(loadEspressoStatus, 2000);
            }
        }

        async function uploadEspressoToGitHub() {
            try {
                // Set loading state
                setButtonLoading('uploadEspressoBtn', true);
                showAlert('Uploading espresso content to GitHub Pages...', 'success', 'espressoAlert');
                
                const response = await fetch('/admin/api/espresso/github/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Successfully uploaded to GitHub Pages! (${result.filesUploaded || 0} files, ${result.imagesUploaded || 0} images)`, 'success', 'espressoAlert');
                } else {
                    showAlert('Failed to upload to GitHub Pages: ' + (result.error || 'Unknown error'), 'error', 'espressoAlert');
                }
            } catch (error) {
                showAlert('Error uploading to GitHub Pages: ' + error.message, 'error', 'espressoAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('uploadEspressoBtn', false);
            }
        }

        // Function to update repository status in espresso tab
        async function updateEspressoRepoStatus() {
            try {
                // Get GitHub configuration from the main config
                const response = await fetch('/admin/api/vidiots/config');
                const result = await response.json();
                
                if (result.success && result.config.githubPages) {
                    const github = result.config.githubPages;
                    const statusElement = document.getElementById('espressoRepoStatusText');
                    
                    if (github.repoOwner && github.repoName && github.repoLocalPath) {
                        statusElement.innerHTML = `✅ Connected to <strong>${github.repoOwner}/${github.repoName}</strong> (${github.branch || 'main'}) at <code>${github.repoLocalPath}</code>`;
                        statusElement.style.color = '#28a745';
                        
                        // Enable save to repo option if repository is configured
                        document.getElementById('espressoSaveToRepo').disabled = false;
                    } else {
                        statusElement.innerHTML = '⚠️ Repository not configured in GitHub tab. Please configure repository settings in the GitHub tab first.';
                        statusElement.style.color = '#ffc107';
                        
                        // Disable save to repo option if repository is not configured
                        document.getElementById('espressoSaveToRepo').value = 'false';
                        document.getElementById('espressoSaveToRepo').disabled = true;
                    }
                } else {
                    document.getElementById('espressoRepoStatusText').innerHTML = '❌ Unable to connect to GitHub configuration.';
                    document.getElementById('espressoRepoStatusText').style.color = '#dc3545';
                }
            } catch (error) {
                document.getElementById('espressoRepoStatusText').innerHTML = `❌ Error: ${error.message}`;
                document.getElementById('espressoRepoStatusText').style.color = '#dc3545';
            }
        }

        // Function to refresh repository status
        async function refreshEspressoRepoStatus() {
            await updateEspressoRepoStatus();
            showAlert('Repository status refreshed', 'info', 'espressoAlert');
        }

        // Helper function to get current config
        async function getCurrentEspressoConfig() {
            try {
                const response = await fetch('/admin/api/espresso/config');
                const result = await response.json();
                return result.success ? result.config : {};
            } catch (error) {
                console.error('Error getting current config:', error);
                return {};
            }
        }

        // Espresso Template Upload Functions
        async function uploadEspressoTemplate() {
            const fileInput = document.getElementById('espressoTemplateFile');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showAlert('Please select at least one file to upload', 'error', 'espressoTemplateAlert');
                return;
            }
            
            try {
                // Upload files one by one
                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    const formData = new FormData();
                    formData.append('templateFile', file);
                    
                    showAlert(`Uploading ${file.name}...`, 'success', 'espressoTemplateAlert');
                    
                    const response = await fetch('/admin/api/espresso/upload-template', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        showAlert(`Failed to upload ${file.name}: ${result.error}`, 'error', 'espressoTemplateAlert');
                        return;
                    }
                }
                
                showAlert('All files uploaded successfully!', 'success', 'espressoTemplateAlert');
                
                // Clear file input and refresh file list
                fileInput.value = '';
                await loadEspressoTemplateFiles();
                await loadEspressoStatus(); // Refresh status to show template is available
                
                // Refresh template path and image mapping UI
                await loadEspressoTemplatePath();
                const currentConfig = await getCurrentEspressoConfig();
                await loadEspressoImageMapping(currentConfig.imagePaths || {});
                
            } catch (error) {
                showAlert('Error uploading files: ' + error.message, 'error', 'espressoTemplateAlert');
            }
        }
        
        async function loadEspressoTemplateFiles() {
            try {
                const response = await fetch('/admin/api/espresso/template-files');
                const result = await response.json();
                
                const filesContainer = document.getElementById('espressoTemplateFiles');
                
                if (result.success && result.files && result.files.length > 0) {
                    let filesHtml = '<h5>📁 Uploaded Template Files:</h5><div class="template-files-list">';
                    
                    result.files.forEach(file => {
                        const fileIcon = file.type === 'image' ? '🖼️' : '📄';
                        const uploadDate = new Date(file.uploadDate).toLocaleString();
                        const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                        
                        filesHtml += `
                            <div class="template-file-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: #fff; border: 1px solid #ddd; border-radius: 4px;">
                                <div>
                                    <strong>${fileIcon} ${file.name}</strong>
                                    <small style="color: #666; margin-left: 10px;">${fileSize} • ${uploadDate}</small>
                                </div>
                                <button onclick="deleteEspressoTemplateFile('${file.name}')" class="btn btn-sm btn-danger">Delete</button>
                            </div>
                        `;
                    });
                    
                    filesHtml += '</div>';
                    filesContainer.innerHTML = filesHtml;
                } else {
                    filesContainer.innerHTML = '<p style="color: #666;"><em>No template files uploaded yet</em></p>';
                }
            } catch (error) {
                console.error('Error loading template files:', error);
                document.getElementById('espressoTemplateFiles').innerHTML = '<p style="color: red;">Error loading template files</p>';
            }
        }
        
        async function deleteEspressoTemplateFile(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/espresso/template-files/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`File deleted: ${filename}`, 'success', 'espressoTemplateAlert');
                    await loadEspressoTemplateFiles();
                    await loadEspressoStatus(); // Refresh status
                    
                    // Refresh template path and image mapping UI
                    await loadEspressoTemplatePath();
                    const currentConfig = await getCurrentEspressoConfig();
                    await loadEspressoImageMapping(currentConfig.imagePaths || {});
                } else {
                    showAlert(`Failed to delete file: ${result.error}`, 'error', 'espressoTemplateAlert');
                }
            } catch (error) {
                showAlert('Error deleting file: ' + error.message, 'error', 'espressoTemplateAlert');
            }
        }

        // Load template path information and update UI
        async function loadEspressoTemplatePath() {
            try {
                const response = await fetch('/admin/api/espresso/template-path');
                const result = await response.json();
                
                if (result.success) {
                    const templatePath = result.templatePath;
                    const templatePathElement = document.getElementById('espressoTemplatePath');
                    const statusElement = document.getElementById('espressoTemplatePathStatus');
                    
                    if (templatePath.uploadedExists) {
                        if (templatePath.isUploaded) {
                            templatePathElement.value = 'Uploaded: index.html';
                            statusElement.textContent = '✅ Using uploaded template';
                            statusElement.style.color = '#28a745';
                        } else {
                            templatePathElement.value = templatePath.currentPath || '';
                            statusElement.textContent = '⚠️ Uploaded template available but configured path is used';
                            statusElement.style.color = '#ffc107';
                        }
                    } else {
                        templatePathElement.value = templatePath.currentPath || '';
                        if (templatePath.currentPath) {
                            statusElement.textContent = '📁 Using configured template path';
                            statusElement.style.color = '#17a2b8';
                        } else {
                            statusElement.textContent = '❌ No template found - please upload or configure path';
                            statusElement.style.color = '#dc3545';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading template path:', error);
            }
        }

        // Load image mapping UI
        async function loadEspressoImageMapping(currentImagePaths = {}) {
            try {
                const response = await fetch('/admin/api/espresso/available-images');
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('espressoImageMapping');
                    const images = result.images;
                    
                    // Known image identifiers from template
                    const knownImageIds = ['smallcontainer', 'mediumcontainer', 'largecontainer'];
                    
                    let html = '<div style="margin-bottom: 15px;"><strong>Configure Image Mapping:</strong></div>';
                    
                    knownImageIds.forEach(imageId => {
                        const currentValue = currentImagePaths[imageId] || '';
                        html += `
                            <div class="image-mapping-row" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="margin-bottom: 8px; font-weight: bold;">
                                    Image ID: <code>${imageId}</code>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <label style="font-size: 12px; color: #666;">Select Uploaded Image:</label>
                                        <select class="image-select" data-image-id="${imageId}" style="width: 100%; margin-top: 2px;">
                                            <option value="">-- Select Image --</option>
                                            ${images.map(img => `
                                                <option value="/uploads/espresso/templates/${img.filename}" ${currentValue === `/uploads/espresso/templates/${img.filename}` ? 'selected' : ''}>
                                                    ${img.filename} (${(img.size / 1024).toFixed(1)}KB)
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div style="color: #666; font-size: 14px; padding: 0 10px;">OR</div>
                                    <div style="flex: 1; min-width: 200px;">
                                        <label style="font-size: 12px; color: #666;">Absolute URL:</label>
                                        <input type="url" class="image-url" data-image-id="${imageId}" placeholder="https://example.com/image.jpg" 
                                               value="${currentValue.startsWith('http') ? currentValue : ''}" 
                                               style="width: 100%; margin-top: 2px;">
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (images.length === 0) {
                        html += '<div style="padding: 20px; text-align: center; color: #666; border: 2px dashed #ddd; border-radius: 4px;"><i>No uploaded images found. Upload image files in the Template Upload section above.</i></div>';
                    }
                    
                    container.innerHTML = html;
                    
                    // Add event listeners for dynamic updates
                    container.addEventListener('change', handleImageMappingChange);
                    container.addEventListener('input', handleImageMappingChange);
                }
            } catch (error) {
                console.error('Error loading image mapping:', error);
                document.getElementById('espressoImageMapping').innerHTML = 
                    '<div style="color: #dc3545; text-align: center; padding: 20px;"><i>Error loading image configuration</i></div>';
            }
        }

        // Handle changes in image mapping controls
        function handleImageMappingChange(event) {
            const target = event.target;
            const imageId = target.dataset.imageId;
            
            if (!imageId) return;
            
            const row = target.closest('.image-mapping-row');
            const selectElement = row.querySelector('.image-select');
            const urlElement = row.querySelector('.image-url');
            
            if (target.classList.contains('image-select')) {
                // Clear URL field when selecting an uploaded image
                if (target.value) {
                    urlElement.value = '';
                }
            } else if (target.classList.contains('image-url')) {
                // Clear select field when entering URL
                if (target.value) {
                    selectElement.value = '';
                }
            }
        }

        // Collect image paths from the new UI for saving
        function collectImagePaths() {
            const imagePaths = {};
            const container = document.getElementById('espressoImageMapping');
            
            container.querySelectorAll('.image-mapping-row').forEach(row => {
                const imageId = row.querySelector('.image-select').dataset.imageId;
                const selectedImage = row.querySelector('.image-select').value;
                const enteredUrl = row.querySelector('.image-url').value.trim();
                
                if (selectedImage) {
                    imagePaths[imageId] = selectedImage;
                } else if (enteredUrl) {
                    imagePaths[imageId] = enteredUrl;
                }
            });
            
            return imagePaths;
        }

        // ================================================================
        // ESPRESSO DATA EDITOR FUNCTIONS
        // ================================================================

        // Global variable to store current espresso data
        let currentEspressoData = {};

        // Load espresso data for editing
        async function loadEspressoData() {
            try {
                const response = await fetch('/admin/api/espresso/data');
                const result = await response.json();
                
                if (result.success) {
                    currentEspressoData = result.data || {};
                    renderEspressoDataForm();
                    showAlert('Espresso data loaded successfully', 'success', 'espressoDataAlert');
                } else {
                    showAlert('Failed to load espresso data: ' + (result.error || 'Unknown error'), 'error', 'espressoDataAlert');
                }
            } catch (error) {
                showAlert('Error loading espresso data: ' + error.message, 'error', 'espressoDataAlert');
            }
        }

        // Render the espresso data editing form
        function renderEspressoDataForm() {
            const container = document.getElementById('espressoDataContainer');
            
            // Define the data structure for each espresso
            const espressos = [
                { id: 1, title: 'Espresso 1' },
                { id: 2, title: 'Espresso 2' }, 
                { id: 3, title: 'Espresso 3' }
            ];

            let html = '';

            espressos.forEach(espresso => {
                const id = espresso.id;
                html += `
                    <div class="espresso-data-section" style="background: #f9f9f9; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #8B4513;">
                        <h3 style="color: #8B4513; margin-bottom: 15px;">${espresso.title}</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="beanName${id}">Bean Name</label>
                                <input type="text" id="beanName${id}" value="${currentEspressoData['beanName' + id] || ''}" placeholder="e.g., Ethiopian Yirgacheffe">
                            </div>
                            <div class="form-group">
                                <label for="roastDate${id}">Roast Date</label>
                                <input type="text" id="roastDate${id}" value="${currentEspressoData['roastDate' + id] || ''}" placeholder="e.g., Jan 2025">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="weight${id}">Weight In</label>
                                <input type="text" id="weight${id}" value="${currentEspressoData['weight' + id] || ''}" placeholder="e.g., 15g">
                            </div>
                            <div class="form-group">
                                <label for="grind${id}">Grind Size</label>
                                <input type="text" id="grind${id}" value="${currentEspressoData['grind' + id] || ''}" placeholder="e.g., 0.5">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tempIn${id}">Temperature</label>
                                <input type="text" id="tempIn${id}" value="${currentEspressoData['tempIn' + id] || ''}" placeholder="e.g., 90°C">
                            </div>
                            <div class="form-group">
                                <label for="soak${id}">Pre-soak</label>
                                <select id="soak${id}">
                                    <option value="yes" ${currentEspressoData['soak' + id] === 'yes' ? 'selected' : ''}>Yes</option>
                                    <option value="no" ${currentEspressoData['soak' + id] === 'no' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="time${id}">Extraction Time</label>
                                <input type="text" id="time${id}" value="${currentEspressoData['time' + id] || ''}" placeholder="e.g., 32s">
                            </div>
                            <div class="form-group">
                                <label for="weightOut${id}">Weight Out</label>
                                <input type="text" id="weightOut${id}" value="${currentEspressoData['weightOut' + id] || ''}" placeholder="e.g., 40g">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes${id}">Tasting Notes</label>
                            <textarea id="notes${id}" rows="3" placeholder="e.g., Bright and floral with citrus notes">${currentEspressoData['notes' + id] || ''}</textarea>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Save espresso data
        async function saveEspressoData() {
            try {
                // Collect data from form
                const updatedData = {};
                
                [1, 2, 3].forEach(id => {
                    updatedData[`beanName${id}`] = document.getElementById(`beanName${id}`).value;
                    updatedData[`roastDate${id}`] = document.getElementById(`roastDate${id}`).value;
                    updatedData[`weight${id}`] = document.getElementById(`weight${id}`).value;
                    updatedData[`grind${id}`] = document.getElementById(`grind${id}`).value;
                    updatedData[`tempIn${id}`] = document.getElementById(`tempIn${id}`).value;
                    updatedData[`soak${id}`] = document.getElementById(`soak${id}`).value;
                    updatedData[`time${id}`] = document.getElementById(`time${id}`).value;
                    updatedData[`weightOut${id}`] = document.getElementById(`weightOut${id}`).value;
                    updatedData[`notes${id}`] = document.getElementById(`notes${id}`).value;
                });

                const response = await fetch('/admin/api/espresso/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'Espresso data saved successfully', 'success', 'espressoDataAlert');
                    currentEspressoData = { ...currentEspressoData, ...updatedData };
                    
                    // Also refresh the status to show updated file timestamp
                    setTimeout(() => {
                        loadEspressoStatus();
                    }, 1000);
                } else {
                    showAlert('Failed to save espresso data: ' + (result.error || 'Unknown error'), 'error', 'espressoDataAlert');
                }
            } catch (error) {
                showAlert('Error saving espresso data: ' + error.message, 'error', 'espressoDataAlert');
            }
        }

        // Reset espresso data to defaults
        async function resetEspressoData() {
            if (!confirm('Are you sure you want to reset all espresso data to default values? This cannot be undone.')) {
                return;
            }

            try {
                // Send empty object to trigger default data creation
                const response = await fetch('/admin/api/espresso/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reset: true })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('Espresso data reset to defaults successfully', 'success', 'espressoDataAlert');
                    await loadEspressoData(); // Reload the form with new data
                    setTimeout(() => {
                        loadEspressoStatus();
                    }, 1000);
                } else {
                    showAlert('Failed to reset espresso data: ' + (result.error || 'Unknown error'), 'error', 'espressoDataAlert');
                }
            } catch (error) {
                showAlert('Error resetting espresso data: ' + error.message, 'error', 'espressoDataAlert');
            }
        }

        function toggleGitHubConfig() {
            const githubEnabled = document.getElementById('vidiotsGithubEnabled').value === 'true';
            const githubConfig = document.getElementById('githubPagesConfig');
            if (githubConfig) {
                githubConfig.style.display = githubEnabled ? 'block' : 'none';
            }
        }

        async function testGitHubConnection() {
            try {
                // Set loading state
                setButtonLoading('testGitHubBtn', true);
                updateGitHubStatus('Testing GitHub connection...', true);
                addGitHubLog('INFO', 'Starting GitHub connection test');
                
                showAlert('Testing GitHub connection...', 'success', 'vidiotsAlert');
                
                const response = await fetch('/admin/api/vidiots/github/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    updateGitHubStatus('GitHub connection test successful');
                    addGitHubLog('SUCCESS', 'GitHub connection test completed successfully');
                    showAlert('GitHub connection test successful', 'success', 'vidiotsAlert');
                } else {
                    setGitHubError('GitHub connection test failed');
                    addGitHubLog('ERROR', `GitHub connection test failed: ${result.error || 'Unknown error'}`);
                    showAlert('GitHub connection test failed: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                setGitHubError('GitHub connection test error');
                addGitHubLog('ERROR', `GitHub connection test error: ${error.message}`);
                showAlert('Error testing GitHub connection: ' + error.message, 'error', 'vidiotsAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('testGitHubBtn', false);
            }
        }

        async function uploadToGitHub() {
            try {
                // Set loading state
                setButtonLoading('uploadGitHubBtn', true);
                updateGitHubStatus('Uploading to GitHub Pages...', true);
                addGitHubLog('INFO', 'Starting GitHub Pages upload');
                
                showAlert('Uploading to GitHub Pages...', 'success', 'vidiotsAlert');
                
                const response = await fetch('/admin/api/vidiots/github/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    updateGitHubStatus('Successfully uploaded to GitHub Pages');
                    addGitHubLog('SUCCESS', 'GitHub Pages upload completed successfully');
                    if (result.commitSha) {
                        addGitHubLog('INFO', `Commit SHA: ${result.commitSha}`);
                    }
                    showAlert('Successfully uploaded to GitHub Pages', 'success', 'vidiotsAlert');
                } else {
                    setGitHubError('GitHub Pages upload failed');
                    addGitHubLog('ERROR', `GitHub Pages upload failed: ${result.error || 'Unknown error'}`);
                    showAlert('Failed to upload to GitHub Pages: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                setGitHubError('GitHub Pages upload error');
                addGitHubLog('ERROR', `GitHub Pages upload error: ${error.message}`);
                showAlert('Error uploading to GitHub Pages: ' + error.message, 'error', 'vidiotsAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('uploadGitHubBtn', false);
            }
        }

        // Repository management functions
        let currentBrowsePath = '';

        async function cloneGitHubRepo() {
            try {
                // Set loading state
                setButtonLoading('cloneGitHubBtn', true);
                updateGitHubStatus('Cloning/pulling GitHub repository...', true);
                addGitHubLog('INFO', 'Starting repository clone/pull operation');
                
                showAlert('Cloning/pulling GitHub repository...', 'success', 'vidiotsAlert');
                
                const response = await fetch('/admin/api/vidiots/github/clone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    updateGitHubStatus(`Repository ${result.action} successfully`);
                    addGitHubLog('SUCCESS', `Repository ${result.action} operation completed successfully`);
                    if (result.output) {
                        addGitHubLog('INFO', `Git output: ${result.output.substring(0, 100)}...`);
                    }
                    showAlert(`Repository ${result.action} successfully`, 'success', 'vidiotsAlert');
                    
                    // Automatically browse the repository after successful clone/pull
                    setTimeout(() => {
                        addGitHubLog('INFO', 'Automatically opening repository browser');
                        browseGitHubRepo();
                    }, 1000);
                } else {
                    setGitHubError('Repository operation failed');
                    addGitHubLog('ERROR', `Repository clone/pull failed: ${result.error || 'Unknown error'}`);
                    showAlert('Failed to clone/pull repository: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                setGitHubError('Repository operation error');
                addGitHubLog('ERROR', `Repository clone/pull error: ${error.message}`);
                showAlert('Error cloning/pulling repository: ' + error.message, 'error', 'vidiotsAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('cloneGitHubBtn', false);
            }
        }

        async function browseGitHubRepo(path = '') {
            try {
                currentBrowsePath = path;
                
                // Set loading state for browse button
                setButtonLoading('browseGitHubBtn', true);
                addGitHubLog('INFO', `Browsing repository path: ${path || '/'}`);
                
                const response = await fetch(`/admin/api/vidiots/github/browse?path=${encodeURIComponent(path)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    displayRepositoryContents(result, path);
                    document.getElementById('githubRepositoryBrowser').style.display = 'block';
                    addGitHubLog('SUCCESS', `Repository contents loaded for path: ${path || '/'}`);
                    if (result.items) {
                        addGitHubLog('INFO', `Found ${result.items.length} items in directory`);
                    }
                    showAlert('Repository contents loaded', 'success', 'repositoryBrowserAlert');
                } else {
                    addGitHubLog('ERROR', `Failed to browse repository: ${result.error || 'Unknown error'}`);
                    showAlert('Failed to browse repository: ' + (result.error || 'Unknown error'), 'error', 'repositoryBrowserAlert');
                }
            } catch (error) {
                addGitHubLog('ERROR', `Error browsing repository: ${error.message}`);
                showAlert('Error browsing repository: ' + error.message, 'error', 'repositoryBrowserAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('browseGitHubBtn', false);
            }
        }

        function displayRepositoryContents(result, path) {
            const fileBrowser = document.getElementById('fileBrowser');
            const currentPathEl = document.getElementById('currentPath');
            
            currentPathEl.textContent = path || '/';
            
            if (result.type === 'directory') {
                let html = '<div style="border-bottom: 1px solid #eee; padding: 10px; font-weight: bold; background: #f8f9fa;">📁 Directory Contents</div>';
                
                if (result.items && result.items.length > 0) {
                    result.items.forEach(item => {
                        const icon = item.type === 'directory' ? '📁' : '📄';
                        const itemPath = item.path;
                        const sizeText = item.size ? ` (${formatFileSize(item.size)})` : '';
                        const modifiedText = item.modified ? new Date(item.modified).toLocaleDateString() : '';
                        
                        html += `
                        <div style="border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; hover: background-color: #f8f9fa;" 
                             onmouseover="this.style.backgroundColor='#f8f9fa'" 
                             onmouseout="this.style.backgroundColor='white'">
                            <div style="flex: 1; cursor: pointer;" onclick="handleItemClick('${itemPath}', '${item.type}')">
                                <span style="font-size: 1.2em; margin-right: 8px;">${icon}</span>
                                <span style="font-weight: ${item.type === 'directory' ? 'bold' : 'normal'};">${escapeHtml(item.name)}</span>
                                <span style="color: #666; font-size: 0.9em;">${sizeText}</span>
                            </div>
                            <div style="color: #666; font-size: 0.9em; margin-right: 10px;">${modifiedText}</div>
                            <div>
                                ${item.isDownloadable ? `<button class="btn btn-sm" onclick="downloadFile('${itemPath}')" style="padding: 4px 8px; font-size: 0.8em; margin-right: 4px;">⬇️ Download</button>` : ''}
                                ${item.isDownloadable ? `<button class="btn btn-sm btn-danger" onclick="deleteFileFromRepository('${itemPath}', '${escapeHtml(item.name)}')" style="padding: 4px 8px; font-size: 0.8em;">🗑️ Delete</button>` : ''}
                            </div>
                        </div>`;
                    });
                } else {
                    html += '<div style="padding: 20px; text-align: center; color: #666;">Directory is empty</div>';
                }
                
                fileBrowser.innerHTML = html;
            } else if (result.type === 'file') {
                fileBrowser.innerHTML = `
                <div style="padding: 20px;">
                    <h4>📄 ${escapeHtml(result.name)}</h4>
                    <p>Size: ${formatFileSize(result.size)}</p>
                    <p>Modified: ${new Date(result.modified).toLocaleString()}</p>
                    <button class="btn" onclick="downloadFile('${result.path}')" style="margin-right: 10px;">⬇️ Download File</button>
                    <button class="btn btn-danger" onclick="deleteFileFromRepository('${escapeHtml(result.path)}', '${escapeHtml(result.name)}')">🗑️ Delete File</button>
                </div>`;
            }
        }

        function handleItemClick(itemPath, itemType) {
            if (itemType === 'directory') {
                browseGitHubRepo(itemPath);
            } else {
                // For files, we could show file info or download
                downloadFile(itemPath);
            }
        }

        async function downloadFile(filePath) {
            try {
                showAlert('Downloading file...', 'success', 'repositoryBrowserAlert');
                
                const url = `/admin/api/vidiots/github/download?path=${encodeURIComponent(filePath)}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filename = contentDisposition
                        ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                        : filePath.split('/').pop();
                    
                    // Create download link and trigger download
                    const downloadLink = document.createElement('a');
                    downloadLink.href = window.URL.createObjectURL(blob);
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    showAlert(`File "${filename}" downloaded successfully`, 'success', 'repositoryBrowserAlert');
                } else {
                    const errorData = await response.json();
                    showAlert('Download failed: ' + (errorData.error || 'Unknown error'), 'error', 'repositoryBrowserAlert');
                }
            } catch (error) {
                showAlert('Error downloading file: ' + error.message, 'error', 'repositoryBrowserAlert');
            }
        }

        async function deleteFileFromRepository(filePath, fileName) {
            // Confirmation dialog
            if (!confirm(`Are you sure you want to delete "${fileName}"? This action will permanently remove the file from your GitHub.io repository when you next upload.`)) {
                return;
            }
            
            try {
                showAlert(`Deleting file "${fileName}"...`, 'success', 'repositoryBrowserAlert');
                
                const response = await fetch(`/admin/api/vidiots/github/delete?path=${encodeURIComponent(filePath)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(`File "${fileName}" deleted successfully! Changes will be uploaded to GitHub.io on next upload.`, 'success', 'repositoryBrowserAlert');
                    // Refresh the repository browser to show the updated file list
                    refreshRepositoryBrowser();
                } else {
                    showAlert('Delete failed: ' + (result.error || 'Unknown error'), 'error', 'repositoryBrowserAlert');
                }
            } catch (error) {
                showAlert('Error deleting file: ' + error.message, 'error', 'repositoryBrowserAlert');
            }
        }

        function refreshRepositoryBrowser() {
            browseGitHubRepo(currentBrowsePath);
        }

        function goToParentDirectory() {
            if (currentBrowsePath && currentBrowsePath !== '') {
                const pathParts = currentBrowsePath.split('/');
                pathParts.pop();
                const parentPath = pathParts.join('/');
                browseGitHubRepo(parentPath);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Git Identity Configuration Functions
        async function saveGitIdentity() {
            try {
                const userName = document.getElementById('gitUserName').value.trim();
                const userEmail = document.getElementById('gitUserEmail').value.trim();
                
                if (!userName || !userEmail) {
                    addGitHubLog('WARNING', 'Git identity save failed: Both user name and email are required');
                    showAlert('Both user name and email are required', 'error', 'gitIdentityAlert');
                    return;
                }
                
                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(userEmail)) {
                    addGitHubLog('WARNING', 'Git identity save failed: Invalid email format');
                    showAlert('Please enter a valid email address', 'error', 'gitIdentityAlert');
                    return;
                }
                
                addGitHubLog('INFO', `Saving git identity: ${userName} <${userEmail}>`);
                showAlert('Saving git identity...', 'success', 'gitIdentityAlert');
                
                const response = await fetch('/admin/api/vidiots/github/git-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userName: userName,
                        userEmail: userEmail
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addGitHubLog('SUCCESS', 'Git identity saved successfully and will persist across restarts');
                    showAlert('✅ Git identity saved successfully! This will be used for all GitHub commit operations and persists across container restarts.', 'success', 'gitIdentityAlert');
                    markSaved('Git Identity'); // Clear unsaved changes
                } else {
                    addGitHubLog('ERROR', `Failed to save git identity: ${result.error || 'Unknown error'}`);
                    showAlert('❌ Failed to save git identity: ' + (result.error || 'Unknown error'), 'error', 'gitIdentityAlert');
                }
            } catch (error) {
                addGitHubLog('ERROR', `Error saving git identity: ${error.message}`);
                showAlert('Error saving git identity: ' + error.message, 'error', 'gitIdentityAlert');
            }
        }

        async function loadGitIdentity() {
            try {
                // Load current git configuration from the API
                const response = await fetch('/admin/api/vidiots/github/git-config', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    // Populate the form fields with the loaded values
                    document.getElementById('gitUserName').value = result.userName || '';
                    document.getElementById('gitUserEmail').value = result.userEmail || '';
                    
                    if (result.isDefault) {
                        showAlert('Default git identity loaded. Please update with your information for GitHub operations.', 'info', 'gitIdentityAlert');
                    } else {
                        const updatedDate = result.updatedAt ? new Date(result.updatedAt).toLocaleString() : 'Unknown';
                        showAlert(`Git identity loaded successfully. Last updated: ${updatedDate}`, 'success', 'gitIdentityAlert');
                    }
                } else {
                    showAlert('Failed to load git identity: ' + (result.error || 'Unknown error'), 'error', 'gitIdentityAlert');
                    // Clear form on error
                    document.getElementById('gitUserName').value = '';
                    document.getElementById('gitUserEmail').value = '';
                }
            } catch (error) {
                console.error('Error loading git identity:', error);
                showAlert('Error loading git identity: ' + error.message, 'error', 'gitIdentityAlert');
                // Clear form on error
                document.getElementById('gitUserName').value = '';
                document.getElementById('gitUserEmail').value = '';
            }
        }

        // GitHub logging and status management functions
        function addGitHubLog(level, message, timestamp = null) {
            const logContainer = document.getElementById('githubOperationLog');
            if (!logContainer) return;
            
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.style.marginBottom = '5px';
            
            // Set color based on log level
            let color = '#6c757d'; // default gray
            switch (level.toUpperCase()) {
                case 'SUCCESS': color = '#28a745'; break;
                case 'ERROR': color = '#dc3545'; break;
                case 'WARNING': color = '#ffc107'; break;
                case 'INFO': color = '#17a2b8'; break;
            }
            
            logEntry.innerHTML = `
                <span class="timestamp" style="color: #6c757d;">[${time}]</span> 
                <span class="level" style="color: ${color}; font-weight: bold;">${level.toUpperCase()}</span> 
                <span class="message">${message}</span>
            `;
            
            // Add to top of log
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Limit to 50 entries to prevent memory issues
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 50) {
                entries[entries.length - 1].remove();
            }
            
            // Auto-scroll to show latest entry
            logContainer.scrollTop = 0;
        }
        
        function updateGitHubStatus(message, isLoading = false) {
            const statusContainer = document.getElementById('githubOperationStatus');
            if (!statusContainer) return;
            
            if (isLoading) {
                statusContainer.innerHTML = `<span style="color: #ffc107;">⏳ ${message}</span>`;
                statusContainer.style.borderLeft = '4px solid #ffc107';
            } else {
                statusContainer.innerHTML = `<span style="color: #28a745;">✅ ${message}</span>`;
                statusContainer.style.borderLeft = '4px solid #28a745';
            }
        }
        
        function setGitHubError(message) {
            const statusContainer = document.getElementById('githubOperationStatus');
            if (!statusContainer) return;
            
            statusContainer.innerHTML = `<span style="color: #dc3545;">❌ ${message}</span>`;
            statusContainer.style.borderLeft = '4px solid #dc3545';
        }
        
        function clearGitHubLogs() {
            const logContainer = document.getElementById('githubOperationLog');
            if (!logContainer) return;
            
            logContainer.innerHTML = `
                <div class="log-entry" style="color: #6c757d; margin-bottom: 5px;">
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span> 
                    <span class="level">INFO</span> 
                    <span class="message">Logs cleared</span>
                </div>
            `;
            addGitHubLog('INFO', 'GitHub operation logs cleared');
        }
        
        function refreshGitHubStatus() {
            addGitHubLog('INFO', 'Refreshing GitHub status...');
            updateGitHubStatus('Checking GitHub configuration and connectivity...', true);
            
            // Load git identity to refresh display
            loadGitIdentity().then(() => {
                updateGitHubStatus('GitHub interface ready');
                addGitHubLog('SUCCESS', 'GitHub status refreshed successfully');
            }).catch((error) => {
                setGitHubError('Failed to refresh GitHub status');
                addGitHubLog('ERROR', `Status refresh failed: ${error.message}`);
            });
        }
        
        function setButtonLoading(buttonId, loading = true, originalText = null) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            if (loading) {
                if (!button.dataset.originalText) {
                    button.dataset.originalText = button.textContent;
                }
                button.textContent = '⏳ Loading...';
                button.disabled = true;
                button.style.opacity = '0.7';
            } else {
                button.textContent = button.dataset.originalText || originalText || button.textContent;
                button.disabled = false;
                button.style.opacity = '1';
                delete button.dataset.originalText;
            }
        }

        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', function() {
            // Hide non-dashboard sections initially
            const allSections = document.querySelectorAll('.admin-section');
            allSections.forEach(section => {
                if (!section.classList.contains('dashboard-section')) {
                    section.classList.add('hidden');
                }
            });

            // Initialize collapsible sections
            initializeCollapsibleSections();

            // Add event listener for GitHub Pages toggle
            const githubEnabledSelect = document.getElementById('vidiotsGithubEnabled');
            if (githubEnabledSelect) {
                githubEnabledSelect.addEventListener('change', toggleGitHubConfig);
            }
            
            // Initialize GitHub status and load git identity when the page loads
            if (document.getElementById('githubOperationLog')) {
                addGitHubLog('INFO', 'GitHub interface initialized');
                updateGitHubStatus('Ready for GitHub operations');
                
                // Load git identity automatically
                setTimeout(() => {
                    loadGitIdentity();
                }, 500);
            }
        });
        
        // Also load Git Identity when switching to GitHub tab
        function initializeGitHubSection() {
            if (document.getElementById('githubOperationLog')) {
                addGitHubLog('INFO', 'GitHub section opened');
                loadGitIdentity();
            }
        }
    </script>
</body>
</html>