<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Local Server Site Pusher</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .card-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .card-header h2 {
            color: #333;
            font-size: 1.3rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .status-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        
        .status-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 0.5rem;
        }
        
        .status-value {
            font-size: 1.2rem;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .config-editor {
            width: 100%;
            height: 400px;
            font-family: 'Courier New', monospace;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            resize: vertical;
        }
        
        .config-editor:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning-box {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        .warning-box strong {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .section-divider {
            border-top: 1px solid #eee;
            margin: 1.5rem 0;
        }
        
        /* Grid Editor Styles */
        .grid-editor-container {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .grid-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .grid-editor-header h3 {
            margin: 0;
            color: #333;
        }
        
        .grid-editor-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .orientation-tabs {
            display: inline-flex;
            gap: 5px;
        }
        
        .orientation-tab {
            padding: 8px 16px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .orientation-tab.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .orientation-tab:not(.active):hover {
            background: #e0e0e0;
        }
        
        .grid-editor-main {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .grid-canvas-wrapper {
            flex: 1;
            min-width: 500px;
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .grid-canvas {
            display: grid;
            /* Grid dimensions set dynamically via JavaScript */
            gap: 10px;
            width: 100%;
            position: relative;
            min-height: 400px;
            /* Remove fixed aspect ratio to allow different grid sizes */
        }
        
        .grid-cell {
            border: 1px dashed #ccc;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #999;
            position: relative;
        }
        
        .grid-cell.hover {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .grid-widget {
            position: absolute;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 10px;
            cursor: move;
            user-select: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: box-shadow 0.2s, transform 0.1s;
            border: 2px solid transparent;
        }
        
        .grid-widget:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            transform: translateY(-2px);
        }
        
        .grid-widget.dragging {
            opacity: 0.7;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .grid-widget.selected {
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
        }
        
        .grid-widget.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: linear-gradient(135deg, #999 0%, #666 100%);
        }
        
        .grid-widget.overlapping {
            border-color: #ff4444;
            box-shadow: 0 0 0 3px rgba(255, 68, 68, 0.3);
        }
        
        .widget-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .widget-name {
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
        }
        
        .widget-position {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            z-index: 10;
        }
        
        .resize-handle.se {
            bottom: -10px;
            right: -10px;
            cursor: se-resize;
        }
        
        .resize-handle.ne {
            top: -10px;
            right: -10px;
            cursor: ne-resize;
        }
        
        .resize-handle.sw {
            bottom: -10px;
            left: -10px;
            cursor: sw-resize;
        }
        
        .resize-handle.nw {
            top: -10px;
            left: -10px;
            cursor: nw-resize;
        }
        
        .widget-palette {
            width: 250px;
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .widget-palette h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1rem;
        }
        
        .palette-widget {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .palette-widget:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
        
        .palette-widget.disabled {
            opacity: 0.5;
            background: #f1f3f5;
        }
        
        .palette-widget-icon {
            font-size: 1.5rem;
        }
        
        .palette-widget-info {
            flex: 1;
        }
        
        .palette-widget-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        
        .palette-widget-status {
            font-size: 0.75rem;
            color: #666;
        }
        
        .grid-legend {
            margin-top: 15px;
            padding: 10px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .legend-item:last-child {
            margin-bottom: 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .grid-editor-main {
                flex-direction: column;
            }
            
            .grid-canvas-wrapper {
                min-width: 100%;
            }
            
            .widget-palette {
                width: 100%;
            }
        }
        
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem;
        }
        
        .log-timestamp {
            color: #6c757d;
            margin-right: 1rem;
        }
        
        .log-level {
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .log-level.INFO {
            color: #28a745;
        }
        
        .log-level.WARN {
            color: #ffc107;
        }
        
        .log-level.ERROR {
            color: #dc3545;
        }
        
        .log-level.SUCCESS {
            color: #28a745;
        }
        
        .log-level.WARNING {
            color: #ffc107;
        }
        
        .log-level.DEBUG {
            color: #6c757d;
        }
        
        .log-category {
            background: #e9ecef;
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            font-size: 0.85rem;
            margin-right: 0.5rem;
            color: #495057;
        }
        
        .links-list {
            list-style: none;
        }
        
        .link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }
        
        .link-item a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .link-item a:hover {
            text-decoration: underline;
        }
        
        .hidden {
            display: none;
        }
        
        .toggle-section {
            cursor: pointer;
            user-select: none;
        }
        
        .toggle-section:hover {
            color: #667eea;
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #ddd;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            border: none;
            background: none;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        /* Client Storage Usage Styles */
        .storage-client {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .storage-client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .storage-client-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }
        
        .storage-client-total {
            color: #666;
            font-size: 0.95rem;
        }
        
        .storage-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .storage-category {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            border-left: 4px solid;
        }
        
        .storage-category.image {
            border-left-color: #28a745;
        }
        
        .storage-category.video {
            border-left-color: #dc3545;
        }
        
        .storage-category.document {
            border-left-color: #007bff;
        }
        
        .storage-category.other {
            border-left-color: #6c757d;
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .category-name {
            font-weight: 600;
            text-transform: capitalize;
            color: #333;
        }
        
        .category-count {
            font-size: 0.85rem;
            color: #666;
        }
        
        .category-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .category-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .category-bar-fill.image {
            background: #28a745;
        }
        
        .category-bar-fill.video {
            background: #dc3545;
        }
        
        .category-bar-fill.document {
            background: #007bff;
        }
        
        .category-bar-fill.other {
            background: #6c757d;
        }
        
        .category-size {
            font-size: 0.9rem;
            color: #555;
            font-weight: 500;
        }
        
        .storage-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }
        
        .media-player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .media-player-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #ddd;
            transition: all 0.2s ease;
        }
        
        .media-player-card.active {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        
        .media-player-card.playing {
            border-left-color: #007bff;
            background: #f0f8ff;
        }
        
        .media-player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .media-player-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        
        .media-player-type {
            font-size: 0.8rem;
            color: #666;
            background: #e9ecef;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }
        
        .media-player-status {
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .media-player-status.playing {
            color: #007bff;
        }
        
        .media-player-status.paused {
            color: #ffc107;
        }
        
        .media-player-status.idle {
            color: #6c757d;
        }
        
        .media-info {
            margin-top: 0.5rem;
        }
        
        .media-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.2rem;
        }
        
        .media-artist {
            color: #666;
            font-size: 0.9rem;
        }
        
        .media-source {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.3rem;
        }
        
        .media-streaming-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .media-streaming-summary h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
        }
        
        .media-streaming-summary p {
            margin: 0;
            opacity: 0.9;
        }
        
        /* Storage Slider Styles */
        .storage-slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .storage-slider {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .storage-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .storage-slider::-webkit-slider-thumb:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }
        
        .storage-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .storage-input-container {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            min-width: 100px;
        }
        
        .storage-input {
            width: 70px;
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .storage-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .storage-unit {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }
        
        .storage-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .storage-display {
            font-weight: 600;
            color: #333;
        }
        
        .storage-available {
            color: #666;
        }
        
        .storage-validation-message {
            font-size: 0.85rem;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .storage-validation-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .storage-validation-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }
        
        /* Drink Mixer Styles */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            color: #007bff;
            background: rgba(0, 123, 255, 0.1);
        }
        
        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: rgba(0, 123, 255, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .ingredients-list, .recipes-list, .available-drinks-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .ingredient-item, .recipe-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ingredient-item.unavailable {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .ingredient-name {
            font-weight: 600;
            color: #333;
        }
        
        .ingredient-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .ingredient-status.available {
            background: #d4edda;
            color: #155724;
        }
        
        .ingredient-status.unavailable {
            background: #f8d7da;
            color: #721c24;
        }
        
        .ingredient-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .ingredient-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        
        .ingredient-field {
            flex: 2;
            position: relative;
        }
        
        .ingredient-name-dropdown,
        .ingredient-name-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .ingredient-amount {
            flex: 1;
            max-width: 120px;
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .ingredient-unit {
            flex: 1;
            max-width: 100px;
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .ingredient-row input {
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        
        .ingredient-row input:focus,
        .ingredient-row select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .recipe-item {
            flex-direction: column;
            align-items: stretch;
        }
        
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .recipe-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .recipe-ingredients {
            background: white;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .recipe-ingredient {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .recipe-ingredient:last-child {
            border-bottom: none;
        }
        
        .recipe-ingredient-name {
            font-weight: 500;
        }
        
        .recipe-ingredient-amount {
            color: #666;
        }
        
        .recipe-directions {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-left: 4px solid #667eea;
        }
        
        .recipe-directions p {
            margin: 0.5rem 0 0 0;
            color: #555;
            line-height: 1.4;
        }
        
        .available-drink-item {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .available-drink-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #155724;
            margin-bottom: 0.5rem;
        }
        
        .available-drink-ingredients {
            background: white;
            border-radius: 4px;
            padding: 0.75rem;
        }
        
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .no-items {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }
        
        /* Tournament Styles */
        .tournament-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
            transition: all 0.2s ease;
        }
        
        .tournament-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .tournament-card.setup {
            border-left-color: #ffc107;
        }
        
        .tournament-card.active {
            border-left-color: #28a745;
        }
        
        .tournament-card.completed {
            border-left-color: #6c757d;
        }
        
        .tournament-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .tournament-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }
        
        .tournament-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .tournament-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            min-width: fit-content;
        }
        
        .tournament-status.setup {
            background: #fff3cd;
            color: #856404;
        }
        
        .tournament-status.active {
            background: #d1eddb;
            color: #155724;
        }
        
        .tournament-status.completed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .tournament-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .tournament-stat {
            text-align: center;
        }
        
        .tournament-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        
        .tournament-stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
        }
        
        .tournament-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .participants-list {
            background: white;
            border-radius: 6px;
            padding: 1rem;
        }
        
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .participant-item:last-child {
            border-bottom: none;
        }
        
        .participant-name {
            font-weight: 500;
            color: #333;
        }
        
        .participant-stats {
            font-size: 0.8rem;
            color: #666;
        }
        
        .bracket-container {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
        }
        
        .bracket-rounds {
            display: flex;
            gap: 3rem;
            min-width: fit-content;
        }
        
        .bracket-round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            min-height: 300px;
        }
        
        .bracket-round-title {
            text-align: center;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }
        
        .bracket-match {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 0.5rem 0;
            min-width: 200px;
            position: relative;
        }
        
        .bracket-match.completed {
            border-color: #28a745;
            background: #d1eddb;
        }
        
        .bracket-participant {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .bracket-participant:last-child {
            border-bottom: none;
        }
        
        .bracket-participant.winner {
            background: #28a745;
            color: white;
            font-weight: 600;
        }
        
        .bracket-participant.loser {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .bracket-participant.bye {
            background: #ffc107;
            color: #856404;
            font-style: italic;
        }
        
        .match-score {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .match-actions {
            padding: 0.5rem 1rem;
            background: white;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .winner-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border: 1px solid #28a745;
            background: white;
            color: #28a745;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .winner-btn:hover {
            background: #28a745;
            color: white;
        }
        
        .tournament-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 3rem;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .main-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }

        .main-tab {
            flex: 1;
            padding: 1rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-right: 1px solid #eee;
        }

        .main-tab:last-child {
            border-right: none;
        }

        .main-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .main-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .sub-tabs {
            display: none;
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .sub-tabs.active {
            display: flex;
            gap: 1rem;
        }

        .sub-tab {
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s ease;
        }

        .sub-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .sub-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Section visibility management */
        .admin-section {
            display: block;
        }

        .admin-section.hidden {
            display: none;
        }

        /* Collapsible sections */
        .collapsible-section {
            margin: 20px 0;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 12px 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .collapsible-header:hover {
            background: #e9ecef;
        }

        .collapsible-header.collapsed {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            margin-bottom: 0;
        }

        .collapsible-header.expanded {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
            margin-bottom: 0;
        }

        .collapsible-title {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-icon {
            transition: transform 0.2s ease;
            font-size: 12px;
            color: #666;
        }

        .collapsible-header.expanded .collapsible-icon {
            transform: rotate(90deg);
        }

        .collapsible-content {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: white;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0 15px;
            opacity: 0;
        }

        .collapsible-content.expanded {
            padding: 15px;
            opacity: 1;
        }

        .error-indicator {
            color: #dc3545;
            font-weight: bold;
            margin-left: 8px;
            font-size: 14px;
        }

        .unsaved-warning {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px 16px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        .unsaved-warning.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .save-button-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        
        /* Finance Module Styles */
        .finance-subsection {
            margin-bottom: 2rem;
        }
        
        .finance-subsection h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .help-text {
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.25rem;
            display: block;
        }
        
        .accounts-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .account-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            position: relative;
        }
        
        .account-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }
        
        .account-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .account-type-badge {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .account-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 0.5rem;
        }
        
        .account-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #dee2e6;
        }
        
        .account-detail {
            font-size: 0.85rem;
        }
        
        .account-detail-label {
            color: #6c757d;
            font-weight: 500;
        }
        
        .account-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .account-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        .recommendation-card {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
        }
        
        .recommendation-card.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .allocation-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .allocation-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }
        
        .allocation-category {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            text-transform: capitalize;
        }
        
        .allocation-values {
            display: flex;
            justify-content: space-around;
            margin-top: 0.5rem;
        }
        
        .allocation-value {
            text-align: center;
        }
        
        .allocation-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .allocation-percent {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .allocation-percent.current {
            color: #007bff;
        }
        
        .allocation-percent.recommended {
            color: #28a745;
        }
        
        .chart-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .legend-label {
            font-size: 0.9rem;
            color: #495057;
        }
        
        .chart-controls label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        /* Widget Connection Test Styles */
        .btn-test-connection {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-test-connection:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-test-connection:active {
            transform: translateY(0);
        }
        
        .btn-test-connection:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-result-container {
            border-radius: 6px;
            padding: 1rem;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .test-result-container.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-result-container.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .test-result-container.warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .test-result-container.loading {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .test-result-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .test-result-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .test-result-icon {
            font-size: 1.2rem;
        }
        
        .test-result-message {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .test-result-details {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background-color: rgba(0,0,0,0.05);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .test-result-detail-item {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .test-result-detail-item:last-child {
            border-bottom: none;
        }
        
        .test-result-detail-label {
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #0c5460;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <!-- Chart.js for Finance Module -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" 
            onerror="console.warn('Chart.js CDN blocked - charts will be unavailable')"></script>
</head>
<body>
    <div class="header">
        <h1>Local Server Site Pusher - Admin Dashboard</h1>
        <form method="POST" action="/admin/logout" style="display: inline;">
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </div>
    
    <!-- Unsaved Changes Warning -->
    <div id="unsaved-warning" class="unsaved-warning">
        ⚠️ You have unsaved changes. Please save your work.
    </div>
    
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <div class="main-tabs">
                <button class="main-tab active" onclick="showMainTab('dashboard')">Dashboard</button>
                <button class="main-tab" onclick="showMainTab('clients')">Clients</button>
                <button class="main-tab" onclick="showMainTab('party')">Party</button>
                <button class="main-tab" onclick="showMainTab('server')">Server</button>
                <button class="main-tab" onclick="showMainTab('finance')">Finance</button>
                <button class="main-tab" onclick="showMainTab('settings')">Settings</button>
            </div>
            
            <!-- Sub-tabs for Party -->
            <div class="sub-tabs" id="party-subtabs">
                <button class="sub-tab active" onclick="showSubTab('party-links')">Useful Links</button>
                <button class="sub-tab" onclick="showSubTab('party-drinks')">Drinks</button>
                <button class="sub-tab" onclick="showSubTab('party-tournament')">Tournament</button>
            </div>
            
            <!-- Sub-tabs for Server -->
            <div class="sub-tabs" id="server-subtabs">
                <button class="sub-tab active" onclick="showSubTab('server-vidiots')">Vidiots</button>
                <button class="sub-tab" onclick="showSubTab('server-espresso')">Espresso</button>
                <button class="sub-tab" onclick="showSubTab('server-github')">GitHub</button>
                <button class="sub-tab" onclick="showSubTab('server-smartmirror')">Smart Mirror</button>
            </div>
            
            <!-- Sub-tabs for Finance -->
            <div class="sub-tabs" id="finance-subtabs">
                <button class="sub-tab" onclick="showSubTab('finance-demo')">Demo</button>
                <button class="sub-tab active" onclick="showSubTab('finance-mydata')">My Data</button>
                <button class="sub-tab" onclick="showSubTab('finance-history')">History</button>
                <button class="sub-tab" onclick="showSubTab('finance-spending')">Spending</button>
            </div>
            
            <!-- Sub-tabs for Settings -->
            <div class="sub-tabs" id="settings-subtabs">
                <button class="sub-tab active" onclick="showSubTab('settings-general')">General</button>
                <button class="sub-tab" onclick="showSubTab('settings-logs')">📝 Logs</button>
            </div>
        </div>
        <!-- Server Status -->
        <div class="card admin-section dashboard-section">
            <div class="card-header">
                <h2>Server Status</h2>
            </div>
            <div class="card-body">
                <div class="status-grid" id="statusGrid">
                    <div class="status-item">
                        <div class="status-label">Loading...</div>
                        <div class="status-value">Please wait</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finance Module - My Data Sub-tab -->
        <div class="card admin-section finance-section finance-mydata-section">
            <div class="card-header">
                <h2>💰 Finance Module</h2>
                <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                    🔐 All financial data is encrypted and stored securely - accessible only to administrators
                </p>
            </div>
            <div class="card-body">
                <!-- Demographics Section -->
                <div class="finance-subsection">
                    <h3>👤 Your Profile</h3>
                    <p class="help-text">Tell us about yourself to get personalized recommendations</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userAge">Current Age</label>
                            <input type="number" id="userAge" placeholder="e.g., 35">
                            <small class="help-text">Your current age helps calculate retirement planning</small>
                        </div>
                        <div class="form-group">
                            <label for="retirementAge">Planned Retirement Age</label>
                            <input type="number" id="retirementAge" placeholder="e.g., 65">
                            <small class="help-text">When do you plan to retire?</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="annualIncome">Annual Income ($)</label>
                            <input type="number" id="annualIncome" placeholder="e.g., 75000">
                            <small class="help-text">Your yearly income before taxes</small>
                        </div>
                        <div class="form-group">
                            <label for="riskTolerance">Risk Tolerance</label>
                            <select id="riskTolerance">
                                <option value="conservative">Conservative - Lower risk, stable returns</option>
                                <option value="moderate" selected>Moderate - Balanced approach</option>
                                <option value="aggressive">Aggressive - Higher risk, growth focused</option>
                            </select>
                            <small class="help-text">How comfortable are you with investment risk?</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="retirementYear">Retirement Year (Optional)</label>
                            <input type="number" id="retirementYear" placeholder="e.g., 2045">
                            <small class="help-text">What year do you plan to retire? (alternative to age)</small>
                        </div>
                        <div class="form-group">
                            <label for="annualRetirementSpending">Annual Retirement Spending ($)</label>
                            <input type="number" id="annualRetirementSpending" placeholder="e.g., 60000">
                            <small class="help-text">How much do you plan to spend per year in retirement?</small>
                        </div>
                    </div>
                    <button onclick="saveDemographics()" class="btn">Save Profile</button>
                </div>

                <div class="section-divider"></div>

                <!-- Retirement Planning Evaluation Section -->
                <div class="finance-subsection">
                    <h3>🎯 Retirement Planning Evaluation</h3>
                    <p class="help-text">Evaluate your retirement plan using Monte Carlo simulation</p>
                    
                    <button onclick="evaluateRetirement()" class="btn" style="margin-bottom: 1rem;">
                        🔍 Evaluate Retirement Plan
                    </button>
                    
                    <div id="retirementEvaluation" style="display: none;">
                        <div id="retirementResult" class="alert"></div>
                        <div id="retirementDetails" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Account Management Section -->
                <div class="finance-subsection">
                    <h3>📊 Accounts & Assets</h3>
                    <p class="help-text">Track all your financial accounts and assets in one place</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="accountName">Account Name</label>
                            <input type="text" id="accountName" placeholder="e.g., Chase Savings">
                        </div>
                        <div class="form-group">
                            <label for="accountType">Account Type</label>
                            <select id="accountType" onchange="updateAccountTypeHelp()">
                                <option value="">Select type...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="accountTypeHelp" class="alert" style="display:none; margin-bottom: 1rem;"></div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="accountValue">Current Value ($)</label>
                            <input type="number" step="0.01" id="accountValue" placeholder="e.g., 25000.00">
                            <small class="help-text">The current balance or market value</small>
                        </div>
                        <div class="form-group">
                            <label for="accountStartDate">Start Date (Optional)</label>
                            <input type="date" id="accountStartDate">
                            <small class="help-text">When did you open this account?</small>
                        </div>
                    </div>
                    
                    <!-- Future Income Specific Fields -->
                    <div id="futureIncomeFields" style="display:none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="monthlyPayment">Expected Monthly Payment ($)</label>
                                <input type="number" step="0.01" id="monthlyPayment" placeholder="e.g., 2500.00">
                                <small class="help-text">How much per month will you receive?</small>
                            </div>
                            <div class="form-group">
                                <label for="startAge">Starting Age</label>
                                <input type="number" id="startAge" placeholder="e.g., 67">
                                <small class="help-text">At what age will payments begin?</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mortgage Property Link Fields -->
                    <div id="mortgagePropertyFields" style="display:none;">
                        <div class="form-group">
                            <label for="linkedProperty">Linked Property</label>
                            <select id="linkedProperty">
                                <option value="">Select property...</option>
                            </select>
                            <small class="help-text">Which property is this mortgage for?</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="accountNotes">Notes (Optional)</label>
                        <textarea id="accountNotes" rows="2" placeholder="Any additional details..."></textarea>
                    </div>
                    
                    <input type="hidden" id="accountId">
                    <button onclick="saveAccount()" class="btn btn-success">Add Account</button>
                    <button onclick="clearAccountForm()" class="btn" style="background: #6c757d;">Clear Form</button>
                </div>

                <div class="section-divider"></div>

                <!-- Screenshot Upload Section -->
                <div class="finance-subsection">
                    <h3>📸 Upload Account Screenshot</h3>
                    <p class="help-text">Upload a screenshot of your account dashboard to automatically update balances</p>
                    
                    <div class="alert" style="background: #e7f3ff; border-left: 4px solid #2196F3; margin-bottom: 1rem;">
                        <strong>ℹ️ How it works:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                            <li>Upload a clear screenshot showing account names and balances</li>
                            <li>The system will extract account information using OCR</li>
                            <li>Existing accounts will be updated with new balances</li>
                            <li>New accounts found in the screenshot will be created automatically</li>
                            <li>Screenshots are deleted immediately after processing for security</li>
                        </ul>
                    </div>
                    
                    <div class="form-group">
                        <label for="screenshotFile">Select Screenshot</label>
                        <input type="file" id="screenshotFile" accept="image/*" style="display: block; width: 100%; padding: 0.5rem; border: 2px dashed #ccc; border-radius: 4px; cursor: pointer;">
                        <small class="help-text">Supported formats: JPG, PNG, WebP. Max size: 10MB</small>
                    </div>
                    
                    <button onclick="uploadAccountScreenshot()" class="btn" style="background: #2196F3;">
                        📤 Upload & Process Screenshot
                    </button>
                    
                    <div id="screenshotUploadStatus" style="margin-top: 1rem; display: none;"></div>
                </div>

                <div class="section-divider"></div>

                <!-- Accounts List -->
                <div class="finance-subsection">
                    <h3>📋 Your Accounts</h3>
                    <div id="accountsList" class="accounts-list">
                        <p style="color: #666;">No accounts added yet</p>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Allocation Recommendations -->
                <div class="finance-subsection">
                    <h3>💡 Portfolio Recommendations</h3>
                    <p class="help-text">Based on your age and risk tolerance</p>
                    <button onclick="loadRecommendations()" class="btn">Get Recommendations</button>
                    <div id="recommendationsContainer" style="margin-top: 1rem;">
                        <!-- Recommendations will be loaded here -->
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Charts Section -->
                <div class="finance-subsection">
                    <h3>📈 Visualizations</h3>
                    <p class="help-text">View your portfolio allocation and account values</p>
                    
                    <div class="chart-controls" style="margin-bottom: 1rem;">
                        <label>
                            <input type="radio" name="chartType" value="pie" checked onchange="updateChart()"> Pie Chart
                        </label>
                        <label style="margin-left: 1rem;">
                            <input type="radio" name="chartType" value="bar" onchange="updateChart()"> Bar Chart
                        </label>
                        <label style="margin-left: 1rem;">
                            <input type="radio" name="chartType" value="doughnut" onchange="updateChart()"> Doughnut Chart
                        </label>
                    </div>
                    
                    <div style="position: relative; height: 400px; margin-bottom: 2rem;">
                        <canvas id="financeChart"></canvas>
                    </div>
                    
                    <div id="chartLegend" class="chart-legend"></div>
                </div>

                <div class="section-divider"></div>

                <!-- Advanced Settings Link -->
                <div style="text-align: center; padding: 1rem;">
                    <a href="#" onclick="showSubTab('finance-advanced'); return false;" style="color: #007bff; text-decoration: none; font-size: 0.95rem;">
                        ⚙️ Advanced settings
                    </a>
                </div>
            </div>
        </div>

        <!-- Finance - Demo Sub-tab -->
        <div class="card admin-section finance-section finance-demo-section">
            <div class="card-header">
                <h2>🎭 Finance Demo</h2>
                <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                    ⚠️ This is demonstration data only - not real financial information
                </p>
            </div>
            <div class="card-body">
                <!-- Demo Notice Banner -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 0.5rem 0;">📊 Welcome to the Finance Module Demo</h3>
                    <p style="margin: 0; font-size: 0.95rem;">
                        This demo showcases the Finance Module's features with sample data. 
                        The demo user is 40 years old, plans to retire at 65, and expects $3,000/month in Social Security benefits.
                        All account balances and historical data are automatically generated and updated monthly.
                    </p>
                </div>

                <!-- Demographics Section -->
                <div class="finance-subsection">
                    <h3>👤 Demo User Profile</h3>
                    <p class="help-text">This demo user's profile information</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="demoUserAge">Current Age</label>
                            <input type="number" id="demoUserAge" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label for="demoRetirementAge">Planned Retirement Age</label>
                            <input type="number" id="demoRetirementAge" readonly style="background: #f8f9fa;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="demoAnnualIncome">Annual Income ($)</label>
                            <input type="number" id="demoAnnualIncome" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label for="demoRiskTolerance">Risk Tolerance</label>
                            <input type="text" id="demoRiskTolerance" readonly style="background: #f8f9fa;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="demoRetirementYear">Retirement Year</label>
                            <input type="number" id="demoRetirementYear" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label for="demoAnnualRetirementSpending">Annual Retirement Spending ($)</label>
                            <input type="number" id="demoAnnualRetirementSpending" readonly style="background: #f8f9fa;">
                        </div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Retirement Planning Evaluation Section -->
                <div class="finance-subsection">
                    <h3>🎯 Retirement Planning Evaluation</h3>
                    <p class="help-text">Evaluate the demo retirement plan using Monte Carlo simulation</p>
                    
                    <button onclick="evaluateDemoRetirement()" class="btn" style="margin-bottom: 1rem;">
                        🔍 Evaluate Demo Retirement Plan
                    </button>
                    
                    <div id="demoRetirementEvaluation" style="display: none;">
                        <div id="demoRetirementResult" class="alert"></div>
                        <div id="demoRetirementDetails" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Accounts List -->
                <div class="finance-subsection">
                    <h3>📋 Demo Accounts</h3>
                    <p class="help-text">Sample accounts demonstrating different investment types</p>
                    <div id="demoAccountsList" class="accounts-list">
                        <p style="color: #666;">Loading demo accounts...</p>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Allocation Recommendations -->
                <div class="finance-subsection">
                    <h3>💡 Portfolio Recommendations</h3>
                    <p class="help-text">Based on demo user's age and risk tolerance</p>
                    <button onclick="loadDemoRecommendations()" class="btn">Get Demo Recommendations</button>
                    <div id="demoRecommendationsContainer" style="margin-top: 1rem;">
                        <!-- Recommendations will be loaded here -->
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Charts Section -->
                <div class="finance-subsection">
                    <h3>📈 Visualizations</h3>
                    <p class="help-text">View demo portfolio allocation and account values</p>
                    
                    <div class="chart-controls" style="margin-bottom: 1rem;">
                        <label>
                            <input type="radio" name="demoChartType" value="pie" checked onchange="updateDemoChart()"> Pie Chart
                        </label>
                        <label style="margin-left: 1rem;">
                            <input type="radio" name="demoChartType" value="bar" onchange="updateDemoChart()"> Bar Chart
                        </label>
                        <label style="margin-left: 1rem;">
                            <input type="radio" name="demoChartType" value="doughnut" onchange="updateDemoChart()"> Doughnut Chart
                        </label>
                    </div>
                    
                    <div style="position: relative; height: 400px; margin-bottom: 2rem;">
                        <canvas id="demoFinanceChart"></canvas>
                    </div>
                    
                    <div id="demoChartLegend" class="chart-legend"></div>
                </div>
            </div>
        </div>

        <!-- Finance - History Sub-tab -->
        <div class="card admin-section finance-section finance-history-section">
            <div class="card-header">
                <h2>📈 Finance History</h2>
                <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                    View historical account balances and track your financial progress over time
                </p>
            </div>
            <div class="card-body">
                <!-- Filter Controls Section -->
                <div class="finance-subsection">
                    <h3>🔍 Filter Options</h3>
                    <p class="help-text">Select date range and accounts to view historical data</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyStartDate">Start Date</label>
                            <input type="date" id="historyStartDate" onchange="updateHistoryView()">
                            <small class="help-text">Leave empty to show all history</small>
                        </div>
                        <div class="form-group">
                            <label for="historyEndDate">End Date</label>
                            <input type="date" id="historyEndDate" onchange="updateHistoryView()">
                            <small class="help-text">Leave empty to include up to today</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyAccountFilter">Filter by Account</label>
                            <select id="historyAccountFilter" onchange="updateHistoryView()">
                                <option value="">All Accounts</option>
                            </select>
                            <small class="help-text">Select a specific account or view all</small>
                        </div>
                        <div class="form-group">
                            <label for="historyViewType">View Type</label>
                            <select id="historyViewType" onchange="updateHistoryView()">
                                <option value="net-worth">Net Worth Over Time</option>
                                <option value="by-category">By Account Type</option>
                                <option value="single-account">Single Account</option>
                            </select>
                            <small class="help-text">Choose what to visualize</small>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <button onclick="setQuickDateRange('30d')" class="btn" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; margin-right: 0.5rem;">Last 30 Days</button>
                        <button onclick="setQuickDateRange('90d')" class="btn" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; margin-right: 0.5rem;">Last 90 Days</button>
                        <button onclick="setQuickDateRange('1y')" class="btn" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; margin-right: 0.5rem;">Last Year</button>
                        <button onclick="setQuickDateRange('all')" class="btn" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">All Time</button>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Chart Visualization Section -->
                <div class="finance-subsection">
                    <h3>📊 Historical Balance Chart</h3>
                    <p class="help-text">Visual representation of your account balances over time</p>
                    
                    <div id="historyChartContainer" style="position: relative; height: 400px; margin-bottom: 2rem;">
                        <canvas id="historyChart"></canvas>
                    </div>
                    
                    <div id="historyChartLegend" class="chart-legend"></div>
                    
                    <div id="historyNoData" style="display: none; text-align: center; padding: 2rem; color: #999;">
                        <p style="font-size: 1.1rem;">📭 No historical data available</p>
                        <p style="font-size: 0.9rem;">Historical data is automatically recorded when you update account balances.</p>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Summary Statistics Section -->
                <div class="finance-subsection">
                    <h3>📋 Summary Statistics</h3>
                    <div id="historySummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <!-- Summary stats will be populated here -->
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Historical Data Table Section -->
                <div class="finance-subsection">
                    <h3>📝 Historical Data</h3>
                    <p class="help-text">Detailed list of balance changes and updates</p>
                    
                    <div style="overflow-x: auto;">
                        <table id="historyTable" class="data-table" style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead>
                                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 0.75rem; text-align: left;">Date</th>
                                    <th style="padding: 0.75rem; text-align: left;">Account</th>
                                    <th style="padding: 0.75rem; text-align: right;">Balance</th>
                                    <th style="padding: 0.75rem; text-align: right;">Change</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="4" style="padding: 2rem; text-align: center; color: #999;">
                                        Loading history data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Export Options Section -->
                <div class="finance-subsection">
                    <h3>💾 Export Options</h3>
                    <p class="help-text">Download your historical data for external analysis</p>
                    
                    <button onclick="exportHistoryToCSV()" class="btn" style="margin-right: 0.5rem;">
                        📥 Export to CSV
                    </button>
                    <button onclick="exportHistoryToJSON()" class="btn">
                        📥 Export to JSON
                    </button>
                </div>
            </div>
        </div>

        <!-- Finance - Spending Sub-tab (Ollama LLM Integration) -->
        <div class="card admin-section finance-section finance-spending-section">
            <div class="card-header">
                <h2>🤖 Spending - AI Assistant (Ollama via Open WebUI)</h2>
                <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                    Connect to Ollama LLM instances running on your network via Open WebUI
                </p>
            </div>
            <div class="card-body">
                <!-- Connection Configuration Section -->
                <div class="finance-subsection">
                    <h3>🔌 Connection Configuration</h3>
                    <p class="help-text">Configure connection to Ollama LLM via Open WebUI on TrueNAS or local network</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ollamaWebUIUrl">Open WebUI URL</label>
                            <input type="url" id="ollamaWebUIUrl" placeholder="e.g., http://truenas.local:3000" value="">
                            <small class="help-text">URL where Open WebUI is accessible</small>
                        </div>
                        <div class="form-group">
                            <label for="ollamaApiKey">API Key (if required)</label>
                            <input type="password" id="ollamaApiKey" placeholder="Enter API key if needed" value="">
                            <small class="help-text">Optional: API key for authentication</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ollamaModel">Model Name</label>
                            <input type="text" id="ollamaModel" placeholder="e.g., llama2, mistral, codellama" value="">
                            <small class="help-text">Name of the Ollama model to use</small>
                        </div>
                    </div>
                    
                    <button onclick="testOllamaConnection()" class="btn">Test Connection</button>
                    <button onclick="saveOllamaConfig()" class="btn btn-success">Save Configuration</button>
                </div>

                <div class="section-divider"></div>

                <!-- Connection Status Section -->
                <div class="finance-subsection">
                    <h3>📊 Connection Status</h3>
                    <div id="ollamaConnectionStatus" class="alert" style="display: none;">
                        <strong>Status:</strong> <span id="ollamaStatusText">Unknown</span>
                    </div>
                    <div id="ollamaConnectionError" class="alert alert-error" style="display: none;">
                        <strong>Error:</strong> <span id="ollamaErrorText"></span>
                    </div>
                    <div id="ollamaConnectionMetrics" style="display: none; margin-top: 1rem;">
                        <p><strong>Last Response Time:</strong> <span id="ollamaResponseTime">-</span></p>
                        <p><strong>Model Info:</strong> <span id="ollamaModelInfo">-</span></p>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Prompt & Response Section -->
                <div class="finance-subsection">
                    <h3>💬 AI Interaction</h3>
                    <p class="help-text">Send prompts to the LLM and receive responses</p>
                    
                    <div class="form-group">
                        <label for="ollamaPrompt">Your Prompt</label>
                        <textarea id="ollamaPrompt" rows="4" placeholder="Enter your question or prompt for the AI assistant..."></textarea>
                    </div>
                    
                    <button onclick="sendOllamaPrompt()" class="btn" id="sendPromptBtn">
                        🚀 Send Prompt
                    </button>
                    <button onclick="clearOllamaConversation()" class="btn" style="background: #6c757d;">
                        🗑️ Clear Conversation
                    </button>
                    
                    <div id="ollamaConversation" style="margin-top: 1.5rem; display: none;">
                        <h4>Conversation History</h4>
                        <div id="ollamaMessages" style="max-height: 500px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 5px; padding: 1rem; background: #f8f9fa;">
                            <!-- Messages will be added here -->
                        </div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Implementation Notes Section -->
                <div class="finance-subsection">
                    <h3>📝 Implementation Notes</h3>
                    <div class="alert" style="background-color: #e7f3ff; border-color: #b3d9ff;">
                        <p><strong>Integration Approaches:</strong></p>
                        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            <li><strong>Direct API:</strong> Communicate with Open WebUI's REST API endpoints for chat completions</li>
                            <li><strong>WebSocket:</strong> Use WebSocket connection for streaming responses</li>
                            <li><strong>Proxy:</strong> Set up a proxy endpoint on this server to handle Ollama/Open WebUI requests</li>
                            <li><strong>Python Backend:</strong> Create a Python service using ollama-python library for more control</li>
                        </ul>
                        <p style="margin-top: 1rem;"><strong>Current Implementation:</strong> UI mockup - backend integration pending. Configuration and prompts are stored locally for future implementation.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finance - Advanced Settings Sub-tab -->
        <div class="card admin-section finance-section finance-advanced-section">
            <div class="card-header">
                <h2>⚙️ Advanced Settings</h2>
                <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                    Configure advanced parameters that influence retirement and allocation assessments
                </p>
            </div>
            <div class="card-body">
                <!-- Monte Carlo Simulation Settings -->
                <div class="finance-subsection">
                    <h3>🎲 Monte Carlo Simulation Parameters</h3>
                    <p class="help-text">These settings control the retirement planning simulation accuracy and assumptions</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="monteCarloSimulations">Number of Simulations</label>
                            <input type="number" id="monteCarloSimulations" min="1000" max="100000" step="1000" placeholder="10000">
                            <small class="help-text">More simulations = more accurate results (default: 10,000)</small>
                        </div>
                        <div class="form-group">
                            <label for="yearsInRetirement">Years in Retirement</label>
                            <input type="number" id="yearsInRetirement" min="10" max="50" placeholder="30">
                            <small class="help-text">Planning horizon for retirement (default: 30 years)</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inflationRate">Inflation Rate (%)</label>
                            <input type="number" id="inflationRate" step="0.1" min="0" max="10" placeholder="3.0">
                            <small class="help-text">Expected annual inflation (default: 3.0%)</small>
                        </div>
                        <div class="form-group">
                            <label for="savingsRate">Assumed Savings Rate (%)</label>
                            <input type="number" id="savingsRate" step="1" min="0" max="100" placeholder="15">
                            <small class="help-text">Annual savings as % of income (default: 15%)</small>
                        </div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Return Assumptions by Risk Profile -->
                <div class="finance-subsection">
                    <h3>📊 Return Assumptions by Risk Tolerance</h3>
                    <p class="help-text">Expected returns and volatility for each risk profile</p>
                    
                    <h4 style="margin-top: 1.5rem; color: #6c757d;">Conservative Profile</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="conservativeReturn">Expected Return (%)</label>
                            <input type="number" id="conservativeReturn" step="0.1" min="0" max="20" placeholder="5.0">
                            <small class="help-text">Annual return (default: 5.0%)</small>
                        </div>
                        <div class="form-group">
                            <label for="conservativeVolatility">Volatility / Std Dev (%)</label>
                            <input type="number" id="conservativeVolatility" step="0.1" min="0" max="50" placeholder="10.0">
                            <small class="help-text">Risk measure (default: 10.0%)</small>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 1.5rem; color: #6c757d;">Moderate Profile</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="moderateReturn">Expected Return (%)</label>
                            <input type="number" id="moderateReturn" step="0.1" min="0" max="20" placeholder="7.0">
                            <small class="help-text">Annual return (default: 7.0%)</small>
                        </div>
                        <div class="form-group">
                            <label for="moderateVolatility">Volatility / Std Dev (%)</label>
                            <input type="number" id="moderateVolatility" step="0.1" min="0" max="50" placeholder="15.0">
                            <small class="help-text">Risk measure (default: 15.0%)</small>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 1.5rem; color: #6c757d;">Aggressive Profile</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aggressiveReturn">Expected Return (%)</label>
                            <input type="number" id="aggressiveReturn" step="0.1" min="0" max="20" placeholder="9.0">
                            <small class="help-text">Annual return (default: 9.0%)</small>
                        </div>
                        <div class="form-group">
                            <label for="aggressiveVolatility">Volatility / Std Dev (%)</label>
                            <input type="number" id="aggressiveVolatility" step="0.1" min="0" max="50" placeholder="20.0">
                            <small class="help-text">Risk measure (default: 20.0%)</small>
                        </div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Retirement Phase Adjustments -->
                <div class="finance-subsection">
                    <h3>🏖️ Retirement Distribution Phase</h3>
                    <p class="help-text">Portfolio behavior adjustments during retirement (typically more conservative)</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="retirementReturnAdjustment">Return Adjustment Factor</label>
                            <input type="number" id="retirementReturnAdjustment" step="0.05" min="0" max="1" placeholder="0.70">
                            <small class="help-text">Multiplier for expected return in retirement (default: 0.70 = 70%)</small>
                        </div>
                        <div class="form-group">
                            <label for="retirementVolatilityAdjustment">Volatility Adjustment Factor</label>
                            <input type="number" id="retirementVolatilityAdjustment" step="0.05" min="0" max="1" placeholder="0.80">
                            <small class="help-text">Multiplier for volatility in retirement (default: 0.80 = 80%)</small>
                        </div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="saveAdvancedSettings()" class="btn btn-success">💾 Save Settings</button>
                    <button onclick="resetAdvancedSettings()" class="btn" style="background: #6c757d;">🔄 Reset to Defaults</button>
                </div>
                
                <div id="advancedSettingsAlert" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Configuration Management -->
        <div class="card admin-section settings-section settings-general-section">
            <div class="card-header">
                <h2>Configuration Management</h2>
            </div>
            <div class="card-body">
                <!-- Basic Settings Form -->
                <div id="basicConfig">
                    <h3>Basic Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serverPort">Server Port</label>
                            <input type="number" id="serverPort" value="3000">
                        </div>
                        <div class="form-group">
                            <label for="adminUsername">Admin Username</label>
                            <input type="text" id="adminUsername" value="admin">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">Admin Password</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="password" id="adminPassword" value="admin123" readonly style="background-color: #f5f5f5; cursor: not-allowed; flex: 1;">
                            <button type="button" id="changePasswordBtn" class="btn btn-secondary" onclick="openPasswordChangeModal()" style="white-space: nowrap;">Change Password</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 4px;">Password is protected. Click "Change Password" to modify.</small>
                    </div>
                    
                    <h3>Integrations</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="homeAssistantEnabled">Home Assistant</label>
                            <select id="homeAssistantEnabled">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="homeAssistantUrl">Home Assistant URL</label>
                            <input type="url" id="homeAssistantUrl" value="http://localhost:8123">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cockpitEnabled">Cockpit</label>
                            <select id="cockpitEnabled">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cockpitUrl">Cockpit URL</label>
                            <input type="url" id="cockpitUrl" value="http://localhost:9090">
                        </div>
                    </div>
                    
                    <button id="saveBasicConfig" class="btn">Save Basic Configuration</button>
                </div>

                <div class="section-divider"></div>

                <!-- Advanced Configuration Editor -->
                <div class="toggle-section" onclick="toggleAdvancedConfig()">
                    <h3>⚠️ Advanced Users - Configuration Editor (Click to expand)</h3>
                </div>
                <div id="advancedConfig" class="hidden">
                    <div class="warning-box">
                        <strong>⚠️ Warning - Advanced Configuration</strong>
                        This section allows direct editing of the configuration file. Incorrect modifications may break the server. 
                        Only modify these settings if you understand the configuration structure.
                    </div>
                    <textarea id="configEditor" class="config-editor" placeholder="Loading configuration..."></textarea>
                    <div>
                        <button id="saveConfig" class="btn">Save Advanced Configuration</button>
                        <button id="resetConfig" class="btn btn-secondary">Reset</button>
                    </div>
                </div>
                <div id="configAlert" class="alert"></div>
            </div>
        </div>

        <!-- Storage Management -->
        <div class="card admin-section settings-section settings-general-section">
            <div class="card-header">
                <h2>Storage Management</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="maxTotalSize">Maximum Total Storage</label>
                    <div class="storage-slider-container">
                        <input type="range" id="maxTotalStorageSlider" class="storage-slider" min="1" max="1000" value="1000">
                        <div class="storage-input-container">
                            <input type="number" id="maxTotalStorageInput" class="storage-input" min="1" placeholder="1000"> 
                            <span class="storage-unit">MB</span>
                        </div>
                    </div>
                    <div class="storage-info">
                        <span id="maxTotalStorageDisplay" class="storage-display">1000 MB</span>
                        <span id="availableStorageInfo" class="storage-available">Loading...</span>
                    </div>
                    <div id="storageValidationMessage" class="storage-validation-message"></div>
                </div>
                
                <h3>File Type Limits</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="maxImageSize">Images (jpg, png, gif, etc.)</label>
                        <input type="text" id="maxImageSize" placeholder="e.g., 50MB">
                    </div>
                    <div class="form-group">
                        <label for="maxVideoSize">Videos (mp4, avi, etc.)</label>
                        <input type="text" id="maxVideoSize" placeholder="e.g., 500MB">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="maxDocumentSize">Documents (pdf, doc, etc.)</label>
                        <input type="text" id="maxDocumentSize" placeholder="e.g., 100MB">
                    </div>
                    <div class="form-group">
                        <label for="maxOtherSize">Other Files</label>
                        <input type="text" id="maxOtherSize" placeholder="e.g., 10MB">
                    </div>
                </div>
                
                <button id="saveStorageConfig" class="btn">Save Storage Settings</button>
                <div id="storageAlert" class="alert"></div>
            </div>
        </div>

        <!-- Useful Links Management -->
        <div class="card admin-section party-section party-links-section">
            <div class="card-header">
                <h2>Useful Links</h2>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="linkName">Link Name (Optional)</label>
                        <input type="text" id="linkName" placeholder="e.g., Documentation (optional)">
                    </div>
                    <div class="form-group">
                        <label for="linkUrl">URL</label>
                        <input type="url" id="linkUrl" placeholder="https://example.com">
                    </div>
                </div>
                <button id="addLink" class="btn btn-success">Add Link</button>
                
                <div class="section-divider"></div>
                
                <h3>Saved Links</h3>
                <ul id="linksList" class="links-list">
                    <!-- Links will be loaded here -->
                </ul>
                
                <div id="linksAlert" class="alert"></div>
            </div>
        </div>

        <!-- Drink Mixer Management -->
        <div class="card admin-section party-section party-drinks-section">
            <div class="card-header">
                <h2>Drink Mixer Management</h2>
            </div>
            <div class="card-body">
                <div class="tabs">
                    <button class="tab-button active" onclick="showTab('alcohols')">Alcohols</button>
                    <button class="tab-button" onclick="showTab('mixers')">Mixers</button>
                    <button class="tab-button" onclick="showTab('recipes')">Recipes</button>
                    <button class="tab-button" onclick="showTab('available')">Available Drinks</button>
                </div>

                <!-- Alcohols Tab -->
                <div id="alcohols-tab" class="tab-content active">
                    <h3>Manage Alcohols</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="alcoholName">Alcohol Name</label>
                            <input type="text" id="alcoholName" placeholder="e.g., Tequila, Vodka">
                        </div>
                        <div class="form-group">
                            <label for="alcoholAvailable">Available</label>
                            <select id="alcoholAvailable">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addAlcohol()" class="btn btn-success">Add Alcohol</button>
                    
                    <div class="section-divider"></div>
                    
                    <h3>Alcohol List</h3>
                    <div id="alcoholsList" class="ingredients-list">
                        <!-- Alcohols will be loaded here -->
                    </div>
                    <div id="alcoholsAlert" class="alert"></div>
                </div>

                <!-- Mixers Tab -->
                <div id="mixers-tab" class="tab-content">
                    <h3>Manage Mixers</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mixerName">Mixer Name</label>
                            <input type="text" id="mixerName" placeholder="e.g., Lemon Juice, Sugar">
                        </div>
                        <div class="form-group">
                            <label for="mixerAvailable">Available</label>
                            <select id="mixerAvailable">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addMixer()" class="btn btn-success">Add Mixer</button>
                    
                    <div class="section-divider"></div>
                    
                    <h3>Mixer List</h3>
                    <div id="mixersList" class="ingredients-list">
                        <!-- Mixers will be loaded here -->
                    </div>
                    <div id="mixersAlert" class="alert"></div>
                </div>

                <!-- Recipes Tab -->
                <div id="recipes-tab" class="tab-content">
                    <h3>Manage Recipes</h3>
                    <div class="form-group">
                        <label for="recipeName">Recipe Name</label>
                        <input type="text" id="recipeName" placeholder="e.g., Margarita">
                    </div>
                    
                    <h4>Ingredients</h4>
                    <div id="recipeIngredients">
                        <div class="ingredient-row">
                            <div class="ingredient-field">
                                <select class="ingredient-name-dropdown" onchange="handleIngredientChange(this)">
                                    <option value="">Select ingredient...</option>
                                    <option value="__ADD_NEW__">+ Add New Ingredient</option>
                                </select>
                                <input type="text" class="ingredient-name-input" placeholder="Enter new ingredient name" style="display: none;">
                            </div>
                            <input type="number" class="ingredient-amount" placeholder="Amount" step="0.1" min="0.1">
                            <select class="ingredient-unit">
                                <option value="oz">Ounces</option>
                                <option value="dash">Dashes</option>
                                <option value="unit">Units</option>
                            </select>
                            <button type="button" onclick="removeIngredientRow(this)" class="btn btn-danger btn-small">Remove</button>
                        </div>
                    </div>
                    <button type="button" onclick="addIngredientRow()" class="btn btn-secondary">Add Ingredient</button>
                    
                    <h4>Directions</h4>
                    <div class="form-group">
                        <textarea id="recipeDirections" placeholder="Enter step-by-step instructions for making this drink..." rows="4" style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 0.9rem; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <button onclick="addRecipe()" class="btn btn-success">Save Recipe</button>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <h3>Recipe List</h3>
                    <div id="recipesList" class="recipes-list">
                        <!-- Recipes will be loaded here -->
                    </div>
                    <div id="recipesAlert" class="alert"></div>
                </div>

                <!-- Available Drinks Tab -->
                <div id="available-tab" class="tab-content">
                    <h3>Available Drinks</h3>
                    <p>These are the drinks that can be made based on currently available ingredients:</p>
                    <div id="availableDrinksList" class="available-drinks-list">
                        <!-- Available drinks will be loaded here -->
                    </div>
                    <button onclick="loadAvailableDrinks()" class="btn">Refresh Available Drinks</button>
                </div>
            </div>
        </div>

        <!-- Client Access Management -->
        <div class="card admin-section clients-section">
            <div class="card-header">
                <h2>Client Access Management</h2>
            </div>
            <div class="card-body">
                <h3>Client Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientEnabled">Client Access</label>
                        <select id="clientEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clientRequirePassword">Password Protection Status</label>
                        <div id="passwordStatus" style="margin-top: 0.5rem;">
                            <span id="passwordStatusText">Checking...</span>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                                <em>Note: Clients manage their own passwords. Admins cannot view or modify client passwords.</em>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="welcomeMessage">Welcome Message</label>
                    <input type="text" id="welcomeMessage" placeholder="Welcome to Local Server Site Pusher">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="showServerStatus">Show Server Status</label>
                        <select id="showServerStatus">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="showUsefulLinks">Show Useful Links</label>
                        <select id="showUsefulLinks">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                
                <button id="saveClientConfig" class="btn btn-primary">Save Client Settings</button>
                
                <div class="section-divider"></div>
                
                <h3>Client Management</h3>
                <p>Manage all clients that have connected to this server. Delete a client to remove their account and all associated data.</p>
                <div id="devicesContainer">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading clients...
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <p><strong>Client Access URL:</strong></p>
                <p><a href="/client" target="_blank"><code>http://your-server:3000/client</code></a></p>
                
                <div id="clientAlert" class="alert"></div>
            </div>
        </div>

        <!-- Client Storage Usage -->
        <div class="card admin-section clients-section">
            <div class="card-header">
                <h2>Client Storage Usage</h2>
            </div>
            <div class="card-body">
                <p>Storage usage by each client, organized by file category:</p>
                <div id="clientStorageContainer">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading storage statistics...
                    </div>
                </div>
                <div id="clientStorageAlert" class="alert"></div>
            </div>
        </div>

        <!-- Client Files Management -->
        <div class="card admin-section clients-section">
            <div class="card-header">
                <h2>Client Files</h2>
            </div>
            <div class="card-body">
                <p>Files uploaded by clients with their sharing permissions:</p>
                <div id="clientFilesContainer">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading client files...
                    </div>
                </div>
                <div id="clientFilesAlert" class="alert"></div>
            </div>
        </div>

        <!-- Vidiots Configuration -->
        <div class="card admin-section server-section server-vidiots-section">
            <div class="card-header">
                <h2>Vidiots Movie Scraper</h2>
            </div>
            <div class="card-body">
                <p>Configure the Vidiots Foundation website scraper for e-ink displays:</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsEnabled">Vidiots Scraper</label>
                        <select id="vidiotsEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vidiotsScheduleFrequency">Schedule Frequency</label>
                        <select id="vidiotsScheduleFrequency" onchange="updateScheduleUI()">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                
                <!-- Weekly options (hidden by default) -->
                <div id="weeklyOptions" class="form-row" style="display: none;">
                    <div class="form-group">
                        <label>Days of Week</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="vidiotsDay0" value="0"> Sunday
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="vidiotsDay1" value="1"> Monday
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="vidiotsDay2" value="2"> Tuesday
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="vidiotsDay3" value="3"> Wednesday
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="vidiotsDay4" value="4"> Thursday
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="vidiotsDay5" value="5"> Friday
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="vidiotsDay6" value="6"> Saturday
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly options (hidden by default) -->
                <div id="monthlyOptions" class="form-row" style="display: none;">
                    <div class="form-group">
                        <label for="vidiotsDayOfMonth">Day of Month (1-31)</label>
                        <input type="number" id="vidiotsDayOfMonth" min="1" max="31" value="1" placeholder="1">
                        <small>Note: Months with fewer days will use the last day of the month</small>
                    </div>
                </div>
                
                <!-- Run times section -->
                <div class="form-group">
                    <label>Run Times</label>
                    <div id="vidiotsRunTimes" style="margin-top: 10px;">
                        <!-- Run time entries will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addVidiotsRunTime()" style="margin-top: 10px;">+ Add Run Time</button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsOutputFile">Output HTML File</label>
                        <input type="text" id="vidiotsOutputFile" placeholder="./public/vidiots/index.html">
                    </div>
                    <div class="form-group">
                        <label for="vidiotsPosterDirectory">Poster Directory</label>
                        <input type="text" id="vidiotsPosterDirectory" placeholder="./public/vidiots/posters">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsPosterBaseUrl">Poster Base URL</label>
                        <input type="text" id="vidiotsPosterBaseUrl" placeholder="/vidiots/posters/" title="URL base for poster images. Use relative path like '/vidiots/posters/' or GitHub Pages like 'username.github.io/repo/path/'">
                        <small>Examples: <code>/vidiots/posters/</code> (local), <code>username.github.io/repo/path/</code> (GitHub Pages)</small>
                    </div>
                    <div class="form-group">
                        <label for="vidiotsMaxAgeHours">Max File Age (Hours)</label>
                        <input type="number" id="vidiotsMaxAgeHours" placeholder="24" min="1" max="168">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsForceUpdate">Force Update</label>
                        <select id="vidiotsForceUpdate">
                            <option value="false">Disabled</option>
                            <option value="true">Always Update</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vidiotsGithubEnabled">GitHub Pages Upload</label>
                        <select id="vidiotsGithubEnabled">
                            <option value="false">Disabled</option>
                            <option value="true">Enabled</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn" onclick="saveVidiotsConfig()">Save Configuration</button>
                    <button class="btn btn-secondary" onclick="testVidiotsScrape()">Test Scrape</button>
                    <button class="btn btn-secondary" onclick="loadVidiotsStatus()">Refresh Status</button>
                </div>
                
                <div id="vidiotsAlert" class="alert"></div>
                
                <!-- Status Display -->
                <div class="card" style="margin-top: 20px; background: #f8f9fa;">
                    <div class="card-header">
                        <h3>Scraper Status</h3>
                    </div>
                    <div class="card-body">
                        <div id="vidiotsStatus" style="font-family: monospace; font-size: 0.9em; white-space: pre-wrap; color: #666;">
                            Loading status...
                        </div>
                    </div>
                </div>
                
                <!-- Preview Link -->
                <div style="margin-top: 15px;">
                    <a href="/vidiots" target="_blank" class="btn btn-secondary">Preview Generated Content</a>
                </div>
            </div>
        </div>

        <!-- Espresso HTML Generator -->
        <div class="card admin-section server-section server-espresso-section">
            <div class="card-header">
                <h2>Espresso HTML Generator</h2>
            </div>
            <div class="card-body">
                <p>Configure the espresso data management and HTML generation system:</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="espressoEnabled">Espresso Module</label>
                        <select id="espressoEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="espressoDataFilePath">Data File Path</label>
                        <input type="text" id="espressoDataFilePath" placeholder="./config/espresso-data.json">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="espressoTemplatePath">HTML Template Path</label>
                        <input type="text" id="espressoTemplatePath" placeholder="/path/to/template.html" readonly>
                        <small id="espressoTemplatePathStatus" style="color: #666;"></small>
                    </div>
                    <div class="form-group">
                        <label for="espressoOutputPath">Output HTML Path</label>
                        <input type="text" id="espressoOutputPath" placeholder="./public/espresso/index.html">
                    </div>
                </div>
                
                <!-- Image Mapping Configuration -->
                <div id="espresso-image-mapping" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>Configure Image Mapping</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <p><small>Map template image identifiers to uploaded images or absolute URLs</small></p>
                        <div id="espressoImageMapping" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                            <div style="text-align: center; color: #666; margin: 20px 0;">
                                <i>Loading image configuration...</i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Local Repository File Location -->
                <div id="espresso-local-repo" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>📂 Local Repository Output Settings</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                            Configure where the generated espresso HTML and images should be saved within the local repository managed by the GitHub tab.
                            The GitHub tab handles all upload operations - this section only controls local file placement.
                        </p>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="espressoLocalOutputPath">HTML Output Path within Repository</label>
                                <input type="text" id="espressoLocalOutputPath" placeholder="espresso/index.html" title="Path within the local repository where the HTML file will be saved">
                                <small>Relative path within repository. Example: <code>espresso/index.html</code> or <code>coffee/espresso.html</code></small>
                            </div>
                            <div class="form-group">
                                <label for="espressoLocalImagePath">Images Path within Repository</label>
                                <input type="text" id="espressoLocalImagePath" placeholder="espresso/images" title="Directory within the local repository where images will be saved">
                                <small>Relative path within repository. Example: <code>espresso/images</code> or <code>assets/coffee-images</code></small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="espressoSaveToRepo">Save to Local Repository</label>
                                <select id="espressoSaveToRepo">
                                    <option value="false">Save to public directory (default)</option>
                                    <option value="true">Save to local repository (managed by GitHub tab)</option>
                                </select>
                                <small>When enabled, files are saved to the local repository configured in the GitHub tab instead of the public directory</small>
                            </div>
                        </div>
                        
                        <div id="espressoRepoStatus" style="margin-top: 15px; padding: 10px; background: white; border-radius: 3px; border: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d;">
                            <strong>Repository Status:</strong> <span id="espressoRepoStatusText">Checking GitHub tab configuration...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Template Source Selection -->
                <div id="espresso-template-source" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>📁 Template Source</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <p><small>Choose how to provide HTML template and image files. Only one method can be active at a time.</small></p>
                        
                        <!-- Template Source Method Selection -->
                        <div class="form-group">
                            <label>Template Source Method</label>
                            <div style="margin-top: 5px;">
                                <input type="radio" id="templateSourceUpload" name="templateSource" value="upload" onchange="toggleTemplateSourceMethod()">
                                <label for="templateSourceUpload" style="margin-left: 5px; font-weight: normal;">📤 File Upload</label>
                            </div>
                            <div style="margin-top: 5px;">
                                <input type="radio" id="templateSourceGit" name="templateSource" value="git" onchange="toggleTemplateSourceMethod()">
                                <label for="templateSourceGit" style="margin-left: 5px; font-weight: normal;">📋 Git Repository</label>
                            </div>
                        </div>

                        <!-- File Upload Section -->
                        <div id="templateUploadSection" style="display: none; margin-top: 15px; padding: 10px; border-left: 3px solid #007bff; background: rgba(0,123,255,0.1);">
                            <h5>📤 Upload Template Files</h5>
                            <p><small>Upload HTML template and image files directly to the server.</small></p>
                            
                            <div class="form-group">
                                <label for="espressoTemplateFile">Upload Template/Images</label>
                                <input type="file" id="espressoTemplateFile" accept=".html,.htm,.png,.jpg,.jpeg,.gif,.svg" multiple>
                                <small>Supported: HTML templates (.html, .htm) and images (.png, .jpg, .jpeg, .gif, .svg)</small>
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <button onclick="uploadEspressoTemplate()" class="btn btn-primary">Upload Files</button>
                                <button onclick="loadEspressoTemplateFiles()" class="btn btn-secondary">Refresh File List</button>
                            </div>
                        </div>

                        <!-- Git Repository Section -->
                        <div id="templateGitSection" style="display: none; margin-top: 15px; padding: 10px; border-left: 3px solid #28a745; background: rgba(40,167,69,0.1);">
                            <h5>📋 Git Repository Template Source</h5>
                            <p><small>Download/clone template files from a public git repository. No authentication required - works with any publicly accessible repository. All HTML and image files will be copied automatically.</small></p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="espressoGitRepoUrl">Template Repository URL <span style="color: red;">*</span></label>
                                    <input type="url" id="espressoGitRepoUrl" placeholder="https://github.com/username/template-repo.git">
                                    <small>Public git repository URL containing template files (no authentication needed)</small>
                                </div>
                                <div class="form-group">
                                    <label for="espressoGitBranch">Branch</label>
                                    <input type="text" id="espressoGitBranch" placeholder="main" value="main">
                                    <small>Git branch to download from (default: main)</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="espressoGitLocalPath">Temporary Download Path <span style="color: red;">*</span></label>
                                <input type="text" id="espressoGitLocalPath" placeholder="/tmp/espresso-template-repo">
                                <small>Temporary local directory where template files will be downloaded. Use writable paths like <code>/tmp/</code>. Files will be copied to the uploads directory automatically.</small>
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <button onclick="cloneEspressoTemplateRepo()" class="btn btn-success" id="cloneTemplateBtn">Download Template Repository</button>
                                <button onclick="loadEspressoTemplateFiles()" class="btn btn-secondary">Refresh File List</button>
                            </div>
                        </div>
                        
                        <!-- Common Template Files Display -->
                        <div id="espressoTemplateFiles" style="margin-top: 15px;"></div>
                        <div id="espressoTemplateAlert" class="alert" style="margin-top: 10px;"></div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="margin-top: 20px;">
                    <button onclick="saveEspressoConfig()" class="btn btn-primary">Save Configuration</button>
                    <button onclick="testEspressoGeneration()" class="btn btn-secondary">Test HTML Generation</button>
                    <button onclick="uploadEspressoToGitHub()" class="btn btn-secondary" id="uploadEspressoBtn" style="display: none;">Upload to GitHub</button>
                    <button onclick="refreshEspressoRepoStatus()" class="btn btn-secondary" id="refreshRepoStatusBtn">Refresh Repository Status</button>
                </div>
                
                <!-- Status and Preview -->
                <div style="margin-top: 15px;">
                    <div id="espressoStatus" class="status-info"></div>
                    <a href="/espresso" target="_blank" class="btn btn-secondary">Preview Generated Content</a>
                </div>
                
                <div id="espressoAlert" class="alert"></div>
            </div>
        </div>

        <!-- Espresso Data Editor -->
        <div class="card admin-section server-section server-espresso-section">
            <div class="card-header">
                <h2>📊 Espresso Data Editor</h2>
            </div>
            <div class="card-body">
                <p>Edit the espresso brewing data for each coffee preparation:</p>
                
                <!-- Shareable URL Section -->
                <div style="background-color: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
                    <h4 style="color: #155724; margin-bottom: 10px;">🔗 Shareable Espresso Editor</h4>
                    <p style="color: #155724; margin-bottom: 10px;">Share this URL with guests on your network to let them edit espresso data without logging in:</p>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="espressoEditorUrl" readonly style="flex: 1; padding: 8px; background: white; border: 1px solid #ccc; border-radius: 4px;" value="">
                        <button onclick="copyEspressoEditorUrl()" class="btn btn-secondary" style="white-space: nowrap;">Copy URL</button>
                        <a id="espressoEditorLink" href="/espresso-editor" target="_blank" class="btn btn-primary" style="text-decoration: none; white-space: nowrap;">Open Editor</a>
                    </div>
                </div>
                
                <div id="espressoDataContainer">
                    <!-- Data will be loaded here -->
                    <div style="text-align: center; color: #666; margin: 20px 0;">
                        <i>Loading espresso data...</i>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                    <button onclick="loadEspressoData()" class="btn btn-secondary">Reload Data</button>
                    <button onclick="saveEspressoData()" class="btn btn-primary">Save Changes</button>
                    <button onclick="resetEspressoData()" class="btn btn-danger">Reset to Defaults</button>
                </div>
                
                <div id="espressoDataAlert" class="alert"></div>
            </div>
        </div>

        <!-- GitHub Configuration -->
        <div class="card admin-section server-section server-github-section">
            <div class="card-header">
                <h2>GitHub Pages Configuration</h2>
            </div>
            <div class="card-body">
                <p>Configure GitHub Pages integration for automated website deployment:</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vidiotsGithubEnabled">GitHub Pages Upload</label>
                        <select id="vidiotsGithubEnabled">
                            <option value="false">Disabled</option>
                            <option value="true">Enabled</option>
                        </select>
                    </div>
                </div>
                
                <!-- GitHub Pages Configuration -->
                <div id="github-repository-settings" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>Repository Settings</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vidiotsRepoOwner">Repository Owner</label>
                                <input type="text" id="vidiotsRepoOwner" placeholder="github-username">
                            </div>
                            <div class="form-group">
                                <label for="vidiotsRepoName">Repository Name</label>
                                <input type="text" id="vidiotsRepoName" placeholder="username.github.io">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vidiotsRepoBranch">Branch</label>
                                <input type="text" id="vidiotsRepoBranch" placeholder="main">
                            </div>
                            <div class="form-group">
                                <label for="vidiotsRepoLocalPath">Local Repository Path</label>
                                <input type="text" id="vidiotsRepoLocalPath" placeholder="/path/to/local/repo">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vidiotsCommitMessage">Commit Message</label>
                                <input type="text" id="vidiotsCommitMessage" placeholder="Automated vidiots update">
                            </div>
                            <div class="form-group">
                                <label for="vidiotsAccessToken">GitHub Personal Access Token <span style="color: red;">*</span></label>
                                <input type="password" id="vidiotsAccessToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                <small style="color: #666;">Required for authentication. Create at: Settings → Developer settings → Personal access tokens</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Git Identity Configuration -->
                <div id="github-git-identity" class="collapsible-section">
                    <div class="collapsible-header collapsed">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            <span>Git Identity Configuration</span>
                        </div>
                    </div>
                    <div class="collapsible-content collapsed">
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                            Configure the git author identity for commits. This is required for GitHub upload operations and will persist across container restarts.
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="gitUserName">Git User Name <span style="color: red;">*</span></label>
                                <input type="text" id="gitUserName" placeholder="Your Name" required>
                                <small style="color: #666;">This will be used as the author name for git commits</small>
                            </div>
                            <div class="form-group">
                                <label for="gitUserEmail">Git User Email <span style="color: red;">*</span></label>
                                <input type="email" id="gitUserEmail" placeholder="your.email@example.com" required>
                                <small style="color: #666;">This will be used as the author email for git commits</small>
                            </div>
                        </div>
                        <div class="save-button-container">
                            <button class="btn btn-primary" onclick="saveGitIdentity()">Save Git Identity</button>
                            <button class="btn btn-secondary" onclick="loadGitIdentity()">Refresh</button>
                        </div>
                        <div id="gitIdentityAlert" class="alert" style="margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn" onclick="saveVidiotsConfig()">Save Configuration</button>
                    <button class="btn btn-secondary" onclick="testGitHubConnection()" id="testGitHubBtn">Test GitHub</button>
                    <button class="btn btn-secondary" onclick="cloneGitHubRepo()" id="cloneGitHubBtn">Clone/Pull Repository</button>
                    <button class="btn btn-secondary" onclick="browseGitHubRepo()" id="browseGitHubBtn">Browse Repository</button>
                    <button class="btn btn-secondary" onclick="uploadToGitHub()" id="uploadGitHubBtn">Upload to GitHub</button>
                </div>
                
                <!-- GitHub Operation Status & Logging -->
                <div id="githubStatusSection" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #28a745;">
                    <h4 style="margin-bottom: 10px; color: #28a745;">GitHub Operation Status</h4>
                    <div id="githubOperationStatus" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 3px; border: 1px solid #dee2e6; font-family: monospace; font-size: 0.9em; color: #6c757d;">
                        Ready for GitHub operations...
                    </div>
                    
                    <h5 style="margin-bottom: 10px;">Recent Operations Log</h5>
                    <div id="githubOperationLog" style="max-height: 200px; overflow-y: auto; background: white; border: 1px solid #dee2e6; border-radius: 3px; padding: 10px; font-family: monospace; font-size: 0.85em;">
                        <div class="log-entry" style="color: #6c757d; margin-bottom: 5px;">
                            <span class="timestamp">[${new Date().toLocaleTimeString()}]</span> 
                            <span class="level">INFO</span> 
                            <span class="message">GitHub interface initialized</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="clearGitHubLogs()" style="font-size: 0.8em;">Clear Logs</button>
                        <button class="btn btn-sm btn-secondary" onclick="refreshGitHubStatus()" style="font-size: 0.8em;">Refresh Status</button>
                    </div>
                </div>
                
                <div id="vidiotsAlert" class="alert"></div>
            </div>
        </div>

        <!-- GitHub.io Repository Browser -->
        <div class="card admin-section server-section server-github-section" id="githubRepositoryBrowser" style="display: none;">
            <div class="card-header">
                <h2>GitHub.io Repository Browser</h2>
            </div>
            <div class="card-body">
                <p>Browse and download files from your GitHub.io repository:</p>
                
                <div id="repositoryBrowserAlert" class="alert"></div>
                
                <!-- Breadcrumb Navigation -->
                <div id="breadcrumbNav" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <span style="font-weight: bold;">📁 Path: </span>
                    <span id="currentPath">/</span>
                </div>
                
                <!-- File Browser -->
                <div id="fileBrowser" style="border: 1px solid #ddd; border-radius: 5px; max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Click "Browse Repository" to explore your GitHub.io files
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="refreshRepositoryBrowser()">Refresh</button>
                    <button class="btn btn-secondary" onclick="goToParentDirectory()">📁 Up One Level</button>
                </div>
            </div>
        </div>


        <!-- Smart Mirror Dashboard Configuration - Server Sub-tab -->
        <div class="card admin-section server-section server-smartmirror-section">
            <div class="card-header">
                <h2>📱 Smart Mirror Dashboard</h2>
            </div>
            <div class="card-body">
                <p>Configure the Smart Mirror dashboard accessible at <a href="/smart-mirror" target="_blank">/smart-mirror</a> for display on home network devices:</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="smartMirrorEnabled">Smart Mirror Dashboard</label>
                        <select id="smartMirrorEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="smartMirrorTheme">Theme</label>
                        <select id="smartMirrorTheme">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                        </select>
                    </div>
                </div>

                <div class="section-divider"></div>
                
                <!-- Auto Theme Switching Configuration -->
                <h3>🌅 Auto Theme Switching</h3>
                <p style="margin-bottom: 15px;">
                    Automatically switch between light and dark themes based on sunrise/sunset times. 
                    Light theme is active from 30 minutes before sunrise to 30 minutes after sunset. 
                    Configure separately for each orientation.
                </p>
                
                <!-- Portrait Auto Theme Settings -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">📱 Portrait Mode Auto Theme</span>
                        <span class="collapsible-icon">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="autoThemePortraitEnabled">Auto Theme Switching</label>
                                <select id="autoThemePortraitEnabled">
                                    <option value="false">Disabled (use manual theme)</option>
                                    <option value="true">Enabled (auto by sunrise/sunset)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="autoThemePortraitLat">
                                    Latitude
                                    <span class="input-hint">Decimal degrees (e.g., 40.7128 for NYC)</span>
                                </label>
                                <input type="number" step="0.0001" id="autoThemePortraitLat" placeholder="e.g., 40.7128">
                            </div>
                            <div class="form-group">
                                <label for="autoThemePortraitLon">
                                    Longitude
                                    <span class="input-hint">Decimal degrees (e.g., -74.0060 for NYC)</span>
                                </label>
                                <input type="number" step="0.0001" id="autoThemePortraitLon" placeholder="e.g., -74.0060">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="autoThemePortraitTimezone">
                                    Timezone
                                    <span class="input-hint">IANA timezone identifier</span>
                                </label>
                                <select id="autoThemePortraitTimezone">
                                    <option value="America/New_York">America/New_York (EST/EDT)</option>
                                    <option value="America/Chicago">America/Chicago (CST/CDT)</option>
                                    <option value="America/Denver">America/Denver (MST/MDT)</option>
                                    <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                                    <option value="America/Phoenix">America/Phoenix (MST - no DST)</option>
                                    <option value="America/Anchorage">America/Anchorage (AKST/AKDT)</option>
                                    <option value="Pacific/Honolulu">Pacific/Honolulu (HST)</option>
                                    <option value="Europe/London">Europe/London (GMT/BST)</option>
                                    <option value="Europe/Paris">Europe/Paris (CET/CEST)</option>
                                    <option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option>
                                    <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                                    <option value="Asia/Shanghai">Asia/Shanghai (CST)</option>
                                    <option value="Australia/Sydney">Australia/Sydney (AEDT/AEST)</option>
                                    <option value="UTC">UTC</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="autoThemePortraitStatus" class="info-message" style="display: none; margin-top: 10px;"></div>
                    </div>
                </div>
                
                <!-- Landscape Auto Theme Settings -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">🖥️ Landscape Mode Auto Theme</span>
                        <span class="collapsible-icon">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="autoThemeLandscapeEnabled">Auto Theme Switching</label>
                                <select id="autoThemeLandscapeEnabled">
                                    <option value="false">Disabled (use manual theme)</option>
                                    <option value="true">Enabled (auto by sunrise/sunset)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="autoThemeLandscapeLat">
                                    Latitude
                                    <span class="input-hint">Decimal degrees (e.g., 40.7128 for NYC)</span>
                                </label>
                                <input type="number" step="0.0001" id="autoThemeLandscapeLat" placeholder="e.g., 40.7128">
                            </div>
                            <div class="form-group">
                                <label for="autoThemeLandscapeLon">
                                    Longitude
                                    <span class="input-hint">Decimal degrees (e.g., -74.0060 for NYC)</span>
                                </label>
                                <input type="number" step="0.0001" id="autoThemeLandscapeLon" placeholder="e.g., -74.0060">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="autoThemeLandscapeTimezone">
                                    Timezone
                                    <span class="input-hint">IANA timezone identifier</span>
                                </label>
                                <select id="autoThemeLandscapeTimezone">
                                    <option value="America/New_York">America/New_York (EST/EDT)</option>
                                    <option value="America/Chicago">America/Chicago (CST/CDT)</option>
                                    <option value="America/Denver">America/Denver (MST/MDT)</option>
                                    <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                                    <option value="America/Phoenix">America/Phoenix (MST - no DST)</option>
                                    <option value="America/Anchorage">America/Anchorage (AKST/AKDT)</option>
                                    <option value="Pacific/Honolulu">Pacific/Honolulu (HST)</option>
                                    <option value="Europe/London">Europe/London (GMT/BST)</option>
                                    <option value="Europe/Paris">Europe/Paris (CET/CEST)</option>
                                    <option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option>
                                    <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                                    <option value="Asia/Shanghai">Asia/Shanghai (CST)</option>
                                    <option value="Australia/Sydney">Australia/Sydney (AEDT/AEST)</option>
                                    <option value="UTC">UTC</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="autoThemeLandscapeStatus" class="info-message" style="display: none; margin-top: 10px;"></div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Interactive Grid Editor -->
                <div class="grid-editor-container">
                    <div class="grid-editor-header">
                        <h3>🎯 Interactive Grid Layout Editor</h3>
                        <div class="grid-editor-controls">
                            <div class="orientation-tabs" style="display: inline-flex; gap: 5px; margin-right: 15px;">
                                <button onclick="switchOrientation('portrait')" id="portraitTab" class="btn btn-secondary orientation-tab active" style="margin: 0;">
                                    📱 Portrait
                                </button>
                                <button onclick="switchOrientation('landscape')" id="landscapeTab" class="btn btn-secondary orientation-tab" style="margin: 0;">
                                    🖥️ Landscape
                                </button>
                            </div>
                            <button onclick="resetGridLayout()" class="btn btn-secondary" style="margin: 0;">
                                ↺ Reset Layout
                            </button>
                            <button onclick="applyGridChanges()" class="btn btn-success" style="margin: 0;">
                                ✓ Apply Changes
                            </button>
                        </div>
                    </div>
                    
                    <p style="color: #666; margin-bottom: 15px;">
                        <strong id="orientationInfo">Editing Portrait Layout:</strong> Drag and drop widgets to reposition them. Use the resize handles on corners to change widget size. 
                        Only enabled widgets are shown. Changes are applied to the form below when you click "Apply Changes".
                    </p>
                    
                    <div class="grid-editor-main">
                        <div class="grid-canvas-wrapper">
                            <div class="grid-canvas" id="gridCanvas">
                                <!-- Grid cells will be generated here -->
                            </div>
                        </div>
                        
                        <div class="widget-palette">
                            <h4>📦 Widget Status</h4>
                            <div id="widgetPalette">
                                <!-- Widget status items will be generated here -->
                            </div>
                            
                            <div class="grid-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                                    <span>Enabled Widget</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: linear-gradient(135deg, #999 0%, #666 100%);"></div>
                                    <span>Disabled Widget</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="border: 2px solid #ffd700; background: transparent;"></div>
                                    <span>Selected</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="border: 2px solid #ff4444; background: transparent;"></div>
                                    <span>Overlapping</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <h3>Widget Configuration</h3>
                <p style="margin-bottom: 15px;">Enable and configure widgets for the Smart Mirror dashboard. Portrait mode uses a finer 4×6 grid (better vertical control), while landscape mode uses an 8×4 grid (better horizontal control).</p>

                <!-- Clock Widget -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            🕐 Clock Widget
                        </span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clockEnabled">Clock Widget</label>
                                <select id="clockEnabled">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="clockSize">Size</label>
                                <select id="clockSize">
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clockGridX">Grid Position X (0-3)</label>
                                <input type="number" id="clockGridX" min="0" max="3" value="0">
                            </div>
                            <div class="form-group">
                                <label for="clockGridY">Grid Position Y (0-2)</label>
                                <input type="number" id="clockGridY" min="0" max="2" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clockGridWidth">Width (1-4 cells)</label>
                                <input type="number" id="clockGridWidth" min="1" max="4" value="2">
                            </div>
                            <div class="form-group">
                                <label for="clockGridHeight">Height (1-3 cells)</label>
                                <input type="number" id="clockGridHeight" min="1" max="3" value="1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Widget -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            📅 Calendar Widget
                        </span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="calendarEnabled">Calendar Widget</label>
                                <select id="calendarEnabled">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="calendarSize">Size</label>
                                <select id="calendarSize">
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="calendarGridX">Grid Position X (0-3)</label>
                                <input type="number" id="calendarGridX" min="0" max="3" value="2">
                            </div>
                            <div class="form-group">
                                <label for="calendarGridY">Grid Position Y (0-2)</label>
                                <input type="number" id="calendarGridY" min="0" max="2" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="calendarGridWidth">Width (1-4 cells)</label>
                                <input type="number" id="calendarGridWidth" min="1" max="4" value="2">
                            </div>
                            <div class="form-group">
                                <label for="calendarGridHeight">Height (1-3 cells)</label>
                                <input type="number" id="calendarGridHeight" min="1" max="3" value="2">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="calendarUrl">Calendar Feed URLs (one per line)</label>
                            <textarea id="calendarUrl" rows="3" placeholder="https://calendar.google.com/calendar/ical/...&#10;webcal://p01-caldav.icloud.com/published/...&#10;https://outlook.office365.com/owa/calendar/..."></textarea>
                            <small style="color: #666; display: block; margin-top: 4px;">
                                Import events from Google Calendar, Outlook, Apple Calendar (webcal:// supported), or other iCal-compatible services. Enter one URL per line.
                            </small>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-test-connection" onclick="testCalendarConnection()">
                                🔍 Test Calendar Feeds
                            </button>
                            <div id="calendarTestResult" class="test-result-container" style="display: none; margin-top: 10px;">
                                <div class="test-result-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weather Widget -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            🌤️ Weather Widget (Current Conditions)
                        </span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="weatherEnabled">Weather Widget</label>
                                <select id="weatherEnabled">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="weatherSize">Size</label>
                                <select id="weatherSize">
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="weatherGridX">Grid Position X (0-3)</label>
                                <input type="number" id="weatherGridX" min="0" max="3" value="0">
                            </div>
                            <div class="form-group">
                                <label for="weatherGridY">Grid Position Y (0-2)</label>
                                <input type="number" id="weatherGridY" min="0" max="2" value="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="weatherGridWidth">Width (1-4 cells)</label>
                                <input type="number" id="weatherGridWidth" min="1" max="4" value="2">
                            </div>
                            <div class="form-group">
                                <label for="weatherGridHeight">Height (1-3 cells)</label>
                                <input type="number" id="weatherGridHeight" min="1" max="3" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="weatherLocation">Location</label>
                            <input type="text" id="weatherLocation" placeholder="City, State or Zip Code (e.g., Seattle, WA)">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="weatherApiKey">OpenWeatherMap API Key</label>
                                <input type="password" id="weatherApiKey" placeholder="Enter your OpenWeatherMap API key">
                                <small style="color: #666; display: block; margin-top: 4px;">
                                    Get a free API key at <a href="https://openweathermap.org/api" target="_blank">openweathermap.org/api</a>
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="weatherUnits">Temperature Units</label>
                                <select id="weatherUnits">
                                    <option value="imperial">Fahrenheit (°F)</option>
                                    <option value="metric">Celsius (°C)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-test-connection" onclick="testWeatherConnection()">
                                🔍 Test Weather Connection
                            </button>
                            <div id="weatherTestResult" class="test-result-container" style="display: none; margin-top: 10px;">
                                <div class="test-result-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Forecast Widget -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            🌦️ Weather Forecast Widget
                        </span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="forecastEnabled">Forecast Widget</label>
                                <select id="forecastEnabled">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="forecastDays">Forecast Days</label>
                                <select id="forecastDays">
                                    <option value="3">3 Days</option>
                                    <option value="5" selected>5 Days</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="forecastGridX">Grid Position X (0-3)</label>
                                <input type="number" id="forecastGridX" min="0" max="3" value="0">
                            </div>
                            <div class="form-group">
                                <label for="forecastGridY">Grid Position Y (0-2)</label>
                                <input type="number" id="forecastGridY" min="0" max="2" value="2">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="forecastGridWidth">Width (1-4 cells)</label>
                                <input type="number" id="forecastGridWidth" min="1" max="4" value="4">
                            </div>
                            <div class="form-group">
                                <label for="forecastGridHeight">Height (1-3 cells)</label>
                                <input type="number" id="forecastGridHeight" min="1" max="3" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="forecastLocation">Location</label>
                            <input type="text" id="forecastLocation" placeholder="City, State or Zip Code (e.g., Seattle, WA)">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="forecastApiKey">OpenWeatherMap API Key</label>
                                <input type="password" id="forecastApiKey" placeholder="Enter your OpenWeatherMap API key">
                                <small style="color: #666; display: block; margin-top: 4px;">
                                    Uses the same OpenWeatherMap API. Get a free key at <a href="https://openweathermap.org/api" target="_blank">openweathermap.org/api</a>
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="forecastUnits">Temperature Units</label>
                                <select id="forecastUnits">
                                    <option value="imperial">Fahrenheit (°F)</option>
                                    <option value="metric">Celsius (°C)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- News Widget -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            📰 News Widget
                        </span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newsEnabled">News Widget</label>
                                <select id="newsEnabled">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newsSize">Size</label>
                                <select id="newsSize">
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newsGridX">Grid Position X (0-3)</label>
                                <input type="number" id="newsGridX" min="0" max="3" value="2">
                            </div>
                            <div class="form-group">
                                <label for="newsGridY">Grid Position Y (0-2)</label>
                                <input type="number" id="newsGridY" min="0" max="2" value="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newsGridWidth">Width (1-4 cells)</label>
                                <input type="number" id="newsGridWidth" min="1" max="4" value="2">
                            </div>
                            <div class="form-group">
                                <label for="newsGridHeight">Height (1-3 cells)</label>
                                <input type="number" id="newsGridHeight" min="1" max="3" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newsFeedUrl">RSS Feed URLs (one per line)</label>
                            <textarea id="newsFeedUrl" rows="3" placeholder="https://feeds.bbci.co.uk/news/rss.xml&#10;https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml"></textarea>
                            <small style="color: #666; display: block; margin-top: 4px;">
                                Enter RSS feed URLs from news sources you want to follow. One URL per line.
                            </small>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-test-connection" onclick="testNewsConnection()">
                                🔍 Test News Feeds
                            </button>
                            <div id="newsTestResult" class="test-result-container" style="display: none; margin-top: 10px;">
                                <div class="test-result-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Media Widget -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            🎵 Media Widget (Home Assistant)
                        </span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mediaEnabled">Media Widget</label>
                                <select id="mediaEnabled">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mediaSize">Size</label>
                                <select id="mediaSize">
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mediaGridX">Grid Position X (0-3)</label>
                                <input type="number" id="mediaGridX" min="0" max="3" value="0">
                            </div>
                            <div class="form-group">
                                <label for="mediaGridY">Grid Position Y (0-2)</label>
                                <input type="number" id="mediaGridY" min="0" max="2" value="2">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mediaGridWidth">Width (1-4 cells)</label>
                                <input type="number" id="mediaGridWidth" min="1" max="4" value="4">
                            </div>
                            <div class="form-group">
                                <label for="mediaGridHeight">Height (1-3 cells)</label>
                                <input type="number" id="mediaGridHeight" min="1" max="3" value="2">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mediaHomeAssistantUrl">Home Assistant Server URL</label>
                            <input type="text" id="mediaHomeAssistantUrl" placeholder="http://homeassistant.local:8123">
                            <small style="color: #666; display: block; margin-top: 4px;">
                                Enter the full URL of your Home Assistant server (e.g., http://192.168.1.100:8123 or http://homeassistant.local:8123)
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="mediaHomeAssistantToken">Home Assistant Long-Lived Access Token</label>
                            <input type="password" id="mediaHomeAssistantToken" placeholder="Enter your long-lived access token">
                            <small style="color: #666; display: block; margin-top: 4px;">
                                Create a long-lived access token in Home Assistant: Profile → Security → Long-Lived Access Tokens → Create Token
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="mediaEntityIds">Media Player Entity IDs (one per line)</label>
                            <textarea id="mediaEntityIds" rows="3" placeholder="media_player.spotify&#10;media_player.chromecast&#10;media_player.sonos"></textarea>
                            <small style="color: #666; display: block; margin-top: 4px;">
                                Enter the entity IDs of your Home Assistant media players. Find these in Home Assistant under Developer Tools → States. The widget will display the first active (playing/paused) player, or the first available player if none are active.
                            </small>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-test-connection" onclick="testMediaConnection()">
                                🔍 Test Home Assistant Connection
                            </button>
                            <div id="mediaTestResult" class="test-result-container" style="display: none; margin-top: 10px;">
                                <div class="test-result-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Smart Mirror Diagnostics -->
                <h3>📊 Diagnostics & Troubleshooting</h3>
                <p style="margin-bottom: 15px;">View deployment information and recent logs for troubleshooting Smart Mirror issues.</p>
                
                <button onclick="loadSmartMirrorDiagnostics()" class="btn btn-secondary" style="margin-bottom: 15px;">
                    🔍 Run Diagnostics
                </button>
                <button onclick="exportSmartMirrorLogs()" class="btn btn-secondary" style="margin-bottom: 15px; margin-left: 10px;">
                    📥 Export Logs
                </button>
                
                <div id="smartMirrorDiagnostics" style="display: none; margin-top: 15px;">
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px;">
                        <h4 style="margin-top: 0;">Environment Information</h4>
                        <div id="diagnosticsEnvironment" style="font-family: monospace; font-size: 12px;"></div>
                        
                        <h4 style="margin-top: 20px;">File Checks</h4>
                        <div id="diagnosticsFiles" style="font-family: monospace; font-size: 12px;"></div>
                        
                        <h4 style="margin-top: 20px;">Configuration Status</h4>
                        <div id="diagnosticsConfig" style="font-family: monospace; font-size: 12px;"></div>
                        
                        <h4 style="margin-top: 20px;">Warnings & Issues</h4>
                        <div id="diagnosticsWarnings" style="font-family: monospace; font-size: 12px;"></div>
                        
                        <h4 style="margin-top: 20px;">Recent Logs (Last 10 entries)</h4>
                        <div id="diagnosticsLogs" style="font-family: monospace; font-size: 11px; max-height: 300px; overflow-y: auto; background: #fff; padding: 10px; border: 1px solid #dee2e6; border-radius: 3px;"></div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <button onclick="saveSmartMirrorConfig()" class="btn btn-primary">Save Smart Mirror Configuration</button>
                <button onclick="previewSmartMirrorPortrait()" class="btn btn-secondary" style="margin-left: 10px;">📱 Preview Portrait</button>
                <button onclick="previewSmartMirrorLandscape()" class="btn btn-secondary" style="margin-left: 5px;">🖥️ Preview Landscape</button>
                
                <div id="smartMirrorAlert" class="alert"></div>
            </div>
        </div>


        <!-- Home Assistant Media Streaming -->
        <div class="card admin-section settings-section settings-general-section">
            <div class="card-header">
                <h2>Home Assistant Media Streaming</h2>
            </div>
            <div class="card-body">
                <p>Monitor and display media currently streaming on your Home Assistant devices:</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="haEnabled">Home Assistant Integration</label>
                        <select id="haEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mediaPlayersEnabled">Media Players</label>
                        <select id="mediaPlayersEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="haUrl">Home Assistant URL</label>
                    <input type="url" id="haUrl" placeholder="http://localhost:8123">
                </div>
                
                <div class="form-group">
                    <label for="haToken">Home Assistant Long-Lived Access Token</label>
                    <input type="password" id="haToken" placeholder="Enter your Home Assistant token">
                    <small style="color: #666; display: block; margin-top: 4px;">
                        Create a long-lived access token in Home Assistant: Profile → Security → Create Token
                    </small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="refreshInterval">Refresh Interval (ms)</label>
                        <input type="number" id="refreshInterval" min="1000" max="60000" step="1000" value="5000">
                    </div>
                    <div class="form-group">
                        <button id="testHAConnection" class="btn btn-secondary" onclick="testHomeAssistantConnection()">Test Connection</button>
                    </div>
                </div>
                
                <button onclick="saveMediaStreamingConfig()" class="btn btn-primary">Save Media Streaming Settings</button>
                
                <div class="section-divider"></div>
                
                <h3>Current Media Status</h3>
                <div id="mediaStreamingStatus">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading media streaming status...
                    </div>
                </div>
                
                <div id="mediaStreamingAlert" class="alert"></div>
            </div>
        </div>

        <!-- Backup & Restore - Settings Sub-tab -->
        <div class="card admin-section settings-section settings-general-section">
            <div class="card-header">
                <h2>💾 Backup & Restore</h2>
            </div>
            <div class="card-body">
                <p>Export all your site configurations and data to a backup file, or restore from a previously exported backup.</p>
                
                <!-- Export Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header expanded" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            📤 Export Data
                        </span>
                    </div>
                    <div class="collapsible-content expanded">
                        <div class="warning-box" style="margin-bottom: 1rem;">
                            <strong>⚠️ Security Note:</strong>
                            <p style="margin: 0.5rem 0 0 0;">For security, sensitive credentials (API keys, tokens, passwords) are NOT included in exports. You will need to re-enter these after importing.</p>
                        </div>
                        
                        <h4 style="margin-bottom: 0.5rem;">The export will include:</h4>
                        <ul style="margin-left: 1.5rem; margin-bottom: 1rem; color: #555;">
                            <li>Magic Mirror configuration (widget settings, layout)</li>
                            <li>Server settings and preferences</li>
                            <li>Vidiots configuration (excluding GitHub token)</li>
                            <li>Espresso configuration and data</li>
                            <li>Finance data (accounts, demographics, settings)</li>
                            <li>Useful links</li>
                            <li>Connected devices</li>
                            <li>Drink mixer recipes and ingredients</li>
                            <li>Tournament data</li>
                            <li>Client configurations</li>
                        </ul>
                        
                        <button onclick="exportBackup()" class="btn btn-primary">
                            📥 Download Backup File
                        </button>
                        
                        <div id="exportAlert" class="alert" style="margin-top: 1rem;"></div>
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <!-- Import Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header expanded" onclick="toggleCollapsible(this)">
                        <span class="collapsible-title">
                            <span class="collapsible-icon">▶</span>
                            📥 Import Data
                        </span>
                    </div>
                    <div class="collapsible-content expanded">
                        <div class="warning-box" style="margin-bottom: 1rem; background: #fff3cd;">
                            <strong>⚠️ Warning:</strong>
                            <p style="margin: 0.5rem 0 0 0;">Importing a backup will overwrite existing configurations. Existing API keys and passwords will be preserved if they are not included in the import file.</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="backupFileInput">Select Backup File</label>
                            <input type="file" id="backupFileInput" accept=".json" onchange="previewBackup(event)" style="width: 100%; padding: 0.75rem; border: 2px dashed #ddd; border-radius: 5px; cursor: pointer;">
                            <small style="color: #666;">Select a .json backup file previously exported from this system</small>
                        </div>
                        
                        <!-- Preview Section -->
                        <div id="backupPreview" style="display: none; margin-top: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">📋 Backup Preview</h4>
                            <div id="backupPreviewContent" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; border: 1px solid #ddd;">
                                <!-- Preview content will be populated here -->
                            </div>
                            
                            <div id="backupValidation" style="margin-top: 1rem;"></div>
                            
                            <div style="margin-top: 1rem;">
                                <button onclick="performImport()" class="btn btn-success" id="importBtn" disabled>
                                    ✅ Confirm Import
                                </button>
                                <button onclick="cancelImport()" class="btn btn-secondary">
                                    ❌ Cancel
                                </button>
                            </div>
                        </div>
                        
                        <div id="importAlert" class="alert" style="margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Logs - Settings Sub-tab -->
        <div class="card admin-section settings-section settings-logs-section hidden">
            <div class="card-header">
                <h2>📝 System Logs</h2>
            </div>
            <div class="card-body">
                <p>View error, status, and activity logs from all system modules. Logs are organized by category to help with troubleshooting.</p>
                
                <div class="form-row" style="margin-bottom: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label for="logCategoryFilter">Filter by Module:</label>
                        <select id="logCategoryFilter" onchange="loadSystemLogs()">
                            <option value="ALL">All Modules</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="logLevelFilter">Filter by Level:</label>
                        <select id="logLevelFilter" onchange="applyLogFilters()">
                            <option value="ALL">All Levels</option>
                            <option value="ERROR">❌ Errors Only</option>
                            <option value="WARNING">⚠️ Warnings Only</option>
                            <option value="SUCCESS">✅ Success Only</option>
                            <option value="INFO">ℹ️ Info Only</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button onclick="loadSystemLogs()" class="btn btn-secondary" style="margin-right: 0.5rem;">🔄 Refresh</button>
                        <button onclick="clearSystemLogs()" class="btn btn-danger">🗑️ Clear Logs</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label>
                        <input type="checkbox" id="autoRefreshLogs" onchange="toggleAutoRefresh()">
                        Auto-refresh every 5 seconds
                    </label>
                </div>
                
                <div id="systemLogsContainer" class="logs-container" style="max-height: 600px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 1rem;">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading logs...
                    </div>
                </div>
                
                <div id="systemLogsAlert" class="alert" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Tournament Management -->
        <div class="card admin-section party-section party-tournament-section">
            <div class="card-header">
                <h2>Tournament Bracket Tracker</h2>
            </div>
            <div class="card-body">
                <p>Manage tournaments and track brackets for competitive events.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <button id="createTournamentBtn" class="btn btn-primary">Create New Tournament</button>
                        <button id="refreshTournaments" class="btn btn-secondary">Refresh</button>
                    </div>
                </div>
                
                <div id="tournamentsContainer">
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        Loading tournaments...
                    </div>
                </div>
                
                <div id="tournamentAlert" class="alert"></div>
            </div>
        </div>

        <!-- System Logs -->
        <div class="card admin-section dashboard-section">
            <div class="card-header">
                <h2>System Logs</h2>
            </div>
            <div class="card-body">
                <button id="refreshLogs" class="btn btn-secondary">Refresh Logs</button>
                <div id="logsContainer" class="logs-container">
                    <!-- Logs will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card admin-section dashboard-section">
            <div class="card-header">
                <h2>Quick Actions</h2>
            </div>
            <div class="card-body">
                <p><strong>API Endpoints:</strong></p>
                <ul>
                    <li><code>GET /api/status</code> - Server status for external tools</li>
                    <li><code>POST /api/webhook</code> - Receive webhooks from external services</li>
                    <li><code>GET /api/data</code> - Data endpoint for integrations</li>
                </ul>
                
                <div class="section-divider"></div>
                
                <p><strong>Public Content:</strong></p>
                <p>Upload files to the <code>public</code> directory to serve web content.</p>
                <p><a href="/public/" target="_blank">View Public Directory</a></p>
                
                <div class="section-divider"></div>
                
                <p><strong>Integration URLs:</strong></p>
                <ul>
                    <li><strong>Home Assistant:</strong> Use <code>http://your-server:3000/api/status</code> as a RESTful sensor</li>
                    <li><strong>Cockpit:</strong> Monitor via <code>http://your-server:3000/api/status</code></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Balance Update Modal -->
    <div id="balanceUpdateModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Account Balance</h3>
                <span class="close" onclick="closeBalanceUpdateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="balanceUpdateAlert" class="alert" style="display: none;"></div>
                <form id="balanceUpdateForm">
                    <input type="hidden" id="balanceAccountId">
                    <div class="form-group">
                        <label>Account</label>
                        <input type="text" id="balanceAccountName" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>Current Balance</label>
                        <input type="text" id="balanceCurrentValue" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label for="balanceNewValue">New Balance ($)</label>
                        <input type="number" step="0.01" id="balanceNewValue" required placeholder="e.g., 25000.00">
                        <small class="help-text">Enter the new balance for this account</small>
                    </div>
                    <div class="form-group">
                        <label for="balanceDate">Balance Date</label>
                        <input type="date" id="balanceDate" required>
                        <small class="help-text">Date when this balance is effective (for historical tracking)</small>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeBalanceUpdateModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn" style="background: #28a745;">Update Balance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Display Name Modal -->
    <div id="displayNameModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Account Display Name</h3>
                <span class="close" onclick="closeDisplayNameModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="displayNameAlert" class="alert" style="display: none;"></div>
                <form id="displayNameForm" onsubmit="updateDisplayName(event)">
                    <input type="hidden" id="displayNameAccountId">
                    <div class="form-group">
                        <label>Original Account Name (from upload/OCR)</label>
                        <div id="displayNameOriginalName" style="padding: 10px; background: #f0f0f0; border-radius: 4px; color: #666;"></div>
                        <small class="help-text">This is the name captured from screenshots or initially entered. It's used for matching across uploads.</small>
                    </div>
                    <div class="form-group">
                        <label for="displayNameInput">Display Name</label>
                        <input type="text" id="displayNameInput" placeholder="e.g., My Savings Account">
                        <small class="help-text">This is the name shown throughout the interface. Leave blank to use the original name. Set a custom display name to correct OCR errors or make the name more descriptive.</small>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeDisplayNameModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn" style="background: #17a2b8;">Update Display Name</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tournament Creation Modal -->
    <div id="tournamentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Tournament</h3>
                <span class="close" onclick="closeTournamentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="tournamentModalAlert" class="alert"></div>
                <form id="tournamentForm">
                    <div class="form-group">
                        <label for="tournamentName">Tournament Name</label>
                        <input type="text" id="tournamentName" required placeholder="Spring Championship 2024">
                    </div>
                    <div class="form-group">
                        <label for="tournamentDescription">Description (Optional)</label>
                        <textarea id="tournamentDescription" rows="3" placeholder="Tournament description..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tournamentType">Tournament Type</label>
                            <select id="tournamentType">
                                <option value="single-elimination">Single Elimination</option>
                                <option value="double-elimination" disabled>Double Elimination (Coming Soon)</option>
                                <option value="round-robin" disabled>Round Robin (Coming Soon)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxParticipants">Max Participants</label>
                            <select id="maxParticipants">
                                <option value="4">4</option>
                                <option value="8" selected>8</option>
                                <option value="16">16</option>
                                <option value="32">32</option>
                                <option value="64">64</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeTournamentModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn">Create Tournament</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tournament Details Modal -->
    <div id="tournamentDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="tournamentDetailsTitle">Tournament Details</h3>
                <span class="close" onclick="closeTournamentDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="tournamentDetailsAlert" class="alert"></div>
                
                <!-- Tournament Info -->
                <div id="tournamentInfo" class="tournament-info">
                    <!-- Tournament info will be loaded here -->
                </div>
                
                <!-- Participants Section -->
                <div id="participantsSection" style="margin-top: 2rem;">
                    <h4>Participants</h4>
                    <div id="addParticipantForm" class="form-row" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <input type="text" id="participantName" placeholder="Participant name">
                        </div>
                        <div class="form-group">
                            <input type="text" id="teamMembers" placeholder="Team members (comma separated, optional)">
                        </div>
                        <div class="form-group">
                            <button type="button" id="addParticipantBtn" class="btn">Add Participant</button>
                        </div>
                    </div>
                    <div id="participantsList">
                        <!-- Participants will be loaded here -->
                    </div>
                </div>
                
                <!-- Bracket Section -->
                <div id="bracketSection" style="margin-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>Tournament Bracket</h4>
                        <div id="tournamentActions">
                            <!-- Actions will be loaded here -->
                        </div>
                    </div>
                    <div id="bracketContainer">
                        <!-- Bracket will be loaded here -->
                    </div>
                </div>
                
                <div class="modal-actions" style="margin-top: 2rem;">
                    <button type="button" onclick="closeTournamentDetailsModal()" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="passwordChangeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Admin Password</h3>
                <span class="close" onclick="closePasswordChangeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="passwordChangeAlert" class="alert"></div>
                <form id="passwordChangeForm">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" required minlength="4">
                        <small style="color: #666; display: block; margin-top: 4px;">Minimum 4 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" required minlength="4">
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closePasswordChangeModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn">Change Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        let originalConfig = '';
        let currentLinks = [];
        let systemDiskSpace = null; // Cache for system disk space information
        let unsavedChanges = new Set(); // Track sections with unsaved changes

        // Collapsible section functions
        function toggleCollapsible(sectionId) {
            const header = document.querySelector(`#${sectionId} .collapsible-header`);
            const content = document.querySelector(`#${sectionId} .collapsible-content`);
            
            if (!header || !content) {
                console.error(`Collapsible section ${sectionId} not found`);
                return;
            }

            const isExpanded = header.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                header.classList.remove('expanded');
                header.classList.add('collapsed');
                content.classList.remove('expanded');
                content.classList.add('collapsed');
            } else {
                // Expand
                header.classList.remove('collapsed');
                header.classList.add('expanded');
                content.classList.remove('collapsed');
                content.classList.add('expanded');
            }
        }

        function showErrorIndicator(sectionId, hasError) {
            const header = document.querySelector(`#${sectionId} .collapsible-header`);
            if (!header) return;

            let errorIndicator = header.querySelector('.error-indicator');
            
            if (hasError && !errorIndicator) {
                errorIndicator = document.createElement('span');
                errorIndicator.className = 'error-indicator';
                errorIndicator.innerHTML = '●';
                errorIndicator.title = 'This section has missing information or errors';
                header.querySelector('.collapsible-title').appendChild(errorIndicator);
            } else if (!hasError && errorIndicator) {
                errorIndicator.remove();
            }
        }

        function markUnsavedChanges(sectionId) {
            unsavedChanges.add(sectionId);
            updateUnsavedWarning();
        }

        function markSaved(sectionId) {
            unsavedChanges.delete(sectionId);
            updateUnsavedWarning();
        }

        function updateUnsavedWarning() {
            const warning = document.getElementById('unsaved-warning');
            if (unsavedChanges.size > 0) {
                if (!warning.classList.contains('show')) {
                    warning.classList.add('show');
                }
                const sections = Array.from(unsavedChanges).join(', ');
                warning.innerHTML = `⚠️ Unsaved changes in: ${sections}. Please save your changes.`;
            } else {
                warning.classList.remove('show');
            }
        }

        function initializeCollapsibleSections() {
            // Initialize all collapsible sections as collapsed by default
            const sections = [
                'espresso-image-mapping',
                'espresso-local-repo',
                'espresso-template-source',
                'github-repository-settings',
                'github-git-identity'
            ];

            sections.forEach(sectionId => {
                const header = document.querySelector(`#${sectionId} .collapsible-header`);
                const content = document.querySelector(`#${sectionId} .collapsible-content`);
                
                if (header && content) {
                    // Start collapsed
                    header.classList.add('collapsed');
                    content.classList.add('collapsed');
                    
                    // Add click handler
                    header.addEventListener('click', () => toggleCollapsible(sectionId));
                }
            });

            // Initialize change tracking for form inputs
            initializeChangeTracking();
        }

        function initializeChangeTracking() {
            // Track changes for espresso section inputs
            const espressoInputs = [
                'espressoEnabled', 'espressoDataFilePath', 'espressoTemplatePath', 'espressoOutputPath',
                'espressoLocalOutputPath', 'espressoLocalImagePath', 'espressoSaveToRepo',
                'templateSourceUpload', 'templateSourceGit', 'espressoGitRepoUrl', 'espressoGitBranch', 'espressoGitLocalPath'
            ];
            
            espressoInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', () => markUnsavedChanges('Espresso Configuration'));
                    input.addEventListener('input', () => markUnsavedChanges('Espresso Configuration'));
                }
            });

            // Track changes for GitHub repository settings
            const githubRepoInputs = [
                'vidiotsRepoOwner', 'vidiotsRepoName', 'vidiotsRepoBranch', 
                'vidiotsRepoLocalPath', 'vidiotsCommitMessage', 'vidiotsAccessToken'
            ];

            githubRepoInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', () => markUnsavedChanges('GitHub Repository Settings'));
                    input.addEventListener('input', () => markUnsavedChanges('GitHub Repository Settings'));
                }
            });

            // Track changes for Git identity
            const gitIdentityInputs = ['gitUserName', 'gitUserEmail'];
            
            gitIdentityInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', () => markUnsavedChanges('Git Identity'));
                    input.addEventListener('input', () => markUnsavedChanges('Git Identity'));
                }
            });

            // Set up periodic validation checks for error indicators
            setInterval(updateErrorIndicators, 5000); // Check every 5 seconds
        }

        function updateErrorIndicators() {
            // Check espresso sections for errors
            checkEspressoImageMappingErrors();
            checkEspressoLocalRepoErrors();
            checkEspressoTemplateSourceErrors();
            checkGitHubRepositoryErrors();
            checkGitIdentityErrors();
        }

        function checkEspressoImageMappingErrors() {
            // Check if there are image configuration issues
            const templatePath = document.getElementById('espressoTemplatePath').value.trim();
            const hasError = !templatePath || templatePath.includes('❌');
            showErrorIndicator('espresso-image-mapping', hasError);
        }

        function checkEspressoLocalRepoErrors() {
            // Check if local repository configuration has issues
            const repoStatusText = document.getElementById('espressoRepoStatusText');
            const hasError = repoStatusText && repoStatusText.textContent.includes('⚠️');
            showErrorIndicator('espresso-local-repo', hasError);
        }

        function checkEspressoTemplateSourceErrors() {
            // Check if template source has issues
            const uploadRadio = document.getElementById('templateSourceUpload');
            const gitRadio = document.getElementById('templateSourceGit');
            const templateFiles = document.getElementById('espressoTemplateFiles');
            
            let hasError = false;
            
            // No method selected
            if (!uploadRadio.checked && !gitRadio.checked) {
                hasError = true;
            }
            
            // Upload method selected but no files
            if (uploadRadio.checked && templateFiles && templateFiles.textContent.includes('No template files uploaded yet')) {
                hasError = true;
            }
            
            // Git method selected but no URL
            if (gitRadio.checked) {
                const gitUrl = document.getElementById('espressoGitRepoUrl').value.trim();
                if (!gitUrl) {
                    hasError = true;
                }
            }
            
            showErrorIndicator('espresso-template-source', hasError);
        }

        function checkGitHubRepositoryErrors() {
            // Check if required GitHub repository fields are missing
            const repoOwner = document.getElementById('vidiotsRepoOwner').value.trim();
            const repoName = document.getElementById('vidiotsRepoName').value.trim();
            const accessToken = document.getElementById('vidiotsAccessToken').value.trim();
            
            const hasError = !repoOwner || !repoName || (!accessToken && accessToken !== '••••••••••••••••••••');
            showErrorIndicator('github-repository-settings', hasError);
        }

        function checkGitIdentityErrors() {
            // Check if required Git identity fields are missing
            const userName = document.getElementById('gitUserName').value.trim();
            const userEmail = document.getElementById('gitUserEmail').value.trim();
            
            let hasError = !userName || !userEmail;
            
            // Basic email validation
            if (userEmail) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                hasError = hasError || !emailRegex.test(userEmail);
            }
            
            showErrorIndicator('github-git-identity', hasError);
        }
        
        // Load system disk space information
        async function loadSystemDiskSpace() {
            try {
                const response = await fetch('/admin/api/system/disk-space');
                const result = await response.json();
                if (result.success) {
                    systemDiskSpace = result.diskSpace;
                } else {
                    console.error('Failed to load disk space:', result.error);
                    // Set fallback values if API fails
                    systemDiskSpace = {
                        total: 50 * 1024 * 1024 * 1024, // 50GB fallback
                        available: 25 * 1024 * 1024 * 1024, // 25GB fallback
                        used: 25 * 1024 * 1024 * 1024,
                        approximate: true
                    };
                }
            } catch (error) {
                console.error('Error loading disk space:', error);
                // Set fallback values if request fails
                systemDiskSpace = {
                    total: 50 * 1024 * 1024 * 1024, // 50GB fallback
                    available: 25 * 1024 * 1024 * 1024, // 25GB fallback
                    used: 25 * 1024 * 1024 * 1024,
                    approximate: true
                };
            }
        }
        
        // Format uptime as days/hours/minutes
        function formatUptime(uptimeInSeconds) {
            const days = Math.floor(uptimeInSeconds / 86400);
            const hours = Math.floor((uptimeInSeconds % 86400) / 3600);
            const minutes = Math.floor((uptimeInSeconds % 3600) / 60);
            return `${days}d ${hours}h ${minutes}m`;
        }
        
        // Load server status
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                const statusGrid = document.getElementById('statusGrid');
                statusGrid.innerHTML = `
                    <div class="status-item">
                        <div class="status-label">Server Status</div>
                        <div class="status-value">${status.server.status}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Uptime</div>
                        <div class="status-value">${formatUptime(status.server.uptime)}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Port</div>
                        <div class="status-value">${status.server.port}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Memory Usage</div>
                        <div class="status-value">${Math.round(status.memory.heapUsed / 1024 / 1024)} MB / ${Math.round(status.memory.heapTotal / 1024 / 1024)} MB</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Version</div>
                        <div class="status-value">${status.version}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Last Updated</div>
                        <div class="status-value">${new Date(status.timestamp).toLocaleTimeString()}</div>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load status:', err);
            }
        }
        
        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/admin/api/config');
                const config = await response.json();
                originalConfig = JSON.stringify(config, null, 2);
                
                // Populate basic config form
                document.getElementById('serverPort').value = config.server.port;
                document.getElementById('adminUsername').value = config.server.admin.username;
                document.getElementById('adminPassword').value = config.server.admin.password;
                document.getElementById('homeAssistantEnabled').value = config.homeAssistant.enabled;
                document.getElementById('homeAssistantUrl').value = config.homeAssistant.url;
                document.getElementById('cockpitEnabled').value = config.cockpit.enabled;
                document.getElementById('cockpitUrl').value = config.cockpit.url;
                
                // Populate storage config
                if (config.storage) {
                    const maxTotalSizeStr = config.storage.maxTotalSize || '1GB';
                    const maxTotalSizeBytes = parseFileSize(maxTotalSizeStr);
                    const maxTotalSizeMB = bytesToMB(maxTotalSizeBytes);
                    
                    // Update slider and input
                    updateStorageSlider(maxTotalSizeMB);
                    
                    if (config.storage.maxFileSizes) {
                        document.getElementById('maxImageSize').value = config.storage.maxFileSizes.image || '';
                        document.getElementById('maxVideoSize').value = config.storage.maxFileSizes.video || '';
                        document.getElementById('maxDocumentSize').value = config.storage.maxFileSizes.document || '';
                        document.getElementById('maxOtherSize').value = config.storage.maxFileSizes.other || '';
                    }
                }
                
                // Populate advanced editor
                document.getElementById('configEditor').value = originalConfig;
            } catch (err) {
                console.error('Failed to load config:', err);
                showAlert('Failed to load configuration', 'error', 'configAlert');
            }
        }
        
        // Save basic configuration
        async function saveBasicConfig() {
            try {
                const config = {
                    server: {
                        port: parseInt(document.getElementById('serverPort').value),
                        admin: {
                            username: document.getElementById('adminUsername').value
                            // Note: password is intentionally omitted to prevent overwriting
                        }
                    },
                    homeAssistant: {
                        enabled: document.getElementById('homeAssistantEnabled').value === 'true',
                        url: document.getElementById('homeAssistantUrl').value
                    },
                    cockpit: {
                        enabled: document.getElementById('cockpitEnabled').value === 'true',
                        url: document.getElementById('cockpitUrl').value
                    },
                    webContent: {
                        directory: "./public",
                        defaultFile: "index.html"
                    }
                };
                
                // Get current config to preserve other settings
                const currentResponse = await fetch('/admin/api/config');
                const currentConfig = await currentResponse.json();
                
                // Merge with existing config, preserving the current admin password
                const mergedConfig = { ...currentConfig, ...config };
                // Ensure admin password is preserved from current config
                mergedConfig.server.admin.password = currentConfig.server.admin.password;
                
                const response = await fetch('/admin/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mergedConfig)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Basic configuration saved successfully!', 'success', 'configAlert');
                    setTimeout(loadStatus, 1000); // Refresh status
                    setTimeout(loadConfig, 1000); // Refresh config
                } else {
                    showAlert('Failed to save: ' + result.error, 'error', 'configAlert');
                }
            } catch (err) {
                showAlert('Error saving configuration: ' + err.message, 'error', 'configAlert');
            }
        }
        
        // Save storage configuration
        async function saveStorageConfig() {
            try {
                // Validate configuration first
                if (!validateStorageConfiguration()) {
                    showAlert('Please fix the storage configuration errors before saving.', 'error', 'storageAlert');
                    return;
                }
                
                // Get current config
                const currentResponse = await fetch('/admin/api/config');
                const config = await currentResponse.json();
                
                // Get values from slider/input
                const totalMB = parseInt(document.getElementById('maxTotalStorageInput').value) || 1000;
                const totalSizeStr = formatFileSizeFromMB(totalMB);
                
                // Update storage settings
                config.storage = {
                    maxTotalSize: totalSizeStr,
                    maxFileSizes: {
                        image: document.getElementById('maxImageSize').value,
                        video: document.getElementById('maxVideoSize').value,
                        document: document.getElementById('maxDocumentSize').value,
                        other: document.getElementById('maxOtherSize').value
                    }
                };
                
                const response = await fetch('/admin/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Storage settings saved successfully!', 'success', 'storageAlert');
                } else {
                    showAlert('Failed to save storage settings: ' + result.error, 'error', 'storageAlert');
                }
            } catch (err) {
                showAlert('Error saving storage settings: ' + err.message, 'error', 'storageAlert');
            }
        }
        
        // Save advanced configuration
        async function saveConfig() {
            try {
                const configText = document.getElementById('configEditor').value;
                const config = JSON.parse(configText);
                
                const response = await fetch('/admin/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    originalConfig = configText;
                    showAlert('Advanced configuration saved successfully!', 'success', 'configAlert');
                    setTimeout(loadStatus, 1000); // Refresh status
                    setTimeout(loadConfig, 1000); // Refresh basic form
                } else {
                    showAlert('Failed to save: ' + result.error, 'error', 'configAlert');
                }
            } catch (err) {
                showAlert('Invalid JSON format: ' + err.message, 'error', 'configAlert');
            }
        }
        
        // Reset configuration
        function resetConfig() {
            document.getElementById('configEditor').value = originalConfig;
            showAlert('Configuration reset to last saved version', 'success', 'configAlert');
        }
        
        // Toggle advanced config section
        function toggleAdvancedConfig() {
            const section = document.getElementById('advancedConfig');
            section.classList.toggle('hidden');
        }
        
        // Load logs (for Dashboard tab)
        async function loadLogs() {
            try {
                const response = await fetch('/admin/api/logs');
                const data = await response.json();
                
                const container = document.getElementById('logsContainer');
                const logs = data.logs || [];
                container.innerHTML = logs.slice(0, 10).map(log => `
                    <div class="log-entry">
                        <span class="log-timestamp">${new Date(log.timestamp).toLocaleString()}</span>
                        <span class="log-level ${log.level}">${log.level}</span>
                        <span class="log-message">${log.message}</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load logs:', err);
            }
        }
        
        // System Logs Functions (for Settings > Logs sub-tab)
        let autoRefreshInterval = null;
        let allSystemLogs = [];
        
        async function loadSystemLogs() {
            try {
                const category = document.getElementById('logCategoryFilter').value;
                const response = await fetch(`/admin/api/logs?category=${category}`);
                const data = await response.json();
                
                // Update category filter if needed
                const categoryFilter = document.getElementById('logCategoryFilter');
                if (categoryFilter.options.length === 1 && data.categories) {
                    categoryFilter.innerHTML = '<option value="ALL">All Modules</option>';
                    Object.entries(data.categories).forEach(([key, value]) => {
                        categoryFilter.innerHTML += `<option value="${value}">${value}</option>`;
                    });
                    categoryFilter.value = category;
                }
                
                allSystemLogs = data.logs || [];
                applyLogFilters();
                
                showSystemLogsAlert('Logs refreshed successfully', 'success');
                setTimeout(() => hideSystemLogsAlert(), 2000);
            } catch (err) {
                console.error('Failed to load system logs:', err);
                showSystemLogsAlert('Failed to load logs: ' + err.message, 'error');
            }
        }
        
        function applyLogFilters() {
            const levelFilter = document.getElementById('logLevelFilter').value;
            let filteredLogs = allSystemLogs;
            
            if (levelFilter !== 'ALL') {
                filteredLogs = allSystemLogs.filter(log => log.level === levelFilter);
            }
            
            displaySystemLogs(filteredLogs);
        }
        
        function displaySystemLogs(logs) {
            const container = document.getElementById('systemLogsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: 2rem;">No logs to display</div>';
                return;
            }
            
            const levelEmojis = {
                'INFO': 'ℹ️',
                'SUCCESS': '✅',
                'WARNING': '⚠️',
                'ERROR': '❌',
                'DEBUG': '🔍'
            };
            
            container.innerHTML = logs.map(log => `
                <div class="log-entry">
                    <span class="log-timestamp">${new Date(log.timestamp).toLocaleString()}</span>
                    <span class="log-category">${log.category}</span>
                    <span class="log-level ${log.level}">${levelEmojis[log.level] || ''} ${log.level}</span>
                    <span class="log-message">${escapeHtml(log.message)}</span>
                </div>
            `).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshLogs');
            
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(loadSystemLogs, 5000);
                showSystemLogsAlert('Auto-refresh enabled', 'success');
                setTimeout(() => hideSystemLogsAlert(), 2000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                showSystemLogsAlert('Auto-refresh disabled', 'success');
                setTimeout(() => hideSystemLogsAlert(), 2000);
            }
        }
        
        async function clearSystemLogs() {
            if (!confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/api/logs/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showSystemLogsAlert('All logs cleared successfully', 'success');
                    loadSystemLogs();
                } else {
                    throw new Error('Failed to clear logs');
                }
            } catch (err) {
                console.error('Failed to clear logs:', err);
                showSystemLogsAlert('Failed to clear logs: ' + err.message, 'error');
            }
        }
        
        function showSystemLogsAlert(message, type) {
            const alertDiv = document.getElementById('systemLogsAlert');
            alertDiv.textContent = message;
            alertDiv.className = 'alert ' + (type === 'success' ? 'alert-success' : 'alert-error');
            alertDiv.style.display = 'block';
        }
        
        function hideSystemLogsAlert() {
            const alertDiv = document.getElementById('systemLogsAlert');
            alertDiv.style.display = 'none';
        }
        
        // Load useful links
        async function loadLinks() {
            try {
                const response = await fetch('/admin/api/links');
                const links = await response.json();
                currentLinks = links;
                
                const container = document.getElementById('linksList');
                container.innerHTML = links.length > 0 ? links.map((link, index) => `
                    <li class="link-item">
                        <a href="${link.url}" target="_blank">${link.name}</a>
                        <button class="btn btn-danger" onclick="removeLink(${index})">Remove</button>
                    </li>
                `).join('') : '<li style="text-align: center; color: #6c757d;">No links saved yet</li>';
            } catch (err) {
                console.error('Failed to load links:', err);
            }
        }
        
        // Add useful link
        async function addLink() {
            const name = document.getElementById('linkName').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            
            if (!url) {
                showAlert('Please enter a URL', 'error', 'linksAlert');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/links', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, url })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('linkName').value = '';
                    document.getElementById('linkUrl').value = '';
                    showAlert('Link added successfully!', 'success', 'linksAlert');
                    loadLinks();
                } else {
                    showAlert('Failed to add link: ' + result.error, 'error', 'linksAlert');
                }
            } catch (err) {
                showAlert('Error adding link: ' + err.message, 'error', 'linksAlert');
            }
        }
        
        // Remove useful link
        async function removeLink(index) {
            const linkToRemove = currentLinks[index];
            if (!linkToRemove || !linkToRemove.id) {
                showAlert('Invalid link to remove', 'error', 'linksAlert');
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/links/${linkToRemove.id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Link removed successfully!', 'success', 'linksAlert');
                    loadLinks();
                } else {
                    showAlert('Failed to remove link: ' + result.error, 'error', 'linksAlert');
                }
            } catch (err) {
                showAlert('Error removing link: ' + err.message, 'error', 'linksAlert');
            }
        }
        
        // Show alert
        function showAlert(message, type, containerId) {
            const alert = document.getElementById(containerId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        // Handle authentication errors
        function handleAuthError(result, fallbackMessage = 'Authentication required') {
            if (result && result.code === 'UNAUTHORIZED') {
                // Session expired, redirect to login
                window.location.href = '/admin/login?expired=1';
                return true;
            }
            return false;
        }
        
        // Wrapper function for API calls that handles authentication errors
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, options);
                const result = await response.json();
                
                // Handle authentication errors
                if (handleAuthError(result)) {
                    throw new Error('Authentication required');
                }
                
                return result;
            } catch (error) {
                // Re-throw to let calling function handle other errors
                throw error;
            }
        }
        
        // Load client configuration and devices
        async function loadClientConfig() {
            try {
                const response = await fetch('/admin/api/client');
                const data = await response.json();
                
                // Populate client configuration
                const config = data.config;
                document.getElementById('clientEnabled').value = config.enabled ? 'true' : 'false';
                document.getElementById('welcomeMessage').value = config.welcomeMessage || '';
                document.getElementById('showServerStatus').value = config.showServerStatus ? 'true' : 'false';
                document.getElementById('showUsefulLinks').value = config.showUsefulLinks ? 'true' : 'false';
                
                // Update password status display
                updatePasswordStatus(config.requirePassword, config.hasPassword);
                
                // Load connected devices
                loadConnectedDevices(data.connectedDevices || []);
            } catch (err) {
                console.error('Failed to load client config:', err);
                showAlert('Failed to load client configuration', 'error', 'clientAlert');
            }
        }
        
        // Update password protection status display
        function updatePasswordStatus(requirePassword, hasPassword) {
            const statusElement = document.getElementById('passwordStatusText');
            if (hasPassword && requirePassword) {
                statusElement.innerHTML = '🔒 <strong>Protected</strong> - Client has set a password and protection is enabled';
                statusElement.style.color = '#28a745';
            } else if (hasPassword && !requirePassword) {
                statusElement.innerHTML = '🔓 <strong>Password Set but Disabled</strong> - Client has a password but protection is disabled';
                statusElement.style.color = '#ffc107';
            } else {
                statusElement.innerHTML = '🔓 <strong>No Protection</strong> - No client password is set';
                statusElement.style.color = '#6c757d';
            }
        }
        
        // Load connected devices
        function loadConnectedDevices(devices) {
            const container = document.getElementById('devicesContainer');
            
            if (devices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                        No clients have connected yet
                    </div>
                `;
                return;
            }
            
            container.innerHTML = devices.map(device => {
                const lastSeen = new Date(device.lastSeen);
                const firstSeen = new Date(device.firstSeen);
                const timeDiff = Math.floor((Date.now() - lastSeen.getTime()) / 1000 / 60); // minutes
                const timeAgo = timeDiff < 1 ? 'Just now' : timeDiff < 60 ? `${timeDiff}m ago` : `${Math.floor(timeDiff/60)}h ago`;
                
                return `
                    <div class="client-item" style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <div>
                                <h4 style="margin: 0; color: #333; font-size: 1.1rem;">
                                    ${escapeHtml(device.name || 'Unnamed Client')}
                                    <span style="opacity: 0.7; font-weight: normal; font-size: 0.9rem; margin-left: 0.5rem;">(${escapeHtml(device.deviceType)})</span>
                                </h4>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                    Client ID: <code style="background: #f1f1f1; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8rem;">${escapeHtml(device.deviceId)}</code>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="removeDevice('${device.deviceId}')" title="Remove client from device list only">Remove Device</button>
                                <button class="btn btn-danger" onclick="deleteClient('${device.deviceId}')" title="Delete client and all their data permanently">Delete Client</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.9rem; color: #555;">
                            <div>
                                <strong>Browser:</strong><br>
                                <span style="opacity: 0.8;">${escapeHtml(device.browserInfo || 'Unknown')}</span>
                            </div>
                            <div>
                                <strong>IP Address:</strong><br>
                                <span style="opacity: 0.8;">${escapeHtml(device.ip || 'Unknown')}</span>
                            </div>
                            <div>
                                <strong>Last Seen:</strong><br>
                                <span style="opacity: 0.8;">${timeAgo}</span>
                            </div>
                            <div>
                                <strong>First Connected:</strong><br>
                                <span style="opacity: 0.8;">${formatDate(device.firstSeen)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Save client configuration
        async function saveClientConfig() {
            const clientConfig = {
                enabled: document.getElementById('clientEnabled').value === 'true',
                welcomeMessage: document.getElementById('welcomeMessage').value.trim(),
                showServerStatus: document.getElementById('showServerStatus').value === 'true',
                showUsefulLinks: document.getElementById('showUsefulLinks').value === 'true'
            };
            
            try {
                const response = await fetch('/admin/api/client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(clientConfig)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Client configuration saved successfully!', 'success', 'clientAlert');
                    // Reload to refresh password status
                    loadClientConfig();
                } else {
                    showAlert('Failed to save client configuration: ' + result.error, 'error', 'clientAlert');
                }
            } catch (err) {
                showAlert('Error saving client configuration: ' + err.message, 'error', 'clientAlert');
            }
        }
        
        // Remove device
        async function removeDevice(deviceId) {
            if (!confirm('Are you sure you want to remove this device from the list? This will NOT delete any files uploaded by the client.')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/client/device/${deviceId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Device removed successfully!', 'success', 'clientAlert');
                    loadClientConfig(); // Reload to refresh device list
                } else {
                    showAlert('Failed to remove device: ' + result.error, 'error', 'clientAlert');
                }
            } catch (err) {
                showAlert('Error removing device: ' + err.message, 'error', 'clientAlert');
            }
        }
        
        // Delete client and all their data
        async function deleteClient(deviceId) {
            const deviceName = getDeviceName(deviceId);
            const confirmMessage = `⚠️ WARNING: This will permanently delete the client "${deviceName}" and ALL their data including:\n\n• Device record from the system\n• All uploaded files\n• All file metadata\n\nThis action CANNOT be undone!\n\nAre you absolutely sure you want to proceed?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Second confirmation for safety
            if (!confirm('This is your final warning. Type "DELETE" and press OK to confirm:')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/client/${deviceId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Client "${result.deletedDevice.name || 'Unnamed Device'}" and all associated data deleted successfully!`, 'success', 'clientAlert');
                    // Reload multiple sections that might be affected
                    loadClientConfig();
                    loadClientFiles();
                    loadClientStorageStats();
                } else {
                    showAlert('Failed to delete client: ' + result.error, 'error', 'clientAlert');
                }
            } catch (err) {
                showAlert('Error deleting client: ' + err.message, 'error', 'clientAlert');
            }
        }
        
        // Helper function to get device name from the current devices list
        function getDeviceName(deviceId) {
            const container = document.getElementById('devicesContainer');
            const deviceElements = container.querySelectorAll('.client-item');
            for (let element of deviceElements) {
                if (element.innerHTML.includes(deviceId)) {
                    const nameElement = element.querySelector('h4');
                    if (nameElement) {
                        return nameElement.textContent.split('(')[0].trim();
                    }
                }
            }
            return 'Unknown Device';
        }
        
        // Password Change Modal Functions
        function openPasswordChangeModal() {
            document.getElementById('passwordChangeModal').style.display = 'flex';
            document.getElementById('currentPassword').focus();
        }
        
        function closePasswordChangeModal() {
            document.getElementById('passwordChangeModal').style.display = 'none';
            document.getElementById('passwordChangeForm').reset();
            document.getElementById('passwordChangeAlert').innerHTML = '';
        }
        
        function showPasswordAlert(message, type) {
            const alertDiv = document.getElementById('passwordChangeAlert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }
        
        async function handlePasswordChange(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showPasswordAlert('New passwords do not match', 'error');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 4) {
                showPasswordAlert('New password must be at least 4 characters long', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showPasswordAlert('Password changed successfully!', 'success');
                    setTimeout(() => {
                        closePasswordChangeModal();
                        // Update the displayed password field to show it was changed
                        document.getElementById('adminPassword').value = '••••••••';
                    }, 2000);
                } else {
                    showPasswordAlert(result.error || 'Failed to change password', 'error');
                }
            } catch (err) {
                showPasswordAlert('Error changing password: ' + err.message, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('saveBasicConfig').addEventListener('click', saveBasicConfig);
        document.getElementById('saveStorageConfig').addEventListener('click', saveStorageConfig);
        document.getElementById('saveConfig').addEventListener('click', saveConfig);
        document.getElementById('resetConfig').addEventListener('click', resetConfig);
        document.getElementById('refreshLogs').addEventListener('click', loadLogs);
        document.getElementById('addLink').addEventListener('click', addLink);
        document.getElementById('saveClientConfig').addEventListener('click', saveClientConfig);
        document.getElementById('passwordChangeForm').addEventListener('submit', handlePasswordChange);
        
        // File type input validation listeners
        ['maxImageSize', 'maxVideoSize', 'maxDocumentSize', 'maxOtherSize'].forEach(id => {
            document.getElementById(id).addEventListener('input', validateStorageConfiguration);
        });
        
        // Close modal when clicking outside of it
        document.getElementById('passwordChangeModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closePasswordChangeModal();
            }
        });
        
        // Close balance update modal when clicking outside of it
        document.getElementById('balanceUpdateModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeBalanceUpdateModal();
            }
        });
        
        document.getElementById('displayNameModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeDisplayNameModal();
            }
        });
        
        // Load client storage usage statistics
        async function loadClientStorageStats() {
            try {
                const response = await fetch('/admin/api/client/storage-stats');
                const result = await response.json();
                
                const container = document.getElementById('clientStorageContainer');
                
                if (result.success && Object.keys(result.clients).length > 0) {
                    let maxClientSize = 0;
                    // Find the max client size for relative bar scaling
                    Object.values(result.clients).forEach(client => {
                        maxClientSize = Math.max(maxClientSize, client.totalSize);
                    });
                    
                    container.innerHTML = Object.values(result.clients).map(client => {
                        let maxCategorySize = 0;
                        // Find max category size for this client for relative bar scaling
                        Object.values(client.categories).forEach(category => {
                            maxCategorySize = Math.max(maxCategorySize, category.size);
                        });
                        
                        const categoriesHtml = Object.entries(client.categories).map(([type, data]) => {
                            const percentage = maxCategorySize > 0 ? (data.size / maxCategorySize * 100) : 0;
                            return `
                                <div class="storage-category ${type}">
                                    <div class="category-header">
                                        <span class="category-name">${type}</span>
                                        <span class="category-count">${data.count} files</span>
                                    </div>
                                    <div class="category-bar">
                                        <div class="category-bar-fill ${type}" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="category-size">${formatFileSize(data.size)}</div>
                                </div>
                            `;
                        }).join('');
                        
                        return `
                            <div class="storage-client">
                                <div class="storage-client-header">
                                    <span class="storage-client-name">${escapeHtml(client.deviceName)}</span>
                                    <span class="storage-client-total">${client.totalFiles} files • ${formatFileSize(client.totalSize)} total</span>
                                </div>
                                <div class="storage-categories">
                                    ${categoriesHtml}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="storage-empty">
                            No client storage data available
                        </div>
                    `;
                }
            } catch (error) {
                const container = document.getElementById('clientStorageContainer');
                container.innerHTML = `
                    <div style="text-align: center; opacity: 0.7; padding: 2rem; color: #dc3545;">
                        Error loading storage statistics: ${error.message}
                    </div>
                `;
            }
        }
        
        // Load client files
        async function loadClientFiles() {
            try {
                const response = await fetch('/admin/api/client/files');
                const result = await response.json();
                
                const container = document.getElementById('clientFilesContainer');
                
                if (result.success && result.files.length > 0) {
                    container.innerHTML = result.files.map(file => `
                        <div class="file-item" style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                            <div class="file-info" style="flex: 1; min-width: 200px;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 0.25rem;">${escapeHtml(file.originalName)}</div>
                                <div style="font-size: 0.9rem; color: #666;">
                                    Device: ${escapeHtml(file.deviceName)} | 
                                    Size: ${formatFileSize(file.size)} | 
                                    Type: ${file.mimeType} | 
                                    Uploaded: ${formatDate(file.uploadDate)}
                                    <span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-left: 0.5rem; background-color: ${getSharingColor(file.sharing)}; color: white;">
                                        ${formatSharing(file.sharing)}
                                    </span>
                                </div>
                            </div>
                            <div class="file-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="window.open('${file.url}', '_blank')" style="padding: 0.25rem 0.75rem; font-size: 0.9rem; border: none; border-radius: 4px; cursor: pointer; background-color: #007bff; color: white;">View</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; opacity: 0.7; padding: 2rem;">
                            No files uploaded by clients yet
                        </div>
                    `;
                }
            } catch (error) {
                const container = document.getElementById('clientFilesContainer');
                container.innerHTML = `
                    <div style="text-align: center; opacity: 0.7; padding: 2rem; color: #dc3545;">
                        Error loading client files: ${error.message}
                    </div>
                `;
            }
        }
        
        // Utility functions for client files
        function getSharingColor(sharing) {
            switch(sharing) {
                case 'none': return '#6c757d';
                case 'admin': return '#fd7e14';
                case 'all': return '#28a745';
                default: return '#6c757d';
            }
        }
        
        // Utility functions for file size conversion
        function parseFileSize(sizeStr) {
            const units = { 'B': 1, 'KB': 1024, 'MB': 1024*1024, 'GB': 1024*1024*1024 };
            const match = sizeStr.match(/^(\d+(?:\.\d+)?)\s*([A-Z]*B?)$/i);
            if (!match) return 0;
            const value = parseFloat(match[1]);
            const unit = match[2].toUpperCase() || 'B';
            return value * (units[unit] || 1);
        }
        
        function bytesToMB(bytes) {
            return Math.round(bytes / (1024 * 1024));
        }
        
        function mbToBytes(mb) {
            return mb * 1024 * 1024;
        }
        
        function formatFileSizeFromMB(mb) {
            const bytes = mbToBytes(mb);
            return formatFileSize(bytes);
        }
        
        // Storage slider management functions
        function updateStorageSlider(mb) {
            const slider = document.getElementById('maxTotalStorageSlider');
            const input = document.getElementById('maxTotalStorageInput');
            const display = document.getElementById('maxTotalStorageDisplay');
            
            slider.value = mb;
            input.value = mb;
            display.textContent = formatFileSizeFromMB(mb);
        }
        
        function setupStorageSlider() {
            const slider = document.getElementById('maxTotalStorageSlider');
            const input = document.getElementById('maxTotalStorageInput');
            
            // Set maximum based on available disk space
            if (systemDiskSpace) {
                const availableMB = bytesToMB(systemDiskSpace.available);
                const maxAllowedMB = Math.min(availableMB, 10000); // Cap at 10GB for UI reasons
                slider.max = maxAllowedMB;
                input.max = maxAllowedMB;
                
                // Update available storage info
                const infoElement = document.getElementById('availableStorageInfo');
                infoElement.textContent = `Available: ${formatFileSize(systemDiskSpace.available)}${systemDiskSpace.approximate ? ' (estimated)' : ''}`;
            }
            
            // Slider change handler
            slider.addEventListener('input', function() {
                const mb = parseInt(this.value);
                input.value = mb;
                document.getElementById('maxTotalStorageDisplay').textContent = formatFileSizeFromMB(mb);
                validateStorageConfiguration();
            });
            
            // Input change handler
            input.addEventListener('input', function() {
                const mb = parseInt(this.value) || 1;
                const maxMB = parseInt(slider.max);
                const clampedMB = Math.max(1, Math.min(mb, maxMB));
                
                if (mb !== clampedMB) {
                    this.value = clampedMB;
                }
                
                slider.value = clampedMB;
                document.getElementById('maxTotalStorageDisplay').textContent = formatFileSizeFromMB(clampedMB);
                validateStorageConfiguration();
            });
        }
        
        function validateStorageConfiguration() {
            const totalMB = parseInt(document.getElementById('maxTotalStorageInput').value) || 0;
            const messageElement = document.getElementById('storageValidationMessage');
            
            // Calculate sum of file type limits
            const imageSize = parseFileSize(document.getElementById('maxImageSize').value || '0MB');
            const videoSize = parseFileSize(document.getElementById('maxVideoSize').value || '0MB');
            const documentSize = parseFileSize(document.getElementById('maxDocumentSize').value || '0MB');
            const otherSize = parseFileSize(document.getElementById('maxOtherSize').value || '0MB');
            
            const totalFileTypesBytes = imageSize + videoSize + documentSize + otherSize;
            const totalFileTypesMB = bytesToMB(totalFileTypesBytes);
            
            messageElement.className = 'storage-validation-message';
            
            if (totalFileTypesMB > totalMB) {
                messageElement.className += ' error';
                messageElement.textContent = `Error: Total file type limits (${formatFileSize(totalFileTypesBytes)}) exceed maximum total storage (${formatFileSizeFromMB(totalMB)}).`;
                return false;
            } else if (totalFileTypesMB > totalMB * 0.8) {
                messageElement.className += ' warning';
                messageElement.textContent = `Warning: File type limits (${formatFileSize(totalFileTypesBytes)}) are close to maximum total storage (${formatFileSizeFromMB(totalMB)}).`;
            } else {
                messageElement.style.display = 'none';
            }
            
            return true;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }
        
        function formatSharing(sharing) {
            switch(sharing) {
                case 'none': return 'Private';
                case 'admin': return 'Admin Only';
                case 'all': return 'Public';
                default: return sharing;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load initial data
        async function initializeAdmin() {
            // Load system information first
            await loadSystemDiskSpace();
            
            // Load configuration and setup storage slider
            await loadConfig();
            setupStorageSlider();
            
            // Load other data
            loadStatus();
            loadLogs();
            loadLinks();
            loadClientConfig();
            loadClientFiles();
            loadClientStorageStats();
            loadMediaStreamingConfig(); // Load media streaming configuration
            initializeDrinkMixer();
            initializeFinance();
        }
        
        // Drink Mixer Functions
        let currentAlcohols = [];
        let currentMixers = [];
        let currentRecipes = [];
        let availableIngredients = [];
        
        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for the selected tab
            if (tabName === 'alcohols') {
                loadAlcohols();
            } else if (tabName === 'mixers') {
                loadMixers();
            } else if (tabName === 'recipes') {
                loadRecipes();
                loadAvailableIngredients().then(() => {
                    // Populate initial dropdown after ingredients are loaded
                    const initialDropdown = document.querySelector('#recipeIngredients .ingredient-name-dropdown');
                    if (initialDropdown) {
                        populateIngredientDropdown(initialDropdown);
                    }
                });
            } else if (tabName === 'available') {
                loadAvailableDrinks();
            }
        }
        
        // Load alcohols
        async function loadAlcohols() {
            try {
                const response = await fetch('/admin/api/drink-mixer/alcohols');
                currentAlcohols = await response.json();
                
                const container = document.getElementById('alcoholsList');
                if (currentAlcohols.length === 0) {
                    container.innerHTML = '<div class="no-items">No alcohols added yet</div>';
                    return;
                }
                
                container.innerHTML = currentAlcohols.map(alcohol => `
                    <div class="ingredient-item ${!alcohol.available ? 'unavailable' : ''}">
                        <div>
                            <div class="ingredient-name">${alcohol.name}</div>
                            <span class="ingredient-status ${alcohol.available ? 'available' : 'unavailable'}">
                                ${alcohol.available ? 'Available' : 'Unavailable'}
                            </span>
                        </div>
                        <div class="ingredient-actions">
                            <button onclick="toggleAlcoholAvailability(${alcohol.id})" class="btn btn-secondary btn-small">
                                ${alcohol.available ? 'Mark Unavailable' : 'Mark Available'}
                            </button>
                            <button onclick="removeAlcohol(${alcohol.id})" class="btn btn-danger btn-small">Remove</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load alcohols:', err);
                showAlertInTab('alcohols', 'Failed to load alcohols: ' + err.message, 'error');
            }
        }
        
        // Add alcohol
        async function addAlcohol() {
            const name = document.getElementById('alcoholName').value.trim();
            const available = document.getElementById('alcoholAvailable').value === 'true';
            
            if (!name) {
                showAlertInTab('alcohols', 'Please enter an alcohol name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/drink-mixer/alcohols', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, available })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('alcoholName').value = '';
                    document.getElementById('alcoholAvailable').value = 'true';
                    showAlertInTab('alcohols', result.message, 'success');
                    loadAlcohols();
                } else {
                    showAlertInTab('alcohols', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('alcohols', 'Error adding alcohol: ' + err.message, 'error');
            }
        }
        
        // Toggle alcohol availability
        async function toggleAlcoholAvailability(id) {
            const alcohol = currentAlcohols.find(a => a.id === id);
            if (!alcohol) return;
            
            try {
                const response = await fetch('/admin/api/drink-mixer/alcohols', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: alcohol.name, available: !alcohol.available })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('alcohols', result.message, 'success');
                    loadAlcohols();
                } else {
                    showAlertInTab('alcohols', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('alcohols', 'Error updating alcohol: ' + err.message, 'error');
            }
        }
        
        // Remove alcohol
        async function removeAlcohol(id) {
            if (!confirm('Are you sure you want to remove this alcohol?')) return;
            
            try {
                const response = await fetch(`/admin/api/drink-mixer/alcohols/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('alcohols', result.message, 'success');
                    loadAlcohols();
                } else {
                    showAlertInTab('alcohols', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('alcohols', 'Error removing alcohol: ' + err.message, 'error');
            }
        }
        
        // Load mixers
        async function loadMixers() {
            try {
                const response = await fetch('/admin/api/drink-mixer/mixers');
                currentMixers = await response.json();
                
                const container = document.getElementById('mixersList');
                if (currentMixers.length === 0) {
                    container.innerHTML = '<div class="no-items">No mixers added yet</div>';
                    return;
                }
                
                container.innerHTML = currentMixers.map(mixer => `
                    <div class="ingredient-item ${!mixer.available ? 'unavailable' : ''}">
                        <div>
                            <div class="ingredient-name">${mixer.name}</div>
                            <span class="ingredient-status ${mixer.available ? 'available' : 'unavailable'}">
                                ${mixer.available ? 'Available' : 'Unavailable'}
                            </span>
                        </div>
                        <div class="ingredient-actions">
                            <button onclick="toggleMixerAvailability(${mixer.id})" class="btn btn-secondary btn-small">
                                ${mixer.available ? 'Mark Unavailable' : 'Mark Available'}
                            </button>
                            <button onclick="removeMixer(${mixer.id})" class="btn btn-danger btn-small">Remove</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load mixers:', err);
                showAlertInTab('mixers', 'Failed to load mixers: ' + err.message, 'error');
            }
        }
        
        // Add mixer
        async function addMixer() {
            const name = document.getElementById('mixerName').value.trim();
            const available = document.getElementById('mixerAvailable').value === 'true';
            
            if (!name) {
                showAlertInTab('mixers', 'Please enter a mixer name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/drink-mixer/mixers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, available })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('mixerName').value = '';
                    document.getElementById('mixerAvailable').value = 'true';
                    showAlertInTab('mixers', result.message, 'success');
                    loadMixers();
                } else {
                    showAlertInTab('mixers', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('mixers', 'Error adding mixer: ' + err.message, 'error');
            }
        }
        
        // Toggle mixer availability
        async function toggleMixerAvailability(id) {
            const mixer = currentMixers.find(m => m.id === id);
            if (!mixer) return;
            
            try {
                const response = await fetch('/admin/api/drink-mixer/mixers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: mixer.name, available: !mixer.available })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('mixers', result.message, 'success');
                    loadMixers();
                } else {
                    showAlertInTab('mixers', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('mixers', 'Error updating mixer: ' + err.message, 'error');
            }
        }
        
        // Remove mixer
        async function removeMixer(id) {
            if (!confirm('Are you sure you want to remove this mixer?')) return;
            
            try {
                const response = await fetch(`/admin/api/drink-mixer/mixers/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('mixers', result.message, 'success');
                    loadMixers();
                } else {
                    showAlertInTab('mixers', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('mixers', 'Error removing mixer: ' + err.message, 'error');
            }
        }
        
        // Load available ingredients for dropdown
        async function loadAvailableIngredients() {
            try {
                const response = await fetch('/admin/api/drink-mixer/available-ingredients');
                availableIngredients = await response.json();
            } catch (err) {
                console.error('Error loading available ingredients:', err);
                availableIngredients = [];
            }
        }
        
        // Recipe management
        function populateIngredientDropdown(selectElement) {
            // Clear existing options except the default ones
            selectElement.innerHTML = '<option value="">Select ingredient...</option><option value="__ADD_NEW__">+ Add New Ingredient</option>';
            
            // Add available ingredients
            availableIngredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient.name;
                option.textContent = `${ingredient.name} (${ingredient.type})`;
                selectElement.appendChild(option);
            });
        }
        
        function handleIngredientChange(selectElement) {
            const row = selectElement.closest('.ingredient-row');
            const textInput = row.querySelector('.ingredient-name-input');
            
            if (selectElement.value === '__ADD_NEW__') {
                selectElement.style.display = 'none';
                textInput.style.display = 'block';
                textInput.focus();
            } else {
                textInput.style.display = 'none';
                selectElement.style.display = 'block';
            }
        }
        
        function addIngredientRow() {
            const container = document.getElementById('recipeIngredients');
            const newRow = document.createElement('div');
            newRow.className = 'ingredient-row';
            newRow.innerHTML = `
                <div class="ingredient-field">
                    <select class="ingredient-name-dropdown" onchange="handleIngredientChange(this)">
                        <option value="">Select ingredient...</option>
                        <option value="__ADD_NEW__">+ Add New Ingredient</option>
                    </select>
                    <input type="text" class="ingredient-name-input" placeholder="Enter new ingredient name" style="display: none;">
                </div>
                <input type="number" class="ingredient-amount" placeholder="Amount" step="0.1" min="0.1">
                <select class="ingredient-unit">
                    <option value="oz">Ounces</option>
                    <option value="dash">Dashes</option>
                    <option value="unit">Units</option>
                </select>
                <button type="button" onclick="removeIngredientRow(this)" class="btn btn-danger btn-small">Remove</button>
            `;
            container.appendChild(newRow);
            
            // Populate the dropdown
            const dropdown = newRow.querySelector('.ingredient-name-dropdown');
            populateIngredientDropdown(dropdown);
        }
        
        function removeIngredientRow(button) {
            const container = document.getElementById('recipeIngredients');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }
        
        // Add recipe
        async function addRecipe() {
            const name = document.getElementById('recipeName').value.trim();
            const directions = document.getElementById('recipeDirections').value.trim();
            const ingredientRows = document.querySelectorAll('#recipeIngredients .ingredient-row');
            
            if (!name) {
                showAlertInTab('recipes', 'Please enter a recipe name', 'error');
                return;
            }
            
            const ingredients = [];
            for (const row of ingredientRows) {
                const dropdown = row.querySelector('.ingredient-name-dropdown');
                const textInput = row.querySelector('.ingredient-name-input');
                const amount = parseFloat(row.querySelector('.ingredient-amount').value);
                const unit = row.querySelector('.ingredient-unit').value;
                
                let ingredientName = '';
                if (dropdown.value && dropdown.value !== '__ADD_NEW__') {
                    ingredientName = dropdown.value;
                } else if (textInput.style.display !== 'none' && textInput.value.trim()) {
                    ingredientName = textInput.value.trim();
                }
                
                if (ingredientName && amount > 0 && unit) {
                    ingredients.push({ name: ingredientName, amount, unit });
                }
            }
            
            if (ingredients.length === 0) {
                showAlertInTab('recipes', 'Please add at least one valid ingredient', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/drink-mixer/recipes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, ingredients, directions })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('recipeName').value = '';
                    document.getElementById('recipeDirections').value = '';
                    // Reset to single ingredient row
                    resetIngredientRows();
                    showAlertInTab('recipes', result.message, 'success');
                    loadRecipes();
                } else {
                    showAlertInTab('recipes', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('recipes', 'Error adding recipe: ' + err.message, 'error');
            }
        }
        
        function resetIngredientRows() {
            document.getElementById('recipeIngredients').innerHTML = `
                <div class="ingredient-row">
                    <div class="ingredient-field">
                        <select class="ingredient-name-dropdown" onchange="handleIngredientChange(this)">
                            <option value="">Select ingredient...</option>
                            <option value="__ADD_NEW__">+ Add New Ingredient</option>
                        </select>
                        <input type="text" class="ingredient-name-input" placeholder="Enter new ingredient name" style="display: none;">
                    </div>
                    <input type="number" class="ingredient-amount" placeholder="Amount" step="0.1" min="0.1">
                    <select class="ingredient-unit">
                        <option value="oz">Ounces</option>
                        <option value="dash">Dashes</option>
                        <option value="unit">Units</option>
                    </select>
                    <button type="button" onclick="removeIngredientRow(this)" class="btn btn-danger btn-small">Remove</button>
                </div>
            `;
            // Populate the dropdown
            const dropdown = document.querySelector('#recipeIngredients .ingredient-name-dropdown');
            populateIngredientDropdown(dropdown);
        }
        
        // Load recipes
        async function loadRecipes() {
            try {
                const response = await fetch('/admin/api/drink-mixer/recipes');
                currentRecipes = await response.json();
                
                const container = document.getElementById('recipesList');
                if (currentRecipes.length === 0) {
                    container.innerHTML = '<div class="no-items">No recipes added yet</div>';
                    return;
                }
                
                container.innerHTML = currentRecipes.map(recipe => `
                    <div class="recipe-item">
                        <div class="recipe-header">
                            <div class="recipe-name">${recipe.name}</div>
                            <button onclick="removeRecipe(${recipe.id})" class="btn btn-danger btn-small">Remove</button>
                        </div>
                        <div class="recipe-ingredients">
                            ${recipe.ingredients.map(ing => `
                                <div class="recipe-ingredient">
                                    <span class="recipe-ingredient-name">${ing.name}</span>
                                    <span class="recipe-ingredient-amount">${ing.amount || ing.ounces} ${getUnitDisplay(ing.unit || 'oz')}</span>
                                </div>
                            `).join('')}
                        </div>
                        ${recipe.directions ? `
                            <div class="recipe-directions">
                                <strong>Directions:</strong>
                                <p>${recipe.directions}</p>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load recipes:', err);
                showAlertInTab('recipes', 'Failed to load recipes: ' + err.message, 'error');
            }
        }
        
        function getUnitDisplay(unit) {
            switch(unit) {
                case 'oz': return 'oz';
                case 'dash': return 'dash(es)';
                case 'unit': return 'unit(s)';
                default: return 'oz';
            }
        }
        
        // Remove recipe
        async function removeRecipe(id) {
            if (!confirm('Are you sure you want to remove this recipe?')) return;
            
            try {
                const response = await fetch(`/admin/api/drink-mixer/recipes/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlertInTab('recipes', result.message, 'success');
                    loadRecipes();
                } else {
                    showAlertInTab('recipes', result.error, 'error');
                }
            } catch (err) {
                showAlertInTab('recipes', 'Error removing recipe: ' + err.message, 'error');
            }
        }
        
        // Load available drinks
        async function loadAvailableDrinks() {
            try {
                const response = await fetch('/api/drink-mixer/available-drinks');
                const data = await response.json();
                
                const container = document.getElementById('availableDrinksList');
                if (data.availableDrinks.length === 0) {
                    container.innerHTML = `
                        <div class="no-items">
                            No drinks can be made with current available ingredients.<br>
                            <small>Total recipes: ${data.totalRecipes}</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #d4edda; border-radius: 6px; color: #155724;">
                        <strong>${data.availableCount}</strong> of <strong>${data.totalRecipes}</strong> drinks can be made
                    </div>
                    ${data.availableDrinks.map(drink => `
                        <div class="available-drink-item">
                            <div class="available-drink-name">${drink.name}</div>
                            <div class="available-drink-ingredients">
                                ${drink.ingredients.map(ing => `
                                    <div class="recipe-ingredient">
                                        <span class="recipe-ingredient-name">${ing.name}</span>
                                        <span class="recipe-ingredient-amount">${ing.amount || ing.ounces} ${getUnitDisplay(ing.unit || 'oz')}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ${drink.directions ? `
                                <div class="recipe-directions" style="margin-top: 0.5rem; font-size: 0.9rem;">
                                    <strong>Directions:</strong> ${drink.directions}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                `;
            } catch (err) {
                console.error('Failed to load available drinks:', err);
                showAlertInTab('available', 'Failed to load available drinks: ' + err.message, 'error');
            }
        }
        
        // Helper function to show alerts in tabs
        function showAlertInTab(tabName, message, type) {
            const alertId = `${tabName}Alert`;
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.textContent = message;
                alert.className = `alert alert-${type}`;
                alert.style.display = 'block';
                
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }
        
        // Initialize drink mixer data on page load
        function initializeDrinkMixer() {
            loadAlcohols(); // Load the default active tab
        }
        
        // Home Assistant Media Streaming Functions
        async function loadMediaStreamingConfig() {
            try {
                const response = await fetch('/admin/api/media-streaming/config');
                const config = await response.json();
                
                if (config.homeAssistant) {
                    const ha = config.homeAssistant;
                    document.getElementById('haEnabled').value = ha.enabled.toString();
                    document.getElementById('haUrl').value = ha.url || 'http://localhost:8123';
                    document.getElementById('haToken').value = ha.hasToken ? '••••••••••••' : '';
                    document.getElementById('haToken').dataset.hasToken = ha.hasToken.toString();
                    
                    if (ha.mediaPlayers) {
                        document.getElementById('mediaPlayersEnabled').value = ha.mediaPlayers.enabled.toString();
                        document.getElementById('refreshInterval').value = ha.mediaPlayers.refreshInterval || 5000;
                    }
                }
                
                // Load media status if enabled
                if (config.homeAssistant?.enabled && config.homeAssistant?.mediaPlayers?.enabled) {
                    loadMediaStreamingStatus();
                }
            } catch (error) {
                console.error('Error loading media streaming config:', error);
                showAlert('Failed to load media streaming configuration', 'error', 'mediaStreamingAlert');
            }
        }
        
        async function saveMediaStreamingConfig() {
            try {
                const tokenField = document.getElementById('haToken');
                let token = tokenField.value;
                
                // If showing masked token and user didn't change it, don't send it
                if (token === '••••••••••••' && tokenField.dataset.hasToken === 'true') {
                    token = undefined; // Don't update the token
                }
                
                const configData = {
                    homeAssistant: {
                        enabled: document.getElementById('haEnabled').value === 'true',
                        url: document.getElementById('haUrl').value,
                        mediaPlayers: {
                            enabled: document.getElementById('mediaPlayersEnabled').value === 'true',
                            refreshInterval: parseInt(document.getElementById('refreshInterval').value) || 5000
                        }
                    }
                };
                
                // Only include token if it was changed
                if (token !== undefined && token !== '••••••••••••') {
                    configData.homeAssistant.token = token;
                }
                
                const response = await fetch('/admin/api/media-streaming/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Media streaming configuration saved successfully!', 'success', 'mediaStreamingAlert');
                    loadMediaStreamingConfig(); // Reload to refresh display
                } else {
                    showAlert('Failed to save configuration: ' + result.error, 'error', 'mediaStreamingAlert');
                }
            } catch (error) {
                showAlert('Error saving configuration: ' + error.message, 'error', 'mediaStreamingAlert');
            }
        }
        
        async function testHomeAssistantConnection() {
            const testButton = document.getElementById('testHAConnection');
            const originalText = testButton.textContent;
            
            try {
                testButton.textContent = 'Testing...';
                testButton.disabled = true;
                
                const response = await fetch('/admin/api/media-streaming/test');
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`✅ Connection successful! ${result.message}`, 'success', 'mediaStreamingAlert');
                    loadMediaStreamingStatus(); // Refresh status display
                } else {
                    showAlert('❌ Connection failed: ' + result.error, 'error', 'mediaStreamingAlert');
                }
            } catch (error) {
                showAlert('❌ Test failed: ' + error.message, 'error', 'mediaStreamingAlert');
            } finally {
                testButton.textContent = originalText;
                testButton.disabled = false;
            }
        }
        
        async function loadMediaStreamingStatus() {
            try {
                const response = await fetch('/api/media-streaming');
                const result = await response.json();
                
                const container = document.getElementById('mediaStreamingStatus');
                
                if (!result.success) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc3545;">
                            <strong>Error:</strong> ${result.error}
                        </div>
                    `;
                    return;
                }
                
                const data = result.data;
                
                if (!data.hasActiveMedia && data.totalDevices === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            No media players found. Check your Home Assistant connection and configuration.
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="media-streaming-summary">
                        <h4>${data.hasActiveMedia ? '🎵 Media Currently Playing' : '⏸️ No Active Media'}</h4>
                        <p>${data.totalDevices} devices found • ${data.activeDevices} currently active</p>
                    </div>
                `;
                
                if (data.players.length > 0) {
                    html += `<div class="media-player-grid">`;
                    
                    data.players.forEach(player => {
                        const cardClass = player.isActive ? (player.state === 'playing' ? 'playing' : 'active') : '';
                        
                        html += `
                            <div class="media-player-card ${cardClass}">
                                <div class="media-player-header">
                                    <span class="media-player-name">${player.friendly_name}</span>
                                    <span class="media-player-type">${player.deviceType}</span>
                                </div>
                                <div class="media-player-status ${player.state}">${player.state}</div>
                        `;
                        
                        if (player.media_title || player.media_artist) {
                            html += `
                                <div class="media-info">
                                    ${player.media_title ? `<div class="media-title">${player.media_title}</div>` : ''}
                                    ${player.media_artist ? `<div class="media-artist">by ${player.media_artist}</div>` : ''}
                                    ${player.source ? `<div class="media-source">Source: ${player.source}</div>` : ''}
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                } else {
                    html += `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            All media players are currently idle.
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('mediaStreamingStatus');
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        Error loading media status: ${error.message}
                    </div>
                `;
            }
        }
        
        
        // Tournament management functions
        let currentTournament = null;
        
        async function loadTournaments() {
            try {
                const response = await fetch('/admin/api/tournaments');
                const tournaments = await response.json();
                
                const container = document.getElementById('tournamentsContainer');
                if (tournaments.length === 0) {
                    container.innerHTML = `
                        <div class="tournament-empty">
                            No tournaments created yet. Click "Create New Tournament" to get started.
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                tournaments.forEach(tournament => {
                    const statusClass = tournament.status;
                    const createdDate = new Date(tournament.createdAt).toLocaleDateString();
                    const winnerText = tournament.winner ? `Winner: ${tournament.winner.name}` : '';
                    
                    html += `
                        <div class="tournament-card ${statusClass}">
                            <div class="tournament-header">
                                <div>
                                    <div class="tournament-title">${escapeHtml(tournament.name)}</div>
                                    ${tournament.description ? `<div class="tournament-description">${escapeHtml(tournament.description)}</div>` : ''}
                                    <small style="color: #666;">Created: ${createdDate}</small>
                                </div>
                                <div class="tournament-status ${statusClass}">
                                    ${tournament.status}
                                </div>
                            </div>
                            
                            <div class="tournament-info">
                                <div class="tournament-stat">
                                    <div class="tournament-stat-value">${tournament.participants.length}</div>
                                    <div class="tournament-stat-label">Participants</div>
                                </div>
                                <div class="tournament-stat">
                                    <div class="tournament-stat-value">${tournament.maxParticipants}</div>
                                    <div class="tournament-stat-label">Max</div>
                                </div>
                                <div class="tournament-stat">
                                    <div class="tournament-stat-value">${tournament.currentRound || 0}</div>
                                    <div class="tournament-stat-label">Round</div>
                                </div>
                            </div>
                            
                            ${winnerText ? `<div style="text-align: center; color: #28a745; font-weight: 600; margin-bottom: 1rem;">${winnerText}</div>` : ''}
                            
                            <div class="tournament-actions">
                                <button class="btn btn-small" onclick="viewTournament(${tournament.id})">View Details</button>
                                ${tournament.status === 'setup' ? `<button class="btn btn-small btn-danger" onclick="deleteTournament(${tournament.id})">Delete</button>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                showTournamentAlert('Error loading tournaments: ' + error.message, 'error');
            }
        }
        
        function showTournamentAlert(message, type = 'info') {
            const alert = document.getElementById('tournamentAlert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alert.innerHTML = '';
            }, 5000);
        }
        
        function showTournamentModalAlert(message, type = 'info') {
            const alert = document.getElementById('tournamentModalAlert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }
        
        // Tournament modal functions
        function openTournamentModal() {
            document.getElementById('tournamentModal').style.display = 'block';
            document.getElementById('tournamentForm').reset();
            showTournamentModalAlert('');
        }
        
        function closeTournamentModal() {
            document.getElementById('tournamentModal').style.display = 'none';
        }
        
        function openTournamentDetailsModal() {
            document.getElementById('tournamentDetailsModal').style.display = 'block';
        }
        
        function closeTournamentDetailsModal() {
            document.getElementById('tournamentDetailsModal').style.display = 'none';
            currentTournament = null;
        }
        
        async function createTournament(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('tournamentName').value,
                description: document.getElementById('tournamentDescription').value,
                tournamentType: document.getElementById('tournamentType').value,
                maxParticipants: parseInt(document.getElementById('maxParticipants').value)
            };
            
            try {
                const response = await fetch('/admin/api/tournaments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showTournamentModalAlert('Tournament created successfully!', 'success');
                    setTimeout(() => {
                        closeTournamentModal();
                        loadTournaments();
                    }, 1500);
                } else {
                    showTournamentModalAlert(result.error || 'Failed to create tournament', 'error');
                }
            } catch (error) {
                showTournamentModalAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function viewTournament(tournamentId) {
            try {
                const response = await fetch(`/admin/api/tournaments/${tournamentId}`);
                currentTournament = await response.json();
                
                document.getElementById('tournamentDetailsTitle').textContent = currentTournament.name;
                
                // Update tournament info
                const infoHtml = `
                    <div class="tournament-info">
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">${currentTournament.status}</div>
                            <div class="tournament-stat-label">Status</div>
                        </div>
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">${currentTournament.participants.length}</div>
                            <div class="tournament-stat-label">Participants</div>
                        </div>
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">${currentTournament.maxParticipants}</div>
                            <div class="tournament-stat-label">Max</div>
                        </div>
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">${currentTournament.currentRound || 0}</div>
                            <div class="tournament-stat-label">Round</div>
                        </div>
                    </div>
                    ${currentTournament.description ? `<p style="margin-top: 1rem;"><strong>Description:</strong> ${escapeHtml(currentTournament.description)}</p>` : ''}
                `;
                document.getElementById('tournamentInfo').innerHTML = infoHtml;
                
                // Update participants
                updateParticipantsList();
                
                // Update bracket
                updateBracket();
                
                // Update tournament actions
                updateTournamentActions();
                
                openTournamentDetailsModal();
                
            } catch (error) {
                showTournamentAlert('Error loading tournament: ' + error.message, 'error');
            }
        }
        
        function updateParticipantsList() {
            const container = document.getElementById('participantsList');
            
            if (currentTournament.participants.length === 0) {
                container.innerHTML = '<div class="tournament-empty">No participants added yet.</div>';
                return;
            }
            
            let html = '<div class="participants-list">';
            currentTournament.participants.forEach(participant => {
                html += `
                    <div class="participant-item">
                        <div>
                            <div class="participant-name">${escapeHtml(participant.name)}</div>
                            ${participant.teamMembers && participant.teamMembers.length > 0 ? 
                                `<small style="color: #666;">Team: ${participant.teamMembers.join(', ')}</small>` : ''}
                        </div>
                        <div class="participant-stats">
                            W: ${participant.wins} | L: ${participant.losses}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        function updateBracket() {
            const container = document.getElementById('bracketContainer');
            
            if (!currentTournament.bracket || currentTournament.bracket.length === 0) {
                container.innerHTML = '<div class="tournament-empty">Bracket not generated yet.</div>';
                return;
            }
            
            let html = '<div class="bracket-rounds">';
            
            currentTournament.bracket.forEach(round => {
                html += `
                    <div class="bracket-round">
                        <div class="bracket-round-title">${round.name}</div>
                `;
                
                round.matches.forEach(match => {
                    const isCompleted = match.completed;
                    const canSetResult = currentTournament.status === 'active' && 
                                       match.participant1 && match.participant2 && !isCompleted;
                    
                    html += `
                        <div class="bracket-match ${isCompleted ? 'completed' : ''}">
                            <div class="bracket-participant ${isCompleted && match.winnerId === match.participant1?.id ? 'winner' : isCompleted ? 'loser' : ''}">
                                <span>${match.participant1 ? escapeHtml(match.participant1.name) : 'TBD'}</span>
                                ${isCompleted && match.score && match.winnerId === match.participant1?.id ? `<span class="match-score">${match.score}</span>` : ''}
                            </div>
                            <div class="bracket-participant ${isCompleted && match.winnerId === match.participant2?.id ? 'winner' : isCompleted ? 'loser' : match.score === 'BYE' ? 'bye' : ''}">
                                <span>${match.participant2 ? escapeHtml(match.participant2.name) : match.score === 'BYE' ? 'BYE' : 'TBD'}</span>
                                ${isCompleted && match.score && match.winnerId === match.participant2?.id ? `<span class="match-score">${match.score}</span>` : ''}
                            </div>
                            ${canSetResult ? `
                                <div class="match-actions">
                                    <button class="winner-btn" onclick="setMatchWinner(${match.id}, ${match.participant1.id})">
                                        ${escapeHtml(match.participant1.name)} Wins
                                    </button>
                                    <button class="winner-btn" onclick="setMatchWinner(${match.id}, ${match.participant2.id})">
                                        ${escapeHtml(match.participant2.name)} Wins
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function updateTournamentActions() {
            const container = document.getElementById('tournamentActions');
            let html = '';
            
            if (currentTournament.status === 'setup') {
                const canGenerate = currentTournament.participants.length >= 2;
                html += `
                    <button class="btn ${canGenerate ? '' : 'btn-secondary'}" 
                            onclick="generateBracket()" 
                            ${canGenerate ? '' : 'disabled'}>
                        Generate Bracket
                    </button>
                `;
            }
            
            container.innerHTML = html;
        }
        
        async function addParticipant() {
            const name = document.getElementById('participantName').value.trim();
            const teamMembersText = document.getElementById('teamMembers').value.trim();
            
            if (!name) {
                showTournamentAlert('Participant name is required', 'error');
                return;
            }
            
            if (currentTournament.participants.length >= currentTournament.maxParticipants) {
                showTournamentAlert('Tournament is full', 'error');
                return;
            }
            
            const teamMembers = teamMembersText ? teamMembersText.split(',').map(m => m.trim()).filter(m => m) : [];
            
            try {
                const response = await fetch(`/admin/api/tournaments/${currentTournament.id}/participants`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, teamMembers })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTournament = result.tournament;
                    updateParticipantsList();
                    updateTournamentActions();
                    
                    // Clear form
                    document.getElementById('participantName').value = '';
                    document.getElementById('teamMembers').value = '';
                    
                    showTournamentAlert('Participant added successfully!', 'success');
                } else {
                    showTournamentAlert(result.error || 'Failed to add participant', 'error');
                }
            } catch (error) {
                showTournamentAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function generateBracket() {
            try {
                const response = await fetch(`/admin/api/tournaments/${currentTournament.id}/generate-bracket`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTournament = result.tournament;
                    updateBracket();
                    updateTournamentActions();
                    showTournamentAlert('Tournament bracket generated successfully!', 'success');
                    loadTournaments(); // Refresh the main list
                } else {
                    showTournamentAlert(result.error || 'Failed to generate bracket', 'error');
                }
            } catch (error) {
                showTournamentAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function setMatchWinner(matchId, winnerId) {
            const score = prompt('Enter score (optional):');
            
            try {
                const response = await fetch(`/admin/api/tournaments/${currentTournament.id}/matches/${matchId}/result`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ winnerId, score: score || null })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTournament = result.tournament;
                    updateBracket();
                    updateParticipantsList();
                    
                    if (result.roundComplete) {
                        if (currentTournament.status === 'completed' && currentTournament.winner) {
                            showTournamentAlert(`Tournament completed! Winner: ${currentTournament.winner.name}`, 'success');
                        } else {
                            showTournamentAlert('Round completed! Tournament advanced to next round.', 'success');
                        }
                    } else {
                        showTournamentAlert('Match result updated successfully!', 'success');
                    }
                    
                    loadTournaments(); // Refresh the main list
                } else {
                    showTournamentAlert(result.error || 'Failed to update match result', 'error');
                }
            } catch (error) {
                showTournamentAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function deleteTournament(tournamentId) {
            if (!confirm('Are you sure you want to delete this tournament? This action cannot be undone.')) {
                return;
            }
            
            // Since we don't have a delete endpoint yet, we'll implement it
            showTournamentAlert('Delete functionality not implemented yet', 'warning');
        }
        
        // Initialize tournament functionality
        function initializeTournaments() {
            // Add event listeners
            document.getElementById('createTournamentBtn').addEventListener('click', openTournamentModal);
            document.getElementById('refreshTournaments').addEventListener('click', loadTournaments);
            document.getElementById('tournamentForm').addEventListener('submit', createTournament);
            document.getElementById('addParticipantBtn').addEventListener('click', addParticipant);
            
            // Load tournaments on init
            loadTournaments();
        }
        
        // Initialize the admin interface
        initializeAdmin();
        
        // Initialize tournaments
        initializeTournaments();
        
        // Refresh status every 30 seconds
        setInterval(loadStatus, 30000);
        
        // Refresh client configuration and connected devices every 30 seconds
        setInterval(loadClientConfig, 30000);
        
        // Refresh client storage stats every 60 seconds
        setInterval(loadClientStorageStats, 60000);
        
        // Refresh media streaming status every 10 seconds (configurable)
        setInterval(loadMediaStreamingStatus, 10000);

        // Tab Management Functions
        function showMainTab(tabName) {
            // Remove active class from all main tabs
            const mainTabs = document.querySelectorAll('.main-tab');
            mainTabs.forEach(tab => tab.classList.remove('active'));
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Hide all sections
            const allSections = document.querySelectorAll('.admin-section');
            allSections.forEach(section => section.classList.add('hidden'));
            
            // Hide all sub-tabs
            const subTabs = document.querySelectorAll('.sub-tabs');
            subTabs.forEach(subTab => subTab.classList.remove('active'));
            
            // Show sections for the selected tab
            if (tabName === 'dashboard') {
                const dashboardSections = document.querySelectorAll('.dashboard-section');
                dashboardSections.forEach(section => section.classList.remove('hidden'));
                
                // Load dashboard data
                loadStatus();
                loadLogs();
            } else if (tabName === 'clients') {
                const clientsSections = document.querySelectorAll('.clients-section');
                clientsSections.forEach(section => section.classList.remove('hidden'));
                
                // Load clients data
                loadClientConfig();
                loadClientFiles();
                loadClientStorageStats();
            } else if (tabName === 'party') {
                // Show sub-tabs for party
                const partySubTabs = document.getElementById('party-subtabs');
                if (partySubTabs) {
                    partySubTabs.classList.add('active');
                }
                
                // Show default sub-tab (useful links)
                showSubTab('party-links', true);
            } else if (tabName === 'server') {
                // Show sub-tabs for server
                const serverSubTabs = document.getElementById('server-subtabs');
                if (serverSubTabs) {
                    serverSubTabs.classList.add('active');
                }
                
                // Show default sub-tab (vidiots)
                showSubTab('server-vidiots', true);
            } else if (tabName === 'settings') {
                // Show sub-tabs for settings
                const settingsSubTabs = document.getElementById('settings-subtabs');
                if (settingsSubTabs) {
                    settingsSubTabs.classList.add('active');
                }
                
                // Show default sub-tab (general)
                showSubTab('settings-general', true);
            } else if (tabName === 'finance') {
                // Show sub-tabs for finance
                const financeSubTabs = document.getElementById('finance-subtabs');
                if (financeSubTabs) {
                    financeSubTabs.classList.add('active');
                }
                
                // Show default sub-tab (My Data)
                showSubTab('finance-mydata', true);
            }
        }

        function showSubTab(subTabName, shouldLoadData = true) {
            // Remove active class from all sub-tabs
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => tab.classList.remove('active'));
            
            // Add active class to clicked sub-tab
            if (shouldLoadData && event && event.target) {
                // If we have a click event, use the clicked element
                event.target.classList.add('active');
            } else {
                // Find the correct sub-tab based on subTabName and activate it
                let targetTabText = '';
                if (subTabName === 'party-links') targetTabText = 'Useful Links';
                else if (subTabName === 'party-drinks') targetTabText = 'Drinks';
                else if (subTabName === 'party-tournament') targetTabText = 'Tournament';
                else if (subTabName === 'server-vidiots') targetTabText = 'Vidiots';
                else if (subTabName === 'server-espresso') targetTabText = 'Espresso';
                else if (subTabName === 'server-github') targetTabText = 'GitHub';
                else if (subTabName === 'server-smartmirror') targetTabText = 'Smart Mirror';
                else if (subTabName === 'finance-demo') targetTabText = 'Demo';
                else if (subTabName === 'finance-mydata') targetTabText = 'My Data';
                else if (subTabName === 'finance-history') targetTabText = 'History';
                else if (subTabName === 'finance-spending') targetTabText = 'Spending';
                else if (subTabName === 'finance-advanced') targetTabText = 'Advanced';
                else if (subTabName === 'settings-general') targetTabText = 'General';
                else if (subTabName === 'settings-logs') targetTabText = '📝 Logs';
                
                if (targetTabText) {
                    const targetTab = Array.from(subTabs).find(tab => tab.textContent.trim() === targetTabText);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                }
            }
            
            // Hide all party, server, finance and settings sections
            const partySections = document.querySelectorAll('.party-section');
            partySections.forEach(section => section.classList.add('hidden'));
            const serverSections = document.querySelectorAll('.server-section');
            serverSections.forEach(section => section.classList.add('hidden'));
            const financeSections = document.querySelectorAll('.finance-section');
            financeSections.forEach(section => section.classList.add('hidden'));
            const settingsSections = document.querySelectorAll('.settings-section');
            settingsSections.forEach(section => section.classList.add('hidden'));
            
            // Show the selected sub-tab sections
            if (subTabName === 'party-links') {
                const linksSections = document.querySelectorAll('.party-links-section');
                linksSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadLinks();
                }
            } else if (subTabName === 'party-drinks') {
                const drinksSections = document.querySelectorAll('.party-drinks-section');
                drinksSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    initializeDrinkMixer();
                }
            } else if (subTabName === 'party-tournament') {
                const tournamentSections = document.querySelectorAll('.party-tournament-section');
                tournamentSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadTournaments();
                }
            } else if (subTabName === 'server-vidiots') {
                const vidiotsSections = document.querySelectorAll('.server-vidiots-section');
                vidiotsSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadVidiotsConfig();
                    loadVidiotsStatus();
                }
            } else if (subTabName === 'server-espresso') {
                const espressoSections = document.querySelectorAll('.server-espresso-section');
                espressoSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadEspressoConfig();
                    loadEspressoStatus();
                    loadEspressoTemplateFiles();
                    loadEspressoData(); // Load the espresso data for editing
                }
            } else if (subTabName === 'server-github') {
                const githubSections = document.querySelectorAll('.server-github-section');
                githubSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadVidiotsConfig(); // Still need to load config for GitHub settings
                    initializeGitHubSection(); // Initialize GitHub logging and load git identity
                }
            } else if (subTabName === 'server-smartmirror') {
                const smartMirrorSections = document.querySelectorAll('.server-smartmirror-section');
                smartMirrorSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadSmartMirrorConfig();
                }
            } else if (subTabName === 'finance-demo') {
                const demoSections = document.querySelectorAll('.finance-demo-section');
                demoSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadDemoFinanceData();
                }
            } else if (subTabName === 'finance-mydata') {
                const myDataSections = document.querySelectorAll('.finance-mydata-section');
                myDataSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadFinanceData();
                }
            } else if (subTabName === 'finance-spending') {
                const spendingSections = document.querySelectorAll('.finance-spending-section');
                spendingSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadOllamaConfig();
                }
            } else if (subTabName === 'finance-history') {
                const historySections = document.querySelectorAll('.finance-history-section');
                historySections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    initializeHistory();
                }
            } else if (subTabName === 'finance-advanced') {
                const advancedSections = document.querySelectorAll('.finance-advanced-section');
                advancedSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadAdvancedSettings();
                }
            } else if (subTabName === 'settings-general') {
                const generalSections = document.querySelectorAll('.settings-general-section');
                generalSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadConfig();
                    setupStorageSlider();
                    loadMediaStreamingConfig();
                }
            } else if (subTabName === 'settings-logs') {
                const logsSections = document.querySelectorAll('.settings-logs-section');
                logsSections.forEach(section => section.classList.remove('hidden'));
                
                if (shouldLoadData) {
                    loadSystemLogs();
                }
            }
        }

        // Template Source Selection Functions
        function toggleTemplateSourceMethod() {
            const uploadRadio = document.getElementById('templateSourceUpload');
            const gitRadio = document.getElementById('templateSourceGit');
            const uploadSection = document.getElementById('templateUploadSection');
            const gitSection = document.getElementById('templateGitSection');
            
            if (uploadRadio.checked) {
                uploadSection.style.display = 'block';
                gitSection.style.display = 'none';
                console.log('Switched to file upload method');
            } else if (gitRadio.checked) {
                uploadSection.style.display = 'none';
                gitSection.style.display = 'block';
                console.log('Switched to git repository method');
            } else {
                uploadSection.style.display = 'none';
                gitSection.style.display = 'none';
            }
        }
        
        // Initialize template source selection on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Default to upload method
            const uploadRadio = document.getElementById('templateSourceUpload');
            if (uploadRadio) {
                uploadRadio.checked = true;
                toggleTemplateSourceMethod();
            }
        });

        // Clone espresso template repository
        async function cloneEspressoTemplateRepo() {
            const repoUrlInput = document.getElementById('espressoGitRepoUrl');
            const branchInput = document.getElementById('espressoGitBranch');
            const localPathInput = document.getElementById('espressoGitLocalPath');
            const cloneBtn = document.getElementById('cloneTemplateBtn');
            
            const repoUrl = repoUrlInput.value.trim();
            const branch = branchInput.value.trim() || 'main';
            const localPath = localPathInput.value.trim();
            
            if (!repoUrl) {
                showAlert('Repository URL is required', 'error', 'espressoTemplateAlert');
                return;
            }
            
            if (!localPath) {
                showAlert('Local clone path is required', 'error', 'espressoTemplateAlert');
                return;
            }
            
            try {
                // Set button loading state
                cloneBtn.disabled = true;
                cloneBtn.innerHTML = '🔄 Cloning...';
                
                showAlert('Cloning template repository...', 'success', 'espressoTemplateAlert');
                
                const response = await fetch('/admin/api/espresso/clone-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        repoUrl: repoUrl,
                        branch: branch,
                        localPath: localPath
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const actionText = result.action === 'cloned' ? 'cloned' : 'updated';
                    const fileText = result.filesCopied > 0 ? ` (${result.filesCopied} files copied)` : '';
                    showAlert(`Repository ${actionText} successfully${fileText}`, 'success', 'espressoTemplateAlert');
                    
                    // Refresh template files list
                    await loadEspressoTemplateFiles();
                    await loadEspressoStatus(); // Refresh status to show template is available
                    
                    // Refresh template path and image mapping UI
                    await loadEspressoTemplatePath();
                    const currentConfig = await getCurrentEspressoConfig();
                    await loadEspressoImageMapping(currentConfig.imagePaths || {});
                    
                } else {
                    showAlert('Failed to clone repository: ' + result.error, 'error', 'espressoTemplateAlert');
                }
                
            } catch (error) {
                showAlert('Error cloning repository: ' + error.message, 'error', 'espressoTemplateAlert');
            } finally {
                // Reset button state
                cloneBtn.disabled = false;
                cloneBtn.innerHTML = 'Clone Repository';
            }
        }

        // Vidiots Functions
        async function loadVidiotsConfig() {
            try {
                const response = await fetch('/admin/api/vidiots/config');
                const result = await response.json();
                
                if (result.success && result.config) {
                    const config = result.config;
                    document.getElementById('vidiotsEnabled').value = config.enabled ? 'true' : 'false';
                    
                    // Load schedule configuration
                    loadVidiotsSchedule(config);
                    
                    document.getElementById('vidiotsOutputFile').value = config.outputFile || './public/vidiots/index.html';
                    document.getElementById('vidiotsPosterDirectory').value = config.posterDirectory || './public/vidiots/posters';
                    document.getElementById('vidiotsPosterBaseUrl').value = config.posterBaseUrl || '/vidiots/posters/';
                    document.getElementById('vidiotsMaxAgeHours').value = config.maxAgeHours || 24;
                    document.getElementById('vidiotsForceUpdate').value = config.forceUpdate ? 'true' : 'false';
                    
                    // GitHub Pages configuration
                    const githubConfig = config.githubPages || {};
                    document.getElementById('vidiotsGithubEnabled').value = githubConfig.enabled ? 'true' : 'false';
                    document.getElementById('vidiotsRepoOwner').value = githubConfig.repoOwner || '';
                    document.getElementById('vidiotsRepoName').value = githubConfig.repoName || '';
                    document.getElementById('vidiotsRepoBranch').value = githubConfig.branch || 'main';
                    document.getElementById('vidiotsRepoLocalPath').value = githubConfig.repoLocalPath || '';
                    document.getElementById('vidiotsCommitMessage').value = githubConfig.commitMessage || 'Automated vidiots update';
                    document.getElementById('vidiotsAccessToken').value = githubConfig.accessToken ? '••••••••••••••••••••' : '';
                    document.getElementById('vidiotsAccessToken').dataset.hasToken = (githubConfig.accessToken ? 'true' : 'false');
                    
                    // Show/hide GitHub config based on enabled status
                    toggleGitHubConfig();
                } else {
                    showAlert('Failed to load vidiots configuration: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                showAlert('Error loading vidiots configuration: ' + error.message, 'error', 'vidiotsAlert');
            }
        }

        // Helper functions for new scheduling UI
        function updateScheduleUI() {
            const frequency = document.getElementById('vidiotsScheduleFrequency').value;
            const weeklyOptions = document.getElementById('weeklyOptions');
            const monthlyOptions = document.getElementById('monthlyOptions');
            
            weeklyOptions.style.display = frequency === 'weekly' ? 'flex' : 'none';
            monthlyOptions.style.display = frequency === 'monthly' ? 'flex' : 'none';
        }

        function addVidiotsRunTime(hour = 6, minute = 0) {
            const container = document.getElementById('vidiotsRunTimes');
            const timeId = 'vidiotsTime_' + Date.now();
            
            const timeEntry = document.createElement('div');
            timeEntry.className = 'time-entry';
            timeEntry.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            timeEntry.innerHTML = `
                <input type="number" min="0" max="23" value="${hour}" placeholder="Hour (0-23)" style="width: 100px;" data-type="hour">
                <span>:</span>
                <input type="number" min="0" max="59" value="${minute}" placeholder="Minute" style="width: 100px;" data-type="minute">
                <button type="button" class="btn btn-secondary" onclick="this.parentElement.remove()" style="padding: 5px 10px;">Remove</button>
            `;
            container.appendChild(timeEntry);
        }

        function loadVidiotsSchedule(config) {
            // Load schedule from config
            const schedule = config.schedule || {};
            
            // If we have new-style schedule config, use it
            if (schedule.frequency) {
                document.getElementById('vidiotsScheduleFrequency').value = schedule.frequency;
                
                if (schedule.frequency === 'weekly' && schedule.daysOfWeek) {
                    schedule.daysOfWeek.forEach(day => {
                        const checkbox = document.getElementById('vidiotsDay' + day);
                        if (checkbox) checkbox.checked = true;
                    });
                } else if (schedule.frequency === 'monthly' && schedule.dayOfMonth) {
                    document.getElementById('vidiotsDayOfMonth').value = schedule.dayOfMonth;
                }
                
                // Load run times
                const runTimesContainer = document.getElementById('vidiotsRunTimes');
                runTimesContainer.innerHTML = '';
                if (schedule.times && schedule.times.length > 0) {
                    schedule.times.forEach(time => {
                        addVidiotsRunTime(time.hour, time.minute);
                    });
                } else {
                    // Default times
                    addVidiotsRunTime(6, 0);
                    addVidiotsRunTime(12, 0);
                }
            } else {
                // Try to parse from cron schedule (backward compatibility)
                const cronSchedule = config.cronSchedule || '0 6,12 * * *';
                parseVidiotsCronSchedule(cronSchedule);
            }
            
            updateScheduleUI();
        }

        function parseVidiotsCronSchedule(cronSchedule) {
            // Parse cron format: "minute hour day month dayOfWeek"
            const parts = cronSchedule.trim().split(/\s+/);
            if (parts.length >= 5) {
                const [minute, hour, day, month, dayOfWeek] = parts;
                const runTimesContainer = document.getElementById('vidiotsRunTimes');
                runTimesContainer.innerHTML = '';
                
                // Parse hours (e.g., "6,12" or "6" or "*/4")
                const hours = hour.includes(',') ? hour.split(',').map(h => parseInt(h)) : [parseInt(hour) || 6];
                const minutes = minute.includes(',') ? minute.split(',').map(m => parseInt(m)) : [parseInt(minute) || 0];
                
                // Add time entries (combine hours and minutes)
                hours.forEach((h, i) => {
                    const m = minutes[i] || minutes[0] || 0;
                    addVidiotsRunTime(h, m);
                });
                
                // Determine frequency
                if (dayOfWeek !== '*') {
                    document.getElementById('vidiotsScheduleFrequency').value = 'weekly';
                    const days = dayOfWeek.split(',');
                    days.forEach(d => {
                        const checkbox = document.getElementById('vidiotsDay' + d);
                        if (checkbox) checkbox.checked = true;
                    });
                } else if (day !== '*') {
                    document.getElementById('vidiotsScheduleFrequency').value = 'monthly';
                    document.getElementById('vidiotsDayOfMonth').value = parseInt(day) || 1;
                } else {
                    document.getElementById('vidiotsScheduleFrequency').value = 'daily';
                }
            } else {
                // Default schedule
                const runTimesContainer = document.getElementById('vidiotsRunTimes');
                runTimesContainer.innerHTML = '';
                addVidiotsRunTime(6, 0);
                addVidiotsRunTime(12, 0);
            }
        }

        function getVidiotsScheduleConfig() {
            const frequency = document.getElementById('vidiotsScheduleFrequency').value;
            const schedule = { frequency };
            
            if (frequency === 'weekly') {
                const daysOfWeek = [];
                for (let i = 0; i <= 6; i++) {
                    const checkbox = document.getElementById('vidiotsDay' + i);
                    if (checkbox && checkbox.checked) {
                        daysOfWeek.push(i);
                    }
                }
                schedule.daysOfWeek = daysOfWeek.length > 0 ? daysOfWeek : [1]; // Default to Monday
            } else if (frequency === 'monthly') {
                schedule.dayOfMonth = parseInt(document.getElementById('vidiotsDayOfMonth').value) || 1;
            }
            
            // Get run times
            const times = [];
            const timeEntries = document.querySelectorAll('#vidiotsRunTimes .time-entry');
            timeEntries.forEach(entry => {
                const hour = parseInt(entry.querySelector('[data-type="hour"]').value) || 0;
                const minute = parseInt(entry.querySelector('[data-type="minute"]').value) || 0;
                times.push({ hour, minute });
            });
            schedule.times = times.length > 0 ? times : [{ hour: 6, minute: 0 }];
            
            return schedule;
        }

        function scheduleToCron(schedule) {
            // Convert schedule to cron format
            const { frequency, daysOfWeek, dayOfMonth, times } = schedule;
            
            if (!times || times.length === 0) {
                return '0 6,12 * * *'; // Default
            }
            
            // Extract unique hours and minutes
            const hours = [...new Set(times.map(t => t.hour))].sort((a, b) => a - b);
            const minutes = [...new Set(times.map(t => t.minute))].sort((a, b) => a - b);
            
            const minuteStr = minutes.join(',');
            const hourStr = hours.join(',');
            
            if (frequency === 'weekly') {
                const days = daysOfWeek && daysOfWeek.length > 0 ? daysOfWeek.sort((a, b) => a - b).join(',') : '*';
                return `${minuteStr} ${hourStr} * * ${days}`;
            } else if (frequency === 'monthly') {
                return `${minuteStr} ${hourStr} ${dayOfMonth || 1} * *`;
            } else {
                // Daily
                return `${minuteStr} ${hourStr} * * *`;
            }
        }


        async function saveVidiotsConfig() {
            try {
                const schedule = getVidiotsScheduleConfig();
                const cronSchedule = scheduleToCron(schedule);
                
                const config = {
                    enabled: document.getElementById('vidiotsEnabled').value === 'true',
                    schedule: schedule, // Store the user-friendly schedule
                    cronSchedule: cronSchedule, // Also store the cron expression for compatibility
                    outputFile: document.getElementById('vidiotsOutputFile').value.trim() || './public/vidiots/index.html',
                    posterDirectory: document.getElementById('vidiotsPosterDirectory').value.trim() || './public/vidiots/posters',
                    posterBaseUrl: document.getElementById('vidiotsPosterBaseUrl').value.trim() || '/vidiots/posters/',
                    maxAgeHours: parseInt(document.getElementById('vidiotsMaxAgeHours').value) || 24,
                    forceUpdate: document.getElementById('vidiotsForceUpdate').value === 'true',
                    githubPages: {
                        enabled: document.getElementById('vidiotsGithubEnabled').value === 'true',
                        repoOwner: document.getElementById('vidiotsRepoOwner').value.trim(),
                        repoName: document.getElementById('vidiotsRepoName').value.trim(),
                        branch: document.getElementById('vidiotsRepoBranch').value.trim() || 'main',
                        repoLocalPath: document.getElementById('vidiotsRepoLocalPath').value.trim(),
                        commitMessage: document.getElementById('vidiotsCommitMessage').value.trim() || 'Automated vidiots update'
                    }
                };
                
                // Handle access token separately (similar to Home Assistant token)
                const accessTokenField = document.getElementById('vidiotsAccessToken');
                let accessToken = accessTokenField.value;
                
                // If showing masked token and user didn't change it, don't send it
                if (accessToken === '••••••••••••••••••••' && accessTokenField.dataset.hasToken === 'true') {
                    accessToken = undefined; // Don't update the token
                }
                
                // Only include access token if it was changed or is new
                if (accessToken !== undefined && accessToken !== '••••••••••••••••••••' && accessToken.trim() !== '') {
                    config.githubPages.accessToken = accessToken.trim();
                }

                const response = await fetch('/admin/api/vidiots/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ vidiots: config })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'Vidiots configuration saved successfully', 'success', 'vidiotsAlert');
                    loadVidiotsStatus(); // Refresh status after config change
                    markSaved('GitHub Repository Settings'); // Clear unsaved changes
                } else {
                    showAlert('Failed to save vidiots configuration: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                showAlert('Error saving vidiots configuration: ' + error.message, 'error', 'vidiotsAlert');
            }
        }

        async function loadVidiotsStatus() {
            try {
                const result = await apiCall('/admin/api/vidiots/status');
                
                if (result.success && result.status) {
                    const status = result.status;
                    let statusText = `Enabled: ${status.enabled ? 'Yes' : 'No'}\n`;
                    
                    // Show friendly schedule description
                    if (status.schedule && status.schedule.frequency) {
                        const sched = status.schedule;
                        statusText += `Schedule: ${sched.frequency.charAt(0).toUpperCase() + sched.frequency.slice(1)}`;
                        
                        if (sched.frequency === 'weekly' && sched.daysOfWeek) {
                            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                            const days = sched.daysOfWeek.map(d => dayNames[d]).join(', ');
                            statusText += ` (${days})`;
                        } else if (sched.frequency === 'monthly' && sched.dayOfMonth) {
                            statusText += ` (Day ${sched.dayOfMonth})`;
                        }
                        
                        if (sched.times && sched.times.length > 0) {
                            const times = sched.times.map(t => {
                                const h = String(t.hour).padStart(2, '0');
                                const m = String(t.minute).padStart(2, '0');
                                return `${h}:${m}`;
                            }).join(', ');
                            statusText += `\nRun Times: ${times}`;
                        }
                    } else {
                        statusText += `Schedule (Cron): ${status.cronSchedule}`;
                    }
                    
                    statusText += `\nCron Job Running: ${status.isRunning ? 'Yes' : 'No'}\n`;
                    statusText += `Output File: ${status.outputFile}\n`;
                    statusText += `File Exists: ${status.fileExists ? 'Yes' : 'No'}\n`;
                    if (status.fileExists) {
                        statusText += `File Size: ${(status.fileSize / 1024).toFixed(1)} KB\n`;
                        statusText += `Last Modified: ${status.lastModified ? new Date(status.lastModified).toLocaleString() : 'Unknown'}\n`;
                    }
                    statusText += `\n--- GitHub Pages ---\n`;
                    statusText += `GitHub Pages: ${status.githubPages.enabled ? 'Enabled' : 'Disabled'}\n`;
                    if (status.githubPages.enabled) {
                        statusText += `Repository: ${status.githubPages.repoOwner}/${status.githubPages.repoName}\n`;
                        statusText += `Local Path: ${status.githubPages.repoLocalPath || 'Not configured'}\n`;
                    }
                    
                    document.getElementById('vidiotsStatus').textContent = statusText;
                } else {
                    document.getElementById('vidiotsStatus').textContent = 'Error loading status: ' + (result.error || 'Unknown error');
                }
            } catch (error) {
                document.getElementById('vidiotsStatus').textContent = 'Error loading status: ' + error.message;
            }
        }

        async function testVidiotsScrape() {
            try {
                showAlert('Starting vidiots scrape test...', 'success', 'vidiotsAlert');
                document.getElementById('vidiotsStatus').textContent = 'Running scrape test... This may take up to 60 seconds.';
                
                const response = await fetch('/admin/api/vidiots/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'Scrape test completed successfully', 'success', 'vidiotsAlert');
                } else {
                    showAlert('Scrape test failed: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
                
                // Refresh status after test
                setTimeout(loadVidiotsStatus, 2000);
            } catch (error) {
                showAlert('Error running scrape test: ' + error.message, 'error', 'vidiotsAlert');
                setTimeout(loadVidiotsStatus, 2000);
            }
        }

        // ================================================================
        // ESPRESSO CONFIGURATION FUNCTIONS
        // ================================================================

        async function loadEspressoConfig() {
            try {
                const response = await fetch('/admin/api/espresso/config');
                const result = await response.json();
                
                if (result.success) {
                    const config = result.config;
                    document.getElementById('espressoEnabled').value = config.enabled ? 'true' : 'false';
                    document.getElementById('espressoDataFilePath').value = config.dataFilePath || '';
                    document.getElementById('espressoOutputPath').value = config.outputPath || '';
                    // Load local repository settings
                    document.getElementById('espressoSaveToRepo').value = config.localRepo?.enabled ? 'true' : 'false';
                    document.getElementById('espressoLocalOutputPath').value = config.localRepo?.outputPath || 'espresso/index.html';
                    document.getElementById('espressoLocalImagePath').value = config.localRepo?.imagePath || 'espresso/images';
                    
                    // Update repository status
                    updateEspressoRepoStatus();
                    
                    // Load template path info
                    await loadEspressoTemplatePath();
                    
                    // Load image mapping UI
                    await loadEspressoImageMapping(config.imagePaths || {});
                    
                    // Load status as well
                    loadEspressoStatus();
                }
            } catch (error) {
                showAlert('Error loading espresso configuration: ' + error.message, 'error', 'espressoAlert');
            }
        }

        async function saveEspressoConfig() {
            try {
                // Collect image paths from new UI
                const imagePaths = collectImagePaths();

                const config = {
                    enabled: document.getElementById('espressoEnabled').value === 'true',
                    dataFilePath: document.getElementById('espressoDataFilePath').value.trim() || './config/espresso-data.json',
                    templatePath: document.getElementById('espressoTemplatePath').value.trim(),
                    outputPath: document.getElementById('espressoOutputPath').value.trim() || './public/espresso/index.html',
                    imagePaths: imagePaths,
                    localRepo: {
                        enabled: document.getElementById('espressoSaveToRepo').value === 'true',
                        outputPath: document.getElementById('espressoLocalOutputPath').value.trim() || 'espresso/index.html',
                        imagePath: document.getElementById('espressoLocalImagePath').value.trim() || 'espresso/images'
                    }
                };

                const response = await fetch('/admin/api/espresso/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ espresso: config })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'Espresso configuration saved successfully', 'success', 'espressoAlert');
                    loadEspressoStatus(); // Refresh status after config change
                    markSaved('Espresso Configuration'); // Clear unsaved changes
                } else {
                    showAlert('Failed to save espresso configuration: ' + (result.error || 'Unknown error'), 'error', 'espressoAlert');
                }
            } catch (error) {
                showAlert('Error saving espresso configuration: ' + error.message, 'error', 'espressoAlert');
            }
        }

        async function loadEspressoStatus() {
            try {
                const result = await apiCall('/admin/api/espresso/status');
                
                if (result.success && result.status) {
                    const status = result.status;
                    let statusText = `Enabled: ${status.enabled ? 'Yes' : 'No'}\n`;
                    statusText += `Data File: ${status.dataFile ? 'Exists' : 'Missing'}\n`;
                    statusText += `Template File: ${status.templateFile ? 'Exists' : 'Missing'}\n`;
                    statusText += `Output File: ${status.outputFile ? 'Exists' : 'Missing'}\n`;
                    statusText += `GitHub Enabled: ${status.githubEnabled ? 'Yes' : 'No'}\n`;
                    if (status.lastUpdated) {
                        statusText += `Last Updated: ${new Date(status.lastUpdated).toLocaleString()}\n`;
                    }
                    
                    document.getElementById('espressoStatus').textContent = statusText;
                } else {
                    document.getElementById('espressoStatus').textContent = 'Error loading status: ' + (result.error || 'Status unavailable');
                }
            } catch (error) {
                document.getElementById('espressoStatus').textContent = 'Error loading status: ' + error.message;
            }
        }

        async function testEspressoGeneration() {
            try {
                showAlert('Starting espresso HTML generation test...', 'success', 'espressoAlert');
                document.getElementById('espressoStatus').textContent = 'Running HTML generation test...';
                
                const response = await fetch('/admin/api/espresso/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'HTML generation test completed successfully', 'success', 'espressoAlert');
                } else {
                    showAlert('HTML generation test failed: ' + (result.error || 'Unknown error'), 'error', 'espressoAlert');
                }
                
                // Refresh status after test
                setTimeout(loadEspressoStatus, 2000);
            } catch (error) {
                showAlert('Error running HTML generation test: ' + error.message, 'error', 'espressoAlert');
                setTimeout(loadEspressoStatus, 2000);
            }
        }

        async function uploadEspressoToGitHub() {
            try {
                // Set loading state
                setButtonLoading('uploadEspressoBtn', true);
                showAlert('Uploading espresso content to GitHub Pages...', 'success', 'espressoAlert');
                
                const response = await fetch('/admin/api/espresso/github/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Successfully uploaded to GitHub Pages! (${result.filesUploaded || 0} files, ${result.imagesUploaded || 0} images)`, 'success', 'espressoAlert');
                } else {
                    showAlert('Failed to upload to GitHub Pages: ' + (result.error || 'Unknown error'), 'error', 'espressoAlert');
                }
            } catch (error) {
                showAlert('Error uploading to GitHub Pages: ' + error.message, 'error', 'espressoAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('uploadEspressoBtn', false);
            }
        }

        // Function to update repository status in espresso tab
        async function updateEspressoRepoStatus() {
            try {
                // Get GitHub configuration from the main config
                const response = await fetch('/admin/api/vidiots/config');
                const result = await response.json();
                
                if (result.success && result.config.githubPages) {
                    const github = result.config.githubPages;
                    const statusElement = document.getElementById('espressoRepoStatusText');
                    
                    if (github.repoOwner && github.repoName && github.repoLocalPath) {
                        statusElement.innerHTML = `✅ Connected to <strong>${github.repoOwner}/${github.repoName}</strong> (${github.branch || 'main'}) at <code>${github.repoLocalPath}</code>`;
                        statusElement.style.color = '#28a745';
                        
                        // Enable save to repo option if repository is configured
                        document.getElementById('espressoSaveToRepo').disabled = false;
                    } else {
                        statusElement.innerHTML = '⚠️ Repository not configured in GitHub tab. Please configure repository settings in the GitHub tab first.';
                        statusElement.style.color = '#ffc107';
                        
                        // Disable save to repo option if repository is not configured
                        document.getElementById('espressoSaveToRepo').value = 'false';
                        document.getElementById('espressoSaveToRepo').disabled = true;
                    }
                } else {
                    document.getElementById('espressoRepoStatusText').innerHTML = '❌ Unable to connect to GitHub configuration.';
                    document.getElementById('espressoRepoStatusText').style.color = '#dc3545';
                }
            } catch (error) {
                document.getElementById('espressoRepoStatusText').innerHTML = `❌ Error: ${error.message}`;
                document.getElementById('espressoRepoStatusText').style.color = '#dc3545';
            }
        }

        // Function to refresh repository status
        async function refreshEspressoRepoStatus() {
            await updateEspressoRepoStatus();
            showAlert('Repository status refreshed', 'info', 'espressoAlert');
        }

        // Helper function to get current config
        async function getCurrentEspressoConfig() {
            try {
                const response = await fetch('/admin/api/espresso/config');
                const result = await response.json();
                return result.success ? result.config : {};
            } catch (error) {
                console.error('Error getting current config:', error);
                return {};
            }
        }

        // Espresso Template Upload Functions
        async function uploadEspressoTemplate() {
            const fileInput = document.getElementById('espressoTemplateFile');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showAlert('Please select at least one file to upload', 'error', 'espressoTemplateAlert');
                return;
            }
            
            try {
                // Upload files one by one
                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    const formData = new FormData();
                    formData.append('templateFile', file);
                    
                    showAlert(`Uploading ${file.name}...`, 'success', 'espressoTemplateAlert');
                    
                    const response = await fetch('/admin/api/espresso/upload-template', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        showAlert(`Failed to upload ${file.name}: ${result.error}`, 'error', 'espressoTemplateAlert');
                        return;
                    }
                }
                
                showAlert('All files uploaded successfully!', 'success', 'espressoTemplateAlert');
                
                // Clear file input and refresh file list
                fileInput.value = '';
                await loadEspressoTemplateFiles();
                await loadEspressoStatus(); // Refresh status to show template is available
                
                // Refresh template path and image mapping UI
                await loadEspressoTemplatePath();
                const currentConfig = await getCurrentEspressoConfig();
                await loadEspressoImageMapping(currentConfig.imagePaths || {});
                
            } catch (error) {
                showAlert('Error uploading files: ' + error.message, 'error', 'espressoTemplateAlert');
            }
        }
        
        async function loadEspressoTemplateFiles() {
            try {
                const response = await fetch('/admin/api/espresso/template-files');
                const result = await response.json();
                
                const filesContainer = document.getElementById('espressoTemplateFiles');
                
                if (result.success && result.files && result.files.length > 0) {
                    let filesHtml = '<h5>📁 Uploaded Template Files:</h5><div class="template-files-list">';
                    
                    result.files.forEach(file => {
                        const fileIcon = file.type === 'image' ? '🖼️' : '📄';
                        const uploadDate = new Date(file.uploadDate).toLocaleString();
                        const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                        
                        filesHtml += `
                            <div class="template-file-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: #fff; border: 1px solid #ddd; border-radius: 4px;">
                                <div>
                                    <strong>${fileIcon} ${file.name}</strong>
                                    <small style="color: #666; margin-left: 10px;">${fileSize} • ${uploadDate}</small>
                                </div>
                                <button onclick="deleteEspressoTemplateFile('${file.name}')" class="btn btn-sm btn-danger">Delete</button>
                            </div>
                        `;
                    });
                    
                    filesHtml += '</div>';
                    filesContainer.innerHTML = filesHtml;
                } else {
                    filesContainer.innerHTML = '<p style="color: #666;"><em>No template files uploaded yet</em></p>';
                }
            } catch (error) {
                console.error('Error loading template files:', error);
                document.getElementById('espressoTemplateFiles').innerHTML = '<p style="color: red;">Error loading template files</p>';
            }
        }
        
        async function deleteEspressoTemplateFile(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/espresso/template-files/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`File deleted: ${filename}`, 'success', 'espressoTemplateAlert');
                    await loadEspressoTemplateFiles();
                    await loadEspressoStatus(); // Refresh status
                    
                    // Refresh template path and image mapping UI
                    await loadEspressoTemplatePath();
                    const currentConfig = await getCurrentEspressoConfig();
                    await loadEspressoImageMapping(currentConfig.imagePaths || {});
                } else {
                    showAlert(`Failed to delete file: ${result.error}`, 'error', 'espressoTemplateAlert');
                }
            } catch (error) {
                showAlert('Error deleting file: ' + error.message, 'error', 'espressoTemplateAlert');
            }
        }

        // Load template path information and update UI
        async function loadEspressoTemplatePath() {
            try {
                const response = await fetch('/admin/api/espresso/template-path');
                const result = await response.json();
                
                if (result.success) {
                    const templatePath = result.templatePath;
                    const templatePathElement = document.getElementById('espressoTemplatePath');
                    const statusElement = document.getElementById('espressoTemplatePathStatus');
                    
                    if (templatePath.uploadedExists) {
                        if (templatePath.isUploaded) {
                            templatePathElement.value = 'Uploaded: index.html';
                            statusElement.textContent = '✅ Using uploaded template';
                            statusElement.style.color = '#28a745';
                        } else {
                            templatePathElement.value = templatePath.currentPath || '';
                            statusElement.textContent = '⚠️ Uploaded template available but configured path is used';
                            statusElement.style.color = '#ffc107';
                        }
                    } else {
                        templatePathElement.value = templatePath.currentPath || '';
                        if (templatePath.currentPath) {
                            statusElement.textContent = '📁 Using configured template path';
                            statusElement.style.color = '#17a2b8';
                        } else {
                            statusElement.textContent = '❌ No template found - please upload or configure path';
                            statusElement.style.color = '#dc3545';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading template path:', error);
            }
        }

        // Load image mapping UI
        async function loadEspressoImageMapping(currentImagePaths = {}) {
            try {
                const response = await fetch('/admin/api/espresso/available-images');
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('espressoImageMapping');
                    const images = result.images;
                    
                    // Known image identifiers from template
                    const knownImageIds = ['smallcontainer', 'mediumcontainer', 'largecontainer'];
                    
                    let html = '<div style="margin-bottom: 15px;"><strong>Configure Image Mapping:</strong></div>';
                    
                    knownImageIds.forEach(imageId => {
                        const currentValue = currentImagePaths[imageId] || '';
                        html += `
                            <div class="image-mapping-row" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="margin-bottom: 8px; font-weight: bold;">
                                    Image ID: <code>${imageId}</code>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <label style="font-size: 12px; color: #666;">Select Uploaded Image:</label>
                                        <select class="image-select" data-image-id="${imageId}" style="width: 100%; margin-top: 2px;">
                                            <option value="">-- Select Image --</option>
                                            ${images.map(img => `
                                                <option value="/uploads/espresso/templates/${img.filename}" ${currentValue === `/uploads/espresso/templates/${img.filename}` ? 'selected' : ''}>
                                                    ${img.filename} (${(img.size / 1024).toFixed(1)}KB)
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div style="color: #666; font-size: 14px; padding: 0 10px;">OR</div>
                                    <div style="flex: 1; min-width: 200px;">
                                        <label style="font-size: 12px; color: #666;">Absolute URL:</label>
                                        <input type="url" class="image-url" data-image-id="${imageId}" placeholder="https://example.com/image.jpg" 
                                               value="${currentValue.startsWith('http') ? currentValue : ''}" 
                                               style="width: 100%; margin-top: 2px;">
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (images.length === 0) {
                        html += '<div style="padding: 20px; text-align: center; color: #666; border: 2px dashed #ddd; border-radius: 4px;"><i>No uploaded images found. Upload image files in the Template Upload section above.</i></div>';
                    }
                    
                    container.innerHTML = html;
                    
                    // Add event listeners for dynamic updates
                    container.addEventListener('change', handleImageMappingChange);
                    container.addEventListener('input', handleImageMappingChange);
                }
            } catch (error) {
                console.error('Error loading image mapping:', error);
                document.getElementById('espressoImageMapping').innerHTML = 
                    '<div style="color: #dc3545; text-align: center; padding: 20px;"><i>Error loading image configuration</i></div>';
            }
        }

        // Handle changes in image mapping controls
        function handleImageMappingChange(event) {
            const target = event.target;
            const imageId = target.dataset.imageId;
            
            if (!imageId) return;
            
            const row = target.closest('.image-mapping-row');
            const selectElement = row.querySelector('.image-select');
            const urlElement = row.querySelector('.image-url');
            
            if (target.classList.contains('image-select')) {
                // Clear URL field when selecting an uploaded image
                if (target.value) {
                    urlElement.value = '';
                }
            } else if (target.classList.contains('image-url')) {
                // Clear select field when entering URL
                if (target.value) {
                    selectElement.value = '';
                }
            }
        }

        // Collect image paths from the new UI for saving
        function collectImagePaths() {
            const imagePaths = {};
            const container = document.getElementById('espressoImageMapping');
            
            container.querySelectorAll('.image-mapping-row').forEach(row => {
                const imageId = row.querySelector('.image-select').dataset.imageId;
                const selectedImage = row.querySelector('.image-select').value;
                const enteredUrl = row.querySelector('.image-url').value.trim();
                
                if (selectedImage) {
                    imagePaths[imageId] = selectedImage;
                } else if (enteredUrl) {
                    imagePaths[imageId] = enteredUrl;
                }
            });
            
            return imagePaths;
        }

        // ================================================================
        // ESPRESSO DATA EDITOR FUNCTIONS
        // ================================================================

        // Global variable to store current espresso data
        let currentEspressoData = {};

        // Initialize espresso editor URL on page load
        function initializeEspressoEditorUrl() {
            const urlInput = document.getElementById('espressoEditorUrl');
            if (urlInput) {
                const currentUrl = window.location.origin + '/espresso-editor';
                urlInput.value = currentUrl;
            }
        }

        // Copy espresso editor URL to clipboard
        async function copyEspressoEditorUrl() {
            const urlInput = document.getElementById('espressoEditorUrl');
            if (urlInput) {
                try {
                    await navigator.clipboard.writeText(urlInput.value);
                    showAlert('Espresso editor URL copied to clipboard!', 'success', 'espressoDataAlert');
                } catch (error) {
                    // Fallback for older browsers
                    urlInput.select();
                    document.execCommand('copy');
                    showAlert('Espresso editor URL copied to clipboard!', 'success', 'espressoDataAlert');
                }
            }
        }

        // Load espresso data for editing
        async function loadEspressoData() {
            try {
                const response = await fetch('/admin/api/espresso/data');
                const result = await response.json();
                
                if (result.success) {
                    currentEspressoData = result.data || {};
                    renderEspressoDataForm();
                    showAlert('Espresso data loaded successfully', 'success', 'espressoDataAlert');
                } else {
                    showAlert('Failed to load espresso data: ' + (result.error || 'Unknown error'), 'error', 'espressoDataAlert');
                }
            } catch (error) {
                showAlert('Error loading espresso data: ' + error.message, 'error', 'espressoDataAlert');
            }
        }

        // Render the espresso data editing form
        function renderEspressoDataForm() {
            const container = document.getElementById('espressoDataContainer');
            
            // Define the data structure for each espresso
            const espressos = [
                { id: 1, title: 'Espresso 1' },
                { id: 2, title: 'Espresso 2' }, 
                { id: 3, title: 'Espresso 3' }
            ];

            let html = '';

            espressos.forEach(espresso => {
                const id = espresso.id;
                html += `
                    <div class="espresso-data-section" style="background: #f9f9f9; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #8B4513;">
                        <h3 style="color: #8B4513; margin-bottom: 15px;">${espresso.title}</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="beanName${id}">Bean Name</label>
                                <input type="text" id="beanName${id}" value="${currentEspressoData['beanName' + id] || ''}" placeholder="e.g., Ethiopian Yirgacheffe">
                            </div>
                            <div class="form-group">
                                <label for="roastDate${id}">Roast Date</label>
                                <input type="text" id="roastDate${id}" value="${currentEspressoData['roastDate' + id] || ''}" placeholder="e.g., Jan 2025">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="weight${id}">Weight In</label>
                                <input type="text" id="weight${id}" value="${currentEspressoData['weight' + id] || ''}" placeholder="e.g., 15g">
                            </div>
                            <div class="form-group">
                                <label for="grind${id}">Grind Size</label>
                                <input type="text" id="grind${id}" value="${currentEspressoData['grind' + id] || ''}" placeholder="e.g., 0.5">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tempIn${id}">Temperature</label>
                                <input type="text" id="tempIn${id}" value="${currentEspressoData['tempIn' + id] || ''}" placeholder="e.g., 90°C">
                            </div>
                            <div class="form-group">
                                <label for="soak${id}">Pre-soak</label>
                                <select id="soak${id}">
                                    <option value="yes" ${currentEspressoData['soak' + id] === 'yes' ? 'selected' : ''}>Yes</option>
                                    <option value="no" ${currentEspressoData['soak' + id] === 'no' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="time${id}">Extraction Time</label>
                                <input type="text" id="time${id}" value="${currentEspressoData['time' + id] || ''}" placeholder="e.g., 32s">
                            </div>
                            <div class="form-group">
                                <label for="weightOut${id}">Weight Out</label>
                                <input type="text" id="weightOut${id}" value="${currentEspressoData['weightOut' + id] || ''}" placeholder="e.g., 40g">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes${id}">Tasting Notes</label>
                            <textarea id="notes${id}" rows="3" placeholder="e.g., Bright and floral with citrus notes">${currentEspressoData['notes' + id] || ''}</textarea>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Save espresso data
        async function saveEspressoData() {
            try {
                // Collect data from form
                const updatedData = {};
                
                [1, 2, 3].forEach(id => {
                    updatedData[`beanName${id}`] = document.getElementById(`beanName${id}`).value;
                    updatedData[`roastDate${id}`] = document.getElementById(`roastDate${id}`).value;
                    updatedData[`weight${id}`] = document.getElementById(`weight${id}`).value;
                    updatedData[`grind${id}`] = document.getElementById(`grind${id}`).value;
                    updatedData[`tempIn${id}`] = document.getElementById(`tempIn${id}`).value;
                    updatedData[`soak${id}`] = document.getElementById(`soak${id}`).value;
                    updatedData[`time${id}`] = document.getElementById(`time${id}`).value;
                    updatedData[`weightOut${id}`] = document.getElementById(`weightOut${id}`).value;
                    updatedData[`notes${id}`] = document.getElementById(`notes${id}`).value;
                });

                const response = await fetch('/admin/api/espresso/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message || 'Espresso data saved successfully', 'success', 'espressoDataAlert');
                    currentEspressoData = { ...currentEspressoData, ...updatedData };
                    
                    // Also refresh the status to show updated file timestamp
                    setTimeout(() => {
                        loadEspressoStatus();
                    }, 1000);
                } else {
                    showAlert('Failed to save espresso data: ' + (result.error || 'Unknown error'), 'error', 'espressoDataAlert');
                }
            } catch (error) {
                showAlert('Error saving espresso data: ' + error.message, 'error', 'espressoDataAlert');
            }
        }

        // Reset espresso data to defaults
        async function resetEspressoData() {
            if (!confirm('Are you sure you want to reset all espresso data to default values? This cannot be undone.')) {
                return;
            }

            try {
                // Send empty object to trigger default data creation
                const response = await fetch('/admin/api/espresso/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reset: true })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('Espresso data reset to defaults successfully', 'success', 'espressoDataAlert');
                    await loadEspressoData(); // Reload the form with new data
                    setTimeout(() => {
                        loadEspressoStatus();
                    }, 1000);
                } else {
                    showAlert('Failed to reset espresso data: ' + (result.error || 'Unknown error'), 'error', 'espressoDataAlert');
                }
            } catch (error) {
                showAlert('Error resetting espresso data: ' + error.message, 'error', 'espressoDataAlert');
            }
        }

        function toggleGitHubConfig() {
            const githubEnabled = document.getElementById('vidiotsGithubEnabled').value === 'true';
            const githubConfig = document.getElementById('githubPagesConfig');
            if (githubConfig) {
                githubConfig.style.display = githubEnabled ? 'block' : 'none';
            }
        }

        async function testGitHubConnection() {
            try {
                // Set loading state
                setButtonLoading('testGitHubBtn', true);
                updateGitHubStatus('Testing GitHub connection...', true);
                addGitHubLog('INFO', 'Starting GitHub connection test');
                
                showAlert('Testing GitHub connection...', 'success', 'vidiotsAlert');
                
                const response = await fetch('/admin/api/vidiots/github/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    updateGitHubStatus('GitHub connection test successful');
                    addGitHubLog('SUCCESS', 'GitHub connection test completed successfully');
                    showAlert('GitHub connection test successful', 'success', 'vidiotsAlert');
                } else {
                    setGitHubError('GitHub connection test failed');
                    addGitHubLog('ERROR', `GitHub connection test failed: ${result.error || 'Unknown error'}`);
                    showAlert('GitHub connection test failed: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                setGitHubError('GitHub connection test error');
                addGitHubLog('ERROR', `GitHub connection test error: ${error.message}`);
                showAlert('Error testing GitHub connection: ' + error.message, 'error', 'vidiotsAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('testGitHubBtn', false);
            }
        }

        async function uploadToGitHub() {
            try {
                // Set loading state
                setButtonLoading('uploadGitHubBtn', true);
                updateGitHubStatus('Uploading to GitHub Pages...', true);
                addGitHubLog('INFO', 'Starting GitHub Pages upload');
                
                showAlert('Uploading to GitHub Pages...', 'success', 'vidiotsAlert');
                
                const response = await fetch('/admin/api/vidiots/github/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    updateGitHubStatus('Successfully uploaded to GitHub Pages');
                    addGitHubLog('SUCCESS', 'GitHub Pages upload completed successfully');
                    if (result.commitSha) {
                        addGitHubLog('INFO', `Commit SHA: ${result.commitSha}`);
                    }
                    showAlert('Successfully uploaded to GitHub Pages', 'success', 'vidiotsAlert');
                } else {
                    setGitHubError('GitHub Pages upload failed');
                    addGitHubLog('ERROR', `GitHub Pages upload failed: ${result.error || 'Unknown error'}`);
                    showAlert('Failed to upload to GitHub Pages: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                setGitHubError('GitHub Pages upload error');
                addGitHubLog('ERROR', `GitHub Pages upload error: ${error.message}`);
                showAlert('Error uploading to GitHub Pages: ' + error.message, 'error', 'vidiotsAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('uploadGitHubBtn', false);
            }
        }

        // Repository management functions
        let currentBrowsePath = '';

        async function cloneGitHubRepo() {
            try {
                // Set loading state
                setButtonLoading('cloneGitHubBtn', true);
                updateGitHubStatus('Cloning/pulling GitHub repository...', true);
                addGitHubLog('INFO', 'Starting repository clone/pull operation');
                
                showAlert('Cloning/pulling GitHub repository...', 'success', 'vidiotsAlert');
                
                const response = await fetch('/admin/api/vidiots/github/clone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    updateGitHubStatus(`Repository ${result.action} successfully`);
                    addGitHubLog('SUCCESS', `Repository ${result.action} operation completed successfully`);
                    if (result.output) {
                        addGitHubLog('INFO', `Git output: ${result.output.substring(0, 100)}...`);
                    }
                    showAlert(`Repository ${result.action} successfully`, 'success', 'vidiotsAlert');
                    
                    // Automatically browse the repository after successful clone/pull
                    setTimeout(() => {
                        addGitHubLog('INFO', 'Automatically opening repository browser');
                        browseGitHubRepo();
                    }, 1000);
                } else {
                    setGitHubError('Repository operation failed');
                    addGitHubLog('ERROR', `Repository clone/pull failed: ${result.error || 'Unknown error'}`);
                    showAlert('Failed to clone/pull repository: ' + (result.error || 'Unknown error'), 'error', 'vidiotsAlert');
                }
            } catch (error) {
                setGitHubError('Repository operation error');
                addGitHubLog('ERROR', `Repository clone/pull error: ${error.message}`);
                showAlert('Error cloning/pulling repository: ' + error.message, 'error', 'vidiotsAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('cloneGitHubBtn', false);
            }
        }

        async function browseGitHubRepo(path = '') {
            try {
                currentBrowsePath = path;
                
                // Set loading state for browse button
                setButtonLoading('browseGitHubBtn', true);
                addGitHubLog('INFO', `Browsing repository path: ${path || '/'}`);
                
                const response = await fetch(`/admin/api/vidiots/github/browse?path=${encodeURIComponent(path)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    displayRepositoryContents(result, path);
                    document.getElementById('githubRepositoryBrowser').style.display = 'block';
                    addGitHubLog('SUCCESS', `Repository contents loaded for path: ${path || '/'}`);
                    if (result.items) {
                        addGitHubLog('INFO', `Found ${result.items.length} items in directory`);
                    }
                    showAlert('Repository contents loaded', 'success', 'repositoryBrowserAlert');
                } else {
                    addGitHubLog('ERROR', `Failed to browse repository: ${result.error || 'Unknown error'}`);
                    showAlert('Failed to browse repository: ' + (result.error || 'Unknown error'), 'error', 'repositoryBrowserAlert');
                }
            } catch (error) {
                addGitHubLog('ERROR', `Error browsing repository: ${error.message}`);
                showAlert('Error browsing repository: ' + error.message, 'error', 'repositoryBrowserAlert');
            } finally {
                // Reset button loading state
                setButtonLoading('browseGitHubBtn', false);
            }
        }

        function displayRepositoryContents(result, path) {
            const fileBrowser = document.getElementById('fileBrowser');
            const currentPathEl = document.getElementById('currentPath');
            
            currentPathEl.textContent = path || '/';
            
            if (result.type === 'directory') {
                let html = '<div style="border-bottom: 1px solid #eee; padding: 10px; font-weight: bold; background: #f8f9fa;">📁 Directory Contents</div>';
                
                if (result.items && result.items.length > 0) {
                    result.items.forEach(item => {
                        const icon = item.type === 'directory' ? '📁' : '📄';
                        const itemPath = item.path;
                        const sizeText = item.size ? ` (${formatFileSize(item.size)})` : '';
                        const modifiedText = item.modified ? new Date(item.modified).toLocaleDateString() : '';
                        
                        html += `
                        <div style="border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; hover: background-color: #f8f9fa;" 
                             onmouseover="this.style.backgroundColor='#f8f9fa'" 
                             onmouseout="this.style.backgroundColor='white'">
                            <div style="flex: 1; cursor: pointer;" onclick="handleItemClick('${itemPath}', '${item.type}')">
                                <span style="font-size: 1.2em; margin-right: 8px;">${icon}</span>
                                <span style="font-weight: ${item.type === 'directory' ? 'bold' : 'normal'};">${escapeHtml(item.name)}</span>
                                <span style="color: #666; font-size: 0.9em;">${sizeText}</span>
                            </div>
                            <div style="color: #666; font-size: 0.9em; margin-right: 10px;">${modifiedText}</div>
                            <div>
                                ${item.isDownloadable ? `<button class="btn btn-sm" onclick="downloadFile('${itemPath}')" style="padding: 4px 8px; font-size: 0.8em; margin-right: 4px;">⬇️ Download</button>` : ''}
                                ${item.isDownloadable ? `<button class="btn btn-sm btn-danger" onclick="deleteFileFromRepository('${itemPath}', '${escapeHtml(item.name)}')" style="padding: 4px 8px; font-size: 0.8em;">🗑️ Delete</button>` : ''}
                            </div>
                        </div>`;
                    });
                } else {
                    html += '<div style="padding: 20px; text-align: center; color: #666;">Directory is empty</div>';
                }
                
                fileBrowser.innerHTML = html;
            } else if (result.type === 'file') {
                fileBrowser.innerHTML = `
                <div style="padding: 20px;">
                    <h4>📄 ${escapeHtml(result.name)}</h4>
                    <p>Size: ${formatFileSize(result.size)}</p>
                    <p>Modified: ${new Date(result.modified).toLocaleString()}</p>
                    <button class="btn" onclick="downloadFile('${result.path}')" style="margin-right: 10px;">⬇️ Download File</button>
                    <button class="btn btn-danger" onclick="deleteFileFromRepository('${escapeHtml(result.path)}', '${escapeHtml(result.name)}')">🗑️ Delete File</button>
                </div>`;
            }
        }

        function handleItemClick(itemPath, itemType) {
            if (itemType === 'directory') {
                browseGitHubRepo(itemPath);
            } else {
                // For files, we could show file info or download
                downloadFile(itemPath);
            }
        }

        async function downloadFile(filePath) {
            try {
                showAlert('Downloading file...', 'success', 'repositoryBrowserAlert');
                
                const url = `/admin/api/vidiots/github/download?path=${encodeURIComponent(filePath)}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filename = contentDisposition
                        ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                        : filePath.split('/').pop();
                    
                    // Create download link and trigger download
                    const downloadLink = document.createElement('a');
                    downloadLink.href = window.URL.createObjectURL(blob);
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    showAlert(`File "${filename}" downloaded successfully`, 'success', 'repositoryBrowserAlert');
                } else {
                    const errorData = await response.json();
                    showAlert('Download failed: ' + (errorData.error || 'Unknown error'), 'error', 'repositoryBrowserAlert');
                }
            } catch (error) {
                showAlert('Error downloading file: ' + error.message, 'error', 'repositoryBrowserAlert');
            }
        }

        async function deleteFileFromRepository(filePath, fileName) {
            // Confirmation dialog
            if (!confirm(`Are you sure you want to delete "${fileName}"? This action will permanently remove the file from your GitHub.io repository when you next upload.`)) {
                return;
            }
            
            try {
                showAlert(`Deleting file "${fileName}"...`, 'success', 'repositoryBrowserAlert');
                
                const response = await fetch(`/admin/api/vidiots/github/delete?path=${encodeURIComponent(filePath)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(`File "${fileName}" deleted successfully! Changes will be uploaded to GitHub.io on next upload.`, 'success', 'repositoryBrowserAlert');
                    // Refresh the repository browser to show the updated file list
                    refreshRepositoryBrowser();
                } else {
                    showAlert('Delete failed: ' + (result.error || 'Unknown error'), 'error', 'repositoryBrowserAlert');
                }
            } catch (error) {
                showAlert('Error deleting file: ' + error.message, 'error', 'repositoryBrowserAlert');
            }
        }

        function refreshRepositoryBrowser() {
            browseGitHubRepo(currentBrowsePath);
        }

        function goToParentDirectory() {
            if (currentBrowsePath && currentBrowsePath !== '') {
                const pathParts = currentBrowsePath.split('/');
                pathParts.pop();
                const parentPath = pathParts.join('/');
                browseGitHubRepo(parentPath);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Git Identity Configuration Functions
        async function saveGitIdentity() {
            try {
                const userName = document.getElementById('gitUserName').value.trim();
                const userEmail = document.getElementById('gitUserEmail').value.trim();
                
                if (!userName || !userEmail) {
                    addGitHubLog('WARNING', 'Git identity save failed: Both user name and email are required');
                    showAlert('Both user name and email are required', 'error', 'gitIdentityAlert');
                    return;
                }
                
                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(userEmail)) {
                    addGitHubLog('WARNING', 'Git identity save failed: Invalid email format');
                    showAlert('Please enter a valid email address', 'error', 'gitIdentityAlert');
                    return;
                }
                
                addGitHubLog('INFO', `Saving git identity: ${userName} <${userEmail}>`);
                showAlert('Saving git identity...', 'success', 'gitIdentityAlert');
                
                const response = await fetch('/admin/api/vidiots/github/git-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userName: userName,
                        userEmail: userEmail
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addGitHubLog('SUCCESS', 'Git identity saved successfully and will persist across restarts');
                    showAlert('✅ Git identity saved successfully! This will be used for all GitHub commit operations and persists across container restarts.', 'success', 'gitIdentityAlert');
                    markSaved('Git Identity'); // Clear unsaved changes
                } else {
                    addGitHubLog('ERROR', `Failed to save git identity: ${result.error || 'Unknown error'}`);
                    showAlert('❌ Failed to save git identity: ' + (result.error || 'Unknown error'), 'error', 'gitIdentityAlert');
                }
            } catch (error) {
                addGitHubLog('ERROR', `Error saving git identity: ${error.message}`);
                showAlert('Error saving git identity: ' + error.message, 'error', 'gitIdentityAlert');
            }
        }

        async function loadGitIdentity() {
            try {
                // Load current git configuration from the API
                const response = await fetch('/admin/api/vidiots/github/git-config', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    // Populate the form fields with the loaded values
                    document.getElementById('gitUserName').value = result.userName || '';
                    document.getElementById('gitUserEmail').value = result.userEmail || '';
                    
                    if (result.isDefault) {
                        showAlert('Default git identity loaded. Please update with your information for GitHub operations.', 'info', 'gitIdentityAlert');
                    } else {
                        const updatedDate = result.updatedAt ? new Date(result.updatedAt).toLocaleString() : 'Unknown';
                        showAlert(`Git identity loaded successfully. Last updated: ${updatedDate}`, 'success', 'gitIdentityAlert');
                    }
                } else {
                    showAlert('Failed to load git identity: ' + (result.error || 'Unknown error'), 'error', 'gitIdentityAlert');
                    // Clear form on error
                    document.getElementById('gitUserName').value = '';
                    document.getElementById('gitUserEmail').value = '';
                }
            } catch (error) {
                console.error('Error loading git identity:', error);
                showAlert('Error loading git identity: ' + error.message, 'error', 'gitIdentityAlert');
                // Clear form on error
                document.getElementById('gitUserName').value = '';
                document.getElementById('gitUserEmail').value = '';
            }
        }

        // GitHub logging and status management functions
        function addGitHubLog(level, message, timestamp = null) {
            const logContainer = document.getElementById('githubOperationLog');
            if (!logContainer) return;
            
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.style.marginBottom = '5px';
            
            // Set color based on log level
            let color = '#6c757d'; // default gray
            switch (level.toUpperCase()) {
                case 'SUCCESS': color = '#28a745'; break;
                case 'ERROR': color = '#dc3545'; break;
                case 'WARNING': color = '#ffc107'; break;
                case 'INFO': color = '#17a2b8'; break;
            }
            
            logEntry.innerHTML = `
                <span class="timestamp" style="color: #6c757d;">[${time}]</span> 
                <span class="level" style="color: ${color}; font-weight: bold;">${level.toUpperCase()}</span> 
                <span class="message">${message}</span>
            `;
            
            // Add to top of log
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Limit to 50 entries to prevent memory issues
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 50) {
                entries[entries.length - 1].remove();
            }
            
            // Auto-scroll to show latest entry
            logContainer.scrollTop = 0;
        }
        
        function updateGitHubStatus(message, isLoading = false) {
            const statusContainer = document.getElementById('githubOperationStatus');
            if (!statusContainer) return;
            
            if (isLoading) {
                statusContainer.innerHTML = `<span style="color: #ffc107;">⏳ ${message}</span>`;
                statusContainer.style.borderLeft = '4px solid #ffc107';
            } else {
                statusContainer.innerHTML = `<span style="color: #28a745;">✅ ${message}</span>`;
                statusContainer.style.borderLeft = '4px solid #28a745';
            }
        }
        
        function setGitHubError(message) {
            const statusContainer = document.getElementById('githubOperationStatus');
            if (!statusContainer) return;
            
            statusContainer.innerHTML = `<span style="color: #dc3545;">❌ ${message}</span>`;
            statusContainer.style.borderLeft = '4px solid #dc3545';
        }
        
        function clearGitHubLogs() {
            const logContainer = document.getElementById('githubOperationLog');
            if (!logContainer) return;
            
            logContainer.innerHTML = `
                <div class="log-entry" style="color: #6c757d; margin-bottom: 5px;">
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span> 
                    <span class="level">INFO</span> 
                    <span class="message">Logs cleared</span>
                </div>
            `;
            addGitHubLog('INFO', 'GitHub operation logs cleared');
        }
        
        function refreshGitHubStatus() {
            addGitHubLog('INFO', 'Refreshing GitHub status...');
            updateGitHubStatus('Checking GitHub configuration and connectivity...', true);
            
            // Load git identity to refresh display
            loadGitIdentity().then(() => {
                updateGitHubStatus('GitHub interface ready');
                addGitHubLog('SUCCESS', 'GitHub status refreshed successfully');
            }).catch((error) => {
                setGitHubError('Failed to refresh GitHub status');
                addGitHubLog('ERROR', `Status refresh failed: ${error.message}`);
            });
        }
        
        function setButtonLoading(buttonId, loading = true, originalText = null) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            if (loading) {
                if (!button.dataset.originalText) {
                    button.dataset.originalText = button.textContent;
                }
                button.textContent = '⏳ Loading...';
                button.disabled = true;
                button.style.opacity = '0.7';
            } else {
                button.textContent = button.dataset.originalText || originalText || button.textContent;
                button.disabled = false;
                button.style.opacity = '1';
                delete button.dataset.originalText;
            }
        }

        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', function() {
            // Hide non-dashboard sections initially
            const allSections = document.querySelectorAll('.admin-section');
            allSections.forEach(section => {
                if (!section.classList.contains('dashboard-section')) {
                    section.classList.add('hidden');
                }
            });

            // Initialize collapsible sections
            initializeCollapsibleSections();

            // Initialize espresso editor URL
            initializeEspressoEditorUrl();

            // Add event listener for GitHub Pages toggle
            const githubEnabledSelect = document.getElementById('vidiotsGithubEnabled');
            if (githubEnabledSelect) {
                githubEnabledSelect.addEventListener('change', toggleGitHubConfig);
            }
            
            // Initialize GitHub status and load git identity when the page loads
            if (document.getElementById('githubOperationLog')) {
                addGitHubLog('INFO', 'GitHub interface initialized');
                updateGitHubStatus('Ready for GitHub operations');
                
                // Load git identity automatically
                setTimeout(() => {
                    loadGitIdentity();
                }, 500);
            }
        });
        
        // Also load Git Identity when switching to GitHub tab
        function initializeGitHubSection() {
            if (document.getElementById('githubOperationLog')) {
                addGitHubLog('INFO', 'GitHub section opened');
                loadGitIdentity();
            }
        }
        
        // Smart Mirror Dashboard Functions
        
        // Update auto theme status display for an orientation
        async function updateAutoThemeStatus(orientation, config) {
            const statusDiv = document.getElementById(`autoTheme${orientation.charAt(0).toUpperCase() + orientation.slice(1)}Status`);
            if (!statusDiv) return;
            
            const autoTheme = config?.autoThemeSwitch?.[orientation];
            
            if (!autoTheme || !autoTheme.enabled) {
                statusDiv.style.display = 'none';
                return;
            }
            
            if (!autoTheme.latitude || !autoTheme.longitude) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'warning-message';
                statusDiv.innerHTML = '⚠️ Auto theme enabled but location not configured. Please enter latitude and longitude.';
                return;
            }
            
            try {
                // Fetch current theme info from API
                const response = await fetch(`/api/smart-mirror/config?orientation=${orientation}`);
                const data = await response.json();
                
                if (data.success && data.config && data.config.themeInfo) {
                    const themeInfo = data.config.themeInfo;
                    
                    if (themeInfo.autoMode) {
                        const now = new Date();
                        const nextSwitch = themeInfo.nextSwitch ? new Date(themeInfo.nextSwitch) : null;
                        
                        let statusHtml = `
                            <strong>🌅 Auto Theme Active</strong><br>
                            <span style="color: #666;">Current Theme: <strong style="color: ${themeInfo.theme === 'light' ? '#f39c12' : '#3498db'};">${themeInfo.theme === 'light' ? '☀️ Light' : '🌙 Dark'}</strong></span>
                        `;
                        
                        if (themeInfo.sunTimes) {
                            const sunrise = new Date(themeInfo.sunTimes.sunrise);
                            const sunset = new Date(themeInfo.sunTimes.sunset);
                            const lightStart = new Date(themeInfo.sunTimes.lightStart);
                            const lightEnd = new Date(themeInfo.sunTimes.lightEnd);
                            
                            statusHtml += `<br><span style="color: #666;">
                                Today's Light Period: ${lightStart.toLocaleTimeString()} - ${lightEnd.toLocaleTimeString()}<br>
                                (Sunrise: ${sunrise.toLocaleTimeString()}, Sunset: ${sunset.toLocaleTimeString()})
                            </span>`;
                        }
                        
                        if (nextSwitch) {
                            const timeUntil = Math.round((nextSwitch - now) / 1000 / 60); // minutes
                            const nextTheme = themeInfo.theme === 'light' ? 'Dark' : 'Light';
                            const nextEmoji = themeInfo.theme === 'light' ? '🌙' : '☀️';
                            
                            statusHtml += `<br><span style="color: #666;">
                                Next Switch: ${nextEmoji} ${nextTheme} in ${timeUntil} minutes (at ${nextSwitch.toLocaleTimeString()})
                            </span>`;
                        }
                        
                        statusDiv.style.display = 'block';
                        statusDiv.className = 'info-message';
                        statusDiv.innerHTML = statusHtml;
                    } else if (themeInfo.error) {
                        statusDiv.style.display = 'block';
                        statusDiv.className = 'error-message';
                        statusDiv.innerHTML = `❌ Error: ${themeInfo.error}`;
                    }
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'info-message';
                    statusDiv.innerHTML = '📊 Save configuration to see auto theme status';
                }
            } catch (error) {
                console.error(`Error fetching theme status for ${orientation}:`, error);
                statusDiv.style.display = 'block';
                statusDiv.className = 'error-message';
                statusDiv.innerHTML = '❌ Error fetching theme status';
            }
        }
        
        async function loadSmartMirrorConfig() {
            try {
                const response = await fetch('/admin/api/smart-mirror/config');
                const data = await response.json();
                
                if (data.success && data.config) {
                    const config = data.config;
                    
                    // Load main settings
                    document.getElementById('smartMirrorEnabled').value = config.enabled ? 'true' : 'false';
                    document.getElementById('smartMirrorTheme').value = config.theme || 'dark';
                    
                    // Get layouts (use old format as fallback)
                    const portraitLayout = config.layouts?.portrait || {};
                    const landscapeLayout = config.layouts?.landscape || {};
                    
                    // Load clock widget config
                    const clock = config.widgets?.clock || {};
                    document.getElementById('clockEnabled').value = clock.enabled === true ? 'true' : 'false';
                    document.getElementById('clockSize').value = clock.size || 'medium';
                    // Load portrait layout (default)
                    const clockPortrait = portraitLayout.clock || clock.gridPosition || { x: 0, y: 0, width: 2, height: 1 };
                    document.getElementById('clockGridX').value = clockPortrait.x ?? 0;
                    document.getElementById('clockGridY').value = clockPortrait.y ?? 0;
                    document.getElementById('clockGridWidth').value = clockPortrait.width ?? 2;
                    document.getElementById('clockGridHeight').value = clockPortrait.height ?? 1;
                    
                    // Load calendar widget config
                    const calendar = config.widgets?.calendar || {};
                    document.getElementById('calendarEnabled').value = calendar.enabled === true ? 'true' : 'false';
                    document.getElementById('calendarSize').value = calendar.size || 'large';
                    const calendarPortrait = portraitLayout.calendar || calendar.gridPosition || { x: 2, y: 0, width: 2, height: 2 };
                    document.getElementById('calendarGridX').value = calendarPortrait.x ?? 2;
                    document.getElementById('calendarGridY').value = calendarPortrait.y ?? 0;
                    document.getElementById('calendarGridWidth').value = calendarPortrait.width ?? 2;
                    document.getElementById('calendarGridHeight').value = calendarPortrait.height ?? 2;
                    // Handle both old single URL and new multiple URLs
                    const calendarUrls = calendar.calendarUrls || (calendar.calendarUrl ? [calendar.calendarUrl] : []);
                    document.getElementById('calendarUrl').value = calendarUrls.join('\n');
                    
                    // Load weather widget config
                    const weather = config.widgets?.weather || {};
                    document.getElementById('weatherEnabled').value = weather.enabled === true ? 'true' : 'false';
                    document.getElementById('weatherSize').value = weather.size || 'medium';
                    const weatherPortrait = portraitLayout.weather || weather.gridPosition || { x: 0, y: 1, width: 2, height: 1 };
                    document.getElementById('weatherGridX').value = weatherPortrait.x ?? 0;
                    document.getElementById('weatherGridY').value = weatherPortrait.y ?? 1;
                    document.getElementById('weatherGridWidth').value = weatherPortrait.width ?? 2;
                    document.getElementById('weatherGridHeight').value = weatherPortrait.height ?? 1;
                    document.getElementById('weatherLocation').value = weather.location || '';
                    document.getElementById('weatherUnits').value = weather.units || 'imperial';
                    // Don't load API key for security, but show if one exists
                    const weatherApiKeyInput = document.getElementById('weatherApiKey');
                    if (weather.apiKey) {
                        weatherApiKeyInput.placeholder = '••••••••••••••••••••••••• (API key is set - leave blank to keep current)';
                        weatherApiKeyInput.dataset.hasKey = 'true';
                    } else {
                        weatherApiKeyInput.placeholder = 'Enter your OpenWeatherMap API key';
                        weatherApiKeyInput.dataset.hasKey = 'false';
                    }
                    
                    // Load forecast widget config
                    const forecast = config.widgets?.forecast || {};
                    document.getElementById('forecastEnabled').value = forecast.enabled === true ? 'true' : 'false';
                    document.getElementById('forecastDays').value = forecast.days || 5;
                    const forecastPortrait = portraitLayout.forecast || forecast.gridPosition || { x: 0, y: 2, width: 4, height: 1 };
                    document.getElementById('forecastGridX').value = forecastPortrait.x ?? 0;
                    document.getElementById('forecastGridY').value = forecastPortrait.y ?? 2;
                    document.getElementById('forecastGridWidth').value = forecastPortrait.width ?? 4;
                    document.getElementById('forecastGridHeight').value = forecastPortrait.height ?? 1;
                    document.getElementById('forecastLocation').value = forecast.location || '';
                    document.getElementById('forecastUnits').value = forecast.units || 'imperial';
                    // Don't load API key for security, but show if one exists
                    const forecastApiKeyInput = document.getElementById('forecastApiKey');
                    if (forecast.apiKey) {
                        forecastApiKeyInput.placeholder = '••••••••••••••••••••••••• (API key is set - leave blank to keep current)';
                        forecastApiKeyInput.dataset.hasKey = 'true';
                    } else {
                        forecastApiKeyInput.placeholder = 'Enter your OpenWeatherMap API key';
                        forecastApiKeyInput.dataset.hasKey = 'false';
                    }
                    
                    // Load news widget config
                    const news = config.widgets?.news || {};
                    document.getElementById('newsEnabled').value = news.enabled === true ? 'true' : 'false';
                    document.getElementById('newsSize').value = news.size || 'medium';
                    const newsPortrait = portraitLayout.news || news.gridPosition || { x: 2, y: 1, width: 2, height: 1 };
                    document.getElementById('newsGridX').value = newsPortrait.x ?? 2;
                    document.getElementById('newsGridY').value = newsPortrait.y ?? 1;
                    document.getElementById('newsGridWidth').value = newsPortrait.width ?? 2;
                    document.getElementById('newsGridHeight').value = newsPortrait.height ?? 1;
                    // Handle both old single URL and new multiple URLs
                    const feedUrls = news.feedUrls || (news.feedUrl ? [news.feedUrl] : []);
                    document.getElementById('newsFeedUrl').value = feedUrls.join('\n');
                    
                    // Load media widget config
                    const media = config.widgets?.media || {};
                    document.getElementById('mediaEnabled').value = media.enabled === true ? 'true' : 'false';
                    document.getElementById('mediaSize').value = media.size || 'large';
                    const mediaPortrait = portraitLayout.media || media.gridPosition || { x: 0, y: 4, width: 4, height: 2 };
                    document.getElementById('mediaGridX').value = mediaPortrait.x ?? 0;
                    document.getElementById('mediaGridY').value = mediaPortrait.y ?? 4;
                    document.getElementById('mediaGridWidth').value = mediaPortrait.width ?? 4;
                    document.getElementById('mediaGridHeight').value = mediaPortrait.height ?? 2;
                    document.getElementById('mediaHomeAssistantUrl').value = media.homeAssistantUrl || '';
                    // Don't load token for security, but show if one exists
                    const mediaTokenInput = document.getElementById('mediaHomeAssistantToken');
                    if (media.homeAssistantToken) {
                        mediaTokenInput.placeholder = '••••••••••••••••••••••••• (Token is set - leave blank to keep current)';
                        mediaTokenInput.dataset.hasToken = 'true';
                    } else {
                        mediaTokenInput.placeholder = 'Enter your long-lived access token';
                        mediaTokenInput.dataset.hasToken = 'false';
                    }
                    const entityIds = media.entityIds || [];
                    document.getElementById('mediaEntityIds').value = entityIds.join('\n');
                    
                    // Store landscape layouts and grid sizes in a global variable for later use
                    window.smartMirrorLayouts = {
                        portrait: portraitLayout,
                        landscape: landscapeLayout
                    };
                    
                    // Store grid sizes per orientation
                    window.smartMirrorGridSizes = config.gridSize || {
                        portrait: { columns: 4, rows: 6 },
                        landscape: { columns: 8, rows: 4 }
                    };
                    
                    // Handle old format (single gridSize object) - migrate to new defaults
                    if (window.smartMirrorGridSizes.columns && window.smartMirrorGridSizes.rows) {
                        // Old format - use new orientation-specific defaults instead of duplicating old size
                        console.log('Migrating old grid size format to new orientation-specific defaults');
                        window.smartMirrorGridSizes = {
                            portrait: { columns: 4, rows: 6 },
                            landscape: { columns: 8, rows: 4 }
                        };
                    }
                    
                    // Load auto theme switch settings
                    const autoTheme = config.autoThemeSwitch || {
                        portrait: { enabled: false, latitude: null, longitude: null, timezone: 'America/New_York' },
                        landscape: { enabled: false, latitude: null, longitude: null, timezone: 'America/New_York' }
                    };
                    
                    // Portrait auto theme
                    document.getElementById('autoThemePortraitEnabled').value = autoTheme.portrait?.enabled ? 'true' : 'false';
                    document.getElementById('autoThemePortraitLat').value = autoTheme.portrait?.latitude || '';
                    document.getElementById('autoThemePortraitLon').value = autoTheme.portrait?.longitude || '';
                    document.getElementById('autoThemePortraitTimezone').value = autoTheme.portrait?.timezone || 'America/New_York';
                    
                    // Landscape auto theme
                    document.getElementById('autoThemeLandscapeEnabled').value = autoTheme.landscape?.enabled ? 'true' : 'false';
                    document.getElementById('autoThemeLandscapeLat').value = autoTheme.landscape?.latitude || '';
                    document.getElementById('autoThemeLandscapeLon').value = autoTheme.landscape?.longitude || '';
                    document.getElementById('autoThemeLandscapeTimezone').value = autoTheme.landscape?.timezone || 'America/New_York';
                    
                    // Calculate and display theme status for both orientations
                    updateAutoThemeStatus('portrait', config);
                    updateAutoThemeStatus('landscape', config);
                    
                    console.log('Smart Mirror configuration loaded');
                    console.log('Portrait layouts:', portraitLayout);
                    console.log('Landscape layouts:', landscapeLayout);
                    console.log('Grid sizes:', window.smartMirrorGridSizes);
                    
                    // Initialize grid editor after loading config
                    initializeGridEditor();
                    
                    // Add event listeners to refresh grid when widgets are enabled/disabled
                    ['clock', 'calendar', 'weather', 'forecast', 'news', 'media'].forEach(type => {
                        const enabledSelect = document.getElementById(`${type}Enabled`);
                        if (enabledSelect) {
                            enabledSelect.addEventListener('change', () => {
                                // Update grid state and re-render
                                // Small delay to ensure DOM updates are complete before re-rendering
                                setTimeout(() => {
                                    loadGridWidgets();
                                }, 100);
                            });
                        }
                    });
                } else {
                    showSmartMirrorAlert('Failed to load Smart Mirror configuration', 'error');
                }
            } catch (error) {
                console.error('Error loading Smart Mirror config:', error);
                showSmartMirrorAlert('Error loading configuration: ' + error.message, 'error');
            }
        }
        
        async function saveSmartMirrorConfig() {
            try {
                // First, fetch current config to preserve API keys if not being changed
                const currentConfigResponse = await fetch('/admin/api/smart-mirror/config');
                const currentConfigData = await currentConfigResponse.json();
                const currentConfig = currentConfigData.success ? currentConfigData.config : null;
                
                // Helper function to preserve existing API key if input is empty
                function preserveApiKey(inputValue, existingKey) {
                    // If user entered a new value, use it; otherwise preserve existing
                    const trimmedInput = inputValue ? inputValue.trim() : '';
                    return trimmedInput || existingKey || undefined;
                }
                
                // Parse calendar URLs from textarea (one per line)
                const calendarUrlText = document.getElementById('calendarUrl').value;
                const calendarUrls = calendarUrlText.split('\n')
                    .map(url => url.trim())
                    .filter(url => url.length > 0);
                
                // Parse news feed URLs from textarea (one per line)
                const newsFeedUrlText = document.getElementById('newsFeedUrl').value;
                const feedUrls = newsFeedUrlText.split('\n')
                    .map(url => url.trim())
                    .filter(url => url.length > 0);
                
                // Build portrait layout from form fields
                const portraitLayout = {
                    clock: {
                        x: parseInt(document.getElementById('clockGridX').value),
                        y: parseInt(document.getElementById('clockGridY').value),
                        width: parseInt(document.getElementById('clockGridWidth').value),
                        height: parseInt(document.getElementById('clockGridHeight').value)
                    },
                    calendar: {
                        x: parseInt(document.getElementById('calendarGridX').value),
                        y: parseInt(document.getElementById('calendarGridY').value),
                        width: parseInt(document.getElementById('calendarGridWidth').value),
                        height: parseInt(document.getElementById('calendarGridHeight').value)
                    },
                    weather: {
                        x: parseInt(document.getElementById('weatherGridX').value),
                        y: parseInt(document.getElementById('weatherGridY').value),
                        width: parseInt(document.getElementById('weatherGridWidth').value),
                        height: parseInt(document.getElementById('weatherGridHeight').value)
                    },
                    forecast: {
                        x: parseInt(document.getElementById('forecastGridX').value),
                        y: parseInt(document.getElementById('forecastGridY').value),
                        width: parseInt(document.getElementById('forecastGridWidth').value),
                        height: parseInt(document.getElementById('forecastGridHeight').value)
                    },
                    news: {
                        x: parseInt(document.getElementById('newsGridX').value),
                        y: parseInt(document.getElementById('newsGridY').value),
                        width: parseInt(document.getElementById('newsGridWidth').value),
                        height: parseInt(document.getElementById('newsGridHeight').value)
                    },
                    media: {
                        x: parseInt(document.getElementById('mediaGridX').value),
                        y: parseInt(document.getElementById('mediaGridY').value),
                        width: parseInt(document.getElementById('mediaGridWidth').value),
                        height: parseInt(document.getElementById('mediaGridHeight').value)
                    }
                };
                
                // Parse media entity IDs from textarea (one per line)
                const mediaEntityIdsText = document.getElementById('mediaEntityIds').value;
                const mediaEntityIds = mediaEntityIdsText.split('\n')
                    .map(id => id.trim())
                    .filter(id => id.length > 0);
                
                // Get landscape layout from stored config (or default if not set)
                const landscapeLayout = window.smartMirrorLayouts?.landscape || portraitLayout;
                
                const config = {
                    enabled: document.getElementById('smartMirrorEnabled').value === 'true',
                    theme: document.getElementById('smartMirrorTheme').value,
                    widgets: {
                        clock: {
                            enabled: document.getElementById('clockEnabled').value === 'true',
                            size: document.getElementById('clockSize').value,
                            area: 'top-left'
                        },
                        calendar: {
                            enabled: document.getElementById('calendarEnabled').value === 'true',
                            size: document.getElementById('calendarSize').value,
                            area: 'top-right',
                            calendarUrls: calendarUrls
                        },
                        weather: {
                            enabled: document.getElementById('weatherEnabled').value === 'true',
                            size: document.getElementById('weatherSize').value,
                            area: 'bottom-left',
                            location: document.getElementById('weatherLocation').value,
                            apiKey: preserveApiKey(
                                document.getElementById('weatherApiKey').value,
                                currentConfig?.widgets?.weather?.apiKey
                            ),
                            units: document.getElementById('weatherUnits').value
                        },
                        forecast: {
                            enabled: document.getElementById('forecastEnabled').value === 'true',
                            size: 'large',
                            area: 'bottom-center',
                            location: document.getElementById('forecastLocation').value,
                            apiKey: preserveApiKey(
                                document.getElementById('forecastApiKey').value,
                                currentConfig?.widgets?.forecast?.apiKey
                            ),
                            days: parseInt(document.getElementById('forecastDays').value),
                            units: document.getElementById('forecastUnits').value
                        },
                        news: {
                            enabled: document.getElementById('newsEnabled').value === 'true',
                            size: document.getElementById('newsSize').value,
                            area: 'bottom-right',
                            feedUrls: feedUrls
                        },
                        media: {
                            enabled: document.getElementById('mediaEnabled').value === 'true',
                            size: document.getElementById('mediaSize').value,
                            area: 'middle-center',
                            homeAssistantUrl: document.getElementById('mediaHomeAssistantUrl').value.trim(),
                            homeAssistantToken: preserveApiKey(
                                document.getElementById('mediaHomeAssistantToken').value,
                                currentConfig?.widgets?.media?.homeAssistantToken
                            ),
                            entityIds: mediaEntityIds
                        }
                    },
                    layouts: {
                        portrait: portraitLayout,
                        landscape: landscapeLayout
                    },
                    gridSize: window.smartMirrorGridSizes || {
                        portrait: { columns: 4, rows: 6 },
                        landscape: { columns: 8, rows: 4 }
                    },
                    refreshInterval: 60000,
                    autoThemeSwitch: {
                        portrait: {
                            enabled: document.getElementById('autoThemePortraitEnabled').value === 'true',
                            latitude: parseFloat(document.getElementById('autoThemePortraitLat').value) || null,
                            longitude: parseFloat(document.getElementById('autoThemePortraitLon').value) || null,
                            timezone: document.getElementById('autoThemePortraitTimezone').value
                        },
                        landscape: {
                            enabled: document.getElementById('autoThemeLandscapeEnabled').value === 'true',
                            latitude: parseFloat(document.getElementById('autoThemeLandscapeLat').value) || null,
                            longitude: parseFloat(document.getElementById('autoThemeLandscapeLon').value) || null,
                            timezone: document.getElementById('autoThemeLandscapeTimezone').value
                        }
                    }
                };
                
                const response = await fetch('/admin/api/smart-mirror/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSmartMirrorAlert('Smart Mirror configuration saved successfully!', 'success');
                    // Update auto theme status displays
                    updateAutoThemeStatus('portrait', result.config);
                    updateAutoThemeStatus('landscape', result.config);
                } else {
                    showSmartMirrorAlert('Failed to save configuration: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error saving Smart Mirror config:', error);
                showSmartMirrorAlert('Error saving configuration: ' + error.message, 'error');
            }
        }
        
        function previewSmartMirror() {
            // Open preview in the current orientation being edited
            const url = gridState.currentOrientation === 'landscape' ? '/smart-mirror-l' : '/smart-mirror';
            window.open(url, '_blank');
        }
        
        function previewSmartMirrorPortrait() {
            window.open('/smart-mirror', '_blank');
        }
        
        function previewSmartMirrorLandscape() {
            window.open('/smart-mirror-l', '_blank');
        }
        
        function showSmartMirrorAlert(message, type) {
            const alertDiv = document.getElementById('smartMirrorAlert');
            if (alertDiv) {
                alertDiv.textContent = message;
                alertDiv.className = 'alert ' + type;
                alertDiv.style.display = 'block';
                
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Smart Mirror Diagnostics Functions
        async function loadSmartMirrorDiagnostics() {
            try {
                const response = await fetch('/admin/api/smart-mirror/diagnostics');
                const data = await response.json();
                
                if (data.success && data.diagnostics) {
                    const diag = data.diagnostics;
                    
                    // Show diagnostics section
                    document.getElementById('smartMirrorDiagnostics').style.display = 'block';
                    
                    // Environment information
                    const envHtml = `
                        <div><strong>Node Environment:</strong> ${diag.environment.nodeEnv}</div>
                        <div><strong>Running in Docker:</strong> ${diag.environment.isDocker ? '✅ Yes' : '❌ No'}</div>
                        <div><strong>Platform:</strong> ${diag.environment.platform} (${diag.environment.arch})</div>
                        <div><strong>Hostname:</strong> ${diag.environment.hostname}</div>
                        <div><strong>Node Version:</strong> ${diag.environment.nodeVersion}</div>
                        <div><strong>Uptime:</strong> ${formatUptime(diag.environment.uptime)}</div>
                        <div><strong>Memory:</strong> ${diag.environment.memory.used}MB used / ${diag.environment.memory.total}MB total</div>
                    `;
                    document.getElementById('diagnosticsEnvironment').innerHTML = envHtml;
                    
                    // File checks
                    const filesHtml = `
                        <div><strong>Dashboard File:</strong> ${diag.fileChecks.dashboardExists ? '✅ Found' : '❌ NOT FOUND'}</div>
                        <div style="margin-left: 20px; color: #666;">Path: ${diag.paths.dashboardFile}</div>
                        ${diag.fileChecks.dashboardExists ? `<div style="margin-left: 20px; color: #666;">Size: ${diag.fileChecks.dashboardSize} bytes</div>` : ''}
                        <div style="margin-top: 10px;"><strong>Config File:</strong> ${diag.fileChecks.configExists ? '✅ Found' : '❌ NOT FOUND'}</div>
                        <div style="margin-left: 20px; color: #666;">Path: ${diag.paths.configFile}</div>
                        ${diag.fileChecks.configExists ? `<div style="margin-left: 20px; color: #666;">Size: ${diag.fileChecks.configSize} bytes</div>` : ''}
                        <div style="margin-top: 10px;"><strong>Public Directory:</strong> ${diag.fileChecks.publicDirExists ? '✅ Found' : '❌ NOT FOUND'}</div>
                        <div style="margin-left: 20px; color: #666;">Path: ${diag.paths.publicDirectory}</div>
                        <div style="margin-top: 10px;"><strong>Working Directory:</strong> ${diag.paths.workingDirectory}</div>
                    `;
                    document.getElementById('diagnosticsFiles').innerHTML = filesHtml;
                    
                    // Configuration status
                    const configHtml = `
                        <div><strong>Dashboard Enabled:</strong> ${diag.configuration.enabled ? '✅ Yes' : '❌ No'}</div>
                        <div><strong>Theme:</strong> ${diag.configuration.theme}</div>
                        <div><strong>Total Widgets:</strong> ${diag.configuration.widgetCount}</div>
                        <div><strong>Enabled Widgets:</strong> ${diag.configuration.enabledWidgets.join(', ') || 'None'}</div>
                        <div><strong>Custom Encryption Key:</strong> ${diag.configuration.hasCustomEncryptionKey ? '✅ Yes' : '⚠️  No (using default)'}</div>
                    `;
                    document.getElementById('diagnosticsConfig').innerHTML = configHtml;
                    
                    // Warnings
                    if (diag.warnings && diag.warnings.length > 0) {
                        const warningsHtml = diag.warnings.map(w => {
                            const icon = w.level === 'ERROR' ? '❌' : w.level === 'WARNING' ? '⚠️' : 'ℹ️';
                            return `
                                <div style="margin-bottom: 10px; padding: 10px; background: ${w.level === 'ERROR' ? '#fee' : w.level === 'WARNING' ? '#ffd' : '#eff'}; border-left: 3px solid ${w.level === 'ERROR' ? '#f00' : w.level === 'WARNING' ? '#fa0' : '#09f'}; border-radius: 3px;">
                                    <div><strong>${icon} ${w.level}:</strong> ${w.message}</div>
                                    <div style="margin-top: 5px; color: #666; font-size: 11px;"><strong>Solution:</strong> ${w.solution}</div>
                                </div>
                            `;
                        }).join('');
                        document.getElementById('diagnosticsWarnings').innerHTML = warningsHtml;
                    } else {
                        document.getElementById('diagnosticsWarnings').innerHTML = '<div style="color: #0a0;">✅ No issues detected</div>';
                    }
                    
                    // Recent logs
                    if (diag.logs && diag.logs.recent && diag.logs.recent.length > 0) {
                        const logsHtml = diag.logs.recent.map(log => {
                            const levelColor = {
                                'ERROR': '#f00',
                                'WARNING': '#fa0',
                                'SUCCESS': '#0a0',
                                'INFO': '#09f',
                                'DEBUG': '#999'
                            }[log.level] || '#000';
                            
                            const timestamp = new Date(log.timestamp).toLocaleString();
                            
                            return `
                                <div style="margin-bottom: 8px; padding: 5px; border-bottom: 1px solid #eee;">
                                    <div style="color: ${levelColor}; font-weight: bold;">${log.level} - ${timestamp}</div>
                                    <div style="margin-top: 3px;">${log.message}</div>
                                </div>
                            `;
                        }).join('');
                        document.getElementById('diagnosticsLogs').innerHTML = logsHtml;
                    } else {
                        document.getElementById('diagnosticsLogs').innerHTML = '<div style="color: #999;">No recent logs available</div>';
                    }
                    
                    showSmartMirrorAlert('Diagnostics loaded successfully', 'success');
                } else {
                    showSmartMirrorAlert('Failed to load diagnostics: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading Smart Mirror diagnostics:', error);
                showSmartMirrorAlert('Error loading diagnostics: ' + error.message, 'error');
            }
        }
        
        async function exportSmartMirrorLogs() {
            try {
                const response = await fetch('/admin/api/smart-mirror/logs/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `smart-mirror-logs-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showSmartMirrorAlert('Logs exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting Smart Mirror logs:', error);
                showSmartMirrorAlert('Error exporting logs: ' + error.message, 'error');
            }
        }
        
        // Widget Connection Test Functions
        
        // Helper function to display test results
        function displayTestResult(containerId, result) {
            const container = document.getElementById(containerId);
            const content = container.querySelector('.test-result-content');
            
            container.style.display = 'block';
            
            // Determine status class
            let statusClass = 'error';
            let icon = '❌';
            if (result.loading) {
                statusClass = 'loading';
                icon = '<span class="spinner"></span>';
            } else if (result.success) {
                statusClass = 'success';
                icon = '✅';
            } else if (result.warning) {
                statusClass = 'warning';
                icon = '⚠️';
            }
            
            container.className = `test-result-container ${statusClass}`;
            
            let html = `
                <div class="test-result-header">
                    <span class="test-result-icon">${icon}</span>
                    <span>${result.loading ? 'Testing connection...' : result.success ? 'Success' : result.error || 'Error'}</span>
                </div>
            `;
            
            if (result.message) {
                html += `<div class="test-result-message">${escapeHtml(result.message)}</div>`;
            }
            
            // Add detailed results for multi-feed tests (calendar, news)
            if (result.results && Array.isArray(result.results)) {
                html += '<div class="test-result-details">';
                result.results.forEach((item, index) => {
                    const itemIcon = item.success ? '✅' : '❌';
                    const itemClass = item.success ? 'success' : 'error';
                    html += `
                        <div class="test-result-detail-item">
                            <span class="test-result-icon">${itemIcon}</span>
                            <span class="test-result-detail-label">Feed ${index + 1}:</span>
                            ${escapeHtml(item.url.substring(0, 60))}${item.url.length > 60 ? '...' : ''}
                            <br>
                            <small style="margin-left: 30px; color: ${item.success ? '#155724' : '#721c24'};">
                                ${escapeHtml(item.message || (item.success ? 'OK' : item.error))}
                            </small>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Add data details if available
            if (result.data && !result.loading) {
                html += '<div class="test-result-details">';
                if (result.data.location) {
                    html += `<div class="test-result-detail-item">
                        <span class="test-result-detail-label">Location:</span> ${escapeHtml(result.data.location)}
                    </div>`;
                }
                if (result.data.temp !== undefined) {
                    html += `<div class="test-result-detail-item">
                        <span class="test-result-detail-label">Temperature:</span> ${result.data.temp}°
                    </div>`;
                }
                if (result.data.condition) {
                    html += `<div class="test-result-detail-item">
                        <span class="test-result-detail-label">Condition:</span> ${escapeHtml(result.data.condition)}
                    </div>`;
                }
                if (result.data.homeAssistantVersion) {
                    html += `<div class="test-result-detail-item">
                        <span class="test-result-detail-label">Version:</span> ${escapeHtml(result.data.homeAssistantVersion)}
                    </div>`;
                }
                if (result.data.foundEntities !== undefined) {
                    html += `<div class="test-result-detail-item">
                        <span class="test-result-detail-label">Entities Found:</span> ${result.data.foundEntities}/${result.data.configuredEntities}
                    </div>`;
                }
                if (result.data.mediaPlayers !== undefined) {
                    html += `<div class="test-result-detail-item">
                        <span class="test-result-detail-label">Media Players:</span> ${result.data.mediaPlayers}
                    </div>`;
                }
                html += '</div>';
            }
            
            content.innerHTML = html;
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Test weather widget connection
        async function testWeatherConnection() {
            const apiKey = document.getElementById('weatherApiKey').value.trim();
            const location = document.getElementById('weatherLocation').value.trim();
            const units = document.getElementById('weatherUnits').value;
            const containerId = 'weatherTestResult';
            
            if (!apiKey || !location) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Missing Information',
                    message: 'Please enter both an API key and location before testing.'
                });
                return;
            }
            
            // Show loading state
            displayTestResult(containerId, {
                loading: true,
                message: 'Connecting to OpenWeatherMap API...'
            });
            
            try {
                const response = await fetch('/admin/api/smart-mirror/test/weather', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ apiKey, location, units })
                });
                
                const result = await response.json();
                displayTestResult(containerId, result);
            } catch (error) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Request Failed',
                    message: 'Failed to test weather connection: ' + error.message
                });
            }
        }
        
        // Test calendar widget connection
        async function testCalendarConnection() {
            const feedUrlsText = document.getElementById('calendarUrl').value.trim();
            const containerId = 'calendarTestResult';
            
            if (!feedUrlsText) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Missing Information',
                    message: 'Please enter at least one calendar feed URL before testing.'
                });
                return;
            }
            
            const feedUrls = feedUrlsText.split('\n').map(url => url.trim()).filter(url => url);
            
            if (feedUrls.length === 0) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Missing Information',
                    message: 'Please enter at least one valid calendar feed URL.'
                });
                return;
            }
            
            // Show loading state
            displayTestResult(containerId, {
                loading: true,
                message: `Testing ${feedUrls.length} calendar feed(s)...`
            });
            
            try {
                const response = await fetch('/admin/api/smart-mirror/test/calendar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ feedUrls })
                });
                
                const result = await response.json();
                displayTestResult(containerId, result);
            } catch (error) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Request Failed',
                    message: 'Failed to test calendar feeds: ' + error.message
                });
            }
        }
        
        // Test news widget connection
        async function testNewsConnection() {
            const feedUrlsText = document.getElementById('newsFeedUrl').value.trim();
            const containerId = 'newsTestResult';
            
            if (!feedUrlsText) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Missing Information',
                    message: 'Please enter at least one news feed URL before testing.'
                });
                return;
            }
            
            const feedUrls = feedUrlsText.split('\n').map(url => url.trim()).filter(url => url);
            
            if (feedUrls.length === 0) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Missing Information',
                    message: 'Please enter at least one valid news feed URL.'
                });
                return;
            }
            
            // Show loading state
            displayTestResult(containerId, {
                loading: true,
                message: `Testing ${feedUrls.length} news feed(s)...`
            });
            
            try {
                const response = await fetch('/admin/api/smart-mirror/test/news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ feedUrls })
                });
                
                const result = await response.json();
                displayTestResult(containerId, result);
            } catch (error) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Request Failed',
                    message: 'Failed to test news feeds: ' + error.message
                });
            }
        }
        
        // Test media widget (Home Assistant) connection
        async function testMediaConnection() {
            const url = document.getElementById('mediaHomeAssistantUrl').value.trim();
            const token = document.getElementById('mediaHomeAssistantToken').value.trim();
            const entityIdsText = document.getElementById('mediaEntityIds').value.trim();
            const containerId = 'mediaTestResult';
            
            if (!url || !token) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Missing Information',
                    message: 'Please enter both the Home Assistant URL and access token before testing.'
                });
                return;
            }
            
            const entityIds = entityIdsText ? entityIdsText.split('\n').map(id => id.trim()).filter(id => id) : [];
            
            // Show loading state
            displayTestResult(containerId, {
                loading: true,
                message: 'Connecting to Home Assistant...'
            });
            
            try {
                const response = await fetch('/admin/api/smart-mirror/test/media', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url, token, entityIds })
                });
                
                const result = await response.json();
                displayTestResult(containerId, result);
            } catch (error) {
                displayTestResult(containerId, {
                    success: false,
                    error: 'Request Failed',
                    message: 'Failed to test Home Assistant connection: ' + error.message
                });
            }
        }
        
        // Interactive Grid Editor Functions
        // Grid configuration - will be updated dynamically based on orientation
        let GRID_CONFIG = {
            COLUMNS: 4,
            ROWS: 6,
            MAX_WIDTH: 4,
            MAX_HEIGHT: 6,
            MAX_COL_INDEX: 3, // 0-based indexing
            MAX_ROW_INDEX: 5  // 0-based indexing
        };
        
        // Update GRID_CONFIG based on orientation
        function updateGridConfig(orientation) {
            const gridSize = window.smartMirrorGridSizes?.[orientation] || { columns: 4, rows: 6 };
            GRID_CONFIG.COLUMNS = gridSize.columns;
            GRID_CONFIG.ROWS = gridSize.rows;
            GRID_CONFIG.MAX_WIDTH = gridSize.columns;
            GRID_CONFIG.MAX_HEIGHT = gridSize.rows;
            GRID_CONFIG.MAX_COL_INDEX = gridSize.columns - 1;
            GRID_CONFIG.MAX_ROW_INDEX = gridSize.rows - 1;
            console.log(`Grid config updated for ${orientation}:`, GRID_CONFIG);
        }
        
        let gridState = {
            widgets: {},
            selectedWidget: null,
            draggedWidget: null,
            originalPositions: {},
            isDragging: false,
            isResizing: false,
            resizeHandle: null,
            dragStartX: 0,
            dragStartY: 0,
            dragStartPos: { x: 0, y: 0, width: 0, height: 0 },
            currentOrientation: 'portrait' // Track which layout we're editing
        };
        
        // Widget icons for the grid editor
        // To add a new widget to the grid editor, simply:
        // 1. Add it to this WIDGET_ICONS object with an appropriate emoji
        // 2. Create form fields following the naming pattern: {widgetType}Enabled, {widgetType}GridX, etc.
        // The grid editor will automatically discover and display the widget - no other changes needed!
        const WIDGET_ICONS = {
            clock: '🕐',
            calendar: '📅',
            weather: '🌤️',
            forecast: '🌦️',
            news: '📰',
            media: '🎵'
        };
        
        // Switch between portrait and landscape editing
        function switchOrientation(orientation) {
            if (gridState.currentOrientation === orientation) return;
            
            // Save current layout state before switching
            applyGridChanges();
            
            // Update state
            gridState.currentOrientation = orientation;
            
            // Update grid config for new orientation
            updateGridConfig(orientation);
            
            // Update UI
            document.getElementById('portraitTab').classList.toggle('active', orientation === 'portrait');
            document.getElementById('landscapeTab').classList.toggle('active', orientation === 'landscape');
            
            // Update info text
            const gridSize = window.smartMirrorGridSizes?.[orientation] || GRID_CONFIG;
            const infoText = orientation === 'portrait' 
                ? `Editing Portrait Layout (${gridSize.columns}×${gridSize.rows} grid):` 
                : `Editing Landscape Layout (${gridSize.columns}×${gridSize.rows} grid):`;
            document.getElementById('orientationInfo').textContent = infoText;
            
            // Re-initialize grid editor with new dimensions
            initializeGridEditor();
            
            console.log(`Switched to ${orientation} layout editing`);
        }
        
        function initializeGridEditor() {
            const canvas = document.getElementById('gridCanvas');
            if (!canvas) return;
            
            // Update grid config for current orientation
            updateGridConfig(gridState.currentOrientation);
            
            // Update canvas grid template to match current orientation's dimensions
            canvas.style.gridTemplateColumns = `repeat(${GRID_CONFIG.COLUMNS}, 1fr)`;
            canvas.style.gridTemplateRows = `repeat(${GRID_CONFIG.ROWS}, 1fr)`;
            
            // Clear existing content
            canvas.innerHTML = '';
            
            // Create grid cells with labels
            for (let row = 0; row < GRID_CONFIG.ROWS; row++) {
                for (let col = 0; col < GRID_CONFIG.COLUMNS; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.col = col;
                    cell.dataset.row = row;
                    cell.textContent = `${col},${row}`;
                    canvas.appendChild(cell);
                }
            }
            
            // Load current widget configuration
            loadGridWidgets();
            
            // Setup event listeners
            setupGridEventListeners();
        }
        
        function loadGridWidgets() {
            gridState.widgets = {};
            gridState.originalPositions = {};
            
            // Dynamically discover all available widget types by scanning DOM for enabled fields
            // This ensures any new widgets added in the future are automatically included
            const widgetTypes = [];
            for (const widgetType of Object.keys(WIDGET_ICONS)) {
                // Check if this widget has form fields
                if (document.getElementById(`${widgetType}Enabled`)) {
                    widgetTypes.push(widgetType);
                }
            }
            
            const palette = document.getElementById('widgetPalette');
            palette.innerHTML = '';
            
            // Get the layout for the current orientation
            const currentLayout = window.smartMirrorLayouts?.[gridState.currentOrientation] || {};
            
            widgetTypes.forEach(type => {
                const enabled = document.getElementById(`${type}Enabled`)?.value === 'true';
                
                // Get position from the current orientation's layout
                let x, y, width, height;
                if (gridState.currentOrientation === 'portrait') {
                    // Use form fields (which contain portrait layout)
                    x = parseInt(document.getElementById(`${type}GridX`)?.value || 0);
                    y = parseInt(document.getElementById(`${type}GridY`)?.value || 0);
                    width = parseInt(document.getElementById(`${type}GridWidth`)?.value || 1);
                    height = parseInt(document.getElementById(`${type}GridHeight`)?.value || 1);
                } else {
                    // Use landscape layout from stored config
                    const layout = currentLayout[type] || { x: 0, y: 0, width: 1, height: 1 };
                    x = layout.x;
                    y = layout.y;
                    width = layout.width;
                    height = layout.height;
                }
                
                gridState.widgets[type] = {
                    type,
                    enabled,
                    x,
                    y,
                    width,
                    height
                };
                
                // Store original positions for reset
                gridState.originalPositions[type] = { x, y, width, height };
                
                // Add to palette
                const paletteItem = document.createElement('div');
                paletteItem.className = `palette-widget ${!enabled ? 'disabled' : ''}`;
                paletteItem.innerHTML = `
                    <div class="palette-widget-icon">${WIDGET_ICONS[type]}</div>
                    <div class="palette-widget-info">
                        <div class="palette-widget-name">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="palette-widget-status">${enabled ? `Position: (${x},${y}) Size: ${width}×${height}` : 'Disabled'}</div>
                    </div>
                `;
                palette.appendChild(paletteItem);
            });
            
            // Render widgets on canvas
            renderGridWidgets();
        }
        
        function renderGridWidgets() {
            const canvas = document.getElementById('gridCanvas');
            if (!canvas) return;
            
            // Remove existing widget elements
            canvas.querySelectorAll('.grid-widget').forEach(el => el.remove());
            
            // Calculate canvas dimensions
            const canvasRect = canvas.getBoundingClientRect();
            const cellWidth = canvasRect.width / GRID_CONFIG.COLUMNS;
            const cellHeight = canvasRect.height / GRID_CONFIG.ROWS;
            
            // Detect overlaps
            const overlaps = detectOverlaps();
            
            // Render each enabled widget
            Object.entries(gridState.widgets).forEach(([type, widget]) => {
                if (!widget.enabled) return;
                
                const widgetEl = document.createElement('div');
                widgetEl.className = 'grid-widget';
                widgetEl.dataset.type = type;
                
                if (gridState.selectedWidget === type) {
                    widgetEl.classList.add('selected');
                }
                
                if (overlaps.includes(type)) {
                    widgetEl.classList.add('overlapping');
                }
                
                // Position and size
                const left = widget.x * cellWidth;
                const top = widget.y * cellHeight;
                const width = widget.width * cellWidth;
                const height = widget.height * cellHeight;
                
                widgetEl.style.left = `${left}px`;
                widgetEl.style.top = `${top}px`;
                widgetEl.style.width = `${width - 10}px`; // Account for gap
                widgetEl.style.height = `${height - 10}px`;
                
                widgetEl.innerHTML = `
                    <div class="widget-icon">${WIDGET_ICONS[type]}</div>
                    <div class="widget-name">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="widget-position">(${widget.x},${widget.y}) ${widget.width}×${widget.height}</div>
                `;
                
                // Add resize handles
                ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                    const handle = document.createElement('div');
                    handle.className = `resize-handle ${pos}`;
                    handle.dataset.handle = pos;
                    widgetEl.appendChild(handle);
                });
                
                canvas.appendChild(widgetEl);
            });
        }
        
        function detectOverlaps() {
            const overlapping = [];
            const enabledWidgets = Object.entries(gridState.widgets)
                .filter(([_, widget]) => widget.enabled);
            
            for (let i = 0; i < enabledWidgets.length; i++) {
                for (let j = i + 1; j < enabledWidgets.length; j++) {
                    const [type1, w1] = enabledWidgets[i];
                    const [type2, w2] = enabledWidgets[j];
                    
                    // Check if rectangles overlap
                    if (w1.x < w2.x + w2.width &&
                        w1.x + w1.width > w2.x &&
                        w1.y < w2.y + w2.height &&
                        w1.y + w1.height > w2.y) {
                        if (!overlapping.includes(type1)) overlapping.push(type1);
                        if (!overlapping.includes(type2)) overlapping.push(type2);
                    }
                }
            }
            
            return overlapping;
        }
        
        function setupGridEventListeners() {
            const canvas = document.getElementById('gridCanvas');
            if (!canvas) return;
            
            // Delegate events for dynamically created widgets
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            
            document.addEventListener('mouseup', handleMouseUp);
            document.addEventListener('touchend', handleTouchEnd);
            
            // Keyboard support
            document.addEventListener('keydown', handleKeyDown);
        }
        
        function handleMouseDown(e) {
            const widget = e.target.closest('.grid-widget');
            if (!widget) {
                gridState.selectedWidget = null;
                renderGridWidgets();
                return;
            }
            
            const type = widget.dataset.type;
            gridState.selectedWidget = type;
            
            // Check if clicking on resize handle
            if (e.target.classList.contains('resize-handle')) {
                gridState.isResizing = true;
                gridState.resizeHandle = e.target.dataset.handle;
                gridState.dragStartX = e.clientX;
                gridState.dragStartY = e.clientY;
                gridState.dragStartPos = { ...gridState.widgets[type] };
                e.preventDefault();
            } else {
                gridState.isDragging = true;
                gridState.draggedWidget = type;
                gridState.dragStartX = e.clientX;
                gridState.dragStartY = e.clientY;
                gridState.dragStartPos = { ...gridState.widgets[type] };
                widget.classList.add('dragging');
            }
            
            renderGridWidgets();
        }
        
        function handleTouchStart(e) {
            if (e.touches.length !== 1) return;
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY,
                bubbles: true
            });
            e.target.dispatchEvent(mouseEvent);
            e.preventDefault();
        }
        
        function handleMouseMove(e) {
            if (!gridState.isDragging && !gridState.isResizing) return;
            
            const canvas = document.getElementById('gridCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const cellWidth = canvasRect.width / 4;
            const cellHeight = canvasRect.height / 3;
            
            const deltaX = e.clientX - gridState.dragStartX;
            const deltaY = e.clientY - gridState.dragStartY;
            
            if (gridState.isDragging) {
                const type = gridState.draggedWidget;
                const widget = gridState.widgets[type];
                
                // Calculate new grid position
                const cellsMovedX = Math.round(deltaX / cellWidth);
                const cellsMovedY = Math.round(deltaY / cellHeight);
                
                let newX = gridState.dragStartPos.x + cellsMovedX;
                let newY = gridState.dragStartPos.y + cellsMovedY;
                
                // Constrain to grid bounds
                newX = Math.max(0, Math.min(GRID_CONFIG.COLUMNS - widget.width, newX));
                newY = Math.max(0, Math.min(GRID_CONFIG.ROWS - widget.height, newY));
                
                if (newX !== widget.x || newY !== widget.y) {
                    widget.x = newX;
                    widget.y = newY;
                    renderGridWidgets();
                    updatePaletteStatus(type);
                }
            } else if (gridState.isResizing) {
                const type = gridState.selectedWidget;
                const widget = gridState.widgets[type];
                const handle = gridState.resizeHandle;
                
                const cellsMovedX = Math.round(deltaX / cellWidth);
                const cellsMovedY = Math.round(deltaY / cellHeight);
                
                let newX = gridState.dragStartPos.x;
                let newY = gridState.dragStartPos.y;
                let newWidth = gridState.dragStartPos.width;
                let newHeight = gridState.dragStartPos.height;
                
                // Adjust based on which handle is being dragged
                if (handle.includes('e')) {
                    newWidth = Math.max(1, gridState.dragStartPos.width + cellsMovedX);
                }
                if (handle.includes('w')) {
                    const widthChange = -cellsMovedX;
                    newWidth = Math.max(1, gridState.dragStartPos.width + widthChange);
                    if (newWidth !== widget.width) {
                        newX = gridState.dragStartPos.x - (newWidth - gridState.dragStartPos.width);
                    }
                }
                if (handle.includes('s')) {
                    newHeight = Math.max(1, gridState.dragStartPos.height + cellsMovedY);
                }
                if (handle.includes('n')) {
                    const heightChange = -cellsMovedY;
                    newHeight = Math.max(1, gridState.dragStartPos.height + heightChange);
                    if (newHeight !== widget.height) {
                        newY = gridState.dragStartPos.y - (newHeight - gridState.dragStartPos.height);
                    }
                }
                
                // Constrain to grid bounds
                newX = Math.max(0, newX);
                newY = Math.max(0, newY);
                newWidth = Math.min(GRID_CONFIG.MAX_WIDTH, newWidth);
                newHeight = Math.min(GRID_CONFIG.MAX_HEIGHT, newHeight);
                
                // Ensure widget doesn't go out of bounds
                if (newX + newWidth > GRID_CONFIG.COLUMNS) newWidth = GRID_CONFIG.COLUMNS - newX;
                if (newY + newHeight > GRID_CONFIG.ROWS) newHeight = GRID_CONFIG.ROWS - newY;
                
                if (newX !== widget.x || newY !== widget.y || 
                    newWidth !== widget.width || newHeight !== widget.height) {
                    widget.x = newX;
                    widget.y = newY;
                    widget.width = newWidth;
                    widget.height = newHeight;
                    renderGridWidgets();
                    updatePaletteStatus(type);
                }
            }
        }
        
        function handleTouchMove(e) {
            if (e.touches.length !== 1) return;
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY,
                bubbles: true
            });
            document.dispatchEvent(mouseEvent);
            e.preventDefault();
        }
        
        function handleMouseUp(e) {
            if (gridState.isDragging) {
                const widget = document.querySelector(`.grid-widget[data-type="${gridState.draggedWidget}"]`);
                if (widget) widget.classList.remove('dragging');
            }
            
            gridState.isDragging = false;
            gridState.isResizing = false;
            gridState.draggedWidget = null;
            gridState.resizeHandle = null;
        }
        
        function handleTouchEnd(e) {
            const mouseEvent = new MouseEvent('mouseup', {
                bubbles: true
            });
            document.dispatchEvent(mouseEvent);
        }
        
        function handleKeyDown(e) {
            if (!gridState.selectedWidget) return;
            
            const widget = gridState.widgets[gridState.selectedWidget];
            if (!widget || !widget.enabled) return;
            
            let moved = false;
            
            // Arrow keys for movement
            if (e.key === 'ArrowLeft' && widget.x > 0) {
                widget.x--;
                moved = true;
            } else if (e.key === 'ArrowRight' && widget.x + widget.width < GRID_CONFIG.COLUMNS) {
                widget.x++;
                moved = true;
            } else if (e.key === 'ArrowUp' && widget.y > 0) {
                widget.y--;
                moved = true;
            } else if (e.key === 'ArrowDown' && widget.y + widget.height < GRID_CONFIG.ROWS) {
                widget.y++;
                moved = true;
            }
            
            // Shift + Arrow keys for resizing
            else if (e.shiftKey && e.key === 'ArrowRight' && widget.x + widget.width < GRID_CONFIG.COLUMNS) {
                widget.width++;
                moved = true;
            } else if (e.shiftKey && e.key === 'ArrowLeft' && widget.width > 1) {
                widget.width--;
                moved = true;
            } else if (e.shiftKey && e.key === 'ArrowDown' && widget.y + widget.height < GRID_CONFIG.ROWS) {
                widget.height++;
                moved = true;
            } else if (e.shiftKey && e.key === 'ArrowUp' && widget.height > 1) {
                widget.height--;
                moved = true;
            }
            
            if (moved) {
                e.preventDefault();
                renderGridWidgets();
                updatePaletteStatus(gridState.selectedWidget);
            }
        }
        
        function updatePaletteStatus(type) {
            const widget = gridState.widgets[type];
            const palette = document.getElementById('widgetPalette');
            const items = palette.querySelectorAll('.palette-widget');
            
            items.forEach(item => {
                const name = item.querySelector('.palette-widget-name').textContent.toLowerCase();
                if (name === type) {
                    const status = item.querySelector('.palette-widget-status');
                    if (widget.enabled) {
                        status.textContent = `Position: (${widget.x},${widget.y}) Size: ${widget.width}×${widget.height}`;
                    }
                }
            });
        }
        
        function resetGridLayout() {
            if (!confirm('Reset all widgets to their original positions? This will undo any changes made in the grid editor.')) {
                return;
            }
            
            // Restore original positions
            Object.entries(gridState.originalPositions).forEach(([type, pos]) => {
                if (gridState.widgets[type]) {
                    gridState.widgets[type].x = pos.x;
                    gridState.widgets[type].y = pos.y;
                    gridState.widgets[type].width = pos.width;
                    gridState.widgets[type].height = pos.height;
                }
            });
            
            renderGridWidgets();
            
            // Update palette
            Object.keys(gridState.widgets).forEach(type => {
                updatePaletteStatus(type);
            });
            
            showSmartMirrorAlert('Grid layout reset to original configuration', 'success');
        }
        
        function applyGridChanges() {
            // Save changes to the appropriate layout
            if (gridState.currentOrientation === 'portrait') {
                // Update form inputs (which store portrait layout)
                Object.entries(gridState.widgets).forEach(([type, widget]) => {
                    const xInput = document.getElementById(`${type}GridX`);
                    const yInput = document.getElementById(`${type}GridY`);
                    const widthInput = document.getElementById(`${type}GridWidth`);
                    const heightInput = document.getElementById(`${type}GridHeight`);
                    
                    if (xInput) xInput.value = widget.x;
                    if (yInput) yInput.value = widget.y;
                    if (widthInput) widthInput.value = widget.width;
                    if (heightInput) heightInput.value = widget.height;
                });
            } else {
                // Update landscape layout in stored layouts
                if (!window.smartMirrorLayouts) {
                    window.smartMirrorLayouts = { portrait: {}, landscape: {} };
                }
                Object.entries(gridState.widgets).forEach(([type, widget]) => {
                    window.smartMirrorLayouts.landscape[type] = {
                        x: widget.x,
                        y: widget.y,
                        width: widget.width,
                        height: widget.height
                    };
                });
            }
            
            // Update original positions to current state
            Object.entries(gridState.widgets).forEach(([type, widget]) => {
                gridState.originalPositions[type] = {
                    x: widget.x,
                    y: widget.y,
                    width: widget.width,
                    height: widget.height
                };
            });
            
            // Check for overlaps
            const overlaps = detectOverlaps();
            if (overlaps.length > 0) {
                showSmartMirrorAlert(
                    `Warning: The following widgets are overlapping: ${overlaps.join(', ')}. ` +
                    'This may cause display issues on the dashboard.',
                    'error'
                );
            } else {
                showSmartMirrorAlert('Grid changes applied to form! Click "Save Smart Mirror Configuration" to persist changes.', 'success');
            }
        }
        
        // Finance Module Functions
        let financeChart = null;
        let accountTypes = {};
        
        // Category colors used across all finance charts
        const FINANCE_CATEGORY_COLORS = {
            cash: '#28a745',
            investments: '#007bff',
            retirement: '#ffc107',
            real_estate: '#17a2b8',
            future_income: '#6f42c1',
            liabilities: '#dc3545'
        };
        
        async function initializeFinance() {
            try {
                // Load account types
                const typesResponse = await fetch('/admin/api/finance/account-types');
                accountTypes = await typesResponse.json();
                
                // Populate account type dropdown
                const accountTypeSelect = document.getElementById('accountType');
                accountTypeSelect.innerHTML = '<option value="">Select type...</option>';
                
                Object.keys(accountTypes).forEach(key => {
                    const type = accountTypes[key];
                    accountTypeSelect.innerHTML += `<option value="${key}">${type.name}</option>`;
                });
                
                // Add balance update form event listener
                document.getElementById('balanceUpdateForm').addEventListener('submit', updateAccountBalance);
            } catch (err) {
                console.error('Failed to initialize finance:', err);
            }
        }
        
        function updateAccountTypeHelp() {
            const accountType = document.getElementById('accountType').value;
            const helpDiv = document.getElementById('accountTypeHelp');
            const futureFields = document.getElementById('futureIncomeFields');
            const mortgageFields = document.getElementById('mortgagePropertyFields');
            
            if (accountType && accountTypes[accountType]) {
                const type = accountTypes[accountType];
                helpDiv.innerHTML = `<strong>${type.name}:</strong> ${type.description}`;
                helpDiv.style.display = 'block';
                helpDiv.className = 'alert';
                
                // Show/hide future income fields
                if (type.category === 'future_income') {
                    futureFields.style.display = 'block';
                } else {
                    futureFields.style.display = 'none';
                }
                
                // Show/hide mortgage property link fields
                if (type.requiresPropertyLink) {
                    mortgageFields.style.display = 'block';
                    loadPropertyOptions();
                } else {
                    mortgageFields.style.display = 'none';
                }
            } else {
                helpDiv.style.display = 'none';
                futureFields.style.display = 'none';
                mortgageFields.style.display = 'none';
            }
        }
        
        async function loadPropertyOptions() {
            try {
                const response = await fetch('/admin/api/finance/accounts');
                const accounts = await response.json();
                
                const propertySelect = document.getElementById('linkedProperty');
                propertySelect.innerHTML = '<option value="">Select property...</option>';
                
                // Filter for real estate accounts
                const properties = accounts.filter(acc => {
                    const type = accountTypes[acc.type];
                    return type && type.category === 'real_estate';
                });
                
                properties.forEach(property => {
                    const type = accountTypes[property.type];
                    propertySelect.innerHTML += `<option value="${property.id}">${property.name} (${type.name})</option>`;
                });
                
                if (properties.length === 0) {
                    propertySelect.innerHTML += '<option value="" disabled>No properties found - add a property first</option>';
                }
            } catch (err) {
                console.error('Failed to load property options:', err);
            }
        }
        
        async function loadFinanceData() {
            await loadDemographics();
            await loadAccounts();
            await updateChart();
        }
        
        async function loadDemographics() {
            try {
                const response = await fetch('/admin/api/finance/demographics');
                const demographics = await response.json();
                
                document.getElementById('userAge').value = demographics.age || '';
                document.getElementById('retirementAge').value = demographics.retirementAge || 65;
                document.getElementById('annualIncome').value = demographics.annualIncome || '';
                document.getElementById('riskTolerance').value = demographics.riskTolerance || 'moderate';
                document.getElementById('retirementYear').value = demographics.retirementYear || '';
                document.getElementById('annualRetirementSpending').value = demographics.annualRetirementSpending || '';
            } catch (err) {
                console.error('Failed to load demographics:', err);
            }
        }
        
        async function saveDemographics() {
            try {
                const demographics = {
                    age: parseInt(document.getElementById('userAge').value) || null,
                    retirementAge: parseInt(document.getElementById('retirementAge').value) || 65,
                    annualIncome: parseFloat(document.getElementById('annualIncome').value) || null,
                    riskTolerance: document.getElementById('riskTolerance').value,
                    retirementYear: parseInt(document.getElementById('retirementYear').value) || null,
                    annualRetirementSpending: parseFloat(document.getElementById('annualRetirementSpending').value) || null
                };
                
                const response = await fetch('/admin/api/finance/demographics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(demographics)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('Profile saved successfully!', 'success');
                } else {
                    showAlert('Error saving profile: ' + result.error, 'error');
                }
            } catch (err) {
                showAlert('Failed to save profile: ' + err.message, 'error');
            }
        }
        
        async function evaluateRetirement() {
            try {
                const response = await fetch('/admin/api/finance/retirement-evaluation');
                const result = await response.json();
                
                const evalSection = document.getElementById('retirementEvaluation');
                const resultDiv = document.getElementById('retirementResult');
                const detailsDiv = document.getElementById('retirementDetails');
                
                if (!result.success) {
                    resultDiv.className = 'alert alert-error';
                    resultDiv.textContent = result.error;
                    evalSection.style.display = 'block';
                    detailsDiv.innerHTML = '';
                    return;
                }
                
                // Display result with appropriate styling based on status
                let alertClass = 'alert-info';
                let icon = '📊';
                
                if (result.status === 'excellent') {
                    alertClass = 'alert-success';
                    icon = '✅';
                } else if (result.status === 'good') {
                    alertClass = 'alert-success';
                    icon = '✅';
                } else if (result.status === 'concerning') {
                    alertClass = 'alert-warning';
                    icon = '⚠️';
                } else if (result.status === 'critical') {
                    alertClass = 'alert-error';
                    icon = '🚨';
                }
                
                resultDiv.className = 'alert ' + alertClass;
                resultDiv.innerHTML = `
                    <h4 style="margin-top: 0;">${icon} Retirement Plan Success Probability: ${result.successProbability}%</h4>
                    <p><strong>${result.recommendation}</strong></p>
                `;
                
                // Display detailed information
                detailsDiv.innerHTML = `
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #007bff;">
                        <h4 style="margin-top: 0; color: #007bff;">📖 Analysis Details</h4>
                        
                        <div style="margin: 1rem 0;">
                            <h5>Current Situation</h5>
                            <ul style="margin: 0.5rem 0;">
                                <li>Current Age: ${result.assumptions.currentAge}</li>
                                <li>Retirement Age: ${result.assumptions.retirementAge}</li>
                                <li>Years Until Retirement: ${result.assumptions.yearsUntilRetirement}</li>
                                <li>Current Total Assets: $${result.assumptions.currentAssets.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</li>
                                <li>Annual Contribution (15% of income): $${result.assumptions.annualContribution.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</li>
                            </ul>
                        </div>
                        
                        <div style="margin: 1rem 0;">
                            <h5>Projections</h5>
                            <ul style="margin: 0.5rem 0;">
                                <li>Projected Portfolio at Retirement: $${result.projections.projectedPortfolioAtRetirement.toLocaleString('en-US')}</li>
                                <li>Total Needed for ${result.assumptions.yearsInRetirement} Years: $${result.projections.totalNeededForRetirement.toLocaleString('en-US')}</li>
                                ${result.projections.shortfall > 0 ? `<li style="color: #d9534f;">Projected Shortfall: $${result.projections.shortfall.toLocaleString('en-US')}</li>` : '<li style="color: #5cb85c;">✅ Projected to meet retirement goals</li>'}
                                ${result.projections.futureIncomeValue > 0 ? `<li>Future Income Value (Pension/SS): $${result.projections.futureIncomeValue.toLocaleString('en-US')}</li>` : ''}
                            </ul>
                        </div>
                        
                        <div style="margin: 1rem 0;">
                            <h5>Assumptions & Methodology</h5>
                            <ul style="margin: 0.5rem 0;">
                                <li>Expected Annual Return: ${result.assumptions.expectedReturn}</li>
                                <li>Return Volatility (Std Dev): ${result.assumptions.returnVolatility}</li>
                                <li>Inflation Rate: ${result.assumptions.inflationRate}</li>
                                <li>Annual Retirement Spending: $${result.assumptions.annualRetirementSpending.toLocaleString('en-US')}</li>
                                <li>Years in Retirement: ${result.assumptions.yearsInRetirement}</li>
                                ${result.assumptions.hasHistoricalGrowthData ? '<li>✅ Using historical growth data from your accounts (3+ months)</li>' : '<li>ℹ️ Using standard assumptions (add 3+ months of balance history for personalized projections)</li>'}
                            </ul>
                        </div>
                        
                        <div style="background: #fff; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            <h5 style="margin-top: 0;">📊 Methodology</h5>
                            <p style="margin-bottom: 0;">${result.methodology}</p>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                                This analysis uses Monte Carlo simulation, a standard financial planning technique that runs thousands of scenarios 
                                with varying market returns to estimate the probability of success. The simulation accounts for market volatility, 
                                inflation, and your specific financial situation. Results are based on historical market data and mathematical models, 
                                but past performance doesn't guarantee future results.
                            </p>
                        </div>
                        
                        <div style="background: #e7f3ff; padding: 1rem; border-radius: 6px; margin-top: 1rem; border-left: 4px solid #2196F3;">
                            <h5 style="margin-top: 0; color: #1976D2;">💡 How to Improve Your Plan</h5>
                            <ul style="margin: 0.5rem 0;">
                                ${result.successProbability < 80 ? '<li>Increase your annual savings rate (currently assumes 15% of income)</li>' : ''}
                                ${result.successProbability < 80 ? '<li>Consider delaying retirement by a few years</li>' : ''}
                                ${result.successProbability < 80 ? '<li>Review and potentially reduce planned retirement spending</li>' : ''}
                                <li>Rebalance your portfolio according to allocation recommendations above</li>
                                <li>Track account balances monthly to get personalized growth projections</li>
                                <li>Review this plan annually or when your financial situation changes</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                evalSection.style.display = 'block';
                
            } catch (err) {
                const resultDiv = document.getElementById('retirementResult');
                resultDiv.className = 'alert alert-error';
                resultDiv.textContent = 'Failed to evaluate retirement plan: ' + err.message;
                document.getElementById('retirementEvaluation').style.display = 'block';
            }
        }
        
        async function loadAccounts() {
            try {
                const response = await fetch('/admin/api/finance/accounts');
                const accounts = await response.json();
                
                const accountsList = document.getElementById('accountsList');
                
                if (accounts.length === 0) {
                    accountsList.innerHTML = '<p style="color: #666;">No accounts added yet</p>';
                    return;
                }
                
                accountsList.innerHTML = accounts.map(account => {
                    const type = accountTypes[account.type] || { name: account.type, category: 'other' };
                    const isFutureIncome = type.category === 'future_income';
                    const isMortgage = type.requiresPropertyLink;
                    
                    // Get display name (prefer displayName, fallback to name)
                    const displayName = account.displayName || account.name;
                    const showOriginalName = account.displayName && account.displayName !== account.name;
                    
                    // Find linked property if applicable
                    let linkedPropertyName = '';
                    if (isMortgage && account.linkedProperty) {
                        const linkedProp = accounts.find(a => a.id === account.linkedProperty);
                        if (linkedProp) {
                            linkedPropertyName = linkedProp.displayName || linkedProp.name;
                        }
                    }
                    
                    return `
                        <div class="account-card">
                            <div class="account-card-header">
                                <div class="account-name">${escapeHtml(displayName)}</div>
                                <div class="account-type-badge">${type.name}</div>
                            </div>
                            ${showOriginalName ? `<div style="color: #888; font-size: 0.85rem; margin-top: -0.5rem; margin-bottom: 0.5rem;">Original: ${escapeHtml(account.name)}</div>` : ''}
                            <div class="account-value">$${parseFloat(account.currentValue || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                            ${isFutureIncome && account.monthlyPayment ? `
                                <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    Monthly: $${parseFloat(account.monthlyPayment).toLocaleString()} starting at age ${account.startAge}
                                </div>
                            ` : ''}
                            ${isMortgage && linkedPropertyName ? `
                                <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    🏠 Linked to: ${escapeHtml(linkedPropertyName)}
                                </div>
                            ` : ''}
                            ${account.notes ? `<div style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">${escapeHtml(account.notes)}</div>` : ''}
                            <div class="account-details">
                                ${account.startDate ? `
                                    <div class="account-detail">
                                        <span class="account-detail-label">Started:</span> ${new Date(account.startDate).toLocaleDateString()}
                                    </div>
                                ` : ''}
                                <div class="account-detail">
                                    <span class="account-detail-label">Updated:</span> ${new Date(account.updatedAt).toLocaleDateString()}
                                </div>
                            </div>
                            <div class="account-actions">
                                <button class="btn" onclick="editAccount('${account.id}')">Edit</button>
                                <button class="btn" style="background: #17a2b8;" onclick="showEditDisplayNameModal('${account.id}', '${escapeHtml(displayName)}', '${escapeHtml(account.name)}')">Edit Display Name</button>
                                <button class="btn" style="background: #28a745;" onclick="showUpdateBalanceModal('${account.id}', '${escapeHtml(displayName)}', ${account.currentValue || 0})">Update Balance</button>
                                <button class="btn" style="background: #dc3545;" onclick="deleteAccount('${account.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Failed to load accounts:', err);
            }
        }
        
        async function saveAccount() {
            try {
                const accountType = document.getElementById('accountType').value;
                const type = accountTypes[accountType];
                
                if (!accountType) {
                    showAlert('Please select an account type', 'error');
                    return;
                }
                
                const account = {
                    id: document.getElementById('accountId').value || undefined,
                    name: document.getElementById('accountName').value,
                    type: accountType,
                    currentValue: parseFloat(document.getElementById('accountValue').value) || 0,
                    startDate: document.getElementById('accountStartDate').value || null,
                    notes: document.getElementById('accountNotes').value || null
                };
                
                // Add future income specific fields
                if (type && type.category === 'future_income') {
                    account.monthlyPayment = parseFloat(document.getElementById('monthlyPayment').value) || 0;
                    account.startAge = parseInt(document.getElementById('startAge').value) || null;
                }
                
                // Add mortgage property link field
                if (type && type.requiresPropertyLink) {
                    account.linkedProperty = document.getElementById('linkedProperty').value || null;
                }
                
                if (!account.name) {
                    showAlert('Please enter an account name', 'error');
                    return;
                }
                
                const response = await fetch('/admin/api/finance/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(account)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('Account saved successfully!', 'success');
                    clearAccountForm();
                    await loadAccounts();
                    await updateChart();
                } else {
                    showAlert('Error saving account: ' + result.error, 'error');
                }
            } catch (err) {
                showAlert('Failed to save account: ' + err.message, 'error');
            }
        }
        
        async function editAccount(accountId) {
            try {
                const response = await fetch('/admin/api/finance/accounts');
                const accounts = await response.json();
                const account = accounts.find(a => a.id === accountId);
                
                if (!account) {
                    showAlert('Account not found', 'error');
                    return;
                }
                
                document.getElementById('accountId').value = account.id;
                document.getElementById('accountName').value = account.name;
                document.getElementById('accountType').value = account.type;
                document.getElementById('accountValue').value = account.currentValue;
                document.getElementById('accountStartDate').value = account.startDate || '';
                document.getElementById('accountNotes').value = account.notes || '';
                
                updateAccountTypeHelp();
                
                // Set future income fields if applicable
                const type = accountTypes[account.type];
                if (type && type.category === 'future_income') {
                    document.getElementById('monthlyPayment').value = account.monthlyPayment || '';
                    document.getElementById('startAge').value = account.startAge || '';
                }
                
                // Set mortgage property link field if applicable
                if (type && type.requiresPropertyLink) {
                    document.getElementById('linkedProperty').value = account.linkedProperty || '';
                }
                
                // Scroll to form
                document.getElementById('accountName').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (err) {
                showAlert('Failed to load account: ' + err.message, 'error');
            }
        }
        
        async function deleteAccount(accountId) {
            if (!confirm('Are you sure you want to delete this account?')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/finance/accounts/${accountId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('Account deleted successfully!', 'success');
                    await loadAccounts();
                    await updateChart();
                } else {
                    showAlert('Error deleting account: ' + result.error, 'error');
                }
            } catch (err) {
                showAlert('Failed to delete account: ' + err.message, 'error');
            }
        }
        
        function showUpdateBalanceModal(accountId, accountName, currentValue) {
            document.getElementById('balanceAccountId').value = accountId;
            document.getElementById('balanceAccountName').value = accountName;
            document.getElementById('balanceCurrentValue').value = '$' + parseFloat(currentValue).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('balanceNewValue').value = '';
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('balanceDate').value = today;
            
            // Show modal
            document.getElementById('balanceUpdateModal').style.display = 'flex';
            
            // Hide alert
            const alert = document.getElementById('balanceUpdateAlert');
            alert.style.display = 'none';
        }
        
        function closeBalanceUpdateModal() {
            document.getElementById('balanceUpdateModal').style.display = 'none';
            document.getElementById('balanceUpdateForm').reset();
        }
        
        async function updateAccountBalance(event) {
            event.preventDefault();
            
            const accountId = document.getElementById('balanceAccountId').value;
            const newBalance = parseFloat(document.getElementById('balanceNewValue').value);
            const balanceDate = document.getElementById('balanceDate').value;
            
            if (!newBalance && newBalance !== 0) {
                const alert = document.getElementById('balanceUpdateAlert');
                alert.textContent = 'Please enter a valid balance';
                alert.className = 'alert alert-error';
                alert.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/finance/accounts/${accountId}/balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        balance: newBalance,
                        balanceDate: balanceDate
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    closeBalanceUpdateModal();
                    showAlert('Balance updated successfully!', 'success');
                    await loadAccounts();
                    await updateChart();
                } else {
                    const alert = document.getElementById('balanceUpdateAlert');
                    alert.textContent = 'Error: ' + result.error;
                    alert.className = 'alert alert-error';
                    alert.style.display = 'block';
                }
            } catch (err) {
                const alert = document.getElementById('balanceUpdateAlert');
                alert.textContent = 'Failed to update balance: ' + err.message;
                alert.className = 'alert alert-error';
                alert.style.display = 'block';
            }
        }
        
        function showEditDisplayNameModal(accountId, currentDisplayName, originalName) {
            document.getElementById('displayNameAccountId').value = accountId;
            document.getElementById('displayNameOriginalName').textContent = originalName;
            document.getElementById('displayNameInput').value = currentDisplayName;
            
            // Show modal
            document.getElementById('displayNameModal').style.display = 'flex';
            
            // Hide alert
            const alert = document.getElementById('displayNameAlert');
            alert.style.display = 'none';
        }
        
        function closeDisplayNameModal() {
            document.getElementById('displayNameModal').style.display = 'none';
            document.getElementById('displayNameForm').reset();
        }
        
        async function updateDisplayName(event) {
            event.preventDefault();
            
            const accountId = document.getElementById('displayNameAccountId').value;
            const displayName = document.getElementById('displayNameInput').value.trim();
            
            try {
                const response = await fetch(`/admin/api/finance/accounts/${accountId}/display-name`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        displayName: displayName
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    closeDisplayNameModal();
                    showAlert('Display name updated successfully!', 'success');
                    await loadAccounts();
                    await updateChart();
                } else {
                    const alert = document.getElementById('displayNameAlert');
                    alert.textContent = 'Error: ' + result.error;
                    alert.className = 'alert alert-error';
                    alert.style.display = 'block';
                }
            } catch (err) {
                const alert = document.getElementById('displayNameAlert');
                alert.textContent = 'Failed to update display name: ' + err.message;
                alert.className = 'alert alert-error';
                alert.style.display = 'block';
            }
        }
        
        function clearAccountForm() {
            document.getElementById('accountId').value = '';
            document.getElementById('accountName').value = '';
            document.getElementById('accountType').value = '';
            document.getElementById('accountValue').value = '';
            document.getElementById('accountStartDate').value = '';
            document.getElementById('accountNotes').value = '';
            document.getElementById('monthlyPayment').value = '';
            document.getElementById('startAge').value = '';
            document.getElementById('linkedProperty').value = '';
            updateAccountTypeHelp();
        }
        
        async function uploadAccountScreenshot() {
            const fileInput = document.getElementById('screenshotFile');
            const statusDiv = document.getElementById('screenshotUploadStatus');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.className = 'alert alert-error';
                statusDiv.textContent = 'Please select a screenshot file first';
                statusDiv.style.display = 'block';
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                statusDiv.className = 'alert alert-error';
                statusDiv.textContent = 'File is too large. Maximum size is 10MB.';
                statusDiv.style.display = 'block';
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                statusDiv.className = 'alert alert-error';
                statusDiv.textContent = 'Please upload an image file (JPG, PNG, WebP, etc.)';
                statusDiv.style.display = 'block';
                return;
            }
            
            // Show processing status
            statusDiv.className = 'alert alert-info';
            statusDiv.innerHTML = '⏳ Processing screenshot... This may take 30-60 seconds.<br><small>Extracting text and updating accounts...</small>';
            statusDiv.style.display = 'block';
            
            try {
                const formData = new FormData();
                formData.append('screenshot', file);
                
                const response = await fetch('/admin/api/finance/upload-screenshot', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'alert alert-success';
                    statusDiv.innerHTML = `
                        ✅ <strong>Screenshot processed successfully!</strong><br>
                        <ul style="margin: 0.5rem 0 0 1.5rem; text-align: left;">
                            <li><strong>${result.accountsCreated}</strong> new account(s) created</li>
                            <li><strong>${result.accountsUpdated}</strong> account(s) updated</li>
                            <li><strong>${result.totalAccounts}</strong> total accounts processed</li>
                            ${result.netWorth ? `<li>Net Worth: <strong>$${result.netWorth.toLocaleString('en-US', { minimumFractionDigits: 2 })}</strong></li>` : ''}
                        </ul>
                    `;
                    
                    // Clear the file input
                    fileInput.value = '';
                    
                    // Reload accounts and chart
                    await loadAccounts();
                    await updateChart();
                    
                    // Show general success alert
                    showAlert('Account balances updated from screenshot!', 'success');
                } else {
                    statusDiv.className = 'alert alert-error';
                    statusDiv.innerHTML = `❌ <strong>Processing failed:</strong><br>${result.error}`;
                }
            } catch (err) {
                console.error('Upload error:', err);
                statusDiv.className = 'alert alert-error';
                statusDiv.innerHTML = `❌ <strong>Upload failed:</strong><br>${err.message}`;
            }
        }
        
        async function loadRecommendations() {
            try {
                const response = await fetch('/admin/api/finance/recommendations');
                const data = await response.json();
                
                const container = document.getElementById('recommendationsContainer');
                
                if (data.accountCount === 0) {
                    container.innerHTML = '<p style="color: #666;">Add some accounts first to get recommendations</p>';
                    return;
                }
                
                let html = `
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <strong>Total Assets:</strong> 
                                <span style="font-size: 1.5rem; color: #28a745; font-weight: 700;">
                                    $${parseFloat(data.totalAssets || data.totalValue).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                </span>
                            </div>
                            ${data.totalLiabilities > 0 ? `
                            <div>
                                <strong>Total Liabilities:</strong> 
                                <span style="font-size: 1.5rem; color: #dc3545; font-weight: 700;">
                                    $${parseFloat(data.totalLiabilities).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                </span>
                            </div>
                            <div>
                                <strong>Net Worth:</strong> 
                                <span style="font-size: 1.5rem; color: ${data.netWorth >= 0 ? '#28a745' : '#dc3545'}; font-weight: 700;">
                                    $${parseFloat(data.netWorth).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                </span>
                            </div>
                            ` : ''}
                            <div>
                                <strong>Accounts:</strong> ${data.accountCount}
                            </div>
                        </div>
                    </div>
                `;
                
                if (data.recommendations.length > 0) {
                    html += '<h4 style="margin-bottom: 0.75rem;">📋 Action Items:</h4>';
                    data.recommendations.forEach(rec => {
                        html += `
                            <div class="recommendation-card">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">${rec.category.replace('_', ' ').toUpperCase()}</div>
                                <div>${rec.message}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                                    Current: ${rec.current}% → Recommended: ${rec.recommended}%
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="recommendation-card" style="background: #d4edda; border-left-color: #28a745;">✅ Your portfolio allocation looks good!</div>';
                }
                
                html += '<h4 style="margin-top: 1.5rem; margin-bottom: 0.75rem;">📊 Allocation Breakdown:</h4>';
                html += '<div class="allocation-comparison">';
                
                Object.keys(data.currentAllocation).forEach(category => {
                    const current = data.currentAllocation[category];
                    const recommended = data.recommendedAllocation[category];
                    
                    html += `
                        <div class="allocation-item">
                            <div class="allocation-category">${category.replace('_', ' ')}</div>
                            <div class="allocation-values">
                                <div class="allocation-value">
                                    <div class="allocation-label">Current</div>
                                    <div class="allocation-percent current">${current}%</div>
                                </div>
                                <div class="allocation-value">
                                    <div class="allocation-label">Target</div>
                                    <div class="allocation-percent recommended">${recommended}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Add detailed explanation if available
                if (data.explanation) {
                    html += data.explanation;
                }
                
                container.innerHTML = html;
            } catch (err) {
                showAlert('Failed to load recommendations: ' + err.message, 'error');
            }
        }
        
        async function updateChart() {
            try {
                // Check if Chart.js is available
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not available - skipping chart rendering');
                    return;
                }
                
                const response = await fetch('/admin/api/finance/accounts');
                const accounts = await response.json();
                
                if (accounts.length === 0) {
                    if (financeChart) {
                        financeChart.destroy();
                        financeChart = null;
                    }
                    return;
                }
                
                // Group by category
                const categoryData = {};
                
                accounts.forEach(account => {
                    const type = accountTypes[account.type];
                    if (type) {
                        const category = type.category;
                        if (!categoryData[category]) {
                            categoryData[category] = 0;
                        }
                        categoryData[category] += parseFloat(account.currentValue || 0);
                    }
                });
                
                const labels = Object.keys(categoryData).map(cat => cat.replace('_', ' ').toUpperCase());
                const data = Object.values(categoryData);
                const colors = Object.keys(categoryData).map(cat => FINANCE_CATEGORY_COLORS[cat] || '#6c757d');
                
                const chartType = document.querySelector('input[name="chartType"]:checked').value;
                
                const ctx = document.getElementById('financeChart').getContext('2d');
                
                if (financeChart) {
                    financeChart.destroy();
                }
                
                financeChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Portfolio Value ($)',
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: chartType === 'bar',
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed || context.parsed.y;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return ` $${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: chartType === 'bar' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        } : {}
                    }
                });
                
                // Update legend
                const legendDiv = document.getElementById('chartLegend');
                legendDiv.innerHTML = labels.map((label, i) => `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${colors[i]}"></div>
                        <div class="legend-label">${label}: $${data[i].toLocaleString()}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to update chart:', err);
            }
        }
        
        // Demo Finance Functions
        let demoFinanceChart = null;
        
        async function loadDemoFinanceData() {
            await loadDemoDemographics();
            await loadDemoAccounts();
            await updateDemoChart();
        }
        
        async function loadDemoDemographics() {
            try {
                const response = await fetch('/admin/api/finance/demo/demographics');
                const demographics = await response.json();
                
                document.getElementById('demoUserAge').value = demographics.age || '';
                document.getElementById('demoRetirementAge').value = demographics.retirementAge || 65;
                document.getElementById('demoAnnualIncome').value = demographics.annualIncome || '';
                document.getElementById('demoRiskTolerance').value = (demographics.riskTolerance || 'moderate').charAt(0).toUpperCase() + (demographics.riskTolerance || 'moderate').slice(1);
                document.getElementById('demoRetirementYear').value = demographics.retirementYear || '';
                document.getElementById('demoAnnualRetirementSpending').value = demographics.annualRetirementSpending || '';
            } catch (err) {
                console.error('Failed to load demo demographics:', err);
            }
        }
        
        async function loadDemoAccounts() {
            try {
                const response = await fetch('/admin/api/finance/demo/accounts');
                const accounts = await response.json();
                
                const accountsList = document.getElementById('demoAccountsList');
                
                if (accounts.length === 0) {
                    accountsList.innerHTML = '<p style="color: #666;">No demo accounts available</p>';
                    return;
                }
                
                accountsList.innerHTML = accounts.map(account => {
                    const type = accountTypes[account.type] || { name: account.type, category: 'other' };
                    const isFutureIncome = type.category === 'future_income';
                    
                    return `
                        <div class="account-card" style="position: relative;">
                            <div style="position: absolute; top: 10px; right: 10px; background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                DEMO
                            </div>
                            <div class="account-card-header">
                                <div class="account-name">${escapeHtml(account.name)}</div>
                                <div class="account-type-badge">${type.name}</div>
                            </div>
                            <div class="account-value">$${parseFloat(account.currentValue || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                            ${isFutureIncome && account.monthlyPayment ? `
                                <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    Monthly: $${parseFloat(account.monthlyPayment).toLocaleString()} starting at age ${account.startAge}
                                </div>
                            ` : ''}
                            ${account.notes ? `<div style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">${escapeHtml(account.notes)}</div>` : ''}
                            <div class="account-details">
                                ${account.startDate ? `
                                    <div class="account-detail">
                                        <span class="account-detail-label">Started:</span> ${new Date(account.startDate).toLocaleDateString()}
                                    </div>
                                ` : ''}
                                <div class="account-detail">
                                    <span class="account-detail-label">Updated:</span> ${new Date(account.updatedAt).toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Failed to load demo accounts:', err);
            }
        }
        
        async function loadDemoRecommendations() {
            try {
                const response = await fetch('/admin/api/finance/demo/recommendations');
                const result = await response.json();
                
                const container = document.getElementById('demoRecommendationsContainer');
                
                let html = `
                    <div class="recommendation-card">
                        <h4>📊 Portfolio Overview</h4>
                        <div class="recommendation-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total Assets:</span>
                                <span class="stat-value">$${result.totalAssets.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Total Liabilities:</span>
                                <span class="stat-value">$${result.totalLiabilities.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Net Worth:</span>
                                <span class="stat-value">$${result.netWorth.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            </div>
                            ${result.debtToAssetRatio > 0 ? `
                                <div class="stat-item">
                                    <span class="stat-label">Debt-to-Asset Ratio:</span>
                                    <span class="stat-value">${result.debtToAssetRatio.toFixed(1)}%</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <h4 style="margin-top: 1.5rem;">📈 Allocation Comparison</h4>
                        <table class="allocation-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Current</th>
                                    <th>Recommended</th>
                                    <th>Difference</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.keys(result.currentAllocation).forEach(category => {
                    if (category === 'future_income' || category === 'liabilities') return;
                    
                    const current = result.currentAllocation[category];
                    const recommended = result.recommendedAllocation[category];
                    const diff = current - recommended;
                    const diffClass = Math.abs(diff) > 10 ? 'allocation-diff-high' : (Math.abs(diff) > 5 ? 'allocation-diff-medium' : 'allocation-diff-low');
                    
                    html += `
                        <tr>
                            <td>${category.replace('_', ' ').toUpperCase()}</td>
                            <td>${current.toFixed(1)}%</td>
                            <td>${recommended.toFixed(1)}%</td>
                            <td class="${diffClass}">${diff > 0 ? '+' : ''}${diff.toFixed(1)}%</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                        
                        <h4 style="margin-top: 1.5rem;">💡 Recommendations</h4>
                        <ul class="recommendations-list">
                `;
                
                result.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                
                html += `
                        </ul>
                        
                        ${result.explanation || ''}
                    </div>
                `;
                
                container.innerHTML = html;
            } catch (err) {
                console.error('Failed to load demo recommendations:', err);
                document.getElementById('demoRecommendationsContainer').innerHTML = 
                    '<div class="alert alert-error">Failed to load recommendations: ' + err.message + '</div>';
            }
        }
        
        async function evaluateDemoRetirement() {
            try {
                const response = await fetch('/admin/api/finance/demo/retirement-evaluation');
                const result = await response.json();
                
                const evalSection = document.getElementById('demoRetirementEvaluation');
                const resultDiv = document.getElementById('demoRetirementResult');
                const detailsDiv = document.getElementById('demoRetirementDetails');
                
                if (!result.success) {
                    resultDiv.className = 'alert alert-error';
                    resultDiv.textContent = result.error;
                    evalSection.style.display = 'block';
                    detailsDiv.innerHTML = '';
                    return;
                }
                
                // Display result with appropriate styling based on status
                let alertClass = 'alert-info';
                let icon = '📊';
                
                if (result.status === 'excellent') {
                    alertClass = 'alert-success';
                    icon = '✅';
                } else if (result.status === 'good') {
                    alertClass = 'alert-success';
                    icon = '✅';
                } else if (result.status === 'concerning') {
                    alertClass = 'alert-warning';
                    icon = '⚠️';
                } else if (result.status === 'critical') {
                    alertClass = 'alert-error';
                    icon = '🚨';
                }
                
                resultDiv.className = 'alert ' + alertClass;
                resultDiv.innerHTML = `
                    <h4 style="margin-top: 0;">${icon} Demo Retirement Plan Success Probability: ${result.successProbability}%</h4>
                    <p><strong>${result.recommendation}</strong></p>
                `;
                
                // Display detailed information (same as real data)
                detailsDiv.innerHTML = `
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #007bff;">
                        <h4 style="margin-top: 0; color: #007bff;">📖 Demo Analysis Details</h4>
                        
                        <div style="margin: 1rem 0;">
                            <h5>Current Situation</h5>
                            <ul style="margin: 0.5rem 0;">
                                <li>Current Age: ${result.assumptions.currentAge}</li>
                                <li>Retirement Age: ${result.assumptions.retirementAge}</li>
                                <li>Years Until Retirement: ${result.assumptions.yearsUntilRetirement}</li>
                                <li>Current Total Assets: $${result.assumptions.currentAssets.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</li>
                                <li>Annual Contribution (15% of income): $${result.assumptions.annualContribution.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</li>
                            </ul>
                        </div>
                        
                        <div style="margin: 1rem 0;">
                            <h5>Projections</h5>
                            <ul style="margin: 0.5rem 0;">
                                <li>Projected Portfolio at Retirement: $${result.projections.projectedPortfolioAtRetirement.toLocaleString('en-US')}</li>
                                <li>Total Needed for ${result.assumptions.yearsInRetirement} Years: $${result.projections.totalNeededForRetirement.toLocaleString('en-US')}</li>
                                ${result.projections.shortfall > 0 ? `<li style="color: #d9534f;">Projected Shortfall: $${result.projections.shortfall.toLocaleString('en-US')}</li>` : '<li style="color: #5cb85c;">✅ Projected to meet retirement goals</li>'}
                                ${result.projections.futureIncomeValue > 0 ? `<li>Future Income Value (Pension/SS): $${result.projections.futureIncomeValue.toLocaleString('en-US')}</li>` : ''}
                            </ul>
                        </div>
                        
                        <div style="margin: 1rem 0;">
                            <h5>Assumptions & Methodology</h5>
                            <ul style="margin: 0.5rem 0;">
                                <li>Expected Annual Return: ${result.assumptions.expectedReturn}</li>
                                <li>Return Volatility (Std Dev): ${result.assumptions.returnVolatility}</li>
                                <li>Inflation Rate: ${result.assumptions.inflationRate}</li>
                                <li>Annual Retirement Spending: $${result.assumptions.annualRetirementSpending.toLocaleString('en-US')}</li>
                                <li>Years in Retirement: ${result.assumptions.yearsInRetirement}</li>
                                <li>✅ Using demo historical growth data (6 months)</li>
                            </ul>
                        </div>
                        
                        <div style="background: #fff; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            <h5 style="margin-top: 0;">📊 Methodology</h5>
                            <p style="margin-bottom: 0;">${result.methodology}</p>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                                This analysis uses Monte Carlo simulation, a standard financial planning technique that runs thousands of scenarios 
                                with varying market returns to estimate the probability of success.
                            </p>
                        </div>
                    </div>
                `;
                
                evalSection.style.display = 'block';
                
            } catch (err) {
                const resultDiv = document.getElementById('demoRetirementResult');
                resultDiv.className = 'alert alert-error';
                resultDiv.textContent = 'Failed to evaluate demo retirement plan: ' + err.message;
                document.getElementById('demoRetirementEvaluation').style.display = 'block';
            }
        }
        
        async function updateDemoChart() {
            try {
                // Check if Chart.js is available
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not available - skipping demo chart rendering');
                    return;
                }
                
                const response = await fetch('/admin/api/finance/demo/accounts');
                const accounts = await response.json();
                
                if (accounts.length === 0) {
                    if (demoFinanceChart) {
                        demoFinanceChart.destroy();
                        demoFinanceChart = null;
                    }
                    return;
                }
                
                // Group by category
                const categoryData = {};
                
                accounts.forEach(account => {
                    const type = accountTypes[account.type];
                    if (type) {
                        const category = type.category;
                        if (!categoryData[category]) {
                            categoryData[category] = 0;
                        }
                        categoryData[category] += parseFloat(account.currentValue || 0);
                    }
                });
                
                const labels = Object.keys(categoryData).map(cat => cat.replace('_', ' ').toUpperCase());
                const data = Object.values(categoryData);
                const colors = Object.keys(categoryData).map(cat => FINANCE_CATEGORY_COLORS[cat] || '#6c757d');
                
                const chartType = document.querySelector('input[name="demoChartType"]:checked').value;
                
                const ctx = document.getElementById('demoFinanceChart').getContext('2d');
                
                if (demoFinanceChart) {
                    demoFinanceChart.destroy();
                }
                
                demoFinanceChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Demo Portfolio Value ($)',
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: chartType === 'bar',
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed || context.parsed.y;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return ` $${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: chartType === 'bar' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        } : {}
                    }
                });
                
                // Update legend
                const legendDiv = document.getElementById('demoChartLegend');
                legendDiv.innerHTML = labels.map((label, i) => `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${colors[i]}"></div>
                        <div class="legend-label">${label}: $${data[i].toLocaleString()}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to update demo chart:', err);
            }
        }
        
        // Finance History Functions
        let historyChart = null;
        
        async function initializeHistory() {
            try {
                // Populate account filter dropdown
                const response = await fetch('/admin/api/finance/accounts');
                const accounts = await response.json();
                
                const filterSelect = document.getElementById('historyAccountFilter');
                filterSelect.innerHTML = '<option value="">All Accounts</option>';
                
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.displayName || account.name;
                    filterSelect.appendChild(option);
                });
                
                // Load initial history view
                await updateHistoryView();
            } catch (err) {
                console.error('Failed to initialize history:', err);
            }
        }
        
        function setQuickDateRange(range) {
            const endDate = new Date();
            let startDate = new Date();
            
            switch(range) {
                case '30d':
                    startDate.setDate(endDate.getDate() - 30);
                    break;
                case '90d':
                    startDate.setDate(endDate.getDate() - 90);
                    break;
                case '1y':
                    startDate.setFullYear(endDate.getFullYear() - 1);
                    break;
                case 'all':
                    document.getElementById('historyStartDate').value = '';
                    document.getElementById('historyEndDate').value = '';
                    updateHistoryView();
                    return;
            }
            
            document.getElementById('historyStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('historyEndDate').value = endDate.toISOString().split('T')[0];
            updateHistoryView();
        }
        
        async function updateHistoryView() {
            try {
                const viewType = document.getElementById('historyViewType').value;
                const startDate = document.getElementById('historyStartDate').value;
                const endDate = document.getElementById('historyEndDate').value;
                const accountId = document.getElementById('historyAccountFilter').value;
                
                if (viewType === 'net-worth') {
                    await renderNetWorthChart(startDate, endDate);
                } else if (viewType === 'by-category') {
                    await renderCategoryChart(startDate, endDate);
                } else if (viewType === 'single-account') {
                    if (!accountId) {
                        document.getElementById('historyNoData').style.display = 'block';
                        document.getElementById('historyChartContainer').style.display = 'none';
                        return;
                    }
                    await renderSingleAccountChart(accountId, startDate, endDate);
                }
                
                // Update the table
                await updateHistoryTable(accountId, startDate, endDate);
                
            } catch (err) {
                console.error('Failed to update history view:', err);
                document.getElementById('historyNoData').style.display = 'block';
                document.getElementById('historyChartContainer').style.display = 'none';
            }
        }
        
        async function renderNetWorthChart(startDate, endDate) {
            try {
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not available');
                    return;
                }
                
                let url = '/admin/api/finance/history/net-worth?';
                if (startDate) url += `startDate=${startDate}&`;
                if (endDate) url += `endDate=${endDate}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    document.getElementById('historyNoData').style.display = 'block';
                    document.getElementById('historyChartContainer').style.display = 'none';
                    return;
                }
                
                document.getElementById('historyNoData').style.display = 'none';
                document.getElementById('historyChartContainer').style.display = 'block';
                
                const labels = data.map(d => new Date(d.timestamp).toLocaleDateString());
                const netWorthData = data.map(d => d.netWorth);
                const assetsData = data.map(d => d.assets);
                const liabilitiesData = data.map(d => d.liabilities);
                
                const ctx = document.getElementById('historyChart').getContext('2d');
                
                if (historyChart) {
                    historyChart.destroy();
                }
                
                historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Net Worth',
                                data: netWorthData,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Total Assets',
                                data: assetsData,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Total Liabilities',
                                data: liabilitiesData,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2 });
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update summary statistics
                updateHistorySummary(data);
                
            } catch (err) {
                console.error('Failed to render net worth chart:', err);
            }
        }
        
        async function renderCategoryChart(startDate, endDate) {
            try {
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not available');
                    return;
                }
                
                let url = '/admin/api/finance/history/by-type?';
                if (startDate) url += `startDate=${startDate}&`;
                if (endDate) url += `endDate=${endDate}`;
                
                const response = await fetch(url);
                const typeHistory = await response.json();
                
                if (!typeHistory || Object.keys(typeHistory).length === 0) {
                    document.getElementById('historyNoData').style.display = 'block';
                    document.getElementById('historyChartContainer').style.display = 'none';
                    return;
                }
                
                document.getElementById('historyNoData').style.display = 'none';
                document.getElementById('historyChartContainer').style.display = 'block';
                
                // Aggregate data by date and category
                const dateMap = {};
                
                Object.keys(typeHistory).forEach(category => {
                    typeHistory[category].forEach(entry => {
                        const date = new Date(entry.timestamp).toISOString().split('T')[0];
                        if (!dateMap[date]) {
                            dateMap[date] = {};
                        }
                        if (!dateMap[date][category]) {
                            dateMap[date][category] = 0;
                        }
                        dateMap[date][category] += entry.balance;
                    });
                });
                
                const sortedDates = Object.keys(dateMap).sort();
                const labels = sortedDates.map(d => new Date(d).toLocaleDateString());
                
                const datasets = Object.keys(categoryColors).map(category => {
                    return {
                        label: category.replace('_', ' ').toUpperCase(),
                        data: sortedDates.map(date => dateMap[date][category] || 0),
                        borderColor: FINANCE_CATEGORY_COLORS[category],
                        backgroundColor: FINANCE_CATEGORY_COLORS[category] + '40',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    };
                }).filter(ds => ds.data.some(v => v > 0));
                
                const ctx = document.getElementById('historyChart').getContext('2d');
                
                if (historyChart) {
                    historyChart.destroy();
                }
                
                historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2 });
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                stacked: true
                            }
                        }
                    }
                });
                
            } catch (err) {
                console.error('Failed to render category chart:', err);
            }
        }
        
        async function renderSingleAccountChart(accountId, startDate, endDate) {
            try {
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not available');
                    return;
                }
                
                let url = `/admin/api/finance/history/account/${accountId}?`;
                if (startDate) url += `startDate=${startDate}&`;
                if (endDate) url += `endDate=${endDate}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    document.getElementById('historyNoData').style.display = 'block';
                    document.getElementById('historyChartContainer').style.display = 'none';
                    return;
                }
                
                document.getElementById('historyNoData').style.display = 'none';
                document.getElementById('historyChartContainer').style.display = 'block';
                
                const labels = data.map(d => new Date(d.timestamp).toLocaleDateString());
                const balances = data.map(d => d.balance);
                const accountName = data[0].accountName;
                
                const ctx = document.getElementById('historyChart').getContext('2d');
                
                if (historyChart) {
                    historyChart.destroy();
                }
                
                historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: accountName,
                            data: balances,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Balance: $' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2 });
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update summary for single account
                updateSingleAccountSummary(data);
                
            } catch (err) {
                console.error('Failed to render single account chart:', err);
            }
        }
        
        function updateHistorySummary(netWorthData) {
            if (!netWorthData || netWorthData.length === 0) {
                document.getElementById('historySummary').innerHTML = '<p style="color: #999;">No data available</p>';
                return;
            }
            
            const latest = netWorthData[netWorthData.length - 1];
            const oldest = netWorthData[0];
            const change = latest.netWorth - oldest.netWorth;
            const percentChange = oldest.netWorth !== 0 ? ((change / oldest.netWorth) * 100) : 0;
            
            const summaryHTML = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #007bff;">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Current Net Worth</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;">$${latest.netWorth.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                </div>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid ${change >= 0 ? '#28a745' : '#dc3545'};">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Change</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${change >= 0 ? '#28a745' : '#dc3545'};">
                        ${change >= 0 ? '+' : ''}$${change.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                    </div>
                    <div style="font-size: 0.85rem; color: #666;">${percentChange >= 0 ? '+' : ''}${percentChange.toFixed(2)}%</div>
                </div>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #007bff;">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Total Assets</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;">$${latest.assets.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                </div>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #dc3545;">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Total Liabilities</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;">$${latest.liabilities.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                </div>
            `;
            
            document.getElementById('historySummary').innerHTML = summaryHTML;
        }
        
        function updateSingleAccountSummary(accountData) {
            if (!accountData || accountData.length === 0) {
                document.getElementById('historySummary').innerHTML = '<p style="color: #999;">No data available</p>';
                return;
            }
            
            const latest = accountData[accountData.length - 1];
            const oldest = accountData[0];
            const change = latest.balance - oldest.balance;
            const percentChange = oldest.balance !== 0 ? ((change / oldest.balance) * 100) : 0;
            
            const summaryHTML = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #007bff;">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Current Balance</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;">$${latest.balance.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                </div>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid ${change >= 0 ? '#28a745' : '#dc3545'};">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Change</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${change >= 0 ? '#28a745' : '#dc3545'};">
                        ${change >= 0 ? '+' : ''}$${change.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                    </div>
                    <div style="font-size: 0.85rem; color: #666;">${percentChange >= 0 ? '+' : ''}${percentChange.toFixed(2)}%</div>
                </div>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #6c757d;">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Data Points</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;">${accountData.length}</div>
                </div>
            `;
            
            document.getElementById('historySummary').innerHTML = summaryHTML;
        }
        
        async function updateHistoryTable(accountId, startDate, endDate) {
            try {
                let url = '/admin/api/finance/history?';
                if (accountId) url += `accountId=${accountId}&`;
                if (startDate) url += `startDate=${startDate}&`;
                if (endDate) url += `endDate=${endDate}`;
                
                const response = await fetch(url);
                const history = await response.json();
                
                const tbody = document.getElementById('historyTableBody');
                
                if (!history || history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding: 2rem; text-align: center; color: #999;">No history data available</td></tr>';
                    return;
                }
                
                // Filter to only balance updates
                const balanceUpdates = history.filter(h => h.type === 'balance_update');
                
                // Sort by date descending (newest first)
                balanceUpdates.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                tbody.innerHTML = balanceUpdates.map((entry, index) => {
                    const change = entry.newBalance - entry.oldBalance;
                    const changeColor = change >= 0 ? '#28a745' : '#dc3545';
                    const date = new Date(entry.balanceDate || entry.timestamp).toLocaleDateString();
                    
                    return `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 0.75rem;">${date}</td>
                            <td style="padding: 0.75rem;">${entry.accountName}</td>
                            <td style="padding: 0.75rem; text-align: right; font-weight: 500;">$${entry.newBalance.toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                            <td style="padding: 0.75rem; text-align: right; color: ${changeColor}; font-weight: 500;">
                                ${change >= 0 ? '+' : ''}$${change.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('Failed to update history table:', err);
            }
        }
        
        function exportHistoryToCSV() {
            try {
                const startDate = document.getElementById('historyStartDate').value;
                const endDate = document.getElementById('historyEndDate').value;
                const accountId = document.getElementById('historyAccountFilter').value;
                
                let url = '/admin/api/finance/history?';
                if (accountId) url += `accountId=${accountId}&`;
                if (startDate) url += `startDate=${startDate}&`;
                if (endDate) url += `endDate=${endDate}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(history => {
                        const balanceUpdates = history.filter(h => h.type === 'balance_update');
                        
                        // Helper function to escape CSV values
                        function escapeCSV(value) {
                            if (value == null) return '';
                            const str = String(value);
                            // Escape quotes and wrap in quotes if contains comma, quote, or newline
                            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                                return '"' + str.replace(/"/g, '""') + '"';
                            }
                            return str;
                        }
                        
                        let csv = 'Date,Account,Old Balance,New Balance,Change\n';
                        balanceUpdates.forEach(entry => {
                            const date = new Date(entry.balanceDate || entry.timestamp).toISOString().split('T')[0];
                            const change = entry.newBalance - entry.oldBalance;
                            csv += `${escapeCSV(date)},${escapeCSV(entry.accountName)},${escapeCSV(entry.oldBalance)},${escapeCSV(entry.newBalance)},${escapeCSV(change)}\n`;
                        });
                        
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `finance-history-${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                    });
            } catch (err) {
                console.error('Failed to export CSV:', err);
                showAlert('Failed to export data', 'error');
            }
        }
        
        function exportHistoryToJSON() {
            try {
                const startDate = document.getElementById('historyStartDate').value;
                const endDate = document.getElementById('historyEndDate').value;
                const accountId = document.getElementById('historyAccountFilter').value;
                
                let url = '/admin/api/finance/history?';
                if (accountId) url += `accountId=${accountId}&`;
                if (startDate) url += `startDate=${startDate}&`;
                if (endDate) url += `endDate=${endDate}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(history => {
                        const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `finance-history-${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                    });
            } catch (err) {
                console.error('Failed to export JSON:', err);
                showAlert('Failed to export data', 'error');
            }
        }
        
        // Advanced Settings Functions
        async function loadAdvancedSettings() {
            try {
                const response = await fetch('/admin/api/finance/advanced-settings');
                const settings = await response.json();
                
                // Monte Carlo Simulation Parameters
                document.getElementById('monteCarloSimulations').value = settings.monteCarloSimulations || 10000;
                document.getElementById('yearsInRetirement').value = settings.yearsInRetirement || 30;
                document.getElementById('inflationRate').value = (settings.inflationRate * 100 || 3.0).toFixed(1);
                document.getElementById('savingsRate').value = (settings.savingsRate * 100 || 15).toFixed(0);
                
                // Return Assumptions
                document.getElementById('conservativeReturn').value = (settings.conservativeReturn * 100 || 5.0).toFixed(1);
                document.getElementById('conservativeVolatility').value = (settings.conservativeVolatility * 100 || 10.0).toFixed(1);
                document.getElementById('moderateReturn').value = (settings.moderateReturn * 100 || 7.0).toFixed(1);
                document.getElementById('moderateVolatility').value = (settings.moderateVolatility * 100 || 15.0).toFixed(1);
                document.getElementById('aggressiveReturn').value = (settings.aggressiveReturn * 100 || 9.0).toFixed(1);
                document.getElementById('aggressiveVolatility').value = (settings.aggressiveVolatility * 100 || 20.0).toFixed(1);
                
                // Retirement Adjustments
                document.getElementById('retirementReturnAdjustment').value = (settings.retirementReturnAdjustment || 0.7).toFixed(2);
                document.getElementById('retirementVolatilityAdjustment').value = (settings.retirementVolatilityAdjustment || 0.8).toFixed(2);
            } catch (err) {
                console.error('Failed to load advanced settings:', err);
                showAdvancedSettingsAlert('Failed to load advanced settings', 'error');
            }
        }

        async function saveAdvancedSettings() {
            try {
                const settings = {
                    monteCarloSimulations: parseInt(document.getElementById('monteCarloSimulations').value) || 10000,
                    yearsInRetirement: parseInt(document.getElementById('yearsInRetirement').value) || 30,
                    inflationRate: parseFloat(document.getElementById('inflationRate').value) / 100 || 0.03,
                    savingsRate: parseFloat(document.getElementById('savingsRate').value) / 100 || 0.15,
                    
                    conservativeReturn: parseFloat(document.getElementById('conservativeReturn').value) / 100 || 0.05,
                    conservativeVolatility: parseFloat(document.getElementById('conservativeVolatility').value) / 100 || 0.10,
                    moderateReturn: parseFloat(document.getElementById('moderateReturn').value) / 100 || 0.07,
                    moderateVolatility: parseFloat(document.getElementById('moderateVolatility').value) / 100 || 0.15,
                    aggressiveReturn: parseFloat(document.getElementById('aggressiveReturn').value) / 100 || 0.09,
                    aggressiveVolatility: parseFloat(document.getElementById('aggressiveVolatility').value) / 100 || 0.20,
                    
                    retirementReturnAdjustment: parseFloat(document.getElementById('retirementReturnAdjustment').value) || 0.7,
                    retirementVolatilityAdjustment: parseFloat(document.getElementById('retirementVolatilityAdjustment').value) || 0.8
                };

                const response = await fetch('/admin/api/finance/advanced-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showAdvancedSettingsAlert('✅ Advanced settings saved successfully!', 'success');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (err) {
                console.error('Failed to save advanced settings:', err);
                showAdvancedSettingsAlert('❌ Failed to save advanced settings', 'error');
            }
        }

        async function resetAdvancedSettings() {
            if (confirm('Are you sure you want to reset all advanced settings to default values?')) {
                const defaults = {
                    monteCarloSimulations: 10000,
                    yearsInRetirement: 30,
                    inflationRate: 0.03,
                    savingsRate: 0.15,
                    conservativeReturn: 0.05,
                    conservativeVolatility: 0.10,
                    moderateReturn: 0.07,
                    moderateVolatility: 0.15,
                    aggressiveReturn: 0.09,
                    aggressiveVolatility: 0.20,
                    retirementReturnAdjustment: 0.7,
                    retirementVolatilityAdjustment: 0.8
                };

                try {
                    const response = await fetch('/admin/api/finance/advanced-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(defaults)
                    });

                    if (response.ok) {
                        await loadAdvancedSettings();
                        showAdvancedSettingsAlert('✅ Settings reset to defaults', 'success');
                    } else {
                        throw new Error('Failed to reset settings');
                    }
                } catch (err) {
                    console.error('Failed to reset advanced settings:', err);
                    showAdvancedSettingsAlert('❌ Failed to reset settings', 'error');
                }
            }
        }

        function showAdvancedSettingsAlert(message, type) {
            const alertDiv = document.getElementById('advancedSettingsAlert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        // Ollama/Spending Tab Functions
        let ollamaConfig = {
            webUIUrl: '',
            apiKey: '',
            model: '',
            hasApiKey: false
        };
        let ollamaConversationHistory = [];
        
        async function loadOllamaConfig() {
            try {
                const response = await fetch('/admin/api/ollama/config');
                if (response.ok) {
                    const config = await response.json();
                    ollamaConfig = config;
                    document.getElementById('ollamaWebUIUrl').value = config.webUIUrl || '';
                    document.getElementById('ollamaModel').value = config.model || '';
                    // Don't populate API key field for security, but show placeholder if it exists
                    if (config.hasApiKey) {
                        document.getElementById('ollamaApiKey').placeholder = '••••••••••••••••';
                    }
                } else {
                    console.error('Failed to load Ollama config');
                }
            } catch (err) {
                console.error('Error loading Ollama config:', err);
            }
            
            // Load conversation history from localStorage (temporary until backend storage is implemented)
            const savedHistory = localStorage.getItem('ollamaConversationHistory');
            if (savedHistory) {
                ollamaConversationHistory = JSON.parse(savedHistory);
                displayOllamaConversation();
            }
        }
        
        async function saveOllamaConfig() {
            const webUIUrl = document.getElementById('ollamaWebUIUrl').value;
            const apiKey = document.getElementById('ollamaApiKey').value;
            const model = document.getElementById('ollamaModel').value;
            
            const configToSave = {
                webUIUrl: webUIUrl,
                model: model
            };
            
            // Only include API key if user entered something
            if (apiKey && apiKey.trim() && !apiKey.startsWith('••')) {
                configToSave.apiKey = apiKey;
            }
            
            try {
                const response = await fetch('/admin/api/ollama/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configToSave)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local config
                    ollamaConfig.webUIUrl = webUIUrl;
                    ollamaConfig.model = model;
                    if (apiKey && apiKey.trim() && !apiKey.startsWith('••')) {
                        ollamaConfig.hasApiKey = true;
                        document.getElementById('ollamaApiKey').value = '';
                        document.getElementById('ollamaApiKey').placeholder = '••••••••••••••••';
                    }
                    showOllamaAlert('Configuration saved successfully!', 'success');
                } else {
                    showOllamaAlert('Error saving configuration: ' + result.error, 'error');
                }
            } catch (err) {
                showOllamaAlert('Error saving configuration: ' + err.message, 'error');
            }
        }
        
        async function testOllamaConnection() {
            const statusDiv = document.getElementById('ollamaConnectionStatus');
            const errorDiv = document.getElementById('ollamaConnectionError');
            const metricsDiv = document.getElementById('ollamaConnectionMetrics');
            const statusText = document.getElementById('ollamaStatusText');
            
            if (!ollamaConfig.webUIUrl) {
                errorDiv.style.display = 'block';
                statusDiv.style.display = 'none';
                document.getElementById('ollamaErrorText').textContent = 'Please enter Open WebUI URL first';
                return;
            }
            
            statusText.textContent = 'Testing connection...';
            statusDiv.className = 'alert';
            statusDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            metricsDiv.style.display = 'none';
            
            try {
                const response = await fetch('/admin/api/ollama/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success && result.connected) {
                    statusText.textContent = 'Connected';
                    statusDiv.className = 'alert alert-success';
                    
                    document.getElementById('ollamaResponseTime').textContent = result.responseTime + ' ms';
                    document.getElementById('ollamaModelInfo').textContent = result.details?.model || ollamaConfig.model || 'Not specified';
                    metricsDiv.style.display = 'block';
                    
                    showOllamaAlert('Successfully connected to Open WebUI', 'success');
                } else {
                    statusText.textContent = 'Connection failed';
                    statusDiv.className = 'alert alert-error';
                    errorDiv.style.display = 'block';
                    
                    let errorMessage = result.error || 'Unknown error';
                    if (result.details && result.details.suggestion) {
                        errorMessage += '\n\n' + result.details.suggestion;
                    }
                    document.getElementById('ollamaErrorText').textContent = errorMessage;
                    
                    showOllamaAlert('Connection failed: ' + result.error, 'error');
                }
            } catch (error) {
                statusText.textContent = 'Connection failed';
                statusDiv.className = 'alert alert-error';
                errorDiv.style.display = 'block';
                document.getElementById('ollamaErrorText').textContent = error.message;
                showOllamaAlert('Error testing connection: ' + error.message, 'error');
            }
        }
        
        async function sendOllamaPrompt() {
            const promptInput = document.getElementById('ollamaPrompt');
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                showOllamaAlert('Please enter a prompt', 'error');
                return;
            }
            
            if (!ollamaConfig.webUIUrl || !ollamaConfig.model) {
                showOllamaAlert('Please configure Open WebUI URL and Model first', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendPromptBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = '⏳ Processing...';
            
            try {
                const response = await fetch('/admin/api/ollama/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        conversationHistory: ollamaConversationHistory
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Add to conversation history
                    ollamaConversationHistory.push({
                        type: 'user',
                        content: prompt,
                        timestamp: new Date().toISOString()
                    });
                    
                    ollamaConversationHistory.push({
                        type: 'assistant',
                        content: result.response,
                        timestamp: result.timestamp || new Date().toISOString(),
                        responseTime: result.responseTime
                    });
                    
                    // Save to localStorage (temporary until backend storage is implemented)
                    localStorage.setItem('ollamaConversationHistory', JSON.stringify(ollamaConversationHistory));
                    
                    // Display conversation
                    displayOllamaConversation();
                    
                    // Clear prompt
                    promptInput.value = '';
                    
                    showOllamaAlert('Response received', 'success');
                } else {
                    showOllamaAlert('Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showOllamaAlert('Error sending prompt: ' + error.message, 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '🚀 Send Prompt';
            }
        }
        
        function displayOllamaConversation() {
            const conversationDiv = document.getElementById('ollamaConversation');
            const messagesDiv = document.getElementById('ollamaMessages');
            
            if (ollamaConversationHistory.length === 0) {
                conversationDiv.style.display = 'none';
                return;
            }
            
            conversationDiv.style.display = 'block';
            
            messagesDiv.innerHTML = ollamaConversationHistory.map(msg => {
                const time = new Date(msg.timestamp).toLocaleTimeString();
                const isUser = msg.type === 'user';
                
                return `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 8px; background: ${isUser ? '#e3f2fd' : '#f1f8e9'}; border-left: 4px solid ${isUser ? '#2196f3' : '#8bc34a'};">
                        <div style="font-weight: 600; color: ${isUser ? '#1976d2' : '#689f38'}; margin-bottom: 0.25rem;">
                            ${isUser ? '👤 You' : '🤖 Assistant'} <span style="font-weight: normal; font-size: 0.85rem; color: #666;">${time}</span>
                        </div>
                        <div style="white-space: pre-wrap; color: #333;">${escapeHtml(msg.content)}</div>
                        ${msg.responseTime ? `<div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">⏱️ Response time: ${msg.responseTime}ms</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function clearOllamaConversation() {
            if (!confirm('Clear all conversation history?')) {
                return;
            }
            
            ollamaConversationHistory = [];
            localStorage.removeItem('ollamaConversationHistory');
            document.getElementById('ollamaConversation').style.display = 'none';
            showOllamaAlert('Conversation cleared', 'success');
        }
        
        function showOllamaAlert(message, type) {
            // Reuse the existing alert system
            showAlert(message, type);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showAlert(message, type) {
            // Use existing alert system if available, or create a simple one
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'success' ? '#d4edda' : '#f8d7da'};
                color: ${type === 'success' ? '#155724' : '#721c24'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Backup and Restore Functions
        let pendingBackupData = null;
        
        async function exportBackup() {
            const exportAlert = document.getElementById('exportAlert');
            exportAlert.style.display = 'none';
            
            try {
                exportAlert.textContent = 'Preparing export...';
                exportAlert.className = 'alert';
                exportAlert.style.display = 'block';
                exportAlert.style.background = '#e7f3ff';
                exportAlert.style.color = '#004085';
                exportAlert.style.border = '1px solid #b6d4fe';
                
                const response = await fetch('/admin/api/backup/export');
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Export failed');
                }
                
                // Get the backup data
                const backupData = await response.json();
                
                // Create a downloadable file
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `site-backup-${timestamp}.json`;
                
                // Create download link and trigger it
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                exportAlert.textContent = `✅ Backup exported successfully! File: ${filename}`;
                exportAlert.className = 'alert alert-success';
                exportAlert.style.display = 'block';
                
            } catch (error) {
                console.error('Export failed:', error);
                exportAlert.textContent = `❌ Export failed: ${error.message}`;
                exportAlert.className = 'alert alert-error';
                exportAlert.style.display = 'block';
            }
        }
        
        async function previewBackup(event) {
            const file = event.target.files[0];
            const importAlert = document.getElementById('importAlert');
            const previewSection = document.getElementById('backupPreview');
            const previewContent = document.getElementById('backupPreviewContent');
            const validationDiv = document.getElementById('backupValidation');
            const importBtn = document.getElementById('importBtn');
            
            importAlert.style.display = 'none';
            previewSection.style.display = 'none';
            importBtn.disabled = true;
            pendingBackupData = null;
            
            if (!file) {
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                importAlert.textContent = '❌ Please select a .json backup file';
                importAlert.className = 'alert alert-error';
                importAlert.style.display = 'block';
                return;
            }
            
            try {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Send to server for validation and preview
                        const response = await fetch('/admin/api/backup/preview', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(backupData)
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'Preview failed');
                        }
                        
                        // Store the backup data for import
                        pendingBackupData = backupData;
                        
                        // Build preview HTML
                        let previewHtml = '';
                        
                        // Metadata
                        if (result.summary && result.summary.metadata) {
                            const meta = result.summary.metadata;
                            previewHtml += `
                                <div style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #ddd;">
                                    <strong>📅 Export Date:</strong> ${new Date(meta.exportedAt).toLocaleString()}<br>
                                    <strong>📦 Backup Version:</strong> ${meta.version}<br>
                                    <strong>🖥️ App Version:</strong> ${meta.applicationVersion || 'Unknown'}
                                </div>
                            `;
                        }
                        
                        // Contents summary
                        if (result.summary && result.summary.contents) {
                            const contents = result.summary.contents;
                            
                            previewHtml += '<strong>📋 Backup Contents:</strong><ul style="margin: 0.5rem 0 0 1.5rem;">';
                            
                            if (contents.mainConfig) {
                                const mc = contents.mainConfig;
                                previewHtml += `<li>Main Configuration
                                    <ul style="margin-left: 1rem; color: #666; font-size: 0.9rem;">
                                        ${mc.usefulLinksCount > 0 ? `<li>Useful Links: ${mc.usefulLinksCount}</li>` : ''}
                                        ${mc.connectedDevicesCount > 0 ? `<li>Connected Devices: ${mc.connectedDevicesCount}</li>` : ''}
                                        ${mc.alcoholsCount > 0 || mc.mixersCount > 0 || mc.recipesCount > 0 ? 
                                            `<li>Drink Mixer: ${mc.alcoholsCount} alcohols, ${mc.mixersCount} mixers, ${mc.recipesCount} recipes</li>` : ''}
                                        ${mc.tournamentsCount > 0 ? `<li>Tournaments: ${mc.tournamentsCount}</li>` : ''}
                                        ${mc.hasVidiots ? '<li>Vidiots Settings</li>' : ''}
                                        ${mc.hasEspresso ? '<li>Espresso Settings</li>' : ''}
                                        ${mc.hasClient ? '<li>Client Settings</li>' : ''}
                                    </ul>
                                </li>`;
                            }
                            
                            if (contents.espressoData && contents.espressoData.hasData) {
                                previewHtml += `<li>Espresso Data (${contents.espressoData.fieldsCount} fields)</li>`;
                            }
                            
                            if (contents.finance) {
                                const fin = contents.finance;
                                previewHtml += `<li>Finance Data
                                    <ul style="margin-left: 1rem; color: #666; font-size: 0.9rem;">
                                        <li>Accounts: ${fin.accountsCount}</li>
                                        ${fin.hasDemographics ? '<li>Demographics</li>' : ''}
                                        ${fin.hasAdvancedSettings ? '<li>Advanced Settings</li>' : ''}
                                        ${fin.historyEntriesCount > 0 ? `<li>History Entries: ${fin.historyEntriesCount}</li>` : ''}
                                    </ul>
                                </li>`;
                            }
                            
                            previewHtml += '</ul>';
                        }
                        
                        previewContent.innerHTML = previewHtml;
                        
                        // Show validation results
                        let validationHtml = '';
                        
                        if (result.valid) {
                            validationHtml = '<div style="background: #d4edda; color: #155724; padding: 0.75rem; border-radius: 5px; border: 1px solid #c3e6cb;">✅ Backup file is valid and ready to import</div>';
                            importBtn.disabled = false;
                        } else {
                            validationHtml = `<div style="background: #f8d7da; color: #721c24; padding: 0.75rem; border-radius: 5px; border: 1px solid #f5c6cb;">
                                ❌ Validation Errors:<br>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${result.errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
                                </ul>
                            </div>`;
                            importBtn.disabled = true;
                        }
                        
                        if (result.warnings && result.warnings.length > 0) {
                            validationHtml += `<div style="background: #fff3cd; color: #856404; padding: 0.75rem; border-radius: 5px; border: 1px solid #ffeaa7; margin-top: 0.5rem;">
                                ⚠️ Warnings:<br>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${result.warnings.map(w => `<li>${escapeHtml(w)}</li>`).join('')}
                                </ul>
                            </div>`;
                        }
                        
                        validationDiv.innerHTML = validationHtml;
                        previewSection.style.display = 'block';
                        
                    } catch (parseError) {
                        importAlert.textContent = `❌ Invalid backup file: ${parseError.message}`;
                        importAlert.className = 'alert alert-error';
                        importAlert.style.display = 'block';
                    }
                };
                
                reader.onerror = function() {
                    importAlert.textContent = '❌ Error reading file';
                    importAlert.className = 'alert alert-error';
                    importAlert.style.display = 'block';
                };
                
                reader.readAsText(file);
                
            } catch (error) {
                console.error('Preview failed:', error);
                importAlert.textContent = `❌ Preview failed: ${error.message}`;
                importAlert.className = 'alert alert-error';
                importAlert.style.display = 'block';
            }
        }
        
        async function performImport() {
            if (!pendingBackupData) {
                alert('No backup data to import. Please select a file first.');
                return;
            }
            
            if (!confirm('Are you sure you want to import this backup? This will overwrite existing configurations. Sensitive credentials will be preserved.')) {
                return;
            }
            
            const importAlert = document.getElementById('importAlert');
            const importBtn = document.getElementById('importBtn');
            
            importBtn.disabled = true;
            importAlert.textContent = 'Importing data...';
            importAlert.className = 'alert';
            importAlert.style.display = 'block';
            importAlert.style.background = '#e7f3ff';
            importAlert.style.color = '#004085';
            importAlert.style.border = '1px solid #b6d4fe';
            
            try {
                const response = await fetch('/admin/api/backup/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pendingBackupData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let successMsg = `✅ Import completed successfully!<br><strong>Imported:</strong> ${result.results.imported.join(', ')}`;
                    
                    if (result.results.skipped && result.results.skipped.length > 0) {
                        successMsg += `<br><strong>Skipped:</strong> ${result.results.skipped.join(', ')}`;
                    }
                    
                    if (result.warnings && result.warnings.length > 0) {
                        successMsg += `<br><strong>Warnings:</strong> ${result.warnings.join(', ')}`;
                    }
                    
                    importAlert.innerHTML = successMsg;
                    importAlert.className = 'alert alert-success';
                    
                    // Reset the form
                    document.getElementById('backupFileInput').value = '';
                    document.getElementById('backupPreview').style.display = 'none';
                    pendingBackupData = null;
                    
                    // Recommend page reload
                    setTimeout(() => {
                        if (confirm('Import completed! It is recommended to reload the page to see all changes. Reload now?')) {
                            window.location.reload();
                        }
                    }, 1000);
                    
                } else {
                    let errorMsg = `❌ Import failed: ${result.error}`;
                    
                    if (result.results && result.results.errors && result.results.errors.length > 0) {
                        errorMsg += `<br><strong>Errors:</strong><ul style="margin: 0.5rem 0 0 1.5rem;">${result.results.errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}</ul>`;
                    }
                    
                    if (result.results && result.results.imported && result.results.imported.length > 0) {
                        errorMsg += `<br><strong>Partially imported:</strong> ${result.results.imported.join(', ')}`;
                    }
                    
                    importAlert.innerHTML = errorMsg;
                    importAlert.className = 'alert alert-error';
                    importBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('Import failed:', error);
                importAlert.textContent = `❌ Import failed: ${error.message}`;
                importAlert.className = 'alert alert-error';
                importBtn.disabled = false;
            }
        }
        
        function cancelImport() {
            pendingBackupData = null;
            document.getElementById('backupFileInput').value = '';
            document.getElementById('backupPreview').style.display = 'none';
            document.getElementById('importAlert').style.display = 'none';
        }

        // Diagnostic error handling - catches missing function errors
        window.addEventListener('error', function(event) {
            if (event.message && (event.message.includes('showMainTab') || event.message.includes('showSubTab'))) {
                console.error('❌ Tab navigation function error detected:', event.message);
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 5px; border: 1px solid #f5c6cb; z-index: 10000; max-width: 500px;';
                errorDiv.textContent = '⚠️ Tab navigation error: ' + event.message + '. Please refresh the page.';
                document.body.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }
        });
    </script>
</body>
</html>